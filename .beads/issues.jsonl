{"id":"dh-02n","title":"Add dependency validation tooling","description":"## Overview\nAdd tooling to detect circular dependencies, orphan modules, and unused code.\n\n## Tools\n- dependency-cruiser - Architecture validation and circular dependency detection\n- knip - Unused exports, dependencies, and files detection\n- changesets - Semantic versioning and changelog generation\n\n## Why\n- Catch architectural issues early\n- Keep codebase clean of dead code\n- Proper release management with changelogs","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:15:15.548317712Z","updated_at":"2025-11-25T07:15:15.548317712Z","dependencies":[{"issue_id":"dh-02n","depends_on_id":"dh-5rx","type":"blocks","created_at":"2025-11-25T07:15:20.292822533Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-07h","title":"Replace RxJS Subjects with Effect SubscriptionRef/PubSub","description":"## Overview\nReplace RxJS Subject patterns with Effect's SubscriptionRef and PubSub for state management with subscribers.\n\n## RxJS → Effect Mapping\n\n### BehaviorSubject/ReplaySubject(1) → SubscriptionRef\n```typescript\n// RxJS\nconst subject = new BehaviorSubject\u003cState\u003e(initialState)\nsubject.next(newState)\nsubject.subscribe(handler)\n\n// Effect\nconst ref = yield* SubscriptionRef.make\u003cState\u003e(initialState)\nyield* SubscriptionRef.set(ref, newState)\nyield* Stream.runForEach(ref.changes, handler)\n```\n\nKey features:\n- `ref.changes` is a Stream that emits current value + all changes\n- Can sample current value with `SubscriptionRef.get(ref)`\n- Multiple subscribers each get independent streams\n\n### Subject (multicast) → PubSub\n```typescript\n// RxJS  \nconst subject = new Subject\u003cEvent\u003e()\nsubject.next(event)\nsubject.subscribe(handler)\n\n// Effect\nconst pubsub = yield* PubSub.bounded\u003cEvent\u003e(16)\nyield* PubSub.publish(pubsub, event)\nconst subscriber = yield* PubSub.subscribe(pubsub)\nyield* Queue.take(subscriber) // or Stream.fromQueue\n```\n\nBackpressure strategies:\n- `PubSub.bounded(n)` - Backpressure, suspends publisher\n- `PubSub.dropping(n)` - Drops new messages when full\n- `PubSub.sliding(n)` - Drops oldest messages\n- `PubSub.unbounded()` - No limit (careful!)\n\n## Current Usage in Codebase\n- DeepHeating.ts uses multiple Subjects for state broadcasting\n- trvControlStateSubject, trvStatusSubject, heatingStatusSubject\n- These are good candidates for SubscriptionRef\n\n## Dependencies\n- Requires dh-597 (adapters) to expose as Observable during transition\n\n## Files to Change\n- packages/deep-heating-rx/src/lib/DeepHeating.ts","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T11:51:08.126613Z","updated_at":"2025-11-30T11:51:08.126613Z","dependencies":[{"issue_id":"dh-07h","depends_on_id":"dh-597","type":"blocks","created_at":"2025-11-30T11:51:11.718223Z","created_by":"daemon"}]}
{"id":"dh-08z","title":"Add CI aggregation task to turbo","description":"Brownsauce has a cleaner pattern: `all` → `ci` → (build, lint, test, deps:check, release:validate, etc). Currently home-automation's `all` task just depends on build/lint/test directly. Should add a `ci` task that aggregates all checks needed for the CI pipeline, including deps:check and potentially release:validate for changesets.\n\n## Implementation notes (from brownsauce)\n\nThe `ci` task aggregates all checks:\n- build, lint, test (already have)\n- `//#deps:check` (just added)\n- `//#arch:check` (if we add dependency-cruiser)\n- `//#release:validate` (for changeset validation)\n- `validate:docs` (if applicable)\n\nThen `all` just depends on `ci` for a clean hierarchy.\n\nEach task should have explicit `inputs` arrays for proper caching - see brownsauce/turbo.json for the patterns.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T08:26:37.747865Z","updated_at":"2025-11-30T08:47:36.510561Z","closed_at":"2025-11-30T08:47:36.510561Z"}
{"id":"dh-09s","title":"Migrate deep-heating-home-assistant tests to Bun","description":"## Task\nMigrate tests in packages/deep-heating-home-assistant from Jest to Bun native.\n\n## Steps\n1. Update test imports to use buntest\n2. Convert Jest patterns to Bun equivalents\n3. Convert Effect tests to use `it.effect()`\n4. Update package.json test script\n5. Remove Jest config\n\n## Notes\nThis package uses Effect heavily - good candidate for it.effect() patterns","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:32.639852102Z","updated_at":"2026-01-02T14:31:00.049810705Z","closed_at":"2025-11-30T10:54:19.523674Z","dependencies":[{"issue_id":"dh-09s","depends_on_id":"dh-659","type":"blocks","created_at":"2025-11-25T07:14:39.539958612Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-0av","title":"Add //#deps:check turbo task for knip","description":"Currently `unused:check` in package.json runs `knip-bun` directly, bypassing turbo. This means no caching and no dependency ordering. Should add a root-level turbo task like brownsauce has.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T08:26:37.415716Z","updated_at":"2025-11-30T08:40:37.382656Z","closed_at":"2025-11-30T08:40:37.382656Z"}
{"id":"dh-0i8z","title":"TrvActor: Add mode and is_heating change notifications to room","description":"The TrvActor only notifies RoomActor of temperature and target changes. Missing:\n\n1. TrvModeChanged notification - needed so RoomActor can derive room mode\n2. TrvIsHeatingChanged notification - needed for room heating status aggregation\n\nRelated to dh-zylb (RoomActor TRV mode tracking).\n\nSee: trv_actor.gleam notify_temperature_change/notify_target_change functions","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:51:31.976502994Z","created_by":"graeme","updated_at":"2026-01-03T15:50:51.699902845Z","closed_at":"2026-01-03T15:50:51.699902845Z","close_reason":"TrvActor now sends TrvModeChanged and TrvIsHeatingChanged notifications to RoomActor, enabling room mode derivation"}
{"id":"dh-0ia","title":"Replace dotenv with Effect Config in socketio","description":"## Overview\n~~Replace manual dotenv configuration loading in deep-heating-socketio with Effect's Config module.~~\n\n**UPDATE**: Package was renamed to deep-heating-server. The server already uses Effect Config for type-safe config loading (see main.ts lines 10-21). \n\n## Current State\n- main.ts calls `dotenv.config()` to load .env file into process.env\n- Then uses Effect Config (Config.integer, Config.string, Config.withDefault) to read values\n- This is actually the correct pattern - dotenv loads the file, Effect Config provides type-safe access\n\n## Remaining Question\nIs this bead still needed? Options:\n1. Close it - current pattern is fine (dotenv + Effect Config)\n2. Keep it - if we want to remove dotenv entirely and use Effect's ConfigProvider.fromEnv() with a custom .env loader\n\n## Files\n- packages/deep-heating-server/src/main.ts (NOT socketio)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T11:40:39.9509Z","updated_at":"2025-12-12T18:22:41.246895Z","closed_at":"2025-12-12T18:22:41.246895Z","dependencies":[{"issue_id":"dh-0ia","depends_on_id":"dh-mdh","type":"blocks","created_at":"2025-11-30T12:05:18.488365Z","created_by":"daemon"}]}
{"id":"dh-116e","title":"Implement connection overlay component","description":"## Overview\n\nCreate a Lustre component that displays a full-screen overlay with a loading spinner when the WebSocket connection is lost.\n\n## TypeScript Reference\n\nFrom `/home/graeme/Development/home-automation/packages/deep-heating-web/src/routes/+layout.svelte`:\n```svelte\n{#if !$homeStore.connected}\n  \u003cdiv class=\"w-screen h-screen bg-black/50 absolute flex items-center justify-center z-10\"\u003e\n    \u003cSpinner /\u003e\n  \u003c/div\u003e\n{/if}\n```\n\n## Implementation\n\nCreate `src/ui/components/connection_overlay.gleam`:\n\n```gleam\nimport lustre/attribute.{class}\nimport lustre/element.{type Element, text}\nimport lustre/element/html.{div, span}\n\n/// Connection state for the overlay\npub type ConnectionState {\n  Connected\n  Disconnected\n  Reconnecting\n}\n\n/// Render the connection overlay.\npub fn view(state: ConnectionState) -\u003e Element(msg) {\n  case state {\n    Connected -\u003e element.none()\n    Disconnected -\u003e overlay(\"Disconnected\", \"connection-overlay-disconnected\")\n    Reconnecting -\u003e overlay(\"Reconnecting...\", \"connection-overlay-reconnecting\")\n  }\n}\n\n/// Simple connected check for use with Model\npub fn view_from_bool(connected: Bool) -\u003e Element(msg) {\n  case connected {\n    True -\u003e element.none()\n    False -\u003e overlay(\"Connecting...\", \"connection-overlay\")\n  }\n}\n\nfn overlay(message: String, test_id: String) -\u003e Element(msg) {\n  div(\n    [\n      class(\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\"),\n      attribute.attribute(\"data-testid\", test_id),\n    ],\n    [\n      div([class(\"flex flex-col items-center gap-4\")], [\n        spinner(),\n        div([class(\"text-white text-lg\")], [text(message)]),\n      ]),\n    ],\n  )\n}\n\nfn spinner() -\u003e Element(msg) {\n  span(\n    [\n      class(\"loading loading-spinner loading-lg text-primary\"),\n      attribute.attribute(\"data-testid\", \"spinner\"),\n    ],\n    [],\n  )\n}\n```\n\n## Testing\n\n### Snapshot Tests\n\nCreate `test/ui/components/connection_overlay_test.gleam`:\n\n```gleam\nimport birdie\nimport lustre/element\nimport ui/components/connection_overlay.{Connected, Disconnected, Reconnecting}\n\npub fn overlay_when_connected_test() {\n  connection_overlay.view(Connected)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"connection_overlay_connected\")\n}\n\npub fn overlay_when_disconnected_test() {\n  connection_overlay.view(Disconnected)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"connection_overlay_disconnected\")\n}\n\npub fn overlay_when_reconnecting_test() {\n  connection_overlay.view(Reconnecting)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"connection_overlay_reconnecting\")\n}\n\npub fn overlay_from_bool_true_test() {\n  connection_overlay.view_from_bool(True)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"connection_overlay_from_bool_connected\")\n}\n\npub fn overlay_from_bool_false_test() {\n  connection_overlay.view_from_bool(False)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"connection_overlay_from_bool_disconnected\")\n}\n```\n\n### Query Tests\n\n```gleam\nimport lustre/dev/query\nimport ui/components/connection_overlay.{Connected, Disconnected}\n\npub fn connected_renders_nothing_test() {\n  let view = connection_overlay.view(Connected)\n  // element.none() renders as empty\n  let assert \"\" = element.to_string(view)\n}\n\npub fn disconnected_has_overlay_test() {\n  let view = connection_overlay.view(Disconnected)\n  let assert True = query.has(view, query.test_id(\"connection-overlay-disconnected\"))\n}\n\npub fn disconnected_has_spinner_test() {\n  let view = connection_overlay.view(Disconnected)\n  let assert True = query.has(view, query.test_id(\"spinner\"))\n}\n\npub fn overlay_has_loading_class_test() {\n  let view = connection_overlay.view(Disconnected)\n  let assert True = query.has(view, query.class(\"loading-spinner\"))\n}\n```\n\n## Type Safety Considerations\n\n1. **ConnectionState enum**: More expressive than raw Bool\n2. **Polymorphic Element(msg)**: Overlay doesn't emit messages\n3. **view_from_bool convenience**: Type-safe bridge from Model.connected\n\n## Acceptance Criteria\n\n- [ ] Overlay appears when `connected = False`\n- [ ] Overlay is hidden when `connected = True`\n- [ ] Spinner animates (DaisyUI loading class)\n- [ ] Overlay covers full viewport\n- [ ] Z-index overlays everything (z-50)\n- [ ] Snapshot tests pass for all connection states\n- [ ] Query tests verify structure\n- [ ] test-id attributes present for testing","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T10:41:30.060593248Z","created_by":"graeme","updated_at":"2026-01-04T13:03:56.030638169Z","closed_at":"2026-01-04T13:03:56.030638169Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-116e","depends_on_id":"dh-33jq.18","type":"blocks","created_at":"2026-01-04T10:47:25.970779865Z","created_by":"graeme"},{"issue_id":"dh-116e","depends_on_id":"dh-33jq","type":"blocks","created_at":"2026-01-04T10:47:32.484417755Z","created_by":"graeme"}]}
{"id":"dh-159","title":"Migrate deep-heating Docker image to Nix","description":"## Task\nReplace packages/deep-heating/Dockerfile with Nix derivation.\n\n## Current Dockerfile\n- Multi-stage build\n- Turbo prune → Build → Runtime\n- nginx + pm2 for serving\n\n## Nix Approach\n- Separate derivations for build and runtime\n- Use dockerTools.buildLayeredImage\n- Include nginx and process manager in image\n\n## Output\n- Container image loadable via `docker load \u003c result`\n- Equivalent functionality to current Docker image\n- Smaller size due to minimal base\n\n## Home Assistant Integration\n- Verify image works as HA add-on\n- Check any add-on specific requirements","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:45.592528121Z","updated_at":"2026-01-02T14:31:00.058663624Z","closed_at":"2025-11-29T15:15:21.324088Z","dependencies":[{"issue_id":"dh-159","depends_on_id":"dh-hgg","type":"blocks","created_at":"2025-11-25T07:15:50.641723297Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-1b6u","title":"Frontend: Pop-out UI and overlay","description":"Broad strokes - details emerge from TDD:\n- Initiation UI (placement from UX research)\n- Duration/time picker (pattern from UX research)\n- Overlay during pop-out with cancel option\n\nImplementation driven by outer E2E test failures.","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-12-16T17:59:12.836955Z","updated_at":"2025-12-26T18:08:29.958799Z","dependencies":[{"issue_id":"dh-1b6u","depends_on_id":"dh-dny6","type":"blocks","created_at":"2025-12-16T17:59:21.03197Z","created_by":"daemon"},{"issue_id":"dh-1b6u","depends_on_id":"dh-rr0","type":"blocks","created_at":"2025-12-16T17:59:21.430844Z","created_by":"daemon"},{"issue_id":"dh-1b6u","depends_on_id":"dh-g7gt","type":"blocks","created_at":"2025-12-26T18:08:29.891931Z","created_by":"daemon"}]}
{"id":"dh-1gr","title":"Add changesets for version management","description":"## Goal\nControl releases of the deep-heating Docker image and produce release notes, rather than releasing on every push to main.\n\n## Design\n\n### packages/deep-heating gets a package.json\nCreated `packages/deep-heating/package.json` with dependencies on:\n- deep-heating-socketio\n- @home-automation/deep-heating-web\n\nThis allows changesets' `updateInternalDependencies` to automatically bump deep-heating when its deps change.\n\n### Workflow\n1. Push changes to main with changesets → `release.yml` runs\n2. `changesets/action` creates \"Version Packages\" PR\n3. Merge that PR → `changesets/action` runs `bun run release`\n4. `release` script creates git tag (e.g., `v0.1.0`)\n5. Tag triggers `docker.yml` → builds multi-arch Docker images\n\n### Scripts\n- `bun run changeset` - create a changeset\n- `bun run version` - bump versions + sync config.yaml\n- `bun run version:sync` - sync version to Home Assistant config.yaml\n- `bun run release` - create and push git tag\n\n### Workflows\n- `.github/workflows/release.yml` - runs changesets/action on push to main\n- `.github/workflows/docker.yml` - builds Docker on tag push (v*)\n- `.github/workflows/ci.yml` - build/test/lint only (no Docker)\n\n### Requirements\n- Protected main branch (PRs required)\n- GitHub App for verified commits:\n  - `RELEASE_APP_ID` secret\n  - `RELEASE_APP_PRIVATE_KEY` secret\n\n## Files Created/Modified\n- `packages/deep-heating/package.json` (new)\n- `.changeset/config.json` (configured)\n- `scripts/sync-version.ts` (new)\n- `scripts/create-release-tag.ts` (new)\n- `.github/workflows/release.yml` (new)\n- `.github/workflows/docker.yml` (new)\n- `.github/workflows/ci.yml` (removed Docker jobs)\n- `package.json` (added scripts)\n\n## Follow-up\ndh-yy2: Inline Docker build in release workflow (blocked by this)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:15.865152041Z","updated_at":"2025-11-27T08:29:20.668453688Z","closed_at":"2025-11-27T08:29:20.668453688Z","dependencies":[{"issue_id":"dh-1gr","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:15:20.336977293Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-1kv","title":"Add bun enforcement to package.json","description":"## Task\nConfigure package.json to enforce bun usage and prevent accidental npm/yarn usage.\n\n## Changes\n1. Update packageManager field: `\"packageManager\": \"bun@1.3.2\"`\n2. Add preinstall hook: `\"preinstall\": \"npx only-allow bun\"`\n\n## Why\nPrevents team members from accidentally using npm and creating lockfile conflicts.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:12:29.631173058Z","updated_at":"2025-11-25T07:48:23.093390559Z","closed_at":"2025-11-25T07:48:23.093390559Z","dependencies":[{"issue_id":"dh-1kv","depends_on_id":"dh-k8y","type":"blocks","created_at":"2025-11-25T07:13:21.163325085Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-1wyv","title":"RoomDecisionActor: Handle TRV off mode (skip actions)","description":"The TS trvActions.test.ts shows that when a TRV is in 'off' mode, no action should be generated.\n\nThe Gleam RoomDecisionActor doesn't check TRV mode. It should:\n1. Track TRV mode in RoomActor.TrvState\n2. Skip action generation for TRVs that are off\n\nSee: trvActions.test.ts - 'returns Either.right(null) when TRV is off'","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:44:47.550961664Z","created_by":"graeme","updated_at":"2026-01-03T15:58:54.638355201Z","closed_at":"2026-01-03T15:58:54.638355201Z","close_reason":"Closed"}
{"id":"dh-1y0j","title":"Add simulate integration tests for main view","description":"The task spec for dh-33jq.25 included simulate integration tests using lustre/dev/simulate, but only snapshot and query tests were implemented. The simulate tests would provide more comprehensive coverage:\n\n- `full_app_flow_connect_receive_state_test` - Connect → receive state → verify rooms displayed\n- `user_adjusts_temperature_test` - Click warmer/colder buttons → verify model update\n- `disconnection_shows_overlay_test` - Connected with state → disconnect → verify overlay appears\n- `rooms_sorted_correctly_test` - Verify room card order programmatically (not just via snapshot)\n\nThese tests exercise the full update cycle rather than just rendering snapshots.\n\nReference: Original task spec in dh-33jq.25 description has example test code.","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-04T13:16:25.991870758Z","created_by":"graeme","updated_at":"2026-01-04T13:16:25.991870758Z"}
{"id":"dh-1yg","title":"Add Effect Schedule for polling intervals","description":"## Overview\n**This bead is superseded by dh-9me (Migrate heatingProvider.ts to Effect Streams).**\n\nThe original scope was to add Effect Schedule for polling, but investigation revealed:\n\n1. The file path was wrong - heatingProvider.ts is in `deep-heating-home-assistant`, not `deep-heating-rx`\n2. The polling happens in `getEntityUpdates` in `home-assistant-api.ts` using RxJS `timer()`\n3. Properly replacing RxJS timer with Effect Schedule requires Effect Stream ↔ RxJS adapters\n4. The adapters require RxJS 7.x for clean AsyncIterable interop\n\n## Correct Migration Path\n1. **dh-apg**: Upgrade RxJS 6.x → 7.x (enables AsyncIterable)\n2. **dh-597**: Create Effect Stream ↔ RxJS Observable adapters\n3. **dh-9me**: Migrate heatingProvider.ts to Effect Streams (includes Schedule)\n\n## Remaining Value\nOnce dh-9me is complete, this bead can track adding exponential backoff retry logic to the Effect-based polling. For now, marking as blocked by the migration path.\n\n## Files Actually Affected\n- packages/deep-heating-home-assistant/src/lib/home-assistant-api.ts (getEntityUpdates)\n- packages/deep-heating-home-assistant/src/lib/climate/heatingProvider.ts (debounceTime)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T11:40:52.026904Z","updated_at":"2025-12-12T18:21:16.645522Z","closed_at":"2025-12-12T18:21:16.645522Z","dependencies":[{"issue_id":"dh-1yg","depends_on_id":"dh-n86","type":"blocks","created_at":"2025-11-30T11:41:15.118665Z","created_by":"daemon"},{"issue_id":"dh-1yg","depends_on_id":"dh-9me","type":"blocks","created_at":"2025-11-30T13:19:15.847858Z","created_by":"daemon"}]}
{"id":"dh-1z5","title":"Replace Node util.isDeepStrictEqual with Effect Equal","description":"Migrate rxx package from Node's isDeepStrictEqual to Effect Equal.\n\nFiles to migrate:\n- packages/rxx/src/lib/rxx.ts\n- packages/deep-heating-socketio/src/app/socket-server.ts\n\nEffect Equal capabilities:\n- Equal.equals for structural equality\n- Hash module for efficient hashing\n- Integrates with Effect data types\n\nThis removes the Node util dependency and keeps equality checking consistent with Effect patterns.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-11-30T11:57:57.860167Z","updated_at":"2025-11-30T12:48:22.420038Z","closed_at":"2025-11-30T12:48:22.420038Z"}
{"id":"dh-20r","title":"Convert .eslintrc.json to eslint.config.mjs","description":"## Task\nMigrate from legacy ESLint config format to flat config.\n\n## Changes\n- Delete .eslintrc.json files\n- Create eslint.config.mjs at root\n- Migrate all rules and plugin configurations\n- Update any package-specific ESLint configs\n\n## Structure\nThe new config should have layered configuration:\n1. Base TypeScript rules\n2. Prettier compatibility\n3. Functional programming rules (non-test files)\n4. Test-specific rules\n\n## Reference\nSee automatarr/eslint.config.mjs for target structure","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:01.97891588Z","updated_at":"2026-01-02T14:31:00.044097147Z","closed_at":"2025-11-29T16:11:34.246591Z","dependencies":[{"issue_id":"dh-20r","depends_on_id":"dh-hkk","type":"blocks","created_at":"2025-11-25T07:14:06.668370682Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-27o","title":"Add GitHub Releases to release workflow","description":"Currently the release workflow creates git tags via changesets but doesn't create actual GitHub Releases with release notes.\n\n**Current state:**\n- release.yml uses changesets/action to version and tag\n- Docker images are built and pushed\n- No GitHub Release is created\n\n**Desired state:**\n- Create GitHub Release when version is published\n- Include aggregated changelog from changesets\n- Link to Docker images in release notes\n\n**Implementation options:**\n1. Enable changesets action's built-in release creation (may need config)\n2. Add separate step using softprops/action-gh-release\n3. Use gh CLI to create release\n\n**Acceptance criteria:**\n- [ ] GitHub Release created for each version\n- [ ] Release notes contain changelog from merged changesets\n- [ ] Docker image links included in release body","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:54:48.912168Z","updated_at":"2025-11-29T10:05:26.230783Z","closed_at":"2025-11-29T10:05:26.230783Z"}
{"id":"dh-27t","title":"Add smoke test for CI","description":"Add a smoke test for CI that verifies the Docker image works end-to-end.\n\n## Implementation\n- Bun test using testcontainers at `packages/deep-heating/smoke-test.test.ts`\n- Verifies frontend serves (GET / returns 200)\n- Verifies WebSocket connects through nginx (/ws)\n- Runs in docker.yml workflow after build, before push\n- Image name passed via SMOKE_TEST_IMAGE env var\n\n## Context\nBeta 0.1.3-beta.0 has a bug where /ws returns 404 - nginx isn't proxying WebSocket traffic to the backend. This test would have caught it before release.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-02T18:00:04.11985Z","updated_at":"2025-12-02T19:29:43.492348Z","closed_at":"2025-12-02T19:29:43.492352Z"}
{"id":"dh-28y","title":"Phase 2a: Migrate SocketServer to Effect Platform","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-11-30T14:06:26.93284Z","updated_at":"2025-11-30T15:36:01.944259Z","closed_at":"2025-11-30T15:36:01.944259Z","dependencies":[{"issue_id":"dh-28y","depends_on_id":"dh-udp","type":"blocks","created_at":"2025-11-30T14:07:50.626432Z","created_by":"daemon"}]}
{"id":"dh-2cr","title":"Add init: false for s6 custom init system","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-30T17:55:40.616325Z","updated_at":"2025-11-30T17:56:05.229314Z","closed_at":"2025-11-30T17:56:05.229314Z"}
{"id":"dh-2ew","title":"Phase 2: Migrate to Svelte 5 + vite-plugin-svelte 6","description":"Migrate from Svelte 4 to Svelte 5 and update vite-plugin-svelte to v6.\n\n## Updates\n- svelte: 4.2.20 → 5.x\n- @sveltejs/vite-plugin-svelte: 5.x → 6.x\n\n## Breaking changes in Svelte 5\n- Runes replace reactive statements\n- Components are no longer classes\n- Event handlers use onclick instead of on:click\n- Snippets replace slots\n\n## Migration approach\n1. Read Svelte 5 migration guide\n2. Run svelte-migrate to auto-fix what it can\n3. Manually update any remaining incompatibilities\n4. Update vite-plugin-svelte to v6\n5. Test thoroughly","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-01T17:27:02.91995Z","updated_at":"2025-12-01T17:46:22.547494Z","closed_at":"2025-12-01T17:46:22.547494Z","dependencies":[{"issue_id":"dh-2ew","depends_on_id":"dh-lul","type":"blocks","created_at":"2025-12-01T17:27:08.435858Z","created_by":"daemon"}]}
{"id":"dh-2ko","title":"Configure Renovate: 5-day minimum release age and bun config","description":"Configure Renovate to ignore packages updated less than 5 days ago (minimumReleaseAge). Also ensure bun package manager is configured the same way.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-11-29T11:34:01.655731Z","updated_at":"2025-11-29T11:34:05.093833Z","closed_at":"2025-11-29T11:34:05.093833Z"}
{"id":"dh-2mm","title":"Add Effect.withSpan for observability","description":"## Overview\nAdd structured tracing/telemetry using Effect.withSpan for better debugging and monitoring.\n\n## Current State\n- Basic Effect.log usage exists\n- No structured spans or traces\n- Difficult to trace request flow through the system\n\n## Target State\n- Add Effect.withSpan to key operations\n- Include relevant attributes (entity IDs, temperatures, etc.)\n- Enable tracing of request flow through Effect chains\n\n## Files to Change\n- packages/deep-heating-home-assistant/src/lib/home-assistant-api.ts\n- packages/deep-heating-rx/src/lib/heatingProvider.ts\n\n## Reference\nSee automatarr's Effect.withSpan('operation-name', { attributes: { key: value } }) pattern","status":"closed","priority":3,"issue_type":"task","created_at":"2025-11-30T11:41:04.385103Z","updated_at":"2025-12-12T18:19:47.235932Z","closed_at":"2025-12-12T18:19:47.235932Z"}
{"id":"dh-2nz","title":"Search repo for remaining Jest/Babel/Vitest references","description":"## Task\nThoroughly search the entire repo for remaining references to legacy testing/build tools that should be removed.\n\n## Findings\n\n### .babelrc files (Nx legacy) - FOUND\nThese files exist and contain `@nx/js/babel` preset:\n- `packages/dictionary/.babelrc`\n- `packages/rxx/.babelrc`\n- `packages/deep-heating-state/.babelrc`\n- `packages/deep-heating-types/.babelrc`\n\n### jest.config.* files - NONE FOUND\nNo jest.config files in our packages (only in node_modules from dependencies).\n\n### vitest.config.* files - NONE FOUND\n\n### References to jest in tsconfig files - FOUND\nMany tsconfig files reference jest:\n\n**tsconfig.lib.json files** (exclude jest.config.ts):\n- `packages/deep-heating-types/tsconfig.lib.json`\n- `packages/rxx/tsconfig.lib.json`\n- `packages/deep-heating-socketio/tsconfig.app.json`\n- `packages/deep-heating/tsconfig.app.json`\n- `packages/deep-heating-home-assistant/tsconfig.lib.json`\n- `packages/dictionary/tsconfig.lib.json`\n- `packages/deep-heating-state/tsconfig.lib.json`\n\n**tsconfig.spec.json files** (types: [\"jest\", \"node\"]):\n- `packages/deep-heating-types/tsconfig.spec.json`\n- `packages/deep-heating-socketio/tsconfig.spec.json`\n- `packages/rxx/tsconfig.spec.json`\n- `packages/deep-heating-state/tsconfig.spec.json`\n- `packages/dictionary/tsconfig.spec.json`\n- `packages/deep-heating-web/tsconfig.spec.json`\n\n### \"node\" types in tsconfig - FOUND (also legacy)\n**tsconfig.lib.json / tsconfig.app.json files** with `\"types\": [\"node\"]`:\n- `packages/deep-heating-rx/tsconfig.lib.json`\n- `packages/deep-heating-socketio/tsconfig.app.json`\n- `packages/deep-heating-types/tsconfig.lib.json`\n- `packages/rxx/tsconfig.lib.json`\n- `packages/deep-heating/tsconfig.app.json`\n- `packages/dictionary/tsconfig.lib.json`\n- `packages/deep-heating-state/tsconfig.lib.json`\n- `packages/deep-heating-home-assistant/tsconfig.lib.json`\n\n### @types/jest in package.json - NONE FOUND\n\n### ts-jest, babel-jest dependencies - NONE FOUND\n\n### jest.fn(), jest.spyOn() patterns - NONE FOUND\n\n### Vitest imports - NONE FOUND\n\n### @nx/js/babel preset references - FOUND (in .babelrc files listed above)\n\n### Nx package.json dependencies - NONE FOUND\n\n## Summary\n\nFiles to **remove entirely**:\n- 4 × `.babelrc` files (packages: dictionary, rxx, deep-heating-state, deep-heating-types)\n\nFiles to **update**:\n- 7 × `tsconfig.lib.json`/`tsconfig.app.json` files:\n  - Remove jest.config.ts from exclude (where present)\n  - Remove `\"types\": [\"node\"]` or set to empty array\n- 6 × `tsconfig.spec.json` files:\n  - Remove \"jest\" and \"node\" from types array (should use bun types or empty)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T11:06:10.454971Z","updated_at":"2025-11-30T11:08:51.329821Z","closed_at":"2025-11-30T11:08:51.329821Z"}
{"id":"dh-2o9","title":"Add eslint-plugin-functional for immutability rules","description":"## Task\nAdd and configure eslint-plugin-functional to enforce immutable programming patterns.\n\n## Installation\n`bun add -D eslint-plugin-functional`\n\n## Configuration\nAdd to eslint.config.mjs with rules like:\n- no-let (prefer const)\n- immutable-data (no mutations)\n- no-loop-statements (prefer map/filter/reduce)\n- functional-parameters (no rest params in certain contexts)\n\n## Scope\nApply to source files only, not test files (tests may need mutations for setup)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:02.102854144Z","updated_at":"2026-01-02T14:31:00.045303429Z","closed_at":"2025-11-29T16:28:07.195541Z","dependencies":[{"issue_id":"dh-2o9","depends_on_id":"dh-20r","type":"blocks","created_at":"2025-11-25T07:14:06.682565579Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-2p9","title":"Track pending TRV actions until confirmed by HA poll","description":"Current flow when an action is sent:\n1. Action sent to HA via heatingProvider.trvActions subject\n2. Immediately publishes 'Synthesised' TrvControlState assuming success\n3. getTrvActions compares desired vs current - sees they match, no new action\n\nProblem: If the HA call actually failed (silently logged), the system thinks the TRV is at the right temp. The next poll shows the real state, but determineAction() sees no difference from what was already 'synthesised'.\n\nFix: Track actions as 'pending' with a timestamp. On next HA poll:\n- If TRV state matches pending action: confirm and clear\n- If TRV state differs after timeout: re-queue the action\n- Consider adding a 'stale action' detector for long-pending actions","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-06T08:02:00.694967Z","updated_at":"2025-12-06T08:03:39.40493Z","dependencies":[{"issue_id":"dh-2p9","depends_on_id":"dh-7sjo","type":"parent-child","created_at":"2025-12-29T16:53:56.91942Z","created_by":"daemon"}]}
{"id":"dh-2tj3","title":"RoomDecisionActor: Add TRV mode change commands (auto→heat)","description":"The TS can change TRV mode from auto to heat when needed. The Gleam RoomDecisionActor only has SetTrvTarget command.\n\nNeed to add:\n1. SetTrvMode command type\n2. Logic to detect when mode change is needed\n3. Send mode change commands when auto mode detected\n\nSee: trvActions.test.ts - 'returns Either.right(action) when mode needs to change from auto to heat'","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:44:47.662614374Z","created_by":"graeme","updated_at":"2026-01-04T10:29:50.690160566Z","closed_at":"2026-01-04T10:29:50.690160566Z","close_reason":"Closed"}
{"id":"dh-2to","title":"Remove remaining Nx references from codebase","description":"## Background\nWe've migrated to Turborepo but Nx remnants keep appearing. This is the THIRD attempt to fully remove it.\n\n## Task\nFind and remove ALL remaining Nx references including:\n- Config files (nx.json, project.json, etc.)\n- Package.json references (nx packages, nx scripts)\n- Import statements\n- Comments mentioning nx\n- Any other traces\n\n## Acceptance Criteria\n- `grep -r 'nx' --include='*.json' --include='*.ts' --include='*.js'` returns no Nx-related matches\n- No nx packages in any package.json\n- Build and tests still pass after removal","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T18:45:31.800532Z","updated_at":"2025-11-30T18:50:07.339394Z","closed_at":"2025-11-30T18:50:07.339394Z"}
{"id":"dh-33jq","title":"Epic: Port Deep Heating to Gleam with actor-based architecture","description":"## Overview\n\nPort the Deep Heating application from TypeScript/RxJS to Gleam with an actor-based architecture running on the BEAM (Erlang runtime).\n\n## Motivation\n\n- RxJS streams are hard to reason about (subscription management, hot/cold observables, shareReplay hacks)\n- Actor model provides simpler mental model: explicit state, message passing, supervision trees\n- Gleam's type safety and functional purity align with our goals\n- BEAM gives us fault tolerance, hot code reloading, and millions of lightweight processes\n\n## Architecture\n\n- **Backend**: Gleam on Erlang/OTP with actor supervision tree\n- **Frontend**: Lustre (Gleam's web framework) with server components\n- **Integration**: Home Assistant REST API via Gleam HTTP client\n\n## TypeScript Reference (for porting)\n\nThe original TypeScript implementation is in the **main worktree**:\n- **Path**: /home/graeme/Development/home-automation\n- **Key packages**:\n  - `packages/deep-heating-types` - Core TypeScript interfaces\n  - `packages/deep-heating-rx` - RxJS reactive streams for heating logic\n  - `packages/deep-heating-state` - State management\n  - `packages/deep-heating-home-assistant` - HA WebSocket API client\n\nUse `git worktree list` to see all worktrees.\n\n## Key Documents\n\n- `docs/gleam-actor-architecture.md` - Actor system design\n- `docs/gleam-lustre-ui-sketch.md` - UI component design\n\n## Success Criteria\n\n- [ ] All current functionality preserved\n- [ ] Tests passing\n- [ ] Docker image builds and runs as HA addon\n- [ ] Same or better performance","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-02T14:31:15.414668386Z","created_by":"graeme","updated_at":"2026-01-04T09:50:32.532385863Z"}
{"id":"dh-33jq.1","title":"Add Gleam toolchain to Nix flake","description":"Add Gleam toolchain to the Nix flake devShell.\n\n## Requirements\n- Add `pkgs.gleam` to devShell buildInputs\n- Add `pkgs.erlang` (OTP 26+) for BEAM runtime\n- Add `pkgs.rebar3` for Erlang build tool (Gleam dependency)\n- Verify versions work together\n\n## Acceptance Criteria\n- [ ] `nix develop` provides `gleam --version` command\n- [ ] `gleam new test_project` creates a valid project\n- [ ] `gleam build` compiles to BEAM (.beam files)\n- [ ] `gleam test` runs successfully\n\n## Reference\nSee automatarr repo for similar Nix+Gleam setup patterns.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:32:32.919822309Z","created_by":"graeme","updated_at":"2026-01-02T15:27:51.349360511Z","closed_at":"2026-01-02T15:27:51.349360511Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-33jq.1","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:32:32.926930312Z","created_by":"graeme"}]}
{"id":"dh-33jq.10","title":"Implement TrvActor","description":"Implement TrvActor - holds state for a single TRV.\n\n## Responsibilities\n- Store current TRV state (temperature, target, mode, isHeating)\n- Receive updates from HaPollerActor\n- Notify parent RoomActor when state changes\n- Forward SetTarget/SetMode commands to HaCommandActor\n\n## Message Types\n```gleam\npub type TrvMsg {\n  // From HA Poller\n  Update(TrvUpdate)\n  \n  // Commands (from RoomDecisionActor)\n  SetTarget(Temperature)\n  SetMode(HvacMode)\n  \n  // Queries\n  GetState(reply_to: Subject(TrvState))\n}\n```\n\n## State\n```gleam\npub type TrvState {\n  TrvState(\n    entity_id: ClimateEntityId,\n    temperature: Option(Temperature),\n    target: Option(Temperature),\n    mode: HvacMode,\n    is_heating: Bool,\n  )\n}\n```\n\n## Implementation Pattern\n```gleam\npub fn start(\n  entity_id: ClimateEntityId,\n  room_actor: Subject(RoomMsg),\n  ha_commands: Subject(HaCommand),\n) -\u003e Result(Subject(TrvMsg), StartError) {\n  actor.start(initial_state, handle_message)\n}\n```\n\n## Acceptance Criteria\n- [ ] Actor starts with entity_id\n- [ ] Updates state on TrvUpdate message\n- [ ] Notifies room actor on temperature/target changes\n- [ ] Forwards commands to HA command actor\n- [ ] Responds to GetState queries","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:14.738939694Z","created_by":"graeme","updated_at":"2026-01-03T09:52:17.679018682Z","closed_at":"2026-01-03T09:52:17.679018682Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-33jq.10","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:14.739914864Z","created_by":"graeme"},{"issue_id":"dh-33jq.10","depends_on_id":"dh-33jq.9","type":"blocks","created_at":"2026-01-02T14:35:10.726219519Z","created_by":"graeme"}]}
{"id":"dh-33jq.11","title":"Implement RoomActor","description":"Implement RoomActor - aggregates state for a room.\n\n## Responsibilities\n- Aggregate TRV states for the room\n- Track external temperature sensor reading\n- Apply house mode and user adjustments\n- Compute room target temperature\n- Notify RoomDecisionActor and StateAggregator on changes\n\n## Message Types\n```gleam\npub type RoomMsg {\n  // From child TrvActors\n  TrvTemperatureChanged(TrvEntityId, Temperature)\n  TrvTargetChanged(TrvEntityId, Temperature)\n  TrvModeChanged(TrvEntityId, HvacMode)\n  TrvHeatingChanged(TrvEntityId, Bool)\n  \n  // From HaPollerActor (external sensor)\n  ExternalTempChanged(Temperature)\n  \n  // From HouseModeActor\n  HouseModeChanged(HouseMode)\n  \n  // From WebSocket client\n  AdjustmentChanged(Float)\n  \n  // Queries\n  GetState(reply_to: Subject(RoomState))\n}\n```\n\n## Core Logic - Target Temperature Calculation\n```gleam\nfn recompute_target(state: RoomState) -\u003e RoomState {\n  let scheduled = get_scheduled_temp(state.schedule, now())\n  let target = case state.house_mode {\n    Sleeping -\u003e min_room_temp\n    Off -\u003e min_trv_temp\n    Auto -\u003e clamp(scheduled +. state.adjustment, min_room_temp, max_room_temp)\n  }\n  RoomState(..state, target_temperature: Some(target))\n}\n```\n\n## Acceptance Criteria\n- [ ] Aggregates state from multiple TRVs\n- [ ] Tracks external sensor temperature\n- [ ] Applies house mode correctly\n- [ ] Clamps adjustments to valid range (-3 to +3)\n- [ ] Notifies decision actor on state changes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:14.755410053Z","created_by":"graeme","updated_at":"2026-01-03T10:15:58.123545929Z","closed_at":"2026-01-03T10:15:58.123545929Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-33jq.11","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:14.756394043Z","created_by":"graeme"},{"issue_id":"dh-33jq.11","depends_on_id":"dh-33jq.10","type":"blocks","created_at":"2026-01-02T14:35:10.740076512Z","created_by":"graeme"}]}
{"id":"dh-33jq.12","title":"Implement RoomDecisionActor","description":"Implement RoomDecisionActor - decides TRV setpoints.\n\n## Responsibilities\n- Receive room state and TRV states\n- Decide what each TRV's target should be\n- Send SetTarget commands to TrvActors\n- Implement the \"smart\" heating logic\n\n## Core Logic\nThe decision logic compensates for the difference between room temperature\nand TRV temperature by adjusting TRV targets:\n\n```gleam\nfn compute_desired_trv_target(\n  room_target: Temperature,\n  room_temp: Option(Temperature),\n  trv_temp: Temperature,\n) -\u003e Temperature {\n  case room_temp {\n    None -\u003e room_target  // No room sensor, use target directly\n    Some(actual) -\u003e {\n      let diff = unwrap(room_target) -. unwrap(actual)\n      case diff {\n        d if d \u003e. 0.5 -\u003e // Room is cold, push TRV higher\n          temperature(unwrap(room_target) +. 2.0)\n        d if d \u003c. -0.5 -\u003e // Room is hot, back off TRV\n          temperature(unwrap(room_target) -. 1.0)\n        _ -\u003e room_target  // Room at target\n      }\n    }\n  }\n}\n```\n\n## Source Reference\n- `packages/deep-heating-rx/src/lib/trvDesiredTargetTemperatures.ts`\n\n## Acceptance Criteria\n- [ ] Evaluates on room state changes\n- [ ] Evaluates on TRV state changes\n- [ ] Only sends SetTarget when target actually differs\n- [ ] Compensates for room/TRV temperature difference\n- [ ] Handles rooms with multiple TRVs","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:14.771309786Z","created_by":"graeme","updated_at":"2026-01-03T10:39:40.477337069Z","closed_at":"2026-01-03T10:39:40.477337069Z","close_reason":"Implemented with TDD: compensation logic, deduplication, multi-TRV support","dependencies":[{"issue_id":"dh-33jq.12","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:14.772364817Z","created_by":"graeme"},{"issue_id":"dh-33jq.12","depends_on_id":"dh-33jq.11","type":"blocks","created_at":"2026-01-02T14:35:10.753365599Z","created_by":"graeme"}]}
{"id":"dh-33jq.13","title":"Implement HouseModeActor","description":"Implement HouseModeActor - tracks house-wide mode.\n\n## Responsibilities\n- Track current house mode (Auto/Sleeping)\n- Listen for sleep button press from HA\n- Broadcast mode changes to all RoomActors\n- Handle wake-up (return to Auto)\n\n## Message Types\n```gleam\npub type HouseModeMsg {\n  SleepButtonPressed\n  WakeUp\n  GetMode(reply_to: Subject(HouseMode))\n}\n```\n\n## Behavior\n- On SleepButtonPressed: transition to Sleeping, broadcast to all rooms\n- On WakeUp: transition to Auto, broadcast to all rooms\n- Wake-up trigger: first scheduled temperature change after sleeping\n\n## Source Reference\n- `packages/deep-heating-rx/src/lib/houseModes.ts`\n\n## Acceptance Criteria\n- [ ] Starts in Auto mode\n- [ ] Transitions to Sleeping on button press\n- [ ] Broadcasts to all registered room actors\n- [ ] Responds to GetMode queries\n- [ ] Handles wake-up transition","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:14.786780794Z","created_by":"graeme","updated_at":"2026-01-03T11:10:11.981180224Z","closed_at":"2026-01-03T11:10:11.981180224Z","close_reason":"Implemented with TDD: start_link for testing, RegisterRoomActor message, and broadcasting to all registered room actors on mode change","dependencies":[{"issue_id":"dh-33jq.13","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:14.787944556Z","created_by":"graeme"},{"issue_id":"dh-33jq.13","depends_on_id":"dh-33jq.9","type":"blocks","created_at":"2026-01-02T14:35:10.76704578Z","created_by":"graeme"}]}
{"id":"dh-33jq.14","title":"Implement StateAggregatorActor","description":"Implement StateAggregatorActor - collects state for UI.\n\n## Responsibilities\n- Receive state updates from all RoomActors\n- Maintain complete DeepHeatingState\n- Throttle updates (don't spam UI)\n- Broadcast state to WebSocket clients\n\n## Message Types\n```gleam\npub type AggregatorMsg {\n  RoomUpdated(room_name: String, RoomState)\n  HeatingStatusChanged(Bool)\n  Subscribe(Subject(DeepHeatingState))\n  Unsubscribe(Subject(DeepHeatingState))\n}\n```\n\n## Throttling\nState updates should be throttled to ~100ms to avoid overwhelming clients:\n\n```gleam\n// On state change, schedule broadcast if not already pending\nfn schedule_broadcast(state: AggregatorState) -\u003e AggregatorState {\n  case state.broadcast_pending {\n    True -\u003e state\n    False -\u003e {\n      process.send_after(self(), Broadcast, 100)\n      AggregatorState(..state, broadcast_pending: True)\n    }\n  }\n}\n```\n\n## Source Reference\n- `packages/deep-heating-state/src/lib/roomState.ts`\n\n## Acceptance Criteria\n- [ ] Aggregates state from all rooms\n- [ ] Maintains subscriber list\n- [ ] Throttles broadcasts to 100ms\n- [ ] Handles subscribe/unsubscribe\n- [ ] Broadcasts complete DeepHeatingState","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:14.80293458Z","created_by":"graeme","updated_at":"2026-01-03T11:13:35.870087405Z","closed_at":"2026-01-03T11:13:35.870087405Z","close_reason":"Implemented with TDD: start_link for testing, RoomUpdated/Unsubscribe messages, 100ms throttled broadcasts using send_after","dependencies":[{"issue_id":"dh-33jq.14","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:14.803828099Z","created_by":"graeme"},{"issue_id":"dh-33jq.14","depends_on_id":"dh-33jq.11","type":"blocks","created_at":"2026-01-02T14:35:10.780473389Z","created_by":"graeme"}]}
{"id":"dh-33jq.15","title":"Port HA REST API client to Gleam","description":"Port Home Assistant REST API client to Gleam.\n\n## Source Reference\n- `packages/deep-heating-home-assistant/src/lib/home-assistant-api.ts`\n\n## API Endpoints Required\n```\nGET  /api/states                     - Get all entity states\nPOST /api/services/climate/set_temperature\nPOST /api/services/climate/set_hvac_mode\n```\n\n## Authentication\nBearer token in Authorization header:\n```\nAuthorization: Bearer \u003cSUPERVISOR_TOKEN\u003e\n```\n\n## Gleam Implementation\n```gleam\nimport gleam/http/request\nimport gleam/httpc\n\npub type HaClient {\n  HaClient(base_url: String, token: String)\n}\n\npub fn get_states(client: HaClient) -\u003e Result(List(EntityState), HaError)\n\npub fn set_temperature(\n  client: HaClient,\n  entity_id: ClimateEntityId,\n  temperature: Temperature,\n) -\u003e Result(Nil, HaError)\n\npub fn set_hvac_mode(\n  client: HaClient,\n  entity_id: ClimateEntityId,\n  mode: HvacMode,\n) -\u003e Result(Nil, HaError)\n```\n\n## Error Types\n```gleam\npub type HaError {\n  ConnectionError(String)\n  AuthenticationError\n  EntityNotFound(String)\n  ApiError(status: Int, body: String)\n}\n```\n\n## Acceptance Criteria\n- [ ] GET /api/states returns parsed entity list\n- [ ] set_temperature calls correct endpoint with JSON body\n- [ ] set_hvac_mode calls correct endpoint\n- [ ] Proper error handling for network/auth failures\n- [ ] Bearer token auth works correctly","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:14.818985954Z","created_by":"graeme","updated_at":"2026-01-03T09:09:17.609459464Z","closed_at":"2026-01-03T09:00:05.605843Z","dependencies":[{"issue_id":"dh-33jq.15","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:14.819931554Z","created_by":"graeme"},{"issue_id":"dh-33jq.15","depends_on_id":"dh-33jq.6","type":"blocks","created_at":"2026-01-02T14:35:10.793597854Z","created_by":"graeme"}]}
{"id":"dh-33jq.16","title":"Implement HaPollerActor","description":"Implement HaPollerActor - polls Home Assistant for state.\n\n## Responsibilities\n- Poll HA API every N seconds (configurable, default 5s)\n- Parse climate entities into TrvUpdate messages\n- Parse main heating entity into HeatingUpdate\n- Detect goodnight button/event for SleepButtonPressed\n- Dispatch updates to appropriate actors\n\n## Message Types\n```gleam\npub type HaPollerMsg {\n  Poll  // Triggered by timer\n  Configure(interval_ms: Int)\n  Stop\n}\n```\n\n## Polling Logic\n```gleam\nfn handle_poll(state: PollerState) -\u003e actor.Next(PollerState) {\n  case ha_client.get_states(state.client) {\n    Ok(entities) -\u003e {\n      // Filter and dispatch TRV updates\n      entities\n      |\u003e list.filter(is_climate_entity)\n      |\u003e list.filter(has_schedule)  // Only TRVs we manage\n      |\u003e list.each(fn(e) {\n        let update = parse_trv_update(e)\n        process.send(get_trv_actor(e.entity_id), Update(update))\n      })\n      \n      // Check for sleep button\n      case find_goodnight_event(entities) {\n        Some(_) -\u003e process.send(state.house_mode_actor, SleepButtonPressed)\n        None -\u003e Nil\n      }\n      \n      // Schedule next poll\n      process.send_after(self(), Poll, state.interval_ms)\n      actor.continue(state)\n    }\n    Error(e) -\u003e {\n      // Log error, retry with backoff\n      actor.continue(state)\n    }\n  }\n}\n```\n\n## Source Reference\n- `packages/deep-heating-home-assistant/src/lib/climate.ts`\n\n## Acceptance Criteria\n- [ ] Polls at configured interval\n- [ ] Parses climate entities correctly\n- [ ] Dispatches TrvUpdate to correct TrvActor\n- [ ] Detects sleep button press\n- [ ] Handles API errors gracefully\n- [ ] Filters to only managed TRVs (those with schedules)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:14.834968268Z","created_by":"graeme","updated_at":"2026-01-03T12:44:17.259616814Z","closed_at":"2026-01-03T12:44:17.259616814Z","close_reason":"Base polling functionality complete - sleep button detection split to dh-scbb","dependencies":[{"issue_id":"dh-33jq.16","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:14.835865757Z","created_by":"graeme"},{"issue_id":"dh-33jq.16","depends_on_id":"dh-33jq.15","type":"blocks","created_at":"2026-01-02T14:35:10.807079723Z","created_by":"graeme"},{"issue_id":"dh-33jq.16","depends_on_id":"dh-33jq.9","type":"blocks","created_at":"2026-01-02T14:35:10.820915196Z","created_by":"graeme"}]}
{"id":"dh-33jq.17","title":"Implement HaCommandActor","description":"Implement HaCommandActor - sends commands to Home Assistant.\n\n## Responsibilities\n- Receive SetTrvTarget and SetTrvMode commands\n- Call HA API to execute commands\n- Handle rate limiting / batching if needed\n- Report errors back to callers\n\n## Message Types\n```gleam\npub type HaCommandMsg {\n  SetTrvTarget(entity_id: ClimateEntityId, target: Temperature)\n  SetTrvMode(entity_id: ClimateEntityId, mode: HvacMode)\n}\n```\n\n## Implementation\n```gleam\nfn handle_message(msg: HaCommandMsg, state: CommandState) {\n  case msg {\n    SetTrvTarget(entity_id, target) -\u003e {\n      case ha_client.set_temperature(state.client, entity_id, target) {\n        Ok(_) -\u003e actor.continue(state)\n        Error(e) -\u003e {\n          // Log error, maybe retry\n          actor.continue(state)\n        }\n      }\n    }\n    SetTrvMode(entity_id, mode) -\u003e {\n      case ha_client.set_hvac_mode(state.client, entity_id, mode) {\n        Ok(_) -\u003e actor.continue(state)\n        Error(e) -\u003e {\n          // Log error\n          actor.continue(state)\n        }\n      }\n    }\n  }\n}\n```\n\n## Considerations\n- May want to debounce rapid target changes\n- Should log all commands for debugging\n- Could batch multiple commands if HA supports it\n\n## Acceptance Criteria\n- [ ] Receives and processes SetTrvTarget\n- [ ] Receives and processes SetTrvMode\n- [ ] Calls HA API correctly\n- [ ] Handles API errors gracefully\n- [ ] Logs commands for debugging","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:14.850906351Z","created_by":"graeme","updated_at":"2026-01-03T12:18:34.699337085Z","closed_at":"2026-01-03T12:18:34.699337085Z","close_reason":"Implemented HaCommandActor with per-TRV debouncing, heating flat debounce, parallel API calls, and error logging","dependencies":[{"issue_id":"dh-33jq.17","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:14.851879881Z","created_by":"graeme"},{"issue_id":"dh-33jq.17","depends_on_id":"dh-33jq.15","type":"blocks","created_at":"2026-01-02T14:35:10.834552427Z","created_by":"graeme"},{"issue_id":"dh-33jq.17","depends_on_id":"dh-33jq.9","type":"blocks","created_at":"2026-01-02T14:35:10.848119977Z","created_by":"graeme"}]}
{"id":"dh-33jq.18","title":"Set up Lustre project structure","description":"Set up Lustre project structure for the UI.\n\n## Reference\nSee `docs/gleam-lustre-ui-sketch.md` for component design.\n\n## Dependencies (gleam.toml)\n\n```toml\n[dependencies]\nlustre = \"\u003e= 5.4.0 and \u003c 6.0.0\"  # v5.2+ required for testing modules\n\n[dev-dependencies]\nbirdie = \"\u003e= 1.2.0 and \u003c 2.0.0\"  # Snapshot testing\npprint = \"\u003e= 1.0.0 and \u003c 2.0.0\"  # Pretty-print for snapshots\n```\n\n## Directory Structure\n\n```\nsrc/ui/\n├── app.gleam              # Main Lustre application\n├── model.gleam            # Model type\n├── msg.gleam              # Msg type\n├── update.gleam           # Update function\n├── view.gleam             # Main view\n└── components/\n    ├── heating_badge.gleam\n    ├── room_card.gleam\n    └── room_controls.gleam\n\ntest/ui/\n├── model_test.gleam\n├── view_test.gleam\n└── components/\n    ├── heating_badge_test.gleam\n    ├── room_card_test.gleam\n    └── room_controls_test.gleam\n\nbirdie_snapshots/          # Committed to git\n├── heating_badge_*.accepted\n├── room_card_*.accepted\n└── ...\n```\n\n## Main Application Setup\n\n```gleam\nimport lustre\nimport ui/model\nimport ui/update\nimport ui/view\n\npub fn main() {\n  let app = lustre.application(model.init, update.update, view.view)\n  let assert Ok(_) = lustre.start(app, \"#app\", Nil)\n  Nil\n}\n```\n\n## Testing Infrastructure\n\n### Snapshot Testing with Birdie\n\n```gleam\n// test/ui/components/heating_badge_test.gleam\nimport birdie\nimport lustre/element\nimport ui/components/heating_badge.{Heating}\n\npub fn heating_badge_when_heating_test() {\n  heating_badge.view(Heating)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"heating_badge_when_heating\")\n}\n```\n\nRun `gleam run -m birdie` to review snapshots interactively.\n\n### Query Testing (lustre/dev/query)\n\n```gleam\nimport lustre/dev/query.{class, tag, test_id, find, has}\n\npub fn component_has_expected_structure_test() {\n  let view = my_component.view(...)\n  \n  // Assert element exists\n  let assert True = query.has(view, test_id(\"fire-icon\"))\n  \n  // Find and inspect element\n  let assert Ok(elem) = query.find(view, query.element(class(\"card\")))\n}\n```\n\n### Simulate Testing (lustre/dev/simulate)\n\n```gleam\nimport lustre/dev/simulate\n\npub fn user_interaction_updates_model_test() {\n  let app = simulate.simple(model.init, update.update, view.view)\n  \n  let sim = \n    simulate.start(app, Nil)\n    |\u003e simulate.click(query.element(test_id(\"button\")))\n  \n  let assert expected_value = simulate.model(sim).field\n}\n```\n\n## Test Data Helpers\n\nCreate `test/ui/test_helpers.gleam`:\n\n```gleam\nimport deep_heating/state.{type RoomState, RoomState}\nimport deep_heating/temperature\nimport gleam/option.{None, Some}\n\n/// Create a room in heating state for testing\npub fn heating_room() -\u003e RoomState {\n  RoomState(\n    name: \"Test Room\",\n    temperature: Some(state.TemperatureReading(\n      temperature: temperature.temperature(20.0),\n      time: 0,\n    )),\n    target_temperature: Some(temperature.temperature(22.0)),\n    radiators: [],\n    mode: Some(mode.Auto),\n    is_heating: Some(True),\n    adjustment: 0.0,\n  )\n}\n\n/// Create a room in cooling state for testing\npub fn cooling_room() -\u003e RoomState {\n  RoomState(..heating_room(), is_heating: Some(False))\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Lustre \u003e= 5.4.0 dependency added and compiles\n- [ ] Birdie dev-dependency added\n- [ ] Directory structure created (src/ui/, test/ui/)\n- [ ] Basic app starts without errors\n- [ ] Can render \"Hello World\" in browser\n- [ ] `gleam test` runs successfully\n- [ ] `gleam run -m birdie` launches snapshot reviewer\n- [ ] test_helpers.gleam provides reusable test fixtures","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:33.622400569Z","created_by":"graeme","updated_at":"2026-01-04T11:09:01.951516097Z","closed_at":"2026-01-04T11:09:01.951516097Z","close_reason":"Set up Lustre 5.4.0 with birdie snapshot testing. All acceptance criteria met: UI module structure created, tests passing, birdie working.","dependencies":[{"issue_id":"dh-33jq.18","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:33.629093768Z","created_by":"graeme"},{"issue_id":"dh-33jq.18","depends_on_id":"dh-33jq.3","type":"blocks","created_at":"2026-01-02T14:36:38.169001006Z","created_by":"graeme"}]}
{"id":"dh-33jq.19","title":"Implement Lustre Model and Msg types","description":"Define Model (connected, state) and Msg (Connected, Disconnected, StateReceived, AdjustRoom) types.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:33.647132123Z","created_by":"graeme","updated_at":"2026-01-04T11:15:06.326308466Z","closed_at":"2026-01-04T11:15:06.326308466Z","close_reason":"Already implemented during Lustre project setup (dh-33jq.18)","dependencies":[{"issue_id":"dh-33jq.19","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:33.648116073Z","created_by":"graeme"},{"issue_id":"dh-33jq.19","depends_on_id":"dh-33jq.18","type":"blocks","created_at":"2026-01-02T14:36:38.185033963Z","created_by":"graeme"},{"issue_id":"dh-33jq.19","depends_on_id":"dh-33jq.6","type":"blocks","created_at":"2026-01-02T14:36:38.198736095Z","created_by":"graeme"}]}
{"id":"dh-33jq.2","title":"Create Gleam project structure","description":"Create the Gleam project structure for deep_heating.\n\n## Requirements\n- Run `gleam new deep_heating` in packages/ directory\n- Configure gleam.toml for OTP application\n- Set up src/ directory structure matching actor architecture\n- Add to turbo.json if needed for build orchestration\n\n## Directory Structure\n```\npackages/deep_heating/\n├── gleam.toml\n├── src/\n│   ├── deep_heating.gleam       # Main entry, starts supervision tree\n│   ├── types/                   # Domain types\n│   ├── actors/                  # Actor implementations\n│   ├── home_assistant/          # HA integration\n│   └── ui/                      # Lustre components\n└── test/\n```\n\n## Acceptance Criteria\n- [ ] `gleam build` succeeds with no errors\n- [ ] `gleam test` runs (even if no tests yet)\n- [ ] Project structure matches architecture docs","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:32:32.943624712Z","created_by":"graeme","updated_at":"2026-01-02T15:37:28.065803643Z","closed_at":"2026-01-02T15:37:28.065803643Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-33jq.2","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:32:32.944730084Z","created_by":"graeme"},{"issue_id":"dh-33jq.2","depends_on_id":"dh-33jq.1","type":"blocks","created_at":"2026-01-02T14:35:10.586566587Z","created_by":"graeme"}]}
{"id":"dh-33jq.20","title":"Implement Lustre update function","description":"Handle all Msg variants, update model state, trigger effects for WebSocket communication.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:33.663965465Z","created_by":"graeme","updated_at":"2026-01-04T11:22:42.544647878Z","closed_at":"2026-01-04T11:22:42.544647878Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-33jq.20","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:33.664971166Z","created_by":"graeme"},{"issue_id":"dh-33jq.20","depends_on_id":"dh-33jq.19","type":"blocks","created_at":"2026-01-02T14:36:38.21180119Z","created_by":"graeme"}]}
{"id":"dh-33jq.21","title":"Implement heating badge component","description":"## Overview\n\nImplement the heating status badge component that displays whether the heating system is currently active across the house.\n\n## TypeScript Reference\n\nFrom `/home/graeme/Development/home-automation/packages/deep-heating-web/src/lib/components/Heating.svelte`:\n```svelte\n{#if isHeating !== undefined}\n  \u003cdiv\n    class=\"badge\"\n    class:bg-heating={isHeating}\n    class:bg-cooling={!isHeating}\n    style=\"color: white\"\n  \u003e\n    {isHeating ? 'Heating' : 'Cooling'}\n  \u003c/div\u003e\n{/if}\n```\n\nColors: heating=#FF9700 (orange), cooling=#77DAE8 (cyan)\n\n## Implementation\n\nCreate `src/ui/components/heating_badge.gleam`:\n\n```gleam\nimport gleam/option.{type Option, None, Some}\nimport lustre/attribute.{class, style, attribute}\nimport lustre/element.{type Element, text}\nimport lustre/element/html.{div}\n\n/// Heating status for the badge\npub type HeatingStatus {\n  Heating\n  Cooling\n  Unknown\n}\n\n/// Convert from Option(Bool) to HeatingStatus\npub fn from_option(is_heating: Option(Bool)) -\u003e HeatingStatus {\n  case is_heating {\n    Some(True) -\u003e Heating\n    Some(False) -\u003e Cooling\n    None -\u003e Unknown\n  }\n}\n\n/// Render the heating status badge\npub fn view(status: HeatingStatus) -\u003e Element(msg) {\n  case status {\n    Unknown -\u003e element.none()\n    Heating -\u003e badge(\"Heating\", \"#FF9700\", \"heating-badge\")\n    Cooling -\u003e badge(\"Cooling\", \"#77DAE8\", \"cooling-badge\")\n  }\n}\n\n/// Convenience: render from Option(Bool) directly\npub fn view_from_option(is_heating: Option(Bool)) -\u003e Element(msg) {\n  view(from_option(is_heating))\n}\n\nfn badge(label: String, bg_color: String, test_id: String) -\u003e Element(msg) {\n  div(\n    [\n      class(\"badge\"),\n      style([#(\"background-color\", bg_color), #(\"color\", \"white\")]),\n      attribute(\"data-testid\", test_id),\n    ],\n    [text(label)],\n  )\n}\n```\n\n## Testing\n\n### Snapshot Tests\n\nCreate `test/ui/components/heating_badge_test.gleam`:\n\n```gleam\nimport birdie\nimport lustre/element\nimport ui/components/heating_badge.{Heating, Cooling, Unknown}\nimport gleam/option.{None, Some}\n\npub fn badge_when_heating_test() {\n  heating_badge.view(Heating)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"heating_badge_heating\")\n}\n\npub fn badge_when_cooling_test() {\n  heating_badge.view(Cooling)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"heating_badge_cooling\")\n}\n\npub fn badge_when_unknown_test() {\n  heating_badge.view(Unknown)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"heating_badge_unknown\")\n}\n\npub fn badge_from_option_true_test() {\n  heating_badge.view_from_option(Some(True))\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"heating_badge_from_option_true\")\n}\n\npub fn badge_from_option_false_test() {\n  heating_badge.view_from_option(Some(False))\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"heating_badge_from_option_false\")\n}\n\npub fn badge_from_option_none_test() {\n  heating_badge.view_from_option(None)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"heating_badge_from_option_none\")\n}\n```\n\n### Query Tests\n\n```gleam\nimport lustre/dev/query\nimport ui/components/heating_badge.{Heating, Cooling, Unknown}\n\npub fn heating_badge_has_correct_test_id_test() {\n  let view = heating_badge.view(Heating)\n  let assert True = query.has(view, query.test_id(\"heating-badge\"))\n}\n\npub fn cooling_badge_has_correct_test_id_test() {\n  let view = heating_badge.view(Cooling)\n  let assert True = query.has(view, query.test_id(\"cooling-badge\"))\n}\n\npub fn unknown_renders_empty_test() {\n  let view = heating_badge.view(Unknown)\n  let assert \"\" = element.to_string(view)\n}\n\npub fn heating_badge_has_badge_class_test() {\n  let view = heating_badge.view(Heating)\n  let assert True = query.has(view, query.class(\"badge\"))\n}\n```\n\n### Unit Tests for from_option\n\n```gleam\nimport ui/components/heating_badge.{from_option, Heating, Cooling, Unknown}\nimport gleam/option.{None, Some}\n\npub fn from_option_true_returns_heating_test() {\n  let assert Heating = from_option(Some(True))\n}\n\npub fn from_option_false_returns_cooling_test() {\n  let assert Cooling = from_option(Some(False))\n}\n\npub fn from_option_none_returns_unknown_test() {\n  let assert Unknown = from_option(None)\n}\n```\n\n## Type Safety Considerations\n\n1. **HeatingStatus enum**: More expressive than `Option(Bool)`\n2. **from_option converter**: Type-safe bridge from model data\n3. **Polymorphic Element(msg)**: Badge doesn't emit messages\n\n## Acceptance Criteria\n\n- [ ] Badge shows \"Heating\" with orange background (#FF9700)\n- [ ] Badge shows \"Cooling\" with cyan background (#77DAE8)\n- [ ] Badge is hidden when status is unknown (None)\n- [ ] White text on both backgrounds\n- [ ] Uses DaisyUI `.badge` class\n- [ ] All status variants have data-testid attributes\n- [ ] Snapshot tests pass for all states\n- [ ] Query tests verify structure\n- [ ] Unit tests verify from_option conversion","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:33.680429234Z","created_by":"graeme","updated_at":"2026-01-04T11:53:57.874790481Z","closed_at":"2026-01-04T11:53:57.874790481Z","close_reason":"Implementation complete with DaisyUI semantic classes and snapshot tests","dependencies":[{"issue_id":"dh-33jq.21","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:33.681361734Z","created_by":"graeme"},{"issue_id":"dh-33jq.21","depends_on_id":"dh-33jq.18","type":"blocks","created_at":"2026-01-02T14:36:38.225642334Z","created_by":"graeme"}]}
{"id":"dh-33jq.22","title":"Implement room card component","description":"## Overview\n\nImplement the room card component that displays a single room's heating status, current temperature, and provides access to temperature controls.\n\n## TypeScript Reference\n\nThe room card shows: room name, fire icon when heating, current temperature, and controls (when target exists).\n\n## Implementation\n\nCreate `src/ui/components/room_card.gleam`:\n\n```gleam\nimport deep_heating/mode.{type RoomMode, Auto}\nimport deep_heating/state.{type RoomState, type TemperatureReading}\nimport deep_heating/temperature\nimport gleam/option.{type Option, None, Some}\nimport lustre/attribute.{class, style, attribute}\nimport lustre/element.{type Element, text}\nimport lustre/element/html.{div}\nimport ui/components/room_controls\nimport ui/icons\nimport ui/msg.{type Msg}\n\npub fn view(room: RoomState) -\u003e Element(Msg) {\n  let is_heating = is_room_heating(room)\n  \n  div(\n    [\n      class(\"card card-sm w-44 shadow-md \" \u003c\u003e background_class(is_heating)),\n      style([#(\"color\", \"white\")]),\n      attribute(\"data-testid\", \"room-card\"),\n      attribute(\"data-room-name\", room.name),\n    ],\n    [\n      div([class(\"card-body p-3\")], [\n        header(room.name, is_heating),\n        current_temperature(room.temperature),\n        controls_section(room),\n      ]),\n    ],\n  )\n}\n\nfn header(name: String, is_heating: Bool) -\u003e Element(Msg) {\n  div(\n    [class(\"card-title text-sm flex items-center gap-1\")],\n    [\n      text(name),\n      case is_heating {\n        True -\u003e icons.fire(icons.IconSmall)\n        False -\u003e element.none()\n      },\n    ],\n  )\n}\n\nfn current_temperature(reading: Option(TemperatureReading)) -\u003e Element(Msg) {\n  let display = case reading {\n    Some(r) -\u003e temperature.format(r.temperature)\n    None -\u003e \"–\"\n  }\n  \n  div(\n    [\n      class(\"stat-value text-right text-2xl\"),\n      attribute(\"data-testid\", \"current-temp\"),\n    ],\n    [text(display)],\n  )\n}\n\nfn controls_section(room: RoomState) -\u003e Element(Msg) {\n  case room.target_temperature {\n    Some(_) -\u003e room_controls.view(room)\n    None -\u003e element.none()\n  }\n}\n\nfn is_room_heating(room: RoomState) -\u003e Bool {\n  case room.is_heating {\n    Some(True) -\u003e True\n    _ -\u003e False\n  }\n}\n\nfn background_class(is_heating: Bool) -\u003e String {\n  case is_heating {\n    True -\u003e \"bg-heating\"\n    False -\u003e \"bg-cooling\"\n  }\n}\n```\n\n## Testing\n\n### Snapshot Tests\n\nCreate `test/ui/components/room_card_test.gleam`:\n\n```gleam\nimport birdie\nimport lustre/element\nimport ui/components/room_card\nimport test/ui/test_helpers.{heating_room, cooling_room, room_without_temp, room_without_target}\n\npub fn room_card_heating_test() {\n  room_card.view(heating_room())\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"room_card_heating\")\n}\n\npub fn room_card_cooling_test() {\n  room_card.view(cooling_room())\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"room_card_cooling\")\n}\n\npub fn room_card_no_temperature_test() {\n  room_card.view(room_without_temp())\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"room_card_no_temperature\")\n}\n\npub fn room_card_no_target_test() {\n  room_card.view(room_without_target())\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"room_card_no_target\")\n}\n\npub fn room_card_with_adjustment_test() {\n  room_card.view(test_helpers.room_with_adjustment(1.5))\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"room_card_with_adjustment\")\n}\n```\n\n### Query Tests\n\n```gleam\nimport lustre/dev/query\nimport ui/components/room_card\nimport test/ui/test_helpers.{heating_room, cooling_room, room_without_target}\n\npub fn room_card_has_test_id_test() {\n  let view = room_card.view(heating_room())\n  let assert True = query.has(view, query.test_id(\"room-card\"))\n}\n\npub fn heating_room_has_fire_icon_test() {\n  let view = room_card.view(heating_room())\n  let assert True = query.has(view, query.test_id(\"fire-icon\"))\n}\n\npub fn cooling_room_has_no_fire_icon_test() {\n  let view = room_card.view(cooling_room())\n  let assert False = query.has(view, query.test_id(\"fire-icon\"))\n}\n\npub fn room_card_shows_temperature_test() {\n  let view = room_card.view(heating_room())\n  let assert Ok(temp_elem) = query.find(view, query.element(query.test_id(\"current-temp\")))\n  let assert True = query.has(temp_elem, query.text(\"20.0°C\"))\n}\n\npub fn room_card_has_card_class_test() {\n  let view = room_card.view(heating_room())\n  let assert True = query.has(view, query.class(\"card\"))\n}\n\npub fn heating_room_has_heating_background_test() {\n  let view = room_card.view(heating_room())\n  let assert True = query.has(view, query.class(\"bg-heating\"))\n}\n\npub fn cooling_room_has_cooling_background_test() {\n  let view = room_card.view(cooling_room())\n  let assert True = query.has(view, query.class(\"bg-cooling\"))\n}\n\npub fn room_without_target_has_no_controls_test() {\n  let view = room_card.view(room_without_target())\n  let assert False = query.has(view, query.test_id(\"room-controls\"))\n}\n```\n\n## Type Safety Considerations\n\n1. **RoomState typed prop**: Fully typed record\n2. **Option handling**: Explicit pattern matching\n3. **Temperature formatting**: Uses typed temperature.format()\n4. **Message type**: Returns `Element(Msg)` for controls\n\n## Acceptance Criteria\n\n- [ ] Card displays room name in header\n- [ ] Fire icon appears when room is heating\n- [ ] Current temperature shown with 1 decimal + °C\n- [ ] \"–\" displayed when temperature is None\n- [ ] Background is orange when heating, cyan when cooling\n- [ ] Controls only rendered when target_temperature exists\n- [ ] Card has data-testid and data-room-name attributes\n- [ ] Snapshot tests pass for all room states\n- [ ] Query tests verify structure and conditional rendering","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:33.69662566Z","created_by":"graeme","updated_at":"2026-01-04T12:17:51.103562606Z","closed_at":"2026-01-04T12:17:51.103562606Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-33jq.22","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:33.697681431Z","created_by":"graeme"},{"issue_id":"dh-33jq.22","depends_on_id":"dh-33jq.19","type":"blocks","created_at":"2026-01-02T14:36:38.238969882Z","created_by":"graeme"},{"issue_id":"dh-33jq.22","depends_on_id":"dh-m18p","type":"blocks","created_at":"2026-01-04T10:47:26.123212844Z","created_by":"graeme"},{"issue_id":"dh-33jq.22","depends_on_id":"dh-mcpu","type":"blocks","created_at":"2026-01-04T10:47:26.278408072Z","created_by":"graeme"}]}
{"id":"dh-33jq.23","title":"Implement room controls component","description":"## Overview\n\nImplement the room controls component that allows users to adjust the target temperature. Shows target temperature with adjustment offset and provides +/- buttons for 0.5°C increments.\n\n## TypeScript Reference\n\nControls show: minus button, target temp with offset, plus button. Buttons only visible in Auto mode. Icons are solid when adjustment is active in that direction.\n\n## Implementation\n\nCreate `src/ui/components/room_controls.gleam`:\n\n```gleam\nimport deep_heating/mode.{type RoomMode, Auto}\nimport deep_heating/state.{type RoomState}\nimport deep_heating/temperature.{type Temperature}\nimport gleam/float\nimport gleam/option.{type Option, None, Some}\nimport lustre/attribute.{class, attribute}\nimport lustre/element.{type Element, text}\nimport lustre/element/html.{button, div, span}\nimport lustre/event\nimport ui/icons.{IconMedium}\nimport ui/msg.{type Msg, AdjustRoom}\n\nconst step: Float = 0.5\n\npub fn view(room: RoomState) -\u003e Element(Msg) {\n  let is_auto = is_auto_mode(room.mode)\n  \n  div(\n    [\n      class(\"card-actions text-xs flex items-center gap-0\"),\n      attribute(\"data-testid\", \"room-controls\"),\n    ],\n    [\n      case is_auto {\n        True -\u003e colder_button(room.name, room.adjustment)\n        False -\u003e element.none()\n      },\n      target_display(room.target_temperature, room.adjustment),\n      case is_auto {\n        True -\u003e warmer_button(room.name, room.adjustment)\n        False -\u003e element.none()\n      },\n    ],\n  )\n}\n\nfn colder_button(room_name: String, adjustment: Float) -\u003e Element(Msg) {\n  button(\n    [\n      class(\"btn btn-circle btn-ghost btn-sm\"),\n      attribute(\"data-testid\", \"colder-button\"),\n      event.on_click(AdjustRoom(room_name, adjustment -. step)),\n    ],\n    [icons.minus_icon(adjustment \u003c. 0.0, IconMedium)],\n  )\n}\n\nfn warmer_button(room_name: String, adjustment: Float) -\u003e Element(Msg) {\n  button(\n    [\n      class(\"btn btn-circle btn-ghost btn-sm\"),\n      attribute(\"data-testid\", \"warmer-button\"),\n      event.on_click(AdjustRoom(room_name, adjustment +. step)),\n    ],\n    [icons.plus_icon(adjustment \u003e. 0.0, IconMedium)],\n  )\n}\n\nfn target_display(target: Option(Temperature), adjustment: Float) -\u003e Element(Msg) {\n  span(\n    [\n      class(\"flex-1 text-center\"),\n      attribute(\"data-testid\", \"target-display\"),\n    ],\n    [\n      text(format_target(target)),\n      case adjustment != 0.0 {\n        True -\u003e adjustment_badge(adjustment)\n        False -\u003e element.none()\n      },\n    ],\n  )\n}\n\nfn format_target(target: Option(Temperature)) -\u003e String {\n  case target {\n    Some(t) -\u003e temperature.format_bare(t)\n    None -\u003e \"–\"\n  }\n}\n\nfn adjustment_badge(adjustment: Float) -\u003e Element(Msg) {\n  let sign = case adjustment \u003e. 0.0 {\n    True -\u003e \"+\"\n    False -\u003e \"\"\n  }\n  span(\n    [\n      class(\"text-xs opacity-75 ml-1\"),\n      attribute(\"data-testid\", \"adjustment-badge\"),\n    ],\n    [text(\"(\" \u003c\u003e sign \u003c\u003e float_to_1dp(adjustment) \u003c\u003e \"°C)\")],\n  )\n}\n\nfn is_auto_mode(mode: Option(RoomMode)) -\u003e Bool {\n  case mode {\n    Some(Auto) -\u003e True\n    _ -\u003e False\n  }\n}\n```\n\n## Testing\n\n### Snapshot Tests\n\nCreate `test/ui/components/room_controls_test.gleam`:\n\n```gleam\nimport birdie\nimport lustre/element\nimport ui/components/room_controls\nimport test/ui/test_helpers\n\npub fn controls_auto_mode_no_adjustment_test() {\n  room_controls.view(test_helpers.auto_room())\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"room_controls_auto_no_adjustment\")\n}\n\npub fn controls_auto_mode_positive_adjustment_test() {\n  room_controls.view(test_helpers.room_with_adjustment(1.0))\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"room_controls_positive_adjustment\")\n}\n\npub fn controls_auto_mode_negative_adjustment_test() {\n  room_controls.view(test_helpers.room_with_adjustment(-0.5))\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"room_controls_negative_adjustment\")\n}\n\npub fn controls_off_mode_test() {\n  room_controls.view(test_helpers.off_room())\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"room_controls_off_mode\")\n}\n\npub fn controls_sleeping_mode_test() {\n  room_controls.view(test_helpers.sleeping_room())\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"room_controls_sleeping_mode\")\n}\n```\n\n### Query Tests\n\n```gleam\nimport lustre/dev/query\nimport ui/components/room_controls\nimport test/ui/test_helpers\n\npub fn auto_mode_has_buttons_test() {\n  let view = room_controls.view(test_helpers.auto_room())\n  let assert True = query.has(view, query.test_id(\"colder-button\"))\n  let assert True = query.has(view, query.test_id(\"warmer-button\"))\n}\n\npub fn off_mode_has_no_buttons_test() {\n  let view = room_controls.view(test_helpers.off_room())\n  let assert False = query.has(view, query.test_id(\"colder-button\"))\n  let assert False = query.has(view, query.test_id(\"warmer-button\"))\n}\n\npub fn no_adjustment_has_no_badge_test() {\n  let view = room_controls.view(test_helpers.auto_room())\n  let assert False = query.has(view, query.test_id(\"adjustment-badge\"))\n}\n\npub fn positive_adjustment_shows_badge_test() {\n  let view = room_controls.view(test_helpers.room_with_adjustment(1.0))\n  let assert True = query.has(view, query.test_id(\"adjustment-badge\"))\n}\n```\n\n### Simulate Tests for User Interactions\n\n```gleam\nimport lustre/dev/simulate\nimport lustre/dev/query\nimport ui/model\nimport ui/update\nimport ui/view\nimport ui/msg.{AdjustRoom}\n\npub fn clicking_warmer_sends_adjust_message_test() {\n  let app = simulate.simple(model.init, update.update, view.view)\n  \n  // Start with a connected state with rooms\n  let sim = \n    simulate.start(app, Nil)\n    |\u003e simulate.message(msg.StateReceived(test_helpers.state_with_auto_room()))\n    |\u003e simulate.click(query.element(query.test_id(\"warmer-button\")))\n  \n  // Check the history for the AdjustRoom message\n  let events = simulate.history(sim)\n  let assert True = list.any(events, fn(e) {\n    case e {\n      simulate.Dispatch(AdjustRoom(_, adjustment)) -\u003e adjustment \u003e. 0.0\n      _ -\u003e False\n    }\n  })\n}\n\npub fn clicking_colder_sends_adjust_message_test() {\n  let app = simulate.simple(model.init, update.update, view.view)\n  \n  let sim = \n    simulate.start(app, Nil)\n    |\u003e simulate.message(msg.StateReceived(test_helpers.state_with_auto_room()))\n    |\u003e simulate.click(query.element(query.test_id(\"colder-button\")))\n  \n  let events = simulate.history(sim)\n  let assert True = list.any(events, fn(e) {\n    case e {\n      simulate.Dispatch(AdjustRoom(_, adjustment)) -\u003e adjustment \u003c. 0.0\n      _ -\u003e False\n    }\n  })\n}\n\npub fn double_click_warmer_increases_adjustment_test() {\n  let app = simulate.simple(model.init, update.update, view.view)\n  \n  let sim = \n    simulate.start(app, Nil)\n    |\u003e simulate.message(msg.StateReceived(test_helpers.state_with_auto_room()))\n    |\u003e simulate.click(query.element(query.test_id(\"warmer-button\")))\n    |\u003e simulate.click(query.element(query.test_id(\"warmer-button\")))\n  \n  // Snapshot the resulting view\n  simulate.view(sim)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"room_controls_after_double_warmer_click\")\n}\n```\n\n## Type Safety Considerations\n\n1. **RoomMode pattern matching**: Uses enum, not string\n2. **AdjustRoom message**: Typed room_name and Float adjustment\n3. **Temperature type**: Uses opaque type with format functions\n4. **step constant**: Named, not magic number\n\n## Acceptance Criteria\n\n- [ ] Buttons only appear when mode is Auto\n- [ ] Clicking - sends AdjustRoom with adjustment - 0.5\n- [ ] Clicking + sends AdjustRoom with adjustment + 0.5\n- [ ] Target temperature displayed without units\n- [ ] Adjustment badge shown when non-zero (includes sign)\n- [ ] Minus icon solid when adjustment \u003c 0\n- [ ] Plus icon solid when adjustment \u003e 0\n- [ ] All elements have data-testid attributes\n- [ ] Snapshot tests pass for all modes and adjustments\n- [ ] Query tests verify conditional rendering\n- [ ] Simulate tests verify click behavior and message dispatch","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:33.71219117Z","created_by":"graeme","updated_at":"2026-01-04T12:25:47.678203703Z","closed_at":"2026-01-04T12:25:47.678203703Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-33jq.23","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:33.71314352Z","created_by":"graeme"},{"issue_id":"dh-33jq.23","depends_on_id":"dh-33jq.19","type":"blocks","created_at":"2026-01-02T14:36:38.252761085Z","created_by":"graeme"},{"issue_id":"dh-33jq.23","depends_on_id":"dh-mcpu","type":"blocks","created_at":"2026-01-04T10:47:26.426013669Z","created_by":"graeme"}]}
{"id":"dh-33jq.24","title":"Set up Lustre server components","description":"Set up Lustre server components for real-time UI.\n\n## What Are Server Components?\nLustre server components run on the BEAM server and send DOM patches\nto the browser over WebSocket. Like Phoenix LiveView but in Gleam.\n\n## Benefits for Deep Heating\n- State already lives on server (in actors)\n- No separate WebSocket API needed\n- Automatic UI sync when state changes\n- Type-safe all the way through\n\n## Implementation\n```gleam\nimport lustre/server_component\n\npub fn start(\n  state_aggregator: Subject(AggregatorMsg),\n) -\u003e Result(Subject(Msg), StartError) {\n  // Subscribe to state changes\n  process.send(state_aggregator, Subscribe(self()))\n  \n  // Start server component\n  lustre.server_component(\n    init: fn(_) { #(Model(None), effect.none()) },\n    update: update,\n    view: view,\n  )\n}\n\n// When state changes, the view re-renders and Lustre\n// automatically sends DOM patches to connected clients\n```\n\n## Client Setup\n```html\n\u003cdiv id=\"app\"\u003e\u003c/div\u003e\n\u003cscript type=\"module\"\u003e\n  import { mount } from \"lustre/server-component\";\n  mount(\"ws://localhost:8085/ws\", \"#app\");\n\u003c/script\u003e\n```\n\n## Acceptance Criteria\n- [ ] Server component starts on BEAM\n- [ ] WebSocket endpoint serves DOM patches\n- [ ] Client renders server-sent UI\n- [ ] State changes trigger UI updates\n- [ ] Multiple clients can connect","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:33.728155244Z","created_by":"graeme","updated_at":"2026-01-04T12:54:25.477657196Z","closed_at":"2026-01-04T12:54:25.477657196Z","close_reason":"Implemented Lustre server components with Mist WebSocket server, integrated with StateAggregatorActor, fixed OTP 28 compatibility in flake.nix","dependencies":[{"issue_id":"dh-33jq.24","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:33.729077263Z","created_by":"graeme"},{"issue_id":"dh-33jq.24","depends_on_id":"dh-33jq.14","type":"blocks","created_at":"2026-01-02T14:36:38.266218454Z","created_by":"graeme"},{"issue_id":"dh-33jq.24","depends_on_id":"dh-33jq.20","type":"blocks","created_at":"2026-01-02T14:36:38.279799435Z","created_by":"graeme"}]}
{"id":"dh-33jq.25","title":"Implement main view composition","description":"## Overview\n\nImplement the main view that composes all UI components into the complete Deep Heating dashboard. This is the top-level view function that renders the entire application UI.\n\n## Implementation\n\nCreate `src/ui/view.gleam`:\n\n```gleam\nimport deep_heating/state.{type DeepHeatingState, type RoomState}\nimport gleam/list\nimport gleam/option.{type Option, None, Some}\nimport lustre/attribute.{class, href, attribute}\nimport lustre/element.{type Element, text}\nimport lustre/element/html.{a, div, li, span, ul}\nimport ui/components/connection_overlay\nimport ui/components/heating_badge\nimport ui/components/room_card\nimport ui/model.{type Model}\nimport ui/msg.{type Msg}\nimport ui/room_sort\n\npub fn view(model: Model) -\u003e Element(Msg) {\n  div(\n    [attribute(\"data-testid\", \"app-root\")],\n    [\n      connection_overlay.view_from_bool(model.connected),\n      main_content(model),\n    ],\n  )\n}\n\nfn main_content(model: Model) -\u003e Element(Msg) {\n  div(\n    [attribute(\"data-testid\", \"main-content\")],\n    [\n      breadcrumbs(),\n      case model.state {\n        None -\u003e loading_placeholder()\n        Some(state) -\u003e home_view(state)\n      },\n    ],\n  )\n}\n\nfn breadcrumbs() -\u003e Element(Msg) {\n  ul(\n    [class(\"breadcrumbs text-sm mx-3.5 mt-2\")],\n    [li([], [a([href(\"/\")], [text(\"Deep Heating\")])])],\n  )\n}\n\nfn loading_placeholder() -\u003e Element(Msg) {\n  div(\n    [\n      class(\"flex items-center justify-center h-64\"),\n      attribute(\"data-testid\", \"loading-placeholder\"),\n    ],\n    [span([class(\"loading loading-spinner loading-lg\")], [])],\n  )\n}\n\nfn home_view(state: DeepHeatingState) -\u003e Element(Msg) {\n  div(\n    [\n      class(\"mx-3.5\"),\n      attribute(\"data-testid\", \"home-view\"),\n    ],\n    [\n      header_section(state),\n      rooms_grid(state.rooms),\n    ],\n  )\n}\n\nfn header_section(state: DeepHeatingState) -\u003e Element(Msg) {\n  div(\n    [class(\"flex flex-row justify-between items-center mb-2\")],\n    [heating_badge.view_from_option(state.is_heating)],\n  )\n}\n\nfn rooms_grid(rooms: List(RoomState)) -\u003e Element(Msg) {\n  let sorted_rooms = room_sort.sort_by_temperature(rooms)\n  \n  div(\n    [\n      class(\"flex flex-row flex-wrap gap-2\"),\n      attribute(\"data-testid\", \"rooms-grid\"),\n    ],\n    list.map(sorted_rooms, room_card.view),\n  )\n}\n```\n\n## Testing\n\n### Snapshot Tests\n\nCreate `test/ui/view_test.gleam`:\n\n```gleam\nimport birdie\nimport lustre/element\nimport ui/view\nimport ui/model.{Model}\nimport gleam/option.{None, Some}\nimport test/ui/test_helpers\n\npub fn view_disconnected_test() {\n  let model = Model(connected: False, state: None)\n  \n  view.view(model)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"main_view_disconnected\")\n}\n\npub fn view_connected_no_state_test() {\n  let model = Model(connected: True, state: None)\n  \n  view.view(model)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"main_view_loading\")\n}\n\npub fn view_connected_with_state_test() {\n  let model = Model(\n    connected: True,\n    state: Some(test_helpers.sample_state()),\n  )\n  \n  view.view(model)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"main_view_with_rooms\")\n}\n\npub fn view_heating_active_test() {\n  let model = Model(\n    connected: True,\n    state: Some(test_helpers.state_heating_active()),\n  )\n  \n  view.view(model)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"main_view_heating_active\")\n}\n\npub fn view_multiple_rooms_sorted_test() {\n  let model = Model(\n    connected: True,\n    state: Some(test_helpers.state_with_multiple_rooms()),\n  )\n  \n  view.view(model)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"main_view_rooms_sorted_by_temp\")\n}\n```\n\n### Query Tests\n\n```gleam\nimport lustre/dev/query\nimport ui/view\nimport ui/model.{Model}\nimport gleam/option.{None, Some}\nimport test/ui/test_helpers\n\npub fn disconnected_shows_overlay_test() {\n  let model = Model(connected: False, state: None)\n  let v = view.view(model)\n  \n  let assert True = query.has(v, query.test_id(\"connection-overlay\"))\n}\n\npub fn connected_no_overlay_test() {\n  let model = Model(connected: True, state: None)\n  let v = view.view(model)\n  \n  let assert False = query.has(v, query.test_id(\"connection-overlay\"))\n}\n\npub fn loading_state_shows_placeholder_test() {\n  let model = Model(connected: True, state: None)\n  let v = view.view(model)\n  \n  let assert True = query.has(v, query.test_id(\"loading-placeholder\"))\n  let assert False = query.has(v, query.test_id(\"home-view\"))\n}\n\npub fn with_state_shows_home_view_test() {\n  let model = Model(connected: True, state: Some(test_helpers.sample_state()))\n  let v = view.view(model)\n  \n  let assert False = query.has(v, query.test_id(\"loading-placeholder\"))\n  let assert True = query.has(v, query.test_id(\"home-view\"))\n}\n\npub fn rooms_grid_contains_room_cards_test() {\n  let state = test_helpers.state_with_multiple_rooms()\n  let model = Model(connected: True, state: Some(state))\n  let v = view.view(model)\n  \n  let assert Ok(grid) = query.find(v, query.element(query.test_id(\"rooms-grid\")))\n  \n  // Should have room cards\n  let cards = query.find_all(grid, query.element(query.test_id(\"room-card\")))\n  let assert True = list.length(cards) == list.length(state.rooms)\n}\n\npub fn heating_badge_present_when_heating_test() {\n  let model = Model(\n    connected: True,\n    state: Some(test_helpers.state_heating_active()),\n  )\n  let v = view.view(model)\n  \n  let assert True = query.has(v, query.test_id(\"heating-badge\"))\n}\n```\n\n### Simulate Integration Tests\n\n```gleam\nimport lustre/dev/simulate\nimport lustre/dev/query\nimport lustre/element\nimport birdie\nimport ui/model\nimport ui/update\nimport ui/view\nimport ui/msg\nimport test/ui/test_helpers\n\npub fn full_app_flow_connect_receive_state_test() {\n  let app = simulate.simple(model.init, update.update, view.view)\n  \n  // Start disconnected\n  let sim = simulate.start(app, Nil)\n  let assert False = simulate.model(sim).connected\n  \n  // Connect\n  let sim = simulate.message(sim, msg.Connected)\n  let assert True = simulate.model(sim).connected\n  \n  // Receive state\n  let sim = simulate.message(sim, msg.StateReceived(test_helpers.sample_state()))\n  let assert True = option.is_some(simulate.model(sim).state)\n  \n  // Snapshot the final view\n  simulate.view(sim)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"app_flow_connected_with_state\")\n}\n\npub fn user_adjusts_temperature_test() {\n  let app = simulate.simple(model.init, update.update, view.view)\n  \n  let sim = \n    simulate.start(app, Nil)\n    |\u003e simulate.message(msg.Connected)\n    |\u003e simulate.message(msg.StateReceived(test_helpers.state_with_auto_room()))\n    |\u003e simulate.click(query.element(query.test_id(\"warmer-button\")))\n  \n  // Verify the adjustment was recorded\n  simulate.view(sim)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"app_after_temperature_adjustment\")\n}\n\npub fn disconnection_shows_overlay_test() {\n  let app = simulate.simple(model.init, update.update, view.view)\n  \n  let sim = \n    simulate.start(app, Nil)\n    |\u003e simulate.message(msg.Connected)\n    |\u003e simulate.message(msg.StateReceived(test_helpers.sample_state()))\n    |\u003e simulate.message(msg.Disconnected)\n  \n  let assert False = simulate.model(sim).connected\n  let assert True = query.has(simulate.view(sim), query.test_id(\"connection-overlay\"))\n}\n\npub fn rooms_sorted_correctly_test() {\n  let app = simulate.simple(model.init, update.update, view.view)\n  \n  let state = test_helpers.state_with_rooms([\n    test_helpers.room_with_temp(\"Cold\", 15.0),\n    test_helpers.room_with_temp(\"Hot\", 25.0),\n    test_helpers.room_with_temp(\"Medium\", 20.0),\n  ])\n  \n  let sim = \n    simulate.start(app, Nil)\n    |\u003e simulate.message(msg.Connected)\n    |\u003e simulate.message(msg.StateReceived(state))\n  \n  let v = simulate.view(sim)\n  let cards = query.find_all(v, query.element(query.test_id(\"room-card\")))\n  \n  // Verify order: Hot, Medium, Cold\n  let names = list.map(cards, fn(card) {\n    // Extract room name from data attribute\n    case query.find(card, query.element(query.attribute(\"data-room-name\", _))) {\n      Ok(_) -\u003e \"found\"  // Simplified - real test would extract value\n      Error(_) -\u003e \"not found\"\n    }\n  })\n  \n  // Snapshot to verify order visually\n  simulate.view(sim)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"rooms_sorted_hot_to_cold\")\n}\n```\n\n## Layout Structure\n\n```\n┌─────────────────────────────────────────────┐\n│ [Connection Overlay - when disconnected]    │\n├─────────────────────────────────────────────┤\n│ \u003e Deep Heating                    (breadcrumb)\n├─────────────────────────────────────────────┤\n│ [Heating Badge]                             │\n├─────────────────────────────────────────────┤\n│ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐       │\n│ │Room 1│ │Room 2│ │Room 3│ │Room 4│ ...   │\n│ └──────┘ └──────┘ └──────┘ └──────┘       │\n│ (flex-wrap, sorted by temperature)          │\n└─────────────────────────────────────────────┘\n```\n\n## Acceptance Criteria\n\n- [ ] Connection overlay shows when `connected = False`\n- [ ] Loading spinner shown when `state = None`\n- [ ] Heating badge displayed with correct status\n- [ ] Room cards rendered in flex-wrap grid\n- [ ] Rooms sorted by temperature (hottest first)\n- [ ] All sections have data-testid attributes\n- [ ] Snapshot tests pass for all view states\n- [ ] Query tests verify conditional rendering\n- [ ] Simulate tests verify full app flow:\n  - Connect → receive state → display rooms\n  - User adjustment → model update → view update\n  - Disconnect → overlay appears\n  - Room sorting order","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:33.744674043Z","created_by":"graeme","updated_at":"2026-01-04T13:14:13.947725517Z","closed_at":"2026-01-04T13:14:13.947725517Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-33jq.25","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:33.745547252Z","created_by":"graeme"},{"issue_id":"dh-33jq.25","depends_on_id":"dh-33jq.21","type":"blocks","created_at":"2026-01-02T14:36:38.292984692Z","created_by":"graeme"},{"issue_id":"dh-33jq.25","depends_on_id":"dh-33jq.22","type":"blocks","created_at":"2026-01-02T14:36:38.306974347Z","created_by":"graeme"},{"issue_id":"dh-33jq.25","depends_on_id":"dh-33jq.23","type":"blocks","created_at":"2026-01-02T14:36:38.320152254Z","created_by":"graeme"},{"issue_id":"dh-33jq.25","depends_on_id":"dh-116e","type":"blocks","created_at":"2026-01-04T10:47:26.579730481Z","created_by":"graeme"}]}
{"id":"dh-33jq.26","title":"Add Tailwind/DaisyUI styling","description":"Integrate Tailwind CSS and DaisyUI for consistent styling with current UI.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:33.760739998Z","created_by":"graeme","updated_at":"2026-01-02T14:33:33.760739998Z","dependencies":[{"issue_id":"dh-33jq.26","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:33.761737088Z","created_by":"graeme"},{"issue_id":"dh-33jq.26","depends_on_id":"dh-33jq.25","type":"blocks","created_at":"2026-01-02T14:36:38.334623994Z","created_by":"graeme"}]}
{"id":"dh-33jq.27","title":"Update Nix flake for Gleam build","description":"Update Nix flake to build the Gleam application.\n\n## Requirements\n- Build Gleam project with `gleam build --target erlang`\n- Package BEAM files into a release\n- Create wrapper script to start OTP application\n- Integrate with existing Docker image build\n\n## Nix Derivation\n```nix\ndeep-heating-gleam = pkgs.stdenv.mkDerivation {\n  pname = \"deep-heating-gleam\";\n  version = \"0.1.0\";\n  src = ./packages/deep_heating;\n  \n  nativeBuildInputs = [ pkgs.gleam pkgs.erlang pkgs.rebar3 ];\n  \n  buildPhase = ''\n    gleam build --target erlang\n    gleam export erlang-shipment\n  '';\n  \n  installPhase = ''\n    mkdir -p $out\n    cp -r build/erlang-shipment/* $out/\n    \n    # Create start script\n    cat \u003e $out/bin/deep-heating \u003c\u003cEOF\n    #!/bin/sh\n    exec ${pkgs.erlang}/bin/erl -pa $out/*/ebin -s deep_heating\n    EOF\n    chmod +x $out/bin/deep-heating\n  '';\n};\n```\n\n## Integration with Docker\n- Replace Bun-based server with Gleam release\n- Keep nginx for ingress (or use Gleam HTTP server)\n- Update s6 service definitions\n\n## Acceptance Criteria\n- [ ] `nix build .#deep-heating-gleam` succeeds\n- [ ] Produces runnable Erlang release\n- [ ] Start script launches OTP application\n- [ ] Can be integrated into Docker image","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T14:34:46.678303252Z","created_by":"graeme","updated_at":"2026-01-02T15:09:15.356509769Z","dependencies":[{"issue_id":"dh-33jq.27","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:34:46.68483394Z","created_by":"graeme"},{"issue_id":"dh-33jq.27","depends_on_id":"dh-33jq.12","type":"blocks","created_at":"2026-01-02T14:36:38.348882842Z","created_by":"graeme"},{"issue_id":"dh-33jq.27","depends_on_id":"dh-33jq.16","type":"blocks","created_at":"2026-01-02T14:36:38.362696615Z","created_by":"graeme"},{"issue_id":"dh-33jq.27","depends_on_id":"dh-33jq.17","type":"blocks","created_at":"2026-01-02T14:36:38.376791471Z","created_by":"graeme"},{"issue_id":"dh-33jq.27","depends_on_id":"dh-33jq.26","type":"blocks","created_at":"2026-01-02T14:36:38.391199671Z","created_by":"graeme"}]}
{"id":"dh-33jq.28","title":"Create Docker image for Gleam app","description":"Create Docker image for Gleam-based Deep Heating.\n\n## Changes from TypeScript Version\n- Replace Bun runtime with Erlang/OTP runtime\n- Gleam release instead of bundled JS\n- Lustre server components instead of SvelteKit\n- May simplify to single service (Gleam serves everything)\n\n## Image Contents\n```nix\ndockerImage = pkgs.dockerTools.buildLayeredImage {\n  name = \"deep-heating\";\n  tag = \"gleam\";\n  \n  contents = [\n    deep-heating-gleam      # Gleam OTP release\n    pkgs.erlang             # Erlang runtime\n    pkgs.dockerTools.binSh  # Shell for scripts\n    # nginx if still needed for ingress\n  ];\n  \n  config = {\n    Entrypoint = [ \"${deep-heating-gleam}/bin/deep-heating\" ];\n    Env = [ \"HOME_CONFIG_PATH=/data/home.json\" ];\n    ExposedPorts = { \"8099/tcp\" = {}; };\n  };\n};\n```\n\n## Considerations\n- Erlang runtime is larger than Bun (~50MB vs ~30MB)\n- But no node_modules bloat\n- Consider using Alpine-based Erlang for smaller image\n- BEAM gives us better observability (remote shell, observer)\n\n## Acceptance Criteria\n- [ ] Docker image builds successfully\n- [ ] Image size is reasonable (\u003c150MB)\n- [ ] Container starts and runs OTP app\n- [ ] WebSocket endpoint accessible\n- [ ] Environment variables work correctly","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T14:34:46.702222139Z","created_by":"graeme","updated_at":"2026-01-02T15:09:15.372470378Z","dependencies":[{"issue_id":"dh-33jq.28","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:34:46.703199319Z","created_by":"graeme"},{"issue_id":"dh-33jq.28","depends_on_id":"dh-33jq.27","type":"blocks","created_at":"2026-01-02T14:36:38.404928123Z","created_by":"graeme"}]}
{"id":"dh-33jq.29","title":"Update Home Assistant addon config","description":"Update addon configuration for Gleam-based backend. Ensure environment variables and ports are correct.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T14:34:46.718882761Z","created_by":"graeme","updated_at":"2026-01-02T14:34:46.718882761Z","dependencies":[{"issue_id":"dh-33jq.29","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:34:46.719737469Z","created_by":"graeme"},{"issue_id":"dh-33jq.29","depends_on_id":"dh-33jq.28","type":"blocks","created_at":"2026-01-02T14:36:38.41907464Z","created_by":"graeme"}]}
{"id":"dh-33jq.3","title":"Configure Gleam for BEAM target","description":"Configure Gleam to compile to Erlang/BEAM, not JavaScript.\n\n## Requirements\n- Set target = \"erlang\" in gleam.toml\n- Configure OTP application metadata\n- Set up proper module naming for BEAM\n- Ensure gleam_otp and gleam_erlang dependencies are added\n\n## gleam.toml Configuration\n```toml\nname = \"deep_heating\"\nversion = \"0.1.0\"\ntarget = \"erlang\"\n\n[dependencies]\ngleam_stdlib = \"\u003e= 0.34.0 and \u003c 2.0.0\"\ngleam_otp = \"\u003e= 0.10.0 and \u003c 1.0.0\"\ngleam_erlang = \"\u003e= 0.25.0 and \u003c 1.0.0\"\n```\n\n## Acceptance Criteria\n- [ ] `gleam build` produces .beam files in build/dev/erlang/\n- [ ] Can start an Erlang shell with the compiled modules\n- [ ] OTP application structure is correct","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:32:32.959939579Z","created_by":"graeme","updated_at":"2026-01-02T16:32:26.66099889Z","closed_at":"2026-01-02T16:32:26.66099889Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-33jq.3","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:32:32.960879688Z","created_by":"graeme"},{"issue_id":"dh-33jq.3","depends_on_id":"dh-33jq.2","type":"blocks","created_at":"2026-01-02T14:35:10.602034667Z","created_by":"graeme"}]}
{"id":"dh-33jq.30","title":"Test addon installation in HA","description":"End-to-end test: build image, install as HA addon, verify functionality.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T14:34:46.735266409Z","created_by":"graeme","updated_at":"2026-01-02T14:34:46.735266409Z","dependencies":[{"issue_id":"dh-33jq.30","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:34:46.736430331Z","created_by":"graeme"},{"issue_id":"dh-33jq.30","depends_on_id":"dh-33jq.29","type":"blocks","created_at":"2026-01-02T14:36:38.433460799Z","created_by":"graeme"}]}
{"id":"dh-33jq.31","title":"Set up Gleam test infrastructure","description":"Configure Gleam's built-in test runner, set up test utilities and helpers.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:34:46.751283495Z","created_by":"graeme","updated_at":"2026-01-03T13:52:50.181701642Z","closed_at":"2026-01-03T13:52:50.181701642Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-33jq.31","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:34:46.752289825Z","created_by":"graeme"},{"issue_id":"dh-33jq.31","depends_on_id":"dh-33jq.3","type":"blocks","created_at":"2026-01-02T14:36:38.447852698Z","created_by":"graeme"}]}
{"id":"dh-33jq.32","title":"Port critical domain logic tests","description":"Port tests for temperature calculations, schedule evaluation, decision logic from deep-heating-rx.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:34:46.766915016Z","created_by":"graeme","updated_at":"2026-01-04T10:07:51.710796009Z","closed_at":"2026-01-04T10:07:51.710796009Z","close_reason":"Domain logic tests already ported and significantly expanded during actor implementation - 261 passing tests covering temperature calculations, schedule evaluation, room mode derivation, offset compensation, and boiler control","dependencies":[{"issue_id":"dh-33jq.32","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:34:46.767815635Z","created_by":"graeme"},{"issue_id":"dh-33jq.32","depends_on_id":"dh-33jq.12","type":"blocks","created_at":"2026-01-02T14:36:38.462287708Z","created_by":"graeme"},{"issue_id":"dh-33jq.32","depends_on_id":"dh-33jq.31","type":"blocks","created_at":"2026-01-02T14:36:38.47595819Z","created_by":"graeme"}]}
{"id":"dh-33jq.33","title":"Add actor unit tests","description":"Unit tests for each actor type - send messages, verify state changes and outgoing messages.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:34:46.783300465Z","created_by":"graeme","updated_at":"2026-01-04T10:08:07.819233198Z","closed_at":"2026-01-04T10:08:07.819233198Z","close_reason":"All actor unit tests already implemented - comprehensive tests for RoomActor, RoomDecisionActor, HeatingControlActor, HaCommandActor, HouseModeActor, StateAggregatorActor, HaPollerActor, TrvActor, and Supervisor","dependencies":[{"issue_id":"dh-33jq.33","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:34:46.784389096Z","created_by":"graeme"},{"issue_id":"dh-33jq.33","depends_on_id":"dh-33jq.14","type":"blocks","created_at":"2026-01-02T14:36:38.489333998Z","created_by":"graeme"},{"issue_id":"dh-33jq.33","depends_on_id":"dh-33jq.31","type":"blocks","created_at":"2026-01-02T14:36:38.503322334Z","created_by":"graeme"}]}
{"id":"dh-33jq.34","title":"Add integration tests","description":"Integration tests for actor supervision tree, HA integration mocking, end-to-end state flow.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T14:34:46.799777564Z","created_by":"graeme","updated_at":"2026-01-02T14:34:46.799777564Z","dependencies":[{"issue_id":"dh-33jq.34","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:34:46.800660684Z","created_by":"graeme"},{"issue_id":"dh-33jq.34","depends_on_id":"dh-33jq.30","type":"blocks","created_at":"2026-01-02T14:36:38.517978826Z","created_by":"graeme"}]}
{"id":"dh-33jq.35","title":"Document Gleam architecture","description":"Update CLAUDE.md and add architecture documentation for the Gleam codebase.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T14:34:46.815612308Z","created_by":"graeme","updated_at":"2026-01-02T14:34:46.815612308Z","dependencies":[{"issue_id":"dh-33jq.35","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:34:46.816917111Z","created_by":"graeme"},{"issue_id":"dh-33jq.35","depends_on_id":"dh-33jq.30","type":"blocks","created_at":"2026-01-02T14:36:38.532006381Z","created_by":"graeme"}]}
{"id":"dh-33jq.36","title":"Remove TypeScript implementation","description":"Once Gleam port is complete and tested, remove old TypeScript packages (after parallel running period).","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T14:34:46.831875195Z","created_by":"graeme","updated_at":"2026-01-02T14:34:46.831875195Z","dependencies":[{"issue_id":"dh-33jq.36","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:34:46.832747104Z","created_by":"graeme"},{"issue_id":"dh-33jq.36","depends_on_id":"dh-33jq.34","type":"blocks","created_at":"2026-01-02T14:36:38.546777394Z","created_by":"graeme"},{"issue_id":"dh-33jq.36","depends_on_id":"dh-33jq.35","type":"blocks","created_at":"2026-01-02T14:36:38.560564877Z","created_by":"graeme"}]}
{"id":"dh-33jq.37","title":"Compare behavioural tests with TypeScript version","description":"Systematically compare the behavioural tests in the Gleam port against the existing TypeScript test suite.\n\n## Key Documentation\n\n**START HERE** - these docs explain the full data flow and what behaviours exist:\n- packages/deep-heating-rx/DATA-FLOW.md (overview)\n- packages/deep-heating-rx/docs/data-flow-input.md (Layers 1-4)\n- packages/deep-heating-rx/docs/data-flow-rooms.md (Layers 5-8)\n- packages/deep-heating-rx/docs/data-flow-decisions.md (Layers 9-14)\n- packages/deep-heating-rx/docs/data-flow-output.md (Layers 15-16)\n\n## Objective\n\nIdentify gaps in behavioural test coverage between the two implementations to ensure the Gleam port handles all the same scenarios.\n\n## Approach\n\n1. Read the DATA-FLOW docs to understand what behaviours exist\n2. Inventory all behavioural tests in the TypeScript version\n3. Check TS implementations for UNTESTED behaviour too\n4. Map each scenario to its Gleam equivalent\n5. Identify missing scenarios in Gleam\n6. Create follow-up beads for each gap found\n\n## Deliverables\n\n- Comparison document or checklist\n- New beads for any gaps discovered\n- Confidence that Gleam port has equivalent behavioural coverage","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:19:00.329460591Z","created_by":"graeme","updated_at":"2026-01-03T11:49:55.540603481Z","closed_at":"2026-01-03T11:49:55.540603481Z","close_reason":"All 5 child comparisons complete. Found 9 total gaps across actors, all with beads created: dh-qv64, dh-zylb, dh-4xrn, dh-7t77 (RoomActor); dh-taws, dh-zcyl, dh-1wyv, dh-2tj3 (RoomDecisionActor); dh-yjba (HouseModeActor). StateAggregatorActor has better coverage than TS equivalent.","dependencies":[{"issue_id":"dh-33jq.37","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-03T11:19:00.330902106Z","created_by":"graeme"}]}
{"id":"dh-33jq.37.1","title":"Compare TrvActor behavioural tests with TS version","description":"Review TrvActor tests against the equivalent TypeScript TRV logic tests. Identify any missing behavioural scenarios.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:21:00.977092428Z","created_by":"graeme","updated_at":"2026-01-03T11:23:40.594357857Z","closed_at":"2026-01-03T11:23:40.594357857Z","close_reason":"Comparison complete. Found 3 gaps in behavioural test coverage - created child beads for: temperature offset calculation, temperature clamping, and action determination logic.","dependencies":[{"issue_id":"dh-33jq.37.1","depends_on_id":"dh-33jq.37","type":"parent-child","created_at":"2026-01-03T11:21:00.986977929Z","created_by":"graeme"}]}
{"id":"dh-33jq.37.1.1","title":"Add TRV temperature offset calculation tests","description":"The TS version calculates TRV target using: target = roomTarget + (trvTemp - roomTemp)\n\nThis formula compensates for the difference between the TRV's local temperature sensor and the room's actual temperature.\n\nNeed to verify the Gleam TrvActor (or related module) implements and tests this calculation.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:23:27.976079706Z","created_by":"graeme","updated_at":"2026-01-03T11:58:42.440061912Z","closed_at":"2026-01-03T11:58:42.440061912Z","close_reason":"Duplicate of dh-taws (RoomDecisionActor offset-based algorithm)","dependencies":[{"issue_id":"dh-33jq.37.1.1","depends_on_id":"dh-33jq.37.1","type":"parent-child","created_at":"2026-01-03T11:23:27.992654244Z","created_by":"graeme"}]}
{"id":"dh-33jq.37.1.2","title":"Add TRV temperature clamping tests (7-32°C)","description":"The TS version clamps calculated TRV targets to min 7°C and max 32°C.\n\nNeed to verify the Gleam TrvActor (or related module) implements and tests this clamping behaviour.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:23:28.090889659Z","created_by":"graeme","updated_at":"2026-01-03T11:58:42.55238545Z","closed_at":"2026-01-03T11:58:42.55238545Z","close_reason":"Duplicate of dh-zcyl (RoomDecisionActor temperature clamping)","dependencies":[{"issue_id":"dh-33jq.37.1.2","depends_on_id":"dh-33jq.37.1","type":"parent-child","created_at":"2026-01-03T11:23:28.09201067Z","created_by":"graeme"}]}
{"id":"dh-33jq.37.1.3","title":"Add TRV action determination tests","description":"The TS trvActions.test.ts covers several action determination scenarios:\n\n1. Entity ID mismatch → error\n2. TRV off mode → no action\n3. Mode change auto→heat\n4. Target temperature change detection\n5. No action when already at target\n\nNeed to verify the Gleam TrvActor implements and tests equivalent logic for when to send commands to Home Assistant.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:23:28.200905263Z","created_by":"graeme","updated_at":"2026-01-03T11:58:42.650474794Z","closed_at":"2026-01-03T11:58:42.650474794Z","close_reason":"Covered by dh-1wyv (TRV off mode handling) and dh-2tj3 (mode change commands)","dependencies":[{"issue_id":"dh-33jq.37.1.3","depends_on_id":"dh-33jq.37.1","type":"parent-child","created_at":"2026-01-03T11:23:28.202020844Z","created_by":"graeme"}]}
{"id":"dh-33jq.37.1.4","title":"Add TRV rounding direction tests","description":"The TS trvDesiredTargetTemperatures.ts has specific rounding logic:\n\n- When heating required (roomTemp \u003c roomTarget): round UP to nearest 0.5°C\n- When NOT heating required: round DOWN to nearest 0.5°C\n\nFormula: heatingRequired ? Math.ceil(temp * 2) / 2 : Math.floor(temp * 2) / 2\n\nThis ensures we err on the side of more heating when cold, and less when warm.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:27:39.48570494Z","created_by":"graeme","updated_at":"2026-01-03T13:17:59.413098712Z","closed_at":"2026-01-03T13:17:59.413098712Z","close_reason":"Added round_up_half and round_down_half functions to temperature module with comprehensive tests","dependencies":[{"issue_id":"dh-33jq.37.1.4","depends_on_id":"dh-33jq.37.1","type":"parent-child","created_at":"2026-01-03T11:27:39.502067855Z","created_by":"graeme"}]}
{"id":"dh-33jq.37.1.5","title":"Add TRV synthesised heating status tests","description":"The TS trvSynthesisedStatuses.ts (untested) determines if a TRV is actively heating:\n\nisHeating = targetTemperature \u003e currentTemperature\n\nThis is used for:\n1. UI display (showing which TRVs are calling for heat)\n2. Aggregating to determine if ANY TRV is heating\n3. Main boiler control decisions","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:27:39.625869145Z","created_by":"graeme","updated_at":"2026-01-03T13:19:09.520800394Z","closed_at":"2026-01-03T13:19:09.520800394Z","close_reason":"Added is_calling_for_heat function to temperature module with tests","dependencies":[{"issue_id":"dh-33jq.37.1.5","depends_on_id":"dh-33jq.37.1","type":"parent-child","created_at":"2026-01-03T11:27:39.627010127Z","created_by":"graeme"}]}
{"id":"dh-33jq.37.1.6","title":"Add TRV fallback handling tests","description":"The TS trvDecisionPoints.ts (untested) has fallback logic for missing data:\n\n1. TRV temperature fallback: If TRV temp reading not found, use room temperature\n2. TRV mode fallback: If TRV mode not found, default to 'off'\n\nThis ensures the system degrades gracefully when HA data is incomplete.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:27:39.746280012Z","created_by":"graeme","updated_at":"2026-01-03T13:21:16.044395619Z","closed_at":"2026-01-03T13:21:16.044395619Z","close_reason":"Added fallback handling tests. Existing implementation already handles missing TRV data gracefully - tests document and preserve this behavior","dependencies":[{"issue_id":"dh-33jq.37.1.6","depends_on_id":"dh-33jq.37.1","type":"parent-child","created_at":"2026-01-03T11:27:39.747345332Z","created_by":"graeme"}]}
{"id":"dh-33jq.37.1.7","title":"Add TRV heating aggregation tests","description":"The TS trvsHeating.ts (untested) aggregates heating status:\n\n1. getTrvsHeating: Maintains HashSet of TRV IDs currently heating\n2. getAnyHeating: Returns true if any TRV in the set\n\nThis feeds into main boiler control - boiler should be on if ANY TRV needs heat.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:27:39.875168873Z","created_by":"graeme","updated_at":"2026-01-03T11:58:42.758013954Z","closed_at":"2026-01-03T11:58:42.758013954Z","close_reason":"Subset of dh-waxe (main boiler/heating control)","dependencies":[{"issue_id":"dh-33jq.37.1.7","depends_on_id":"dh-33jq.37.1","type":"parent-child","created_at":"2026-01-03T11:27:39.876219644Z","created_by":"graeme"}]}
{"id":"dh-33jq.37.2","title":"Compare RoomActor behavioural tests with TS version","description":"Review RoomActor tests against the equivalent TypeScript room logic tests. Identify any missing behavioural scenarios.\n\n## Where to Look\n\n### TS Tests\n- packages/deep-heating-rx/src/lib/streams/rooms/roomTargetTemperatures.test.ts\n\n### TS Implementations (check for untested behaviour)\n- packages/deep-heating-rx/src/lib/streams/rooms/ (all files)\n\n### Data Flow Docs\n- packages/deep-heating-rx/DATA-FLOW.md\n- packages/deep-heating-rx/docs/data-flow-rooms.md (Layers 5-8: Room Aggregation)\n\n### Gleam Tests\n- packages/deep_heating/test/room_actor_test.gleam\n\n### Architecture\n- docs/gleam-actor-architecture.md (RoomActor section)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:21:01.089420506Z","created_by":"graeme","updated_at":"2026-01-03T11:43:14.604646692Z","closed_at":"2026-01-03T11:43:14.604646692Z","close_reason":"Comparison complete. Found 4 gaps: target temp calculation, TRV mode tracking, schedule-based calculation, state aggregator notifications. Created beads dh-qv64, dh-zylb, dh-4xrn, dh-7t77.","dependencies":[{"issue_id":"dh-33jq.37.2","depends_on_id":"dh-33jq.37","type":"parent-child","created_at":"2026-01-03T11:21:01.090563747Z","created_by":"graeme"}]}
{"id":"dh-33jq.37.3","title":"Compare RoomDecisionActor behavioural tests with TS version","description":"Review RoomDecisionActor tests against the equivalent TypeScript room decision logic tests. Identify any missing behavioural scenarios.\n\n## Where to Look\n\n### TS Tests\n- packages/deep-heating-rx/src/lib/streams/trvs/trvActions.test.ts\n- packages/deep-heating-rx/src/lib/streams/trvs/trvDesiredTargetTemperatures.test.ts\n\n### TS Implementations (check for untested behaviour)\n- packages/deep-heating-rx/src/lib/streams/rooms/roomDecisionPoints.ts\n- packages/deep-heating-rx/src/lib/streams/trvs/trvDecisionPoints.ts\n- packages/deep-heating-rx/src/lib/streams/trvs/trvDesiredTargetTemperatures.ts\n\n### Data Flow Docs\n- packages/deep-heating-rx/DATA-FLOW.md\n- packages/deep-heating-rx/docs/data-flow-decisions.md (Layers 9-14: Decision \u0026 Actions)\n\n### Gleam Tests\n- packages/deep_heating/test/room_decision_actor_test.gleam\n\n### Architecture\n- docs/gleam-actor-architecture.md (RoomDecisionActor section)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:21:01.189777861Z","created_by":"graeme","updated_at":"2026-01-03T11:44:58.62325806Z","closed_at":"2026-01-03T11:44:58.62325806Z","close_reason":"Comparison complete. Found significant algorithm difference (offset vs threshold formula) plus 3 gaps: temperature clamping, TRV off mode handling, mode change commands. Created beads dh-taws, dh-zcyl, dh-1wyv, dh-2tj3.","dependencies":[{"issue_id":"dh-33jq.37.3","depends_on_id":"dh-33jq.37","type":"parent-child","created_at":"2026-01-03T11:21:01.190747741Z","created_by":"graeme"}]}
{"id":"dh-33jq.37.4","title":"Compare HouseModeActor behavioural tests with TS version","description":"Review HouseModeActor tests against the equivalent TypeScript house mode logic tests. Identify any missing behavioural scenarios.\n\n## Where to Look\n\n### TS Implementations (check for untested behaviour)\n- packages/deep-heating-rx/src/lib/streams/houseModes.ts\n\n### Data Flow Docs\n- packages/deep-heating-rx/DATA-FLOW.md\n- packages/deep-heating-rx/docs/data-flow-rooms.md (Layer 6: House Mode Logic)\n\n### Key Behaviours\n- Auto mode: uses scheduled temperatures, allows adjustments\n- Sleeping mode: triggered by Goodnight button, reduces temps\n- Timer: 63s interval for re-evaluation\n\n### Gleam Tests\n- packages/deep_heating/test/house_mode_actor_test.gleam\n\n### Architecture\n- docs/gleam-actor-architecture.md (HouseModeActor section)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:21:01.298067447Z","created_by":"graeme","updated_at":"2026-01-03T11:46:22.478204756Z","closed_at":"2026-01-03T11:46:22.478204756Z","close_reason":"Comparison complete. Found 1 major gap: time-based sleep logic (auto-sleep before 3am, button validation after 8pm, 63s refresh timer). Created bead dh-yjba.","dependencies":[{"issue_id":"dh-33jq.37.4","depends_on_id":"dh-33jq.37","type":"parent-child","created_at":"2026-01-03T11:21:01.299115978Z","created_by":"graeme"}]}
{"id":"dh-33jq.37.5","title":"Compare StateAggregatorActor behavioural tests with TS version","description":"Review StateAggregatorActor tests against the equivalent TypeScript state aggregation logic tests.\n\n## TS Equivalent Found\nThe equivalent is `packages/deep-heating-state/src/lib/deep-heating-state.ts`:\n- `maintainState` function composes all DeepHeating streams into DeepHeatingState\n- `maintainRoomState` for per-room state\n- `maintainTrvState` for per-TRV state\n\n**No TS tests exist for this functionality!**\n\n## Gleam Coverage\nStateAggregatorActor has comprehensive tests for:\n- Actor startup\n- Subscribe/unsubscribe\n- Room updates\n- Multiple rooms\n- Throttled broadcasting\n\n## Conclusion\nGleam has BETTER test coverage than TS for state aggregation.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:21:01.408129052Z","created_by":"graeme","updated_at":"2026-01-03T11:49:55.426044179Z","closed_at":"2026-01-03T11:47:38.755026685Z","close_reason":"Comparison complete. StateAggregatorActor is a new Gleam-specific component without direct TS equivalent. Tests are comprehensive for actor behaviour. Integration gap (RoomActor not sending to it) already captured in dh-7t77.","dependencies":[{"issue_id":"dh-33jq.37.5","depends_on_id":"dh-33jq.37","type":"parent-child","created_at":"2026-01-03T11:21:01.409254013Z","created_by":"graeme"}]}
{"id":"dh-33jq.4","title":"Port temperature types to Gleam","description":"Port temperature types from TypeScript to Gleam.\n\n## Source Files\n- `packages/deep-heating-types/src/lib/temperature.ts`\n\n## TypeScript Types to Port\n```typescript\nexport const Temperature = Schema.Number.pipe(Schema.brand('Temperature'));\nexport const decodeTemperature = (value: number): Temperature =\u003e ...\nexport const MinimumRoomTargetTemperature = decodeTemperature(16);\nexport const MinimumTrvTargetTemperature = decodeTemperature(5);\n```\n\n## Gleam Implementation\n```gleam\npub opaque type Temperature {\n  Temperature(Float)\n}\n\npub fn temperature(value: Float) -\u003e Temperature {\n  Temperature(value)\n}\n\npub fn unwrap(temp: Temperature) -\u003e Float {\n  let Temperature(value) = temp\n  value\n}\n\npub const min_room_target: Temperature = Temperature(16.0)\npub const min_trv_target: Temperature = Temperature(5.0)\n```\n\n## Acceptance Criteria\n- [ ] Temperature is an opaque type (can't construct directly)\n- [ ] Smart constructor validates/creates temperatures\n- [ ] Constants for minimum values defined\n- [ ] Comparison functions work correctly","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:32:32.976172295Z","created_by":"graeme","updated_at":"2026-01-03T09:09:17.612577788Z","closed_at":"2026-01-02T19:00:56.344677Z","dependencies":[{"issue_id":"dh-33jq.4","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:32:32.977055274Z","created_by":"graeme"},{"issue_id":"dh-33jq.4","depends_on_id":"dh-33jq.3","type":"blocks","created_at":"2026-01-02T14:35:10.615547186Z","created_by":"graeme"}]}
{"id":"dh-33jq.5","title":"Port entity ID types to Gleam","description":"Port entity ID types from TypeScript to Gleam.\n\n## Source Files\n- `packages/deep-heating-types/src/lib/entities.ts`\n\n## TypeScript Types to Port\n```typescript\nexport const ClimateEntityId = Schema.String\n  .pipe(Schema.startsWith('climate.'))\n  .pipe(Schema.brand('ClimateEntityId'));\n\nexport const SensorEntityId = Schema.String\n  .pipe(Schema.startsWith('sensor.'))\n  .pipe(Schema.brand('SensorEntityId'));\n\nexport const GoodnightEntityId = Schema.Union(\n  Schema.String.pipe(Schema.startsWith('event.')),\n  Schema.String.pipe(Schema.startsWith('input_button.'))\n).pipe(Schema.brand('GoodnightEntityId'));\n```\n\n## Gleam Implementation\n```gleam\npub opaque type ClimateEntityId {\n  ClimateEntityId(String)\n}\n\npub fn climate_entity_id(id: String) -\u003e Result(ClimateEntityId, String) {\n  case string.starts_with(id, \"climate.\") {\n    True -\u003e Ok(ClimateEntityId(id))\n    False -\u003e Error(\"Climate entity ID must start with 'climate.'\")\n  }\n}\n```\n\n## Acceptance Criteria\n- [ ] All three entity ID types are opaque\n- [ ] Smart constructors validate prefix\n- [ ] Unwrap functions to get raw string\n- [ ] Parse functions return Result for invalid input","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:32:32.992248469Z","created_by":"graeme","updated_at":"2026-01-03T09:09:17.614460658Z","closed_at":"2026-01-02T19:00:56.376764Z","dependencies":[{"issue_id":"dh-33jq.5","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:32:32.993199689Z","created_by":"graeme"},{"issue_id":"dh-33jq.5","depends_on_id":"dh-33jq.3","type":"blocks","created_at":"2026-01-02T14:35:10.629298118Z","created_by":"graeme"}]}
{"id":"dh-33jq.6","title":"Port room/TRV state types to Gleam","description":"Port room and TRV state types from TypeScript to Gleam.\n\n## Source Files\n- `packages/deep-heating-types/src/lib/deep-heating-types.ts`\n\n## TypeScript Types to Port\n```typescript\nconst RadiatorState = Schema.Struct({\n  isHeating: Schema.Option(Schema.Boolean),\n  name: Schema.String,\n  temperature: Schema.OptionFromNullOr(TemperatureReading),\n  targetTemperature: Schema.Option(TemperatureReading),\n  desiredTargetTemperature: Schema.Option(TemperatureReading),\n});\n\nexport const RoomState = Schema.Struct({\n  name: Schema.String,\n  temperature: Schema.Option(TemperatureReading),\n  targetTemperature: Schema.Option(Temperature),\n  radiators: Schema.Array(RadiatorState),\n  mode: Schema.Option(RoomModeValue),\n  isHeating: Schema.Option(Schema.Boolean),\n  adjustment: Schema.Number,\n});\n\nexport const DeepHeatingState = Schema.Struct({\n  rooms: Schema.Array(RoomState),\n  isHeating: Schema.Option(Schema.Boolean),\n});\n```\n\n## Gleam Implementation\n```gleam\npub type TemperatureReading {\n  TemperatureReading(temperature: Temperature, time: Int)\n}\n\npub type RadiatorState {\n  RadiatorState(\n    name: String,\n    temperature: Option(TemperatureReading),\n    target_temperature: Option(TemperatureReading),\n    desired_target_temperature: Option(TemperatureReading),\n    is_heating: Option(Bool),\n  )\n}\n\npub type RoomState {\n  RoomState(\n    name: String,\n    temperature: Option(TemperatureReading),\n    target_temperature: Option(Temperature),\n    radiators: List(RadiatorState),\n    mode: Option(RoomMode),\n    is_heating: Option(Bool),\n    adjustment: Float,\n  )\n}\n\npub type DeepHeatingState {\n  DeepHeatingState(\n    rooms: List(RoomState),\n    is_heating: Option(Bool),\n  )\n}\n```\n\n## Acceptance Criteria\n- [ ] All state types defined as Gleam custom types\n- [ ] Option types used correctly for nullable fields\n- [ ] Types compose correctly (RoomState contains RadiatorState)\n- [ ] JSON encoding/decoding works for WebSocket messages","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:32:33.00802666Z","created_by":"graeme","updated_at":"2026-01-03T09:09:17.616275848Z","closed_at":"2026-01-02T19:00:56.406039Z","dependencies":[{"issue_id":"dh-33jq.6","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:32:33.008921269Z","created_by":"graeme"},{"issue_id":"dh-33jq.6","depends_on_id":"dh-33jq.4","type":"blocks","created_at":"2026-01-02T14:35:10.64298732Z","created_by":"graeme"},{"issue_id":"dh-33jq.6","depends_on_id":"dh-33jq.5","type":"blocks","created_at":"2026-01-02T14:35:10.656219446Z","created_by":"graeme"}]}
{"id":"dh-33jq.7","title":"Port schedule types to Gleam","description":"Port schedule types from TypeScript to Gleam.\n\n## Source Files\n- `packages/deep-heating-types/src/lib/schedule-types.ts`\n\n## TypeScript Types to Port\n```typescript\nconst DayScheduleEntry = Schema.Struct({\n  start: Schema.String,  // \"HH:MM\" format\n  targetTemperature: Temperature,\n});\n\nconst DaySchedule = Schema.Array(DayScheduleEntry);\n\nexport const WeekSchedule = Schema.Struct({\n  monday: DaySchedule,\n  tuesday: DaySchedule,\n  // ... etc\n});\n```\n\n## Gleam Implementation\n```gleam\npub type TimeOfDay {\n  TimeOfDay(hour: Int, minute: Int)\n}\n\npub type ScheduleEntry {\n  ScheduleEntry(start: TimeOfDay, target_temperature: Temperature)\n}\n\npub type DaySchedule = List(ScheduleEntry)\n\npub type WeekSchedule {\n  WeekSchedule(\n    monday: DaySchedule,\n    tuesday: DaySchedule,\n    wednesday: DaySchedule,\n    thursday: DaySchedule,\n    friday: DaySchedule,\n    saturday: DaySchedule,\n    sunday: DaySchedule,\n  )\n}\n\npub fn get_scheduled_temperature(\n  schedule: WeekSchedule,\n  now: DateTime,\n) -\u003e Temperature\n```\n\n## Acceptance Criteria\n- [ ] TimeOfDay type for \"HH:MM\" times\n- [ ] WeekSchedule with all 7 days\n- [ ] Function to get current scheduled temperature\n- [ ] Handles schedule transitions correctly","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:32:33.024049904Z","created_by":"graeme","updated_at":"2026-01-03T09:09:17.618058647Z","closed_at":"2026-01-02T19:00:56.435344Z","dependencies":[{"issue_id":"dh-33jq.7","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:32:33.024890862Z","created_by":"graeme"},{"issue_id":"dh-33jq.7","depends_on_id":"dh-33jq.4","type":"blocks","created_at":"2026-01-02T14:35:10.67010415Z","created_by":"graeme"}]}
{"id":"dh-33jq.8","title":"Port mode types to Gleam","description":"Port mode types (HouseMode, RoomMode, HvacMode) from TypeScript to Gleam.\n\n## Source Files\n- `packages/deep-heating-types/src/lib/deep-heating-types.ts`\n- `packages/deep-heating-types/src/lib/home-assistant.ts`\n\n## TypeScript Types to Port\n```typescript\nexport const HouseModeValue = Schema.Literal('Auto', 'Sleeping');\nexport const RoomModeValue = Schema.Literal('Off', 'Auto', 'Sleeping');\n\n// From home-assistant.ts\nexport const ClimateMode = Schema.Literal('off', 'heat', 'auto', 'unknown');\nexport const OperationalClimateMode = Schema.Literal('off', 'heat', 'auto');\n```\n\n## Gleam Implementation\n```gleam\npub type HouseMode {\n  HouseModeAuto\n  HouseModeSleeping\n}\n\npub type RoomMode {\n  RoomModeOff\n  RoomModeAuto\n  RoomModeSleeping\n}\n\npub type HvacMode {\n  HvacOff\n  HvacHeat\n  HvacAuto\n}\n```\n\n## Acceptance Criteria\n- [ ] All mode enums defined as Gleam custom types\n- [ ] Conversion functions between related modes\n- [ ] String serialization for HA API calls\n- [ ] Pattern matching works for all variants","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:32:33.040295489Z","created_by":"graeme","updated_at":"2026-01-03T09:09:17.619834177Z","closed_at":"2026-01-02T19:00:56.465431Z","dependencies":[{"issue_id":"dh-33jq.8","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:32:33.041148008Z","created_by":"graeme"},{"issue_id":"dh-33jq.8","depends_on_id":"dh-33jq.3","type":"blocks","created_at":"2026-01-02T14:35:10.684846772Z","created_by":"graeme"}]}
{"id":"dh-33jq.9","title":"Set up OTP supervision tree","description":"Set up the OTP supervision tree for Deep Heating.\n\n## Architecture Reference\nSee `docs/gleam-actor-architecture.md` for full supervision tree diagram.\n\n## Supervision Tree Structure\n```\nDeepHeatingSupervisor (one_for_one)\n├── HomeAssistantSupervisor (one_for_all)\n│   ├── HaPollerActor\n│   └── HaCommandActor\n├── HouseModeActor\n├── RoomsSupervisor (one_for_one, dynamic)\n│   └── RoomSupervisor(room_name) per room\n├── StateAggregatorActor\n└── WebSocketSupervisor (simple_one_for_one)\n```\n\n## Implementation\n```gleam\nimport gleam/otp/supervisor.{Spec}\n\npub fn start() -\u003e Result(Subject(Msg), StartError) {\n  supervisor.start_spec(supervisor.Spec(\n    argument: Nil,\n    init: fn(_) {\n      supervisor.Init(\n        state: Nil,\n        strategy: supervisor.OneForOne,\n        children: [\n          supervisor.worker(ha_supervisor.start),\n          supervisor.worker(house_mode.start),\n          supervisor.supervisor(rooms_supervisor.start),\n          supervisor.worker(state_aggregator.start),\n          supervisor.supervisor(websocket_supervisor.start),\n        ],\n      )\n    },\n  ))\n}\n```\n\n## Acceptance Criteria\n- [ ] Top-level supervisor starts successfully\n- [ ] Child supervisors start in correct order\n- [ ] Supervisor restarts crashed children\n- [ ] Can query supervisor for child PIDs","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:33:14.715838527Z","created_by":"graeme","updated_at":"2026-01-03T09:09:17.621617186Z","closed_at":"2026-01-02T19:32:06.966129Z","dependencies":[{"issue_id":"dh-33jq.9","depends_on_id":"dh-33jq","type":"parent-child","created_at":"2026-01-02T14:33:14.722496766Z","created_by":"graeme"},{"issue_id":"dh-33jq.9","depends_on_id":"dh-33jq.6","type":"blocks","created_at":"2026-01-02T14:35:10.698528623Z","created_by":"graeme"},{"issue_id":"dh-33jq.9","depends_on_id":"dh-33jq.8","type":"blocks","created_at":"2026-01-02T14:35:10.712897991Z","created_by":"graeme"}]}
{"id":"dh-3h2","title":"Verify turbo cache is working correctly with E2E tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-03T18:44:22.535134Z","updated_at":"2025-12-03T18:50:44.762362Z","closed_at":"2025-12-03T18:50:44.762362Z"}
{"id":"dh-3pc","title":"Investigate spurious Docker image build on non-release merge","description":"GitHub Actions run https://github.com/GraemeF/home-automation/actions/runs/20032581827 built Docker images even though there was no release. The workflow should only build images when a release PR is merged (one that updates package versions via changesets). Need to investigate the trigger conditions and fix the workflow to prevent unnecessary image builds.","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-08T15:12:48.439797Z","updated_at":"2025-12-08T15:12:48.439797Z","dependencies":[{"issue_id":"dh-3pc","depends_on_id":"dh-i01m","type":"parent-child","created_at":"2025-12-29T16:53:55.613877Z","created_by":"daemon"}]}
{"id":"dh-3r6","title":"Create bun-pruned.nix for dependency management","description":"## Task\nCreate Nix derivation for Bun dependencies that can be cached and shared.\n\n## Purpose\n- Extract production dependencies from bun.lock\n- Create fixed-output derivation for caching\n- Enable reproducible builds without network access\n\n## Reference\n- automatarr/bun-pruned.nix\n- This is auto-generated from bun.lock\n\n## Integration\n- Pre-commit hook to regenerate when bun.lock changes\n- Import into flake.nix for builds","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:45.308801827Z","updated_at":"2026-01-02T14:31:00.055401792Z","closed_at":"2025-11-29T14:51:19.452764Z","dependencies":[{"issue_id":"dh-3r6","depends_on_id":"dh-7rz","type":"blocks","created_at":"2025-11-25T07:15:50.612672212Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-3vs","title":"Update scripts and verify builds with Bun","description":"## Task\nEnsure all npm scripts work correctly with bun and verify the full build pipeline.\n\n## Verification Steps\n1. `bun run build` - all packages build successfully\n2. `bun run test` - all tests pass\n3. `bun run lint` - linting works\n4. `bun run dev` - dev servers start correctly\n5. Manual smoke test of web UI\n\n## Notes\n- Most scripts should work unchanged\n- Watch for any npm-specific behaviours in scripts\n- Update any scripts that shell out to npm directly","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:12:29.729974266Z","updated_at":"2025-11-25T07:49:21.373612057Z","closed_at":"2025-11-25T07:49:21.373612057Z","dependencies":[{"issue_id":"dh-3vs","depends_on_id":"dh-1kv","type":"blocks","created_at":"2025-11-25T07:13:21.177791972Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-3zy","title":"Add workflow to auto-sync bun-deep-heating.nix when bun.lock changes","description":"## Task\nPort the sync-bun-pruned-nix.yml workflow from automatarr to home-automation.\n\n## What it does\nWhen bun.lock is pushed (e.g., by Renovate), automatically:\n1. Regenerate bun-deep-heating.nix using turbo prune + bun2nix\n2. If changed, commit and push with [skip ci]\n\n## Reference\nSee automatarr/.github/workflows/sync-bun-pruned-nix.yml\n\n## Differences from automatarr\n- Use GitHub-hosted runners (not homelab)\n- Use turbo prune flow instead of Nix flake outputs\n- Skip Attic cache integration\n- Only one nix file to regenerate (bun-deep-heating.nix)\n\n## Implementation\n1. Create .github/workflows/sync-bun-nix.yml\n2. Trigger on push to bun.lock\n3. Run turbo prune + bun2nix\n4. Commit and push if changed","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T10:51:03.083673Z","updated_at":"2025-11-29T13:54:57.677384Z","closed_at":"2025-11-29T13:54:57.677384Z"}
{"id":"dh-44d4","title":"Add HeatingSystem as Effect Service (Context.Tag)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T16:19:44.961935Z","created_by":"graemefoster","updated_at":"2025-12-29T16:24:37.35028Z","closed_at":"2025-12-29T16:24:37.35028Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-44d4","depends_on_id":"dh-amoo","type":"blocks","created_at":"2025-12-29T16:19:54.724296Z","created_by":"daemon"}]}
{"id":"dh-44x","title":"Migrate Svelte components to runes syntax","description":"-","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-01T18:10:51.599325Z","updated_at":"2025-12-01T18:37:34.153672Z","closed_at":"2025-12-01T18:37:34.153672Z"}
{"id":"dh-469","title":"Make CI build job depend on nix lockfile validation","description":"Currently the build job runs in parallel with validate-nix. If validate-nix fails, build gets cancelled mid-run which wastes CI time. Make build depend on validate-nix so it only starts after lockfile validation passes.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-03T18:06:58.884889Z","updated_at":"2025-12-08T14:36:57.386291Z","closed_at":"2025-12-08T14:36:57.386291Z"}
{"id":"dh-49v","title":"Add pre-commit hook for nix lockfile regeneration","description":"## Goal\n\nCatch nix lockfile drift locally before it hits CI.\n\n## Why\n\nCurrently if a developer changes `bun.lock` and forgets to regenerate `bun-deep-heating.nix`, the CI workflow has to do it. This adds ~2 minutes to PR validation. A pre-commit hook would catch this immediately.\n\n## Expected Outcome\n\n- When `bun.lock` is staged for commit, the hook checks if `bun-deep-heating.nix` needs updating\n- If so, regenerate it and stage the updated file\n- Only runs when relevant files change (conditional execution)\n- Fast enough (~1 second) that caching isn't necessary","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-10T21:10:14.50095Z","updated_at":"2025-12-10T21:10:14.50095Z","dependencies":[{"issue_id":"dh-49v","depends_on_id":"dh-9so","type":"blocks","created_at":"2025-12-10T21:10:20.346197Z","created_by":"daemon"},{"issue_id":"dh-49v","depends_on_id":"dh-i01m","type":"parent-child","created_at":"2025-12-29T16:53:55.428558Z","created_by":"daemon"}]}
{"id":"dh-4do9","title":"HouseModeActor: Add 63-second auto-timer for mode re-evaluation","description":"The TypeScript houseModes.ts uses a 63-second timer to periodically re-evaluate house mode:\n\n```typescript\ntimer(0, refreshIntervalSeconds * 1000)  // refreshIntervalSeconds = 63\n```\n\nThe Gleam HouseModeActor now has:\n- ReEvaluateMode message that recalculates mode based on current time\n- Time-based logic (before 3am = Sleeping, after 3am = Auto, button after 8pm = Sleeping)\n\nMissing:\n- Automatic timer that sends ReEvaluateMode every 63 seconds\n- Should start on actor init using process.send_after\n- Should reschedule after each ReEvaluateMode handling\n\nThis enables automatic transitions (e.g., from Sleeping to Auto when clock passes 3am).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T14:43:14.517309675Z","created_by":"graeme","updated_at":"2026-01-03T15:10:16.621571549Z","closed_at":"2026-01-03T15:10:16.621571549Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-4do9","depends_on_id":"dh-33jq","type":"blocks","created_at":"2026-01-03T14:43:28.050911772Z","created_by":"graeme"}]}
{"id":"dh-4wu2","title":"Wire room adjuster callback to RoomActors","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-04T12:56:27.831590445Z","created_by":"graeme","updated_at":"2026-01-04T12:56:27.831590445Z","dependencies":[{"issue_id":"dh-4wu2","depends_on_id":"dh-33jq.24","type":"blocks","created_at":"2026-01-04T12:56:34.818384153Z","created_by":"graeme"}]}
{"id":"dh-4xrn","title":"RoomActor: Implement schedule-based target calculation","description":"The Gleam RoomActor has a schedule field but never uses it. The TypeScript version has complex schedule calculation in roomScheduledTargetTemperatures.ts with:\n\n- Ramp-up calculation based on schedule entries\n- 60-second refresh interval\n\nNeed to implement getScheduledTargetTemperature equivalent that calculates the scheduled target based on the current time and the room's schedule.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:42:30.290581119Z","created_by":"graeme","updated_at":"2026-01-04T10:15:06.191343625Z","closed_at":"2026-01-04T10:15:06.191343625Z","close_reason":"Implemented timer-based schedule refresh: RoomActor now recomputes target temperature every 60 seconds (configurable) using the schedule module. Uses injectable time provider for testing."}
{"id":"dh-597","title":"Create Effect Stream ↔ RxJS Observable adapters","description":"## Overview\nCreate adapter functions in the rxx package to convert between Effect Streams and RxJS Observables.\n\n## Adapters Needed\n\n### Effect Stream → RxJS Observable\n```typescript\n// Option 1: Via AsyncIterable (cleanest, needs RxJS 7+)\nexport const streamToObservable = \u003cA, E\u003e(\n  stream: Stream\u003cA, E\u003e,\n  runtime: Runtime.Runtime\u003cnever\u003e\n): Observable\u003cA\u003e =\u003e from(Stream.toAsyncIterable(stream))\n\n// Option 2: Manual subscription\nexport const streamToObservable = \u003cA, E, R\u003e(\n  stream: Stream\u003cA, E, R\u003e,\n  runtime: Runtime.Runtime\u003cR\u003e\n): Observable\u003cA\u003e =\u003e new Observable(subscriber =\u003e {\n  const fiber = Effect.runFork(\n    Stream.runForEach(stream, a =\u003e Effect.sync(() =\u003e subscriber.next(a))),\n    { runtime }\n  )\n  return () =\u003e Effect.runFork(Fiber.interrupt(fiber))\n})\n```\n\n### RxJS Observable → Effect Stream\n```typescript\nexport const observableToStream = \u003cA\u003e(\n  observable: Observable\u003cA\u003e\n): Stream\u003cA, Error\u003e =\u003e Stream.async\u003cA, Error\u003e(emit =\u003e {\n  const subscription = observable.subscribe({\n    next: a =\u003e emit.single(a),\n    error: e =\u003e emit.fail(e instanceof Error ? e : new Error(String(e))),\n    complete: () =\u003e emit.end()\n  })\n  return Effect.sync(() =\u003e subscription.unsubscribe())\n})\n```\n\n## Dependencies\n- Requires dh-apg (RxJS upgrade) for cleanest AsyncIterable approach\n\n## Files to Change\n- packages/rxx/src/lib/rxx.ts (or new file adapters.ts)\n- packages/rxx/package.json (add effect dependency)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T11:50:24.899088Z","updated_at":"2025-11-30T13:48:10.306003Z","closed_at":"2025-11-30T13:48:10.306003Z","dependencies":[{"issue_id":"dh-597","depends_on_id":"dh-apg","type":"blocks","created_at":"2025-11-30T11:50:29.403035Z","created_by":"daemon"}]}
{"id":"dh-5jty","title":"Add ConnectionState enum for richer connection status","description":"The connection overlay currently uses a simple Bool for connected status. The original spec suggested a ConnectionState enum with Connected, Disconnected, and Reconnecting variants for richer UX. This would show 'Reconnecting...' with different styling during reconnection attempts. Low priority - only worth doing if we implement reconnection logic in the WebSocket handler.","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-04T13:06:33.894470788Z","created_by":"graeme","updated_at":"2026-01-04T13:07:06.068569323Z"}
{"id":"dh-5k0","title":"Expose Playwright test results in GitHub Actions","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-03T17:50:10.913843Z","updated_at":"2025-12-03T18:00:08.272333Z","closed_at":"2025-12-03T18:00:08.272333Z","dependencies":[{"issue_id":"dh-5k0","depends_on_id":"dh-am1","type":"blocks","created_at":"2025-12-03T17:50:19.906152Z","created_by":"daemon"}]}
{"id":"dh-5k1","title":"Enable @typescript-eslint/explicit-function-return-type","description":"Enable the `@typescript-eslint/explicit-function-return-type` ESLint rule to require explicit return type annotations on functions.\n\n## Why This Matters\nThe temperature.ts bug (dh-d0s) was caused by TypeScript inferring a union type that included an Effect, and this wasn't caught because:\n1. No explicit return type was declared\n2. TypeScript allows `\u003e` and `\u003c` operators on any values\n\nIf we had explicit return types, TypeScript would ERROR when the inferred type doesn't match the declared type.\n\n## Example\n```typescript\n// Without return type - silently infers wrong union type\nconst getTemperatureFromRoom = (room: {...}) =\u003e\n  pipe(room.temperature, Option.getOrElse(() =\u003e VeryHot));  // Returns { temperature: T } | Effect\u003c...\u003e\n\n// With return type - TypeScript ERROR\\!\nconst getTemperatureFromRoom = (room: {...}): { temperature: Temperature } =\u003e\n  pipe(room.temperature, Option.getOrElse(() =\u003e VeryHot));  // TS2322: Type '... | Effect\u003c...\u003e' is not assignable\n```\n\n## Implementation\n1. Change `'@typescript-eslint/explicit-function-return-type': 'off'` to `'error'` in eslint.config.mjs\n2. Consider using `allowExpressions: true` to allow arrow functions in callbacks\n3. Fix all violations (add return types to functions)\n\n## Current State\nBoth rules are disabled:\n- `@typescript-eslint/explicit-function-return-type: 'off'`\n- `@typescript-eslint/explicit-module-boundary-types: 'off'`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-03T16:17:08.057254Z","updated_at":"2025-12-03T16:17:15.371347Z","closed_at":"2025-12-03T16:17:15.371347Z"}
{"id":"dh-5re","title":"Exclude .beads/ from CI workflow triggers","description":"## Problem\nCommits that only change `.beads/` files (issue tracking) unnecessarily trigger CI workflows, wasting compute resources.\n\n## Solution\nAdd path exclusion filters to CI workflows so they don't run when only `.beads/**` files change.\n\n## Files to update\n- `.github/workflows/ci.yml`\n- Any other workflows that shouldn't run for beads-only changes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-28T19:09:32.928277Z","updated_at":"2025-11-29T08:39:43.971954Z","closed_at":"2025-11-29T08:39:43.971954Z"}
{"id":"dh-5rw","title":"Migrate deep-heating-rx tests to Bun","description":"## Task\nMigrate all tests in packages/deep-heating-rx from Jest to Bun native.\n\n## Steps\n1. Update test file imports to use buntest\n2. Convert Jest-specific patterns:\n   - `describe/it/expect` → Bun equivalents\n   - `jest.fn()` → `mock()`\n   - `jest.spyOn()` → Bun spy equivalent\n3. Convert Effect tests to use `it.effect()`\n4. Update package.json test script\n5. Remove Jest config\n\n## Files\nThis package has the most tests - treat as the main migration reference.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:32.502838683Z","updated_at":"2026-01-02T14:31:00.036170697Z","closed_at":"2025-11-30T10:58:21.43315Z","dependencies":[{"issue_id":"dh-5rw","depends_on_id":"dh-659","type":"blocks","created_at":"2025-11-25T07:14:39.525817975Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-5rx","title":"Expand Effect library usage","description":"## Overview\n**This is now a tracking/parent issue.** The actual work has been broken into sub-tasks.\n\n## Sub-tasks\n- dh-0ia: Replace dotenv with Effect Config in socketio\n- dh-n86: Add tagged error types with Effect.catchTag  \n- dh-1yg: Add Effect Schedule for polling intervals (depends on dh-n86)\n- dh-2mm: Add Effect.withSpan for observability\n- dh-7zk: Expand Layer-based DI to socketio server (depends on dh-0ia)\n\n## Original Scope\nUpdate Effect library usage throughout the codebase, following patterns established in automatarr.\n\n## Completion Criteria\nClose this issue when all sub-tasks are complete.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:14:57.343388698Z","updated_at":"2026-01-02T14:31:00.057591054Z","dependencies":[{"issue_id":"dh-5rx","depends_on_id":"dh-gno","type":"blocks","created_at":"2025-11-25T07:15:01.655005736Z","created_by":"daemon","metadata":"{}"},{"issue_id":"dh-5rx","depends_on_id":"dh-0ia","type":"blocks","created_at":"2025-11-30T11:41:19.824189Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-1yg","type":"blocks","created_at":"2025-11-30T11:41:19.860752Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-n86","type":"blocks","created_at":"2025-11-30T11:41:19.898286Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-2mm","type":"blocks","created_at":"2025-11-30T11:41:19.935043Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-7zk","type":"blocks","created_at":"2025-11-30T11:41:19.972188Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-aah","type":"blocks","created_at":"2025-11-30T11:58:13.058841Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-klx","type":"blocks","created_at":"2025-11-30T11:58:13.09534Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-6wp","type":"blocks","created_at":"2025-11-30T11:58:13.13298Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-1z5","type":"blocks","created_at":"2025-11-30T11:58:13.170554Z","created_by":"daemon"}]}
{"id":"dh-5xw","title":"Optimise CI workflow: avoid duplicate builds","description":"The CI workflow builds packages twice - once in the 'build' job and again in the 'e2e' job. We should cache or share build artifacts between jobs to avoid redundant work and speed up CI.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-03T18:08:16.03113Z","updated_at":"2025-12-08T14:36:57.396876Z","closed_at":"2025-12-08T14:36:57.396876Z"}
{"id":"dh-659","title":"Integrate buntest package from eventsourcing repo","description":"## Task\nIntegrate buntest package from eventsourcing repo for Effect test integration.\n\n## Dependency\nThis depends on the buntest-equivalent package being published from the eventsourcing repo. Once available, add it as a workspace dependency.\n\n## Steps\n1. Wait for buntest package to be published from eventsourcing repo\n2. Add as dependency: `bun add -D @\u003cscope\u003e/buntest`\n3. Verify it provides required features:\n   - `it.effect()` for Effect-native test assertions\n   - Proper Effect runtime management per test\n   - Integration with Bun's expect API\n4. Update any test utilities documentation\n\n## Blocked By\nExternal: buntest package publication from eventsourcing repo","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:32.367784892Z","updated_at":"2026-01-02T14:31:00.048648153Z","closed_at":"2025-11-30T10:28:18.996811Z","dependencies":[{"issue_id":"dh-659","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:14:39.511441216Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-68e","title":"Fix Renovate warnings from dashboard","description":"Address Renovate warnings shown on the dashboard. See: https://github.com/GraemeF/home-automation/issues/163","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T10:25:42.423953Z","updated_at":"2025-11-29T18:47:57.195228Z","closed_at":"2025-11-29T18:47:57.195228Z"}
{"id":"dh-6db","title":"Investigate other blocking streams in trvActions preventing TRV commands","description":"## Summary\n\nAfter fixing trvScheduledTargetTemperatures (dh-d41), all 6 TRVs now emit scheduled temperatures. However, only lounge and office TRVs are receiving actual heat commands. \n\nThe trvActions combineLatest waits for 4 streams per TRV:\n- trvDesiredTargetTemperatures\n- trvControlStates  \n- trvTemperatures\n- trvScheduledTargetTemperatures ✅ (now fixed)\n\nOne or more of the other 3 streams may have the same combineLatest blocking pattern that was fixed in trvScheduledTargetTemperatures.\n\n## Investigation needed\n\nCheck if these streams use combineLatest with a single source that only holds the latest value:\n- trvDesiredTargetTemperatures (from trvDecisionPoints)\n- trvControlStates (from heatingProvider)\n- trvTemperatures (from heatingProvider)\n\n## Related\n- dh-d41 (fixed trvScheduledTargetTemperatures)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-10T07:58:06.762284Z","updated_at":"2025-12-10T08:13:43.201841Z","closed_at":"2025-12-10T08:13:43.201841Z"}
{"id":"dh-6uu","title":"Root format:check and turbo format are inconsistent","description":"The root format:check script uses 'prettier --check .' which checks all files including .changeset/, but 'turbo format' only formats files within packages.\n\nThis means files like .changeset/pre.json can fail CI format checks but won't be fixed by running turbo format.\n\nOptions:\n1. Add a root 'format' script that runs prettier on root-level files\n2. Exclude .changeset from format:check\n3. Add .changeset formatting to an existing package's format script","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-02T19:04:02.399278Z","updated_at":"2025-12-13T09:02:04.45241Z","closed_at":"2025-12-13T09:02:04.45241Z"}
{"id":"dh-6wp","title":"Replace rxjs-multi-scan with Effect patterns","description":"Migrate deep-heating-state from rxjs-multi-scan to Effect patterns.\n\nFile to migrate:\n- packages/deep-heating-state/src/lib/deep-heating-state.ts\n\nThe multiScan operator combines multiple observables into a single state. Options:\n1. SubscriptionRef with multiple update sources\n2. Effect Stream combinators (mergeAll, zipAll)\n3. Custom scan over merged streams\n\nThis removes the rxjs-multi-scan dependency and moves us closer to full Effect adoption.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T11:57:57.55187Z","updated_at":"2025-11-30T17:37:19.465179Z","closed_at":"2025-11-30T17:37:19.465179Z"}
{"id":"dh-6xb","title":"Replace custom turbo FOD with nixpkgs package","description":"The flake.nix has ~50 lines of custom turboFod derivation (lines 28-79) that manually fetches turbo via bun and extracts the binary.\n\nnixpkgs already has 'turbo' and 'turbo-unwrapped' packages at the version we need (2.6.1). The pkgs.turbo wrapper disables telemetry and update notifications by default - perfect for reproducible Nix builds.\n\nReplace turboFod usage in:\n- prunedWorkspace (line 107)\n- deep-heating build phase (line 237)\n- generateBunNixDeepHeating (lines 191, 195)\n\nMay need to update nixpkgs input if the pinned version has an older/broken turbo.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-26T18:56:58.062400889Z","updated_at":"2025-11-27T07:59:18.632023829Z","closed_at":"2025-11-26T21:03:11.268555Z"}
{"id":"dh-76l","title":"Changeset file cleanup fails with HTTP 422 Invalid tree info","description":"The 'Delete consumed changeset files' step in release.yml is failing with 'gh: Invalid tree info (HTTP 422)' when calling the Git Trees API. This causes changeset .md files to remain on the changeset-release/main branch after they've been consumed by changeset version.\n\n**Impact:**\n1. Changeset files aren't deleted from the PR branch\n2. After a version packages PR is merged, orphaned changeset files remain on main\n3. The next release workflow run sees these orphans and creates another version packages PR\n4. Results in ghost/duplicate PRs like #1213 (closed as stale)\n\n**Failed runs:**\n- 20099487471 (PR #1211)\n- 20099316616 (PR #1210)\n- 20091290236 (PR #1208)\n\nAll fail at the same step with the same error.\n\n**Root cause investigation needed:**\n- The jq filter creates NEW_TREE by removing .changeset/*.md files (except README.md)\n- The gh api call to repos/REPO/git/trees fails with HTTP 422\n- Need to debug what's wrong with the tree payload being sent\n\n**Workaround:**\nManually delete the orphaned changeset files from main after each release.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-10T14:37:00.751554Z","updated_at":"2025-12-10T17:46:14.96478Z","closed_at":"2025-12-10T17:46:14.96478Z"}
{"id":"dh-7eae","title":"HaCommandActor: Add debouncing for TRV actions (5s per entity)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T12:52:12.655601929Z","created_by":"graeme","updated_at":"2026-01-03T14:24:02.742808346Z","closed_at":"2026-01-03T14:24:02.742808346Z","close_reason":"Already implemented - HaCommandActor has per-TRV and heating debouncing with comprehensive tests","dependencies":[{"issue_id":"dh-7eae","depends_on_id":"dh-33jq.17","type":"blocks","created_at":"2026-01-03T12:52:19.408205472Z","created_by":"graeme"}]}
{"id":"dh-7fzk","title":"Add tests for server.gleam WebSocket handler","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-04T12:56:27.68775011Z","created_by":"graeme","updated_at":"2026-01-04T12:56:27.68775011Z","dependencies":[{"issue_id":"dh-7fzk","depends_on_id":"dh-33jq.24","type":"blocks","created_at":"2026-01-04T12:56:34.798572069Z","created_by":"graeme"}]}
{"id":"dh-7rz","title":"Create flake.nix for reproducible builds","description":"## Task\nCreate Nix flake configuration for the monorepo.\n\n## Design (2025-11-25)\n\n### Approach\nFull Nix build replicating automatarr's pattern:\n- bun2nix for dependency management\n- turbo prune for workspace isolation\n- Single combined derivation for both apps\n- s6-overlay for process management in Docker\n\n### Inputs\n- nixpkgs (nixos-unstable)\n- bun2nix (github:baileyluTCD/bun2nix)\n\n### Dependency Management\n- turbo FOD: Platform-specific turbo binary (2.6.1)\n- Pruned workspace: `turbo prune deep-heating-socketio @home-automation/deep-heating-web --docker`\n- bun-deep-heating.nix: Generated from pruned lockfile, checked into git\n\n### Build Derivation\n- Single `deep-heating` derivation using bun2nix mkDerivation\n- Turbo builds all packages in dependency order\n- Bundle socketio backend with `bun build` (single file)\n- Copy SvelteKit build output (.svelte-kit/output)\n\n### Docker Image\n- `dockerTools.buildLayeredImage`\n- Contents: deep-heating + nginx + s6-overlay + binSh\n- s6 services: nginx (serves static + proxy) + socketio backend\n- Estimated size: ~80-100MB (vs ~200MB+ current)\n\n### Dev Shell\n- Bun, Git, Docker\n- Works on macOS and Linux\n- `nix develop` for consistent environment\n\n### Files to Create\n- flake.nix - Main flake\n- bun.nix - Full lockfile deps (CI validation)\n- bun-deep-heating.nix - Pruned deps (builds)\n\n### Reference\n- automatarr/flake.nix for structure","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:45.193162353Z","updated_at":"2025-11-26T18:29:45.412297732Z","closed_at":"2025-11-26T18:29:41.466754291Z","dependencies":[{"issue_id":"dh-7rz","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:15:50.598603433Z","created_by":"daemon","metadata":"{}"},{"issue_id":"dh-7rz","depends_on_id":"dh-s6c","type":"blocks","created_at":"2025-11-25T18:43:56.923192Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-7sjo","title":"TRV reliability and error handling","description":"## Overview\nImprove reliability of TRV control through better error handling, retries, and state tracking.\n\n## Goals\n- Track pending TRV actions and confirm when applied\n- Implement retry logic with backoff for failed actions\n- Add proper error handling to RxJS subscriptions\n- Fix timer bugs affecting temperature calculations\n\n## Child Issues\n- dh-2p9: Track pending TRV actions until confirmed by HA poll\n- dh-d73: Retry failed TRV actions with exponential backoff\n- dh-js6: Add error handlers to all RxJS subscriptions in DeepHeating.ts\n- dh-d5q: TRV target temperature timer only recalculates last TRV\n- dh-jjs: Share single timer across all TRV scheduled temperature groups","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-29T16:53:14.128277Z","created_by":"graemefoster","updated_at":"2025-12-29T16:53:14.128277Z"}
{"id":"dh-7t77","title":"RoomActor: Add StateAggregator notifications","description":"The RoomActor constructor takes a state_aggregator Subject but never sends to it. The notify_state_changed function only notifies the decision_actor.\n\nNeed to add StateAggregator notifications so the UI can receive room state updates. Should call process.send(state.state_aggregator, RoomUpdated(state.room.name, state.room)) on state changes.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:42:30.400030531Z","created_by":"graeme","updated_at":"2026-01-04T09:36:41.529848387Z","closed_at":"2026-01-04T09:36:41.529848387Z","close_reason":"Closed"}
{"id":"dh-7vu","title":"Add panel_icon to config.yaml","status":"closed","priority":3,"issue_type":"task","created_at":"2025-11-30T17:55:41.285232Z","updated_at":"2025-12-13T09:09:42.974181Z","closed_at":"2025-12-13T09:09:42.974181Z"}
{"id":"dh-7xh","title":"Document Effect patterns and conventions","description":"## Overview\nDocument Effect patterns and conventions for the team, including RxJS migration mappings.\n\n## Content to Document\n\n### RxJS → Effect Stream Operator Mapping\n\n| RxJS | Effect Stream | Notes |\n|------|---------------|-------|\n| `combineLatest` | `Stream.zipLatest` / `Stream.zipLatestWith` / `Stream.zipLatestAll` | Direct equivalent! |\n| `merge` | `Stream.merge` / `Stream.mergeWith` | ✅ |\n| `concat` | `Stream.concat` / `Stream.concatAll` | ✅ |\n| `zip` | `Stream.zip` / `Stream.zipWith` / `Stream.zipAll` | ✅ |\n| `map` | `Stream.map` | ✅ |\n| `filter` | `Stream.filter` | ✅ |\n| `mergeMap/flatMap` | `Stream.flatMap` | ✅ |\n| `concatMap` | `Stream.flatMap(..., { concurrency: 1 })` | ✅ |\n| `switchMap` | `Stream.flatMap(..., { switch: true })` | ✅ |\n| `scan` | `Stream.scan` | ✅ |\n| `debounceTime` | `Stream.debounce` | ✅ |\n| `throttleTime` | `Stream.throttle` | ✅ |\n| `take` | `Stream.take` | ✅ |\n| `takeUntil` | `Stream.takeUntil` | ✅ |\n| `takeWhile` | `Stream.takeWhile` | ✅ |\n| `distinctUntilChanged` | `Stream.changes` / `Stream.changesWith` | ✅ |\n| `groupBy` | `Stream.groupByKey` / `Stream.groupBy` | ✅ |\n| `share` | `Stream.share` | ✅ |\n| `shareReplay` | `Stream.broadcast` / `Stream.broadcastDynamic` | ✅ |\n| `startWith` | Compose with `Stream.concat` | ⚠️ |\n| `withLatestFrom` | Custom implementation needed | ⚠️ |\n| `exhaustMap` | Not available | ❌ |\n\n### Subject → Effect Equivalents\n\n| RxJS | Effect | Notes |\n|------|--------|-------|\n| `BehaviorSubject` | `SubscriptionRef` | Has `.changes` stream + current value |\n| `Subject` | `PubSub` | Broadcast to all subscribers |\n| `ReplaySubject(1)` | `SubscriptionRef` | Same as BehaviorSubject |\n\n### Effect Patterns Used in Codebase\n- Schema for all domain types\n- Layer/Context.Tag for dependency injection\n- Config for environment variables\n- Effect.gen for async composition\n- Stream for reactive data flows\n\n## Files to Create\n- docs/effect-patterns.md or similar","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:57.655023309Z","updated_at":"2026-01-02T14:31:00.033786383Z","dependencies":[{"issue_id":"dh-7xh","depends_on_id":"dh-c34","type":"blocks","created_at":"2025-11-25T07:15:01.697606001Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-7zk","title":"Expand Layer-based DI to socketio server","description":"## Overview\nExtend the Layer-based dependency injection pattern from home-assistant-api to the socketio server.\n\n## Current State\n- home-assistant-api.ts has proper Layer/Context.Tag patterns\n- server.ts creates services manually without DI\n- Hard to test server components in isolation\n\n## Target State\n- Define Context.Tag services for server components\n- Use Layer composition to build the server\n- Enable easier testing with mock layers\n\n## Files to Change\n- packages/deep-heating-socketio/src/server.ts\n- Potentially new files for service definitions\n\n## Dependencies\n- Should be done after Config migration (dh-0ia) since config will be a Layer","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T11:41:11.239156Z","updated_at":"2025-11-30T11:41:11.239156Z","dependencies":[{"issue_id":"dh-7zk","depends_on_id":"dh-0ia","type":"blocks","created_at":"2025-11-30T11:41:15.081541Z","created_by":"daemon"}]}
{"id":"dh-821","title":"Set up GitHub App for release workflow","description":"## Task\nCreate and configure a GitHub App for the changesets release workflow to create verified commits.\n\n## Steps\n1. Create GitHub App at https://github.com/settings/apps/new\n2. Configure permissions:\n   - **Contents**: Read \u0026 write (to commit version bumps)\n   - **Pull requests**: Read \u0026 write (to create PRs)\n3. Install app on home-automation repo\n4. Add repository secrets:\n   - `RELEASE_APP_ID` - the App ID from app settings\n   - `RELEASE_APP_PRIVATE_KEY` - generate and download a private key\n\n## Why\n- Commits made with default GITHUB_TOKEN aren't verified\n- PRs created by default token won't trigger other workflows\n- GitHub App gives proper attribution and verified commits\n\n## Blocked by\nNothing - can be done anytime\n\n## Blocks\nFirst real release using changesets","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-27T08:46:26.78554636Z","updated_at":"2025-11-27T18:28:43.352730961Z","closed_at":"2025-11-27T18:28:43.352730961Z"}
{"id":"dh-8g9","title":"Add Effect-specific ESLint rules","description":"## Task\nAdd ESLint rules to enforce correct Effect usage patterns.\n\n## Progress\n- Installed @codeforbreakfast/eslint-effect\n- Configured recommended rules with RxJS overrides\n- Fixed 50+ lint errors across deep-heating-types, deep-heating-home-assistant, rxx packages\n- Disabled effect/no-method-pipe (conflicts with RxJS)\n- Disabled effect/no-if-statement (too strict for mixed codebase)\n- Disabled functional/type-declaration-immutability (I.+ heuristic too blunt)\n\n## Remaining\n- 24 errors in deep-heating-web package need fixing\n\n## TODO\nGrab /fix-all command from brownsauce repo to help fix remaining issues automatically\n\n## Rules Enabled\n- effect/no-runPromise (except tests/scripts)\n- effect/no-runSync (except tests/scripts)\n- effect/prefer-andThen\n- effect/prefer-as\n- effect/no-curried-calls\n- effect/no-eta-expansion\n- functional/prefer-immutable-types (with RxJS patterns ignored)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:02.222727342Z","updated_at":"2026-01-02T14:31:00.04640422Z","closed_at":"2025-11-30T08:08:59.839253Z","dependencies":[{"issue_id":"dh-8g9","depends_on_id":"dh-20r","type":"blocks","created_at":"2025-11-25T07:14:06.696610574Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-8i0","title":"Add 'popping out' temperature to config schema","description":"Add a configuration option for the 'popping out' temperature override value.\n\n- Add to config schema/types\n- Default to 14°C if not specified\n- Validate it's a sensible temperature range\n\nPart of: dh-ddf (Popping Out epic)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T17:49:10.693547Z","updated_at":"2025-12-16T17:59:03.672508Z","closed_at":"2025-12-16T17:59:03.672508Z","dependencies":[{"issue_id":"dh-8i0","depends_on_id":"dh-dny6","type":"blocks","created_at":"2025-12-16T17:51:58.349096Z","created_by":"daemon"}]}
{"id":"dh-8zb7","title":"Refactor to remove unnecessary code duplication","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-04T12:28:07.516897607Z","created_by":"graeme","updated_at":"2026-01-04T12:28:07.516897607Z"}
{"id":"dh-91v","title":"Migrate remaining package tests to Bun","description":"## Task\nMigrate tests in remaining packages from Jest to Bun native:\n- deep-heating-types\n- deep-heating-state\n- rxx\n- dictionary (if any)\n\n## Steps per package\n1. Update test imports to use buntest\n2. Convert Jest patterns to Bun equivalents\n3. Update package.json test script\n4. Remove Jest config\n\n## Notes\nThese packages likely have fewer tests - should be straightforward after rx and home-assistant migrations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:32.783048317Z","updated_at":"2026-01-02T14:31:00.029054425Z","closed_at":"2025-11-30T11:16:57.700128Z","dependencies":[{"issue_id":"dh-91v","depends_on_id":"dh-5rw","type":"blocks","created_at":"2025-11-25T07:14:39.55415719Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-9g8","title":"Beads git-history-backfill incorrectly purges valid beads","description":"The git-history-backfill mechanism in beads incorrectly marks valid beads as deleted and purges them during bd sync.\n\n**Root cause:**\nWhen a bead exists in git history but isn't in the current JSONL (e.g., after pull/merge conflict resolution), beads assumes it was intentionally deleted and creates a tombstone.\n\n**Impact:**\n- 7 beads were lost during a bd sync today: dh-3pc, dh-6db, dh-d41, dh-jjs, dh-mun, dh-r75, dh-v42\n- Newly created beads can be immediately purged if sync timing is unlucky\n- Data loss with no easy recovery\n\n**The bug flow:**\n1. Bead exists in git history (was committed when created)\n2. Missing from current JSONL (due to merge/pull/branch switch)\n3. No deletion record exists (bead was just created)\n4. git-history-backfill assumes it was deleted → creates tombstone → purges\n\n**Workaround:**\n- Stop bd daemon before doing git operations that might affect JSONL\n- Use --no-git-history flag during import\n- Manually recover beads from older beads-metadata commits\n\n**Fix needed in beads:**\nThe git-history-backfill should NOT purge beads that exist in the local DB unless there's explicit evidence of deletion (deletion record in manifest).","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-10T14:37:15.147222Z","updated_at":"2025-12-10T14:39:57.129698Z","closed_at":"2025-12-10T14:39:57.129698Z"}
{"id":"dh-9i8","title":"Add knip for unused code detection","description":"## Task\nAdd knip to detect unused exports, dependencies, and files.\n\n## Installation\n`bun add -D knip`\n\n## Configuration\nCreate knip.config.ts with:\n- Workspace configuration for monorepo\n- Entry points for each package\n- Ignore patterns for false positives\n\n## Integration\n- Add `unused:check` script to package.json\n- Optionally add to CI pipeline\n\n## Benefits\n- Find dead code\n- Detect unused dependencies\n- Keep exports clean","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:15.757204914Z","updated_at":"2026-01-02T14:31:00.041825174Z","closed_at":"2025-11-29T17:58:18.367516Z","dependencies":[{"issue_id":"dh-9i8","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:15:20.321738185Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-9me","title":"Migrate getEntityUpdates to Effect Stream (pilot)","description":"## Overview\nPilot migration of heatingProvider.ts from RxJS to Effect Streams using the new adapters.\n\n## Why This File\n- Already mixes Effect and RxJS (uses Runtime.runPromise)\n- Good boundary point between Effect HTTP calls and RxJS streams\n- Relatively isolated - can test migration without affecting whole system\n\n## Current State\n- `getEntityUpdates` in home-assistant-api.ts uses RxJS timer() for polling\n- Uses switchMap, mergeAll, shareReplay\n- Bridges to Effect via Runtime.runPromise\n- heatingProvider.ts uses debounceTime and groupBy for action batching\n\n## Target State\n- Use Effect Stream with Schedule.fixed for polling intervals\n- Use Schedule.exponential for retry with backoff on failures\n- Use Stream.flatMap with switch: true for switchMap equivalent  \n- Use Stream.broadcast for shareReplay equivalent\n- Export as Observable via adapter for backward compatibility\n\n## Approach\n1. Rewrite internals using Effect Stream\n2. Use streamToObservable adapter at the export boundary\n3. Consumers don't need to change yet\n\n## Dependencies\n- Requires dh-597 (adapters)\n\n## Files to Change\n- packages/deep-heating-home-assistant/src/lib/home-assistant-api.ts (getEntityUpdates)\n- packages/deep-heating-home-assistant/src/lib/climate/heatingProvider.ts\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T11:50:38.911303Z","updated_at":"2025-11-30T14:09:13.022348Z","closed_at":"2025-11-30T14:09:13.022348Z","dependencies":[{"issue_id":"dh-9me","depends_on_id":"dh-597","type":"blocks","created_at":"2025-11-30T11:50:42.495626Z","created_by":"daemon"}]}
{"id":"dh-9so","title":"Refactor generateBunNixDeepHeating to reuse prunedWorkspace","description":"## Goal\n\nEliminate duplicate `turbo prune` execution in the nix flake.\n\n## Why\n\nCurrently `prunedWorkspace` and `generateBunNixDeepHeating` both run `turbo prune` independently. This is wasteful - the second derivation should reuse the output of the first.\n\n## Approach\n\nMake `generateBunNixDeepHeating` depend on `prunedWorkspace` and only run `bun2nix` on its `bun.lock` output.\n\n## Trade-off: Imprecise Caching\n\nSince `prunedWorkspace` depends on all source files, `generateBunNixDeepHeating` will rebuild whenever any source file changes - even though `bun-deep-heating.nix` only actually changes when `bun.lock` or `package.json` files change.\n\nThis is acceptable because:\n- The `bun2nix` step is fast (~2 seconds)\n- Splitting the derivation for precise caching would require either duplicating `turbo prune` or reimplementing its package selection logic\n- We're still eliminating one `turbo prune` call compared to today\n\n## Expected Outcome\n\n- `generateBunNixDeepHeating` depends on `prunedWorkspace` and only runs `bun2nix`\n- Running `nix build .#generateBunNixDeepHeating` produces the same output as before\n- One fewer `turbo prune` execution in the build graph","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-10T21:10:04.537833Z","updated_at":"2025-12-10T21:10:04.537833Z","dependencies":[{"issue_id":"dh-9so","depends_on_id":"dh-i01m","type":"parent-child","created_at":"2025-12-29T16:53:55.493207Z","created_by":"daemon"}]}
{"id":"dh-9vb","title":"Add Effect language service plugin","description":"## Task\nAdd the Effect TypeScript language service plugin for better IDE integration.\n\n## Steps\n1. Add `@effect/language-service` as dev dependency\n2. Update tsconfig.base.json to include plugin:\n```json\n{\n  \"compilerOptions\": {\n    \"plugins\": [\n      { \"name\": \"@effect/language-service\" }\n    ]\n  }\n}\n```\n\n## Benefits\n- Better autocomplete for Effect types\n- Improved error messages for Effect code\n- Hover information for Effect combinators","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:13:37.36770342Z","updated_at":"2026-01-02T14:31:00.039536701Z","closed_at":"2025-11-29T15:22:08.506058Z","dependencies":[{"issue_id":"dh-9vb","depends_on_id":"dh-cb3","type":"blocks","created_at":"2025-11-25T07:13:41.617795594Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-9vq","title":"Switch SvelteKit to svelte-adapter-bun","description":"Replace @sveltejs/adapter-node with svelte-adapter-bun to run the SvelteKit web app on Bun instead of Node.js. This removes the Node.js dependency from the Docker image and keeps the runtime consistent (both server and web use Bun).","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-01T18:49:44.886682Z","updated_at":"2025-12-01T18:52:00.577089Z","closed_at":"2025-12-01T18:52:00.577089Z"}
{"id":"dh-a5l","title":"Migrate package manager from npm to Bun","description":"## Overview\nReplace npm with Bun as the primary package manager. This is the foundational change that unblocks most other modernisation work.\n\n## Why Bun?\n- Faster installs and script execution\n- Built-in TypeScript support\n- Native test runner (needed for testing migration)\n- Simpler toolchain (replaces multiple tools)\n\n## Scope\n- Replace lockfile\n- Update package.json configuration\n- Verify all packages build and run correctly\n- Update documentation\n\n## Technical Notes\n- Bun is largely npm-compatible but watch for native module compilation differences\n- Turbo orchestration should continue unchanged\n- May need to update some scripts that assume npm-specific behaviour","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:12:12.163911812Z","updated_at":"2025-11-25T07:49:27.847241901Z","closed_at":"2025-11-25T07:49:27.847241901Z"}
{"id":"dh-a6k","title":"Replace Docker with Nix flakes for deployment","description":"## Overview\nReplace multi-stage Docker builds with Nix flakes for reproducible, minimal container images.\n\n## Why Nix\n- Bit-for-bit reproducible builds\n- Automatic dependency layering (optimal caching)\n- Minimal final images (no build tools)\n- Cross-compilation support\n- Better handling of Bun/Node native deps\n\n## Scope\n- Create flake.nix for the monorepo\n- Create bun-pruned.nix for dependency management\n- Build container images via Nix\n- Multi-arch support (x86_64, aarch64)\n\n## Challenges\n- Learning curve for Nix\n- Home Assistant add-on integration may have requirements\n- CI/CD pipeline changes","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:15:45.057190805Z","updated_at":"2025-11-25T07:15:45.057190805Z","dependencies":[{"issue_id":"dh-a6k","depends_on_id":"dh-02n","type":"blocks","created_at":"2025-11-25T07:15:50.583498596Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-aah","title":"Replace luxon with Effect DateTime","description":"Migrate 6 files from luxon DateTime/Duration to Effect DateTime module.\n\nFiles to migrate:\n- packages/deep-heating-rx/src/lib/utils/datetime.ts\n- packages/deep-heating-rx/src/lib/streams/rooms/roomScheduledTargetTemperatures.ts\n- packages/deep-heating-rx/src/lib/streams/house/houseModes.ts\n- packages/deep-heating-rx/src/lib/streams/trvs/trvActions.test.ts\n- packages/deep-heating-types/src/lib/weekSchedule.ts\n- packages/deep-heating-types/src/lib/weekSchedule.test.ts\n\nEffect DateTime capabilities:\n- DateTime.unsafeMake / DateTime.unsafeMakeZoned for creation\n- DateTime.add for arithmetic\n- DateTime.distanceDuration for differences\n- Full timezone support with TimeZone.Named\n- Duration module for time spans\n\nThis removes the luxon dependency entirely.","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T11:57:56.956725Z","updated_at":"2025-11-30T11:57:56.956725Z","dependencies":[{"issue_id":"dh-aah","depends_on_id":"dh-7zk","type":"blocks","created_at":"2025-11-30T12:05:18.780233Z","created_by":"daemon"}]}
{"id":"dh-abx","title":"Add eslint-effect rule: no-effect-as-value","description":"Create a new ESLint rule for @codeforbreakfast/eslint-effect that detects when an Effect type is used as a plain value instead of being executed.\n\n## Problem\nThe temperature.ts bug shows a pattern that TypeScript can't catch:\n```typescript\nconst VeryHot = pipe(60, Schema.decodeUnknown(Temperature));  // Effect, not Temperature!\nOption.getOrElse(() =\u003e VeryHot)  // Returns Effect when Option is None\n```\n\nTypeScript allows this because:\n1. `Option.getOrElse` is generic - accepts any fallback type\n2. JavaScript comparison operators (\u003e \u003c) work on any values (return false for objects)\n\n## Rule: effect/no-effect-as-value\nShould detect:\n- Effect/Schema.decode* results stored in const without running\n- Effect types used as arguments to non-Effect functions\n- Effect types in comparison operations (\u003e, \u003c, \u003e=, \u003c=, ==, ===)\n- Effect types as return values where non-Effect is expected\n\n## Implementation\nThis requires type-aware linting (needs parserOptions.project/projectService) to detect Effect types at variable assignment and usage sites.\n\n## Location\nThe rule should be added to the eventsourcing repo in packages/eslint-effect","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-03T16:13:17.823996Z","updated_at":"2025-12-03T16:16:54.83934Z","closed_at":"2025-12-03T16:16:54.83934Z"}
{"id":"dh-akk","title":"Reduce Docker image size by ~100MB: disable patchShebangs in bun2nix","description":"## Problem\n\nThe Docker image is ~311MB (combined architectures) / ~114MB (single arch) - larger than expected.\n\n## Root Cause\n\nIn `flake.nix` line 88, `patchShebangs = true` causes bun2nix to patch node_modules shebangs to use `bun-with-fake-node`, which pulls Node.js (101MB) into the runtime closure.\n\nDocker image layer breakdown shows both runtimes:\n- `nodejs-22.21.1`: 101MB ← unnecessary at runtime\n- `bun-1.3.2`: 97.9MB\n\n## Why simple fix didn't work\n\nAttempted to set `patchShebangs = false` but this broke Docker builds - tsc and other tools in node_modules/.bin have shebangs pointing to `/usr/bin/env` which doesn't exist in the Nix sandbox.\n\n`patchShebangs = true` is required at BUILD time to run these tools.\n\n## How automatarr solves this\n\nAutomatarr can use `patchShebangs = false` because:\n1. Uses `bun install --production` (no devDependencies)\n2. Uses `bun build` directly on TypeScript sources (Bun transpiles TS natively)\n3. Has a separate `turboFod` derivation for turbo\n\n## Proposed Solution\n\nMigrate build process to use Bun's native TypeScript handling:\n1. Remove tsc from build scripts\n2. Use `bun build` directly on TypeScript sources\n3. Switch to `bun install --production`\n4. Then safely use `patchShebangs = false`\n\nThis is a larger change requiring updates to all package build scripts.\n\n## Expected Result\n\nDocker image size reduction of ~100MB (from ~114MB to ~70MB single arch).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-01T19:18:07.891462Z","updated_at":"2025-12-02T12:29:07.791582Z","closed_at":"2025-12-02T12:29:07.791582Z"}
{"id":"dh-am1","title":"Run E2E tests during PR builds","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-03T17:50:10.556269Z","updated_at":"2025-12-03T17:57:34.364798Z","closed_at":"2025-12-03T17:57:34.364798Z"}
{"id":"dh-am2","title":"Add @effect/workflow for orchestration","description":"## Task\nAdd @effect/workflow for orchestration patterns if applicable to the heating logic.\n\n## Evaluation\n1. Review current heating orchestration in deep-heating-rx\n2. Determine if workflow patterns would benefit the codebase\n3. If yes, add @effect/workflow and implement\n\n## Potential Use Cases\n- Heating schedule management\n- TRV coordination workflows\n- State machine patterns\n\n## Notes\nThis is optional - only implement if it provides clear benefits over current RxJS approach","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:57.551200953Z","updated_at":"2025-11-25T07:14:57.551200953Z","dependencies":[{"issue_id":"dh-am2","depends_on_id":"dh-c34","type":"blocks","created_at":"2025-11-25T07:15:01.683576424Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-amoo","title":"Define HeatingSystem interface in domain terms","description":"Define the `HeatingSystem` interface in `deep-heating-types` that expresses what the core heating logic needs from external device communication.\n\nInterface should include:\n- `trvUpdates: Observable\u003cTrvUpdate\u003e`\n- `heatingUpdates: Observable\u003cHeatingUpdate\u003e`\n- `temperatureReadings: Observable\u003cTemperatureSensorEntity\u003e`\n- `sleepModeEvents: Observable\u003cGoodnightEventEntity\u003e`\n- `setTrvTemperature(entityId, temp): Effect.Effect\u003cvoid, HeatingSystemError\u003e`\n- `setTrvMode(entityId, mode): Effect.Effect\u003cvoid, HeatingSystemError\u003e`\n\nAll types are existing domain types - no new concepts needed. Use Effect for actions to maintain consistency with the codebase and provide typed errors.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T12:12:38.038057Z","created_by":"graemefoster","updated_at":"2025-12-29T15:39:31.663066Z","closed_at":"2025-12-29T15:39:31.663066Z","close_reason":"HeatingSystem interface defined in commit 130c186"}
{"id":"dh-apg","title":"Upgrade RxJS from 6.x to 7.x","description":"## Overview\nUpgrade RxJS from 6.6.7 to 7.x (or 8.x) to get better AsyncIterable support needed for Effect interop.\n\n## Current State\n- RxJS 6.6.7 used across the codebase\n- Limited AsyncIterable support in RxJS 6\n\n## Target State\n- RxJS 7.x or 8.x with full AsyncIterable support\n- `from(asyncIterable)` works for converting Effect Streams\n- Minimal breaking changes (most operators unchanged)\n\n## Why\n- RxJS 7+ can convert AsyncIterable to Observable via `from()`\n- Effect Stream has `toAsyncIterable()` method\n- This enables bidirectional conversion between Effect and RxJS\n\n## Files to Change\n- All package.json files with rxjs dependency\n- May need minor operator import changes (rxjs/operators → rxjs)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T11:50:10.218065Z","updated_at":"2025-11-30T13:35:29.443256Z","closed_at":"2025-11-30T13:35:29.443256Z"}
{"id":"dh-b0w","title":"Add turbo FOD to flake.nix","description":"## Task\nAdd turbo Fixed-Output Derivation:\n- Platform-specific turbo binary packages\n- Platform-specific hashes (generate for current platform)\n- turboFod derivation that fetches turbo 2.6.1\n\n## Acceptance\n- `nix build .#turboFod` succeeds\n- turbo binary works: `result/bin/turbo --version`\n\n## Reference\n- automatarr/flake.nix lines 100-186","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T18:42:25.985622Z","updated_at":"2025-11-26T07:13:08.091333Z","closed_at":"2025-11-26T07:13:08.091333Z","dependencies":[{"issue_id":"dh-b0w","depends_on_id":"dh-n48","type":"blocks","created_at":"2025-11-25T18:43:56.668526Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-b44","title":"Update TypeScript to 5.9.x","description":"## Overview\nUpdate TypeScript to the latest stable version (5.9.x) and modernise the configuration.\n\n## Key Changes\n- Update TypeScript from current version to 5.9.x\n- Switch target from ES2015 to ES2022\n- Switch module resolution from Node to Bundler\n- Add Effect language service plugin for better IDE diagnostics\n\n## Why\n- Better type inference and error messages\n- ES2022 features available without transpilation\n- Bundler resolution is more appropriate for modern tooling\n- Effect plugin provides better autocomplete and error messages for Effect code","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:13:37.033048447Z","updated_at":"2026-01-02T14:31:00.032655051Z","closed_at":"2025-11-29T14:11:06.926292Z","dependencies":[{"issue_id":"dh-b44","depends_on_id":"dh-a5l","type":"blocks","created_at":"2025-11-25T07:13:41.575516189Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-b4l","title":"Evaluate Cachix service for Docker build caching","description":"Investigate using Cachix (the service) to cache project-specific Nix derivations for Docker builds. This would provide caching that works with multi-user mode (sandbox enabled).\n\n## Context\n- PR #1223 switched to nix-quick-install (single-user) for caching benefits\n- Single-user mode disables sandbox, breaking Docker builds\n- Option A fix: split approach (single-user for CI, multi-user for Docker)\n- Option B (this bead): Cachix service could give us both sandbox AND caching\n\n## Potential Benefits\n- Save 3-5 minutes per Docker build by caching project-specific derivations\n- Cross-branch caching (feature branches use main's cached derivations)\n- Faster re-runs if builds fail partway through\n\n## Considerations\n- Docker builds only run on releases (infrequent)\n- Requires Cachix account and secrets management\n- Free tier: 5GB storage limit\n- ROI may be marginal given build frequency\n\n## Implementation\n- Set up Cachix account for the repo\n- Add CACHIX_AUTH_TOKEN secret\n- Use cachix/cachix-action with cachix/install-nix-action\n- Works with multi-user mode (sandbox enabled)","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-11T07:43:53.574672Z","updated_at":"2025-12-11T07:43:53.574672Z","dependencies":[{"issue_id":"dh-b4l","depends_on_id":"dh-i01m","type":"parent-child","created_at":"2025-12-29T16:53:55.363391Z","created_by":"daemon"}]}
{"id":"dh-b5h","title":"Update documentation for Bun migration","description":"## Task\nUpdate all documentation to reflect the new Bun-based workflow.\n\n## Files to Update\n- CLAUDE.md - Update all command examples from npm to bun\n- .mise.toml - Add bun to managed tools\n- README files in packages if they reference npm\n\n## Changes\n- `npm run X` → `bun run X` or just `bun X`\n- `npm install` → `bun install`\n- `npm test` → `bun test`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:12:29.82246809Z","updated_at":"2025-11-25T18:16:24.805187Z","closed_at":"2025-11-25T18:16:24.805187Z","dependencies":[{"issue_id":"dh-b5h","depends_on_id":"dh-3vs","type":"blocks","created_at":"2025-11-25T07:13:21.191675234Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-b5j","title":"Remove format task from CI pipeline","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-03T18:20:33.058215Z","updated_at":"2025-12-03T18:20:33.058215Z","dependencies":[{"issue_id":"dh-b5j","depends_on_id":"dh-i01m","type":"parent-child","created_at":"2025-12-29T16:53:56.507536Z","created_by":"daemon"}]}
{"id":"dh-bhrg","title":"Frontend: Pop-out overlay with cancel option","description":"Implement the overlay shown while pop-out is active:\n- Display end time or countdown\n- Show the override temperature\n- Prominent 'Cancel' button (only action available)\n- Automatically dismiss when pop-out expires\n\nPart of: dh-ddf (Popping Out epic)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T17:49:31.816506Z","updated_at":"2025-12-16T17:59:03.676046Z","closed_at":"2025-12-16T17:59:03.676046Z","dependencies":[{"issue_id":"dh-bhrg","depends_on_id":"dh-i5b2","type":"blocks","created_at":"2025-12-16T17:49:46.135332Z","created_by":"daemon"}]}
{"id":"dh-bx6","title":"Configure Renovate to update Bun version in both mise and flake.nix","description":"## Problem\nRenovate updates Bun version in .mise.toml but not in flake.nix (or vice versa), leaving them out of sync.\n\nPR #1068 updates Bun 1.3.2 → 1.3.3 but only in one location.\n\n## Bun version locations\n- `.mise.toml` - local dev tooling\n- `flake.nix` - Nix builds (Docker image)\n\n## Solution\nConfigure Renovate to recognise both files and update them together, either via:\n- Custom manager with regex\n- Group rule to update both in same PR\n- Post-upgrade task to sync versions\n\n## Reference\nCheck Renovate docs for custom managers and regexManagers.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T11:11:31.880448Z","updated_at":"2025-11-29T19:28:06.462905Z","closed_at":"2025-11-29T19:28:06.462905Z"}
{"id":"dh-by9","title":"Research: Manage Playwright browsers via Nix","description":"Currently we install Playwright browsers via bunx playwright install in CI. This is slow and non-reproducible. Research whether Playwright browsers can be managed via Nix for faster, more reproducible CI runs. Look at nixpkgs playwright packages and cachix options.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-03T18:07:29.747097Z","updated_at":"2025-12-03T18:07:29.747097Z"}
{"id":"dh-c34","title":"Update Effect to 3.19.x","description":"## Task\nUpdate Effect and related packages to latest stable versions.\n\n## Dependencies to Update\n- effect → 3.19.x\n- @effect/platform → 0.93.x\n- @effect/platform-node → latest compatible\n- @effect/schema → latest (if separate from effect)\n\n## Steps\n1. Update package.json dependencies\n2. Run `bun install`\n3. Fix any breaking changes from version upgrade\n4. Verify all Effect-using code still works\n\n## Breaking Changes to Watch\n- Check Effect changelog for 3.5 → 3.19 breaking changes\n- Schema API may have changed\n- Platform APIs may have changed","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:57.449614167Z","updated_at":"2026-01-02T14:31:00.052135698Z","closed_at":"2025-11-30T11:33:45.343269Z","dependencies":[{"issue_id":"dh-c34","depends_on_id":"dh-luf","type":"blocks","created_at":"2025-11-25T07:15:01.669564208Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-c3r","title":"Design and trial UI mockups for pop-out interface","description":"Create and trial different UI designs for:\n1. The pop-out initiation UI (button placement, duration/time picker)\n2. The overlay shown while popped out (countdown, cancel button)\n\nIterate on designs based on feedback.\n\nPart of: dh-ddf (Popping Out epic)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T17:49:20.331438Z","updated_at":"2025-12-16T17:59:03.674764Z","closed_at":"2025-12-16T17:59:03.674764Z","dependencies":[{"issue_id":"dh-c3r","depends_on_id":"dh-rr0","type":"blocks","created_at":"2025-12-16T17:49:43.975576Z","created_by":"daemon"}]}
{"id":"dh-cb3","title":"Modernise tsconfig: ES2022 target and bundler resolution","description":"## Task\nUpdate TypeScript configuration to use modern settings.\n\n## Changes to tsconfig.base.json\n- `target`: ES2015 → ES2022\n- `module`: ESNext (keep)\n- `moduleResolution`: Node → Bundler\n\n## Changes to package tsconfigs\n- Review and update any package-specific overrides\n- Ensure library output settings are still correct\n\n## Verification\n- Full build passes\n- All tests pass\n- Runtime behaviour unchanged","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:13:37.253291677Z","updated_at":"2026-01-02T14:31:00.051008287Z","closed_at":"2025-11-29T14:49:32.415893Z","dependencies":[{"issue_id":"dh-cb3","depends_on_id":"dh-jai","type":"blocks","created_at":"2025-11-25T07:13:41.603753769Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-czn","title":"Backend: Override schedule during pop-out period","description":"Modify the heating logic to:\n- Detect when pop-out is active\n- Override all room target temperatures with the configured pop-out temperature\n- Resume normal schedule calculation when pop-out ends or is cancelled\n\nPart of: dh-ddf (Popping Out epic)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T17:49:21.135571Z","updated_at":"2025-12-16T17:59:03.67418Z","closed_at":"2025-12-16T17:59:03.67418Z","dependencies":[{"issue_id":"dh-czn","depends_on_id":"dh-ibr","type":"blocks","created_at":"2025-12-16T17:49:44.824143Z","created_by":"daemon"}]}
{"id":"dh-d0s","title":"Fix temperature.ts Effect-as-value bug","description":"The temperature.ts file has a critical bug at line 22:\n\n```typescript\nconst VeryHot = pipe(60, Schema.decodeUnknown(Temperature));\n```\n\nThis returns `Effect\u003cTemperature, ParseError, never\u003e`, not `Temperature`. The VeryHot constant is then used in `Option.getOrElse(() =\u003e VeryHot)`, so when the Option is None, it returns an Effect object instead of a temperature value.\n\n## Why TypeScript Doesn't Catch This\n\n1. `Option.getOrElse\u003cA, B\u003e` is typed to return `A | B` - it intentionally allows different fallback types\n2. TypeScript allows `\u003e` and `\u003c` operators on ANY types - there's no type error for comparing objects\n3. No ESLint rule exists for 'comparing non-comparable types' in typescript-eslint\n\n## What Would Catch This\n\n1. **Unit tests** for `compareByRoomTemperature` - would fail with rooms having `None` temperatures\n2. **E2E smoke test** (dh-kag) - browser would show runtime errors\n3. Custom ESLint rule for unsafe comparisons (doesn't exist)\n\n## Fix\nUse `Schema.decodeUnknownSync(Temperature)(60)` or `60 as Temperature` (since 60 is a valid temperature).","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-03T16:13:07.67416Z","updated_at":"2025-12-03T18:28:38.109084Z","closed_at":"2025-12-03T18:28:38.109084Z"}
{"id":"dh-d41","title":"trvScheduledTargetTemperatures$ only emits for last TRV, blocking heating for other rooms","description":"## Summary\n\nOnly one TRV (the last one to emit a schedule update at startup) receives `trvScheduledTargetTemperature` values. This blocks the `combineLatest` in `trvActions.ts` from emitting for all other TRVs, meaning no heating actions are generated for most rooms.\n\n## Observed Behaviour\n\n- All TRVs report their status at startup (\"is set to heat 15\")\n- Room target temperatures are calculated correctly (\"Living Area should be 18.2\", etc.)\n- \"Some rooms are heating\" appears (from `roomDecisionPoints$`)\n- But only ONE room (typically Office, the last TRV to report) gets TRV actions\n- Other rooms remain at their initial low temperature (15°C) instead of being commanded to heat\n\n## Root Cause\n\nIn `packages/deep-heating-rx/src/lib/streams/trvs/trvScheduledTargetTemperatures.ts`:\n\n```typescript\nexport const getTrvScheduledTargetTemperatures = (\n  trvHiveHeatingSchedule$: Observable\u003cTrvWeekHeatingSchedule\u003e,\n): Observable\u003cTrvScheduledTargetTemperature\u003e =\u003e\n  combineLatest([\n    trvHiveHeatingSchedule$,  // ← Single stream emitting one TRV at a time\n    timer(0, refreshIntervalSeconds * 1000).pipe(map(localNow), shareReplay(1)),\n  ]).pipe(\n    map(([trvSchedule, now]) =\u003e ({ ... })),\n    shareReplayLatestDistinctByKey((x) =\u003e x.climateEntityId),\n  );\n```\n\nThe `combineLatest` operator stores only the LATEST value from `trvHiveHeatingSchedule$`. When the timer fires (including at t=0), it combines with that single latest value and emits ONE `TrvScheduledTargetTemperature`.\n\nThe `shareReplayLatestDistinctByKey` at the end stores values by `climateEntityId`, but since only one value is emitted per timer tick, only one TRV ever gets stored.\n\n## Impact Chain\n\n1. `trvScheduledTargetTemperatures$` only has data for one TRV\n2. In `trvActions.ts` (line 97-105), `combineLatest` waits for 4 streams per TRV:\n   - `trvDesiredTargetTemperatures` ✅\n   - `trvControlStates` ✅\n   - `trvTemperatures` ✅\n   - `trvScheduledTargetTemperatures` ❌ (never emits for most TRVs)\n3. The `combineLatest` never completes for TRVs missing scheduled target data\n4. No `ClimateAction` is generated for those TRVs\n5. Those rooms never heat\n\n## Affected Files\n\n- `packages/deep-heating-rx/src/lib/streams/trvs/trvScheduledTargetTemperatures.ts` - Root cause\n- `packages/deep-heating-rx/src/lib/streams/trvs/trvActions.ts` - Consumer that blocks\n- `packages/deep-heating-rx/src/lib/streams/actions.ts` - Another consumer using `withLatestFrom`\n\n## Expected Behaviour\n\nWhen the 60-second timer fires (and at t=0), the stream should emit a `TrvScheduledTargetTemperature` for EVERY TRV that has reported a schedule, not just the most recent one.\n\n## Reproduction\n\n1. Start Deep Heating with multiple rooms/TRVs\n2. Observe startup logs - all TRVs report \"is set to heat\"\n3. Observe room targets are calculated\n4. Note that only ONE TRV gets \"will be changed to heat\" commands\n5. Other rooms remain cold\n\n## Related\n\nThis is similar to the bug fixed in PR #1178 (see CHANGELOG entry about `shareReplayLatestDistinctByKey` for scheduled targets), but that fix was for room-level scheduling. The TRV-level scheduled target stream has the same fundamental issue.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-10T07:28:04.782438Z","updated_at":"2025-12-10T07:36:25.276691Z","closed_at":"2025-12-10T07:36:25.276691Z"}
{"id":"dh-d5q","title":"TRV target temperature timer only recalculates last TRV","description":"## Summary\n\nThe 60-second periodic timer in `trvDesiredTargetTemperatures.ts` only triggers recalculation for the **last TRV that emitted** a decision point. Other TRVs in the system don't get periodic recalculation, causing their target temperatures to become stale.\n\n## Root Cause\n\nIn `packages/deep-heating-rx/src/lib/streams/trvs/trvDesiredTargetTemperatures.ts:53-56`:\n\n```typescript\ncombineLatest([\n  trvDecisionPoints,  // emits individual TRV decision points\n  timer(0, refreshIntervalSeconds * 1000),\n])\n```\n\nThe `trvDecisionPoints` stream emits **individual** `TrvDecisionPoint` objects - one per TRV when room data changes. When `combineLatest` receives these, it only remembers the **latest** value from the stream.\n\n### The Bug Flow\n\n1. Living Area room updates → emits Lounge TRV decision point\n2. Living Area room updates → emits Kitchen TRV decision point  \n3. `combineLatest` now holds: `[kitchenDecisionPoint, 0]`\n4. Timer ticks (60s later)\n5. `combineLatest` emits: `[kitchenDecisionPoint, 1]`\n6. **Only Kitchen gets recalculated!**\n7. **Lounge is NOT recalculated** - its target temperature becomes stale\n\n## Symptoms\n\n- TRV target temperatures don't adjust as TRV internal sensor readings change\n- The offset calculation `roomTarget + trvInternalTemp - roomTemp` uses stale `trvInternalTemp`\n- TRVs may sit idle when they should be heating because target is too low\n- Observed: Lounge TRV at 24.5°C target when calculation with fresh data would give 27°C\n\n## Impact\n\nWhen a TRV's internal temperature sensor rises (e.g., from 22°C to 24°C), the system should increase the TRV target to compensate. But if that TRV wasn't the last one to emit, its target stays at the old value calculated with 22°C.\n\nThis causes the TRV to stop heating prematurely because:\n- TRV target: 24.5°C (stale calculation)\n- TRV internal sensor: 24°C\n- Hysteresis means TRV thinks it's \"close enough\" and sits idle\n- Room stays cold at 18°C instead of reaching 20°C target\n\n## Data Flow Context\n\nFrom the TRV temperature data flow:\n1. `trvApiUpdates$` → `trvTemperatures$` \n2. `trvTemperatures$` → `roomTrvTemperatures$`\n3. `roomTrvTemperatures$` → `roomDecisionPoints$`\n4. `roomDecisionPoints$` → `trvDecisionPoints$` (emits per-TRV)\n5. `trvDecisionPoints$` → `trvDesiredTargetTemperatures$` ← **BUG HERE**\n\n## Possible Fixes\n\n1. **Move timer upstream**: Add timer to `trvDecisionPoints.ts` so each TRV gets periodic re-emit via the `shareReplayLatestDistinctByKey` cache replay\n\n2. **Use merge + withLatestFrom**: Instead of `combineLatest`, use the timer to trigger replay of ALL cached TRV decision points\n\n3. **Remove timer entirely**: If upstream streams already have timers for schedule changes, the timer here may be redundant\n\n## Files Affected\n\n- `packages/deep-heating-rx/src/lib/streams/trvs/trvDesiredTargetTemperatures.ts` - contains the buggy timer\n- `packages/deep-heating-rx/src/lib/streams/trvs/trvDecisionPoints.ts` - emits individual TRV decision points","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-04T16:58:49.370517Z","updated_at":"2025-12-04T16:58:49.370517Z","dependencies":[{"issue_id":"dh-d5q","depends_on_id":"dh-7sjo","type":"parent-child","created_at":"2025-12-29T16:53:57.874363Z","created_by":"daemon"}]}
{"id":"dh-d73","title":"Retry failed TRV actions with exponential backoff","description":"createHomeAssistantHeatingProvider() in heatingProvider.ts catches SetTemperatureError and SetHvacModeError but only logs them. Failed actions are never retried.\n\nImpact: If HA temporarily rejects a command (e.g., TRV unavailable, network glitch), the system moves on. The next poll may not generate a new action if desired vs current temps appear unchanged.\n\nFix: Use Effect.retry with exponential backoff before giving up. Example:\nEffect.retry(Schedule.exponential(Duration.seconds(1), 2).pipe(Schedule.upTo(Duration.seconds(30))))","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-06T08:01:52.411946Z","updated_at":"2025-12-06T08:03:29.221827Z","dependencies":[{"issue_id":"dh-d73","depends_on_id":"dh-7sjo","type":"parent-child","created_at":"2025-12-29T16:53:57.749093Z","created_by":"daemon"}]}
{"id":"dh-d8w","title":"Fix nix sync workflow fetching SHA from wrong branch","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T13:06:59.499163Z","updated_at":"2025-11-29T13:07:37.3255Z","closed_at":"2025-11-29T13:07:37.3255Z"}
{"id":"dh-dd4","title":"Set up bun2nix dependency management","description":"## Task\nSet up bun2nix for dependency management:\n- Generate bun-deep-heating.nix from pruned lockfile\n- Generate bun.nix from full lockfile (CI validation)\n- Add generateBunNix and generateBunNixDeepHeating derivations\n- Add bunDepsDeepHeating using fetchBunDeps\n- Add validateDeps derivation for CI\n\n## Acceptance\n- bun-deep-heating.nix and bun.nix files generated and committed\n- `nix build .#bunDepsDeepHeating` succeeds\n- `nix build .#validateDeps` succeeds\n\n## Reference\n- automatarr/flake.nix lines 224-342","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T18:42:41.889504Z","updated_at":"2025-11-26T07:36:09.083059Z","closed_at":"2025-11-26T07:36:09.083059Z","dependencies":[{"issue_id":"dh-dd4","depends_on_id":"dh-vjn","type":"blocks","created_at":"2025-11-25T18:43:56.768614Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-ddf","title":"Popping Out feature - temporary whole-house temperature override","description":"## Overview\nA 'Popping Out' feature that lets users temporarily override the entire house schedule with a low temperature (configured in config file) until a specified return time.\n\n## Key Requirements\n- **Scope**: Whole house override (all rooms)\n- **Temperature**: Read from config file (not UI-configurable)\n- **Duration input**: Either a period of time (to nearest hour) OR a specific end date/time\n- **Persistence**: State survives server restarts (similar to room adjustments)\n- **UI during pop-out**: Overlay showing countdown/end time with only a 'Cancel' option\n- **Cancellation**: Returns schedule and UI to normal immediately\n\n## Why explicit return time (not presence detection)\nDeep Heating's USP is anticipating when rooms need to reach target temperature and pre-heating accordingly. If we waited for presence detection, the house would be cold when users return. By setting an explicit return time, the system can factor this into its heating calculations.\n\n## Out of Scope\n- Per-room popping out\n- Home Assistant presence/away mode integration\n- UI-configurable away temperature","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-16T17:48:58.222037Z","updated_at":"2026-01-03T09:09:17.623346515Z","dependencies":[{"issue_id":"dh-ddf","depends_on_id":"dh-z3mu","type":"blocks","created_at":"2025-12-16T17:59:21.833846Z","created_by":"daemon"},{"issue_id":"dh-ddf","depends_on_id":"dh-1b6u","type":"blocks","created_at":"2025-12-16T17:59:22.238688Z","created_by":"daemon"}]}
{"id":"dh-dny6","title":"Write outer E2E acceptance test for Popping Out (GOOS)","description":"**GOOS-style outside-in acceptance test**\n\nWrite ONE outer E2E test that describes the complete pop-out flow from the user's perspective:\n1. User initiates pop-out with a return time\n2. All rooms override to configured temperature\n3. UI shows overlay with cancel option only\n4. User cancels (or time expires)\n5. Schedule and UI return to normal\n\nThis test will fail repeatedly as we build. Each failure tells us what to implement next:\n- 'Button not found' → build UI element\n- 'No server response' → build WebSocket handler  \n- 'State not persisted' → build persistence\n- etc.\n\nInner TDD loops (unit tests) drive each piece of implementation. When the outer test passes, the feature is complete.\n\nPart of: dh-ddf (Popping Out epic)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T17:49:32.230226Z","updated_at":"2025-12-26T17:38:36.700714Z","closed_at":"2025-12-26T17:38:36.700714Z"}
{"id":"dh-dxvc","title":"Add pre-commit to Nix devShell","description":"Add pre-commit framework to the Nix development shell.\n\n## Requirements\n\nUpdate `flake.nix` devShell to:\n1. Add `pkgs.pre-commit` to buildInputs\n2. Add `pre-commit install` to shellHook (with `--allow-missing-config`)\n\nReference: ../anticipatarr-gleam/flake.nix\n\n## Acceptance Criteria\n- [ ] `pre-commit` available in `nix develop`\n- [ ] Hooks auto-install when entering shell","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T16:02:46.56996631Z","created_by":"graeme","updated_at":"2026-01-02T16:04:20.048466598Z","closed_at":"2026-01-02T16:04:20.048466598Z","close_reason":"Closed"}
{"id":"dh-dys","title":"Extract shared Playwright E2E test logic to run against both Docker and local services","description":"The current e2e-smoke-test.test.ts only runs against Docker images. We want to:\n\n1. Extract the core Playwright test logic (checking for JS errors, WebSocket connection, UI structure) into a shared module\n2. Have one test file that uses testcontainers to spin up Docker\n3. Have another test file that starts local services (via child processes) and tests against them\n\n**Key requirement**: Playwright/test harness is in charge of starting and stopping services - no expectation of pre-running services.\n\nThis allows:\n- Quick local iteration: run tests against locally-built services without building Docker\n- CI validation: run the same tests against built Docker images  \n- Single source of truth for test logic\n\nApproach:\n- Create shared-e2e-tests.ts with test functions that take a baseUrl and Browser\n- e2e-docker-smoke-test.test.ts - uses testcontainers, passes baseUrl to shared tests\n- e2e-local-smoke-test.test.ts - spawns local server/web processes in beforeAll, kills in afterAll, passes baseUrl to shared tests","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-03T17:31:04.67926Z","updated_at":"2025-12-03T17:39:45.254513Z","closed_at":"2025-12-03T17:39:45.254513Z"}
{"id":"dh-e5x","title":"Migrate deep-heating-web tests to Bun","description":"## Task\nMigrate tests in packages/deep-heating-web from Vitest to Bun native.\n\n## Challenges\n- SvelteKit uses Vitest by default\n- Component testing may need different approach\n- Svelte Testing Library integration\n\n## Steps\n1. Research Bun + Svelte testing options\n2. Update test imports and patterns\n3. Handle component mounting/rendering\n4. Update vite.config.ts and package.json\n5. Remove Vitest dependencies\n\n## Notes\nThis may be the most complex migration due to Svelte integration. Consider if hybrid approach (Vitest for component tests only) is acceptable.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:32.935855558Z","updated_at":"2026-01-02T14:31:00.053207889Z","closed_at":"2025-11-30T11:16:58.019681Z","dependencies":[{"issue_id":"dh-e5x","depends_on_id":"dh-5rw","type":"blocks","created_at":"2025-11-25T07:14:39.568043554Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-e8n","title":"Create deep-heating build derivation","description":"## Task\nCreate the main deep-heating derivation:\n- Use bun2nix mkDerivation with pruned workspace\n- Build all packages with turbo\n- Bundle socketio backend with bun build\n- Copy SvelteKit build output\n- Create wrapper script for socketio\n\n## Output Structure\n- $out/bin/deep-heating-socketio - Wrapper script\n- $out/lib/deep-heating/socketio-bundle.js - Bundled backend\n- $out/lib/deep-heating/web/ - SvelteKit output\n\n## Acceptance\n- `nix build .#deep-heating` succeeds\n- `result/bin/deep-heating-socketio --help` runs (or similar)\n\n## Reference\n- automatarr/flake.nix lines 344-431","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T18:42:47.62984Z","updated_at":"2025-11-26T08:45:38.000547Z","closed_at":"2025-11-26T08:45:38.000547Z","dependencies":[{"issue_id":"dh-e8n","depends_on_id":"dh-dd4","type":"blocks","created_at":"2025-11-25T18:43:56.816482Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-eoz","title":"Fix frontend _tag error in E2E tests","description":"E2E test 'frontend loads without JavaScript errors' is failing with: Cannot read properties of undefined (reading '_tag'). This appears to be an Effect library error where something expects an Effect/Option value but receives undefined. The error surfaces when the frontend connects to the WebSocket and receives state data.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-03T17:53:49.456056Z","updated_at":"2025-12-03T18:41:56.011724Z","closed_at":"2025-12-03T18:41:56.011724Z","dependencies":[{"issue_id":"dh-eoz","depends_on_id":"dh-5k0","type":"blocks","created_at":"2025-12-03T17:56:55.256312Z","created_by":"daemon"}]}
{"id":"dh-eq0","title":"Fix DateTime.local eta-expansion in timer streams","description":"Four files use `() =\u003e DateTime.local()` wrapper with eslint-disable comments for effect/no-eta-expansion. This is needed because RxJS timer passes a number to map callbacks but DateTime.local() doesn't accept it. Consider creating a helper function or using a different pattern.\n\nFiles affected:\n- houseModes.ts:37\n- roomSchedules.ts:22\n- roomScheduledTargetTemperatures.ts:48\n- trvScheduledTargetTemperatures.ts:17","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T08:09:45.403693Z","updated_at":"2025-11-30T08:58:35.399774Z","closed_at":"2025-11-30T08:58:35.399774Z"}
{"id":"dh-ew7","title":"Remove unused Dockerfiles","description":"The following Dockerfiles are dead code - production builds use Nix (nix build .#dockerImage):\n\n- packages/deep-heating/Dockerfile\n- packages/deep-heating-socketio/Dockerfile  \n- packages/deep-heating-web/Dockerfile\n\nAlso remove the npm scripts from package.json:\n- docker:build:deep-heating\n- docker:build:socketio\n- docker:build:web\n- docker:build:all","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T10:00:33.995087Z","updated_at":"2025-11-29T10:21:36.580612Z","closed_at":"2025-11-29T10:21:36.580612Z"}
{"id":"dh-ez9","title":"Phase 4: Incrementally migrate createDeepHeating streams","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-30T14:07:45.769223Z","updated_at":"2025-11-30T14:07:45.769223Z","dependencies":[{"issue_id":"dh-ez9","depends_on_id":"dh-srn","type":"blocks","created_at":"2025-11-30T14:07:50.781272Z","created_by":"daemon"}]}
{"id":"dh-f4v","title":"Separate web build derivation to eliminate manual shebang patching","description":"## Problem\n\nThe current approach in PR #1156 uses manual `sed` patching of shebangs in `bunNodeModulesInstallPhase` to replace `#!/usr/bin/env node` with bun. This works but is hacky.\n\n## Root Cause\n\nWe can't use `bun install --production` because vite (a devDependency) is needed to build the SvelteKit web frontend. This forces us to install all devDeps, which means tools with node shebangs need patching to work in the Nix sandbox.\n\n## Proposed Solution\n\nFollow automatarr's pattern more closely by splitting the build:\n\n1. **Separate web build derivation** with full devDeps\n   - Uses `patchShebangs = true` (or manual patching)\n   - Runs vite build for SvelteKit\n   - Outputs only the built web assets\n\n2. **Main deep-heating derivation** with production deps only\n   - Uses `bun install --production`\n   - Uses `patchShebangs = false` (no shebangs to patch in prod deps)\n   - Bundles server with `bun build`\n   - Copies pre-built web assets from step 1\n\nThis eliminates:\n- Manual sed patching in the main build\n- Any risk of devDep tooling leaking into runtime closure\n\n## Benefits\n\n- Cleaner separation of build-time vs runtime dependencies\n- More confidence that runtime closure is minimal\n- Follows the pattern proven in automatarr\n\n## Depends On\n\nPR #1156 should merge first (establishes TypeScript-native builds), then this can be a follow-up improvement.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-02T08:37:08.386744Z","updated_at":"2025-12-02T16:40:52.283484Z","closed_at":"2025-12-02T16:40:52.283484Z","dependencies":[{"issue_id":"dh-f4v","depends_on_id":"dh-akk","type":"blocks","created_at":"2025-12-02T08:37:13.915622Z","created_by":"daemon"}]}
{"id":"dh-f6g","title":"Make E2E job required for PR merge","description":"Add the E2E test job to GitHub branch protection rules so that PRs cannot be merged unless E2E tests pass. This requires updating the repo's branch protection settings to include the 'e2e' job as a required status check.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-03T18:11:07.01407Z","updated_at":"2025-12-03T18:11:13.465323Z","dependencies":[{"issue_id":"dh-f6g","depends_on_id":"dh-5xw","type":"blocks","created_at":"2025-12-03T18:12:24.621662Z","created_by":"daemon"},{"issue_id":"dh-f6g","depends_on_id":"dh-stnj","type":"parent-child","created_at":"2025-12-29T16:53:54.167665Z","created_by":"daemon"}]}
{"id":"dh-fgf","title":"TRV availability transitions don't trigger re-push of correct temperature","description":"## Problem\n\nWhen a TRV goes unavailable and comes back online, the system doesn't re-push the correct target temperature. The TRV returns with a stale/default temperature and the room stays cold.\n\n## Observed Behavior (2025-12-04)\n\n- **09:12:10** - Lounge radiator \"Became unavailable\" (Zigbee dropout)\n- **09:16:40** - Lounge radiator \"Changed to Heat\" (came back online)\n- **09:30:18** - Deep Heating addon restarted\n- Lounge TRV reported target of 20°C (stale value)\n- Kitchen TRV (same Living Area room) was at 24°C and heating correctly\n- Room temperature was 16.56°C, target was 20°C\n- System calculated \"Living Area should be 20\" but never sent \"will be changed\" for lounge\n\n## Root Cause Analysis\n\nThe action generation pipeline in `getTrvActions` uses `combineLatest` with 4 streams:\n1. `trvDesiredTargetTemperatures` - what the TRV should be set to\n2. `trvControlStates` - what the TRV is currently set to (from device)\n3. `trvTemperatures` - TRV's own temperature reading\n4. `trvScheduledTargetTemperatures` - TRV's schedule\n\nCombined with `distinctUntilChanged(isDeepStrictEqual)` on line 90-97, if the calculated desired temperature matches what the device reports, no action is emitted.\n\nThe 60-second timer in `getTrvDesiredTargetTemperatures` should eventually trigger recalculation, but:\n- `shareReplayLatestDistinctByKey` suppresses emissions if the calculated value is the same\n- The action comparison in `determineAction()` returns `null` if desired === current\n\n## Why Local Server Fixed It\n\nWhen running locally, the server connected fresh to Home Assistant and received all current state. The `combineLatest` fired with all values available simultaneously, and the mismatch was detected (lounge at 20°C but should be ~22.5°C based on room temp differential).\n\n## Potential Fixes\n\n1. **Track availability transitions**: When a TRV transitions from unavailable → available, force re-evaluation regardless of cached values\n2. **Don't suppress identical desired temps**: Remove or modify the `distinctUntilChanged` in the action pipeline\n3. **Compare against device state, not cached state**: Ensure actions are generated when device state differs from desired, even if desired hasn't changed\n4. **Periodic forced re-push**: On a longer interval (5-10 min), force re-send all TRV targets regardless of change detection\n\n## Key Files\n\n- `packages/deep-heating-rx/src/lib/streams/trvs/trvActions.ts` - Action generation with combineLatest\n- `packages/deep-heating-rx/src/lib/streams/trvs/trvDesiredTargetTemperatures.ts` - Desired temp calculation with 60s timer\n- `packages/deep-heating-rx/src/lib/streams/DeepHeating.ts` - Stream wiring and subscriptions\n- `packages/deep-heating-home-assistant/` - Where availability state would be tracked","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-04T14:46:38.166614Z","updated_at":"2025-12-04T15:20:51.058907Z","closed_at":"2025-12-04T15:20:51.058907Z"}
{"id":"dh-g7gt","title":"E2E test fixture needs target temperatures","description":"The E2E test server doesn't calculate target temperatures because no real Home Assistant data flows through. The test fixture has a schedule but room.targetTemperature is None. Need to either: (1) stub target temps in test setup, (2) make server calculate from schedule alone, or (3) provide mock HA state in fixtures.","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-26T18:08:22.225846Z","updated_at":"2025-12-26T18:08:22.225846Z","dependencies":[{"issue_id":"dh-g7gt","depends_on_id":"dh-stnj","type":"parent-child","created_at":"2025-12-29T16:53:54.038248Z","created_by":"daemon"}]}
{"id":"dh-gh0","title":"Add unit tests for web client WebSocket code","description":"The web package's WebSocket client code has zero test coverage:\n\n- `src/lib/apiClient.ts` - WebSocket connection, message handling, exponential backoff reconnection\n- `src/lib/home.ts` - State decoding from WebSocket messages, Svelte store updates\n\n## Why This Matters\nThe double-decode bug (PR #1171) would have been caught if these files had unit tests:\n- apiClient.ts was correctly decoding ServerMessage\n- home.ts was then re-decoding already-decoded data\n- A test verifying the data flow would have caught the type mismatch\n\n## Test Coverage Needed\n1. **apiClient.ts tests**:\n   - Connection lifecycle (connect, disconnect, reconnect)\n   - Message encoding/decoding (ServerMessage schema)\n   - Exponential backoff on reconnection\n   - Error handling\n\n2. **home.ts tests**:\n   - State updates from WebSocket messages\n   - Svelte store integration\n   - Effect Option/Schema handling\n\n## Implementation Notes\n- Use bun:test\n- Mock WebSocket for unit tests (not full E2E)\n- Verify types flow correctly through the decode pipeline","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-03T16:13:27.076438Z","updated_at":"2025-12-03T16:13:27.076438Z","dependencies":[{"issue_id":"dh-gh0","depends_on_id":"dh-stnj","type":"parent-child","created_at":"2025-12-29T16:53:53.107986Z","created_by":"daemon"}]}
{"id":"dh-gno","title":"Migrate testing from Jest/Vitest to Bun native","description":"## Overview\nReplace Jest and Vitest with Bun's native test runner, including Effect integration via a buntest-style utility package.\n\n## Why\n- Bun's test runner is faster\n- Native TypeScript support without ts-jest\n- Better Effect integration possible\n- Simpler toolchain (one less tool)\n\n## Scope\n- Create buntest utility package for Effect integration\n- Migrate all package tests to Bun syntax\n- Remove Jest and Vitest dependencies\n- Update Turbo pipeline for new test command\n\n## Challenges\n- Jest mocking patterns need Bun equivalents\n- Vitest's Svelte integration needs replacement\n- Effect test patterns need it.effect() support","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:14:32.220270678Z","updated_at":"2026-01-02T14:31:00.054329251Z","closed_at":"2025-11-29T17:11:07.959239Z","dependencies":[{"issue_id":"dh-gno","depends_on_id":"dh-p8z","type":"blocks","created_at":"2025-11-25T07:14:39.496933005Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-gzw","title":"Fix Nix build network errors in CI","description":"## Problem\nNix build in GitHub Actions fails with network errors when downloading npm packages:\n- `ConnectionRefused downloading tarball`\n- `FailedToOpenSocket downloading tarball`\n\n## Failed run\nhttps://github.com/GraemeF/home-automation/actions/runs/19771675627\n\n## Context\nThe bun2nix fetcher can't reach the npm registry from within the Nix sandbox during CI builds.\n\n## Potential causes\n- Nix sandbox network restrictions\n- GitHub Actions runner network configuration\n- bun2nix fixed-output derivation issues","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-28T18:47:50.370411Z","updated_at":"2025-11-28T19:08:00.735556Z","closed_at":"2025-11-28T19:08:00.735556Z"}
{"id":"dh-hgg","title":"Set up multi-arch Nix builds","description":"## Task\nConfigure Nix flake for multi-architecture support.\n\n## Architectures\n- x86_64-linux (primary)\n- aarch64-linux (ARM servers, Raspberry Pi)\n- aarch64-darwin (optional, for Mac development)\n\n## Implementation\n- Use flake-utils or nixpkgs.lib.systems for multi-arch\n- Configure QEMU for cross-compilation if needed\n- Test builds on both architectures\n\n## Verification\n- `nix build .#packages.x86_64-linux.dockerImage`\n- `nix build .#packages.aarch64-linux.dockerImage`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:45.448272697Z","updated_at":"2026-01-02T14:31:00.040711643Z","closed_at":"2025-11-29T14:51:40.273328Z","dependencies":[{"issue_id":"dh-hgg","depends_on_id":"dh-3r6","type":"blocks","created_at":"2025-11-25T07:15:50.627143754Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-hkk","title":"Update ESLint to 9.x","description":"## Task\nUpdate ESLint and related plugins to version 9.x.\n\n## Dependencies to Update\n- eslint → 9.x\n- @typescript-eslint/parser → 8.x (compatible with ESLint 9)\n- @typescript-eslint/eslint-plugin → 8.x\n- eslint-config-prettier → latest\n- eslint-plugin-svelte → latest compatible\n\n## Notes\n- Some plugins may not yet support ESLint 9 flat config\n- Check compatibility before updating\n- May need to temporarily disable incompatible plugins","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:01.857328777Z","updated_at":"2026-01-02T14:31:00.037273098Z","closed_at":"2025-11-29T16:01:45.345116Z","dependencies":[{"issue_id":"dh-hkk","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:14:06.654470948Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-hnu","title":"Enable type-aware ESLint rules for eslint-plugin-functional","description":"## Task\nAdd parserOptions.project configuration to enable type-aware ESLint rules from eslint-plugin-functional.\n\n## Rules to Enable\n- `functional/immutable-data` - Prevent mutations (requires type info to detect complex cases)\n- `functional/prefer-immutable-types` - Prefer readonly types\n\n## Implementation\n1. Add `parserOptions.project: true` to the source-functional config\n2. May need per-package tsconfig.eslint.json files for proper scope\n3. Test performance impact (typed linting can be slower)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T16:24:19.013397Z","updated_at":"2025-11-29T17:00:08.78292Z","closed_at":"2025-11-29T17:00:08.78292Z","dependencies":[{"issue_id":"dh-hnu","depends_on_id":"dh-2o9","type":"blocks","created_at":"2025-11-29T16:27:54.425704Z","created_by":"daemon"}]}
{"id":"dh-i01m","title":"Build and CI improvements","description":"## Overview\nImprove build performance, CI reliability, and release process.\n\n## Goals\n- Evaluate and implement build caching (Cachix)\n- Optimise Nix lockfile handling\n- Fix CI issues (spurious builds, format task)\n- Streamline release process\n\n## Child Issues\n- dh-b4l: Evaluate Cachix service for Docker build caching\n- dh-49v: Add pre-commit hook for nix lockfile regeneration\n- dh-9so: Refactor generateBunNixDeepHeating to reuse prunedWorkspace\n- dh-lo5: Optimise nix lockfile regeneration with caching\n- dh-3pc: Investigate spurious Docker image build on non-release merge\n- dh-b5j: Remove format task from CI pipeline\n- dh-ktd: Update bun.lock and nix files as part of release","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-29T16:53:12.997101Z","created_by":"graemefoster","updated_at":"2025-12-29T16:53:12.997101Z"}
{"id":"dh-i5b2","title":"Frontend: Pop-out initiation UI","description":"Implement the UI for initiating a pop-out:\n- Button/trigger in the main interface (placement TBD from design trials)\n- Duration/time picker based on UX research findings\n- Send pop-out request to backend via WebSocket\n\nPart of: dh-ddf (Popping Out epic)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T17:49:31.404887Z","updated_at":"2025-12-16T17:59:03.675336Z","closed_at":"2025-12-16T17:59:03.675336Z","dependencies":[{"issue_id":"dh-i5b2","depends_on_id":"dh-c3r","type":"blocks","created_at":"2025-12-16T17:49:45.258054Z","created_by":"daemon"},{"issue_id":"dh-i5b2","depends_on_id":"dh-ibr","type":"blocks","created_at":"2025-12-16T17:49:45.688818Z","created_by":"daemon"},{"issue_id":"dh-i5b2","depends_on_id":"dh-dny6","type":"blocks","created_at":"2025-12-16T17:51:30.139374Z","created_by":"daemon"}]}
{"id":"dh-ibr","title":"Backend: Pop-out state management","description":"Implement state management for the pop-out feature:\n- Store pop-out state (active, end time)\n- Persist across server restarts (similar to room adjustments)\n- Expose state via WebSocket to frontend\n- Handle expiry (automatic return to normal when end time reached)\n\nPart of: dh-ddf (Popping Out epic)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T17:49:20.738199Z","updated_at":"2025-12-16T17:59:03.673538Z","closed_at":"2025-12-16T17:59:03.673538Z","dependencies":[{"issue_id":"dh-ibr","depends_on_id":"dh-8i0","type":"blocks","created_at":"2025-12-16T17:49:44.391407Z","created_by":"daemon"},{"issue_id":"dh-ibr","depends_on_id":"dh-dny6","type":"blocks","created_at":"2025-12-16T17:51:29.72788Z","created_by":"daemon"}]}
{"id":"dh-icx","title":"Update CI to publish Nix-built Docker image","description":"## Task\nUpdate GitHub Actions workflow to build and publish Docker images using Nix instead of Dockerfile.\n\n## Current State\n- Docker builds disabled in CI (`if: false`)\n- When enabled, uses `docker/build-push-action` with Dockerfile\n- Nix build produces 337MB image (28% smaller than Dockerfile's 466MB)\n\n## Implementation\n1. Install Nix in CI (e.g., `cachix/install-nix-action`)\n2. Build with `nix build .#dockerImage`\n3. Load image: `docker load \u003c result`\n4. Push to GHCR and DockerHub\n\n## Considerations\n- Multi-arch support: may need separate builds for amd64/arm64\n- Caching: consider Cachix or GitHub Actions cache for Nix store\n- The flake is on feature/nix-flake branch - merge first or test in PR\n\n## Acceptance\n- CI builds Docker image with Nix on push to main\n- Image published to ghcr.io/graemef/deep-heating\n- Image size ~337MB (not 466MB)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-26T18:22:51.672871536Z","updated_at":"2025-11-27T07:59:18.633790781Z","closed_at":"2025-11-26T21:33:41.732392Z","dependencies":[{"issue_id":"dh-icx","depends_on_id":"dh-7rz","type":"blocks","created_at":"2025-11-26T18:23:17.293667872Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-ijgk","title":"Introduce HeatingSystem abstraction for device communication","description":"## Overview\n\nFormalize the boundary between core heating logic and external device communication (currently Home Assistant). The abstraction should speak purely in domain terms, not external system concepts.\n\n## Current State\n\nThe architecture already has good separation:\n- `deep-heating-rx` is pure domain logic (knows nothing about HA)\n- Translation happens in `deep-heating-home-assistant` providers\n- Domain types exist: `TrvUpdate`, `HeatingUpdate`, `TemperatureSensorEntity`, `GoodnightEventEntity`\n\nBut:\n- No explicit interface defining what the core needs from the outside world\n- Testing requires faking Home Assistant entities instead of domain objects\n- The boundary isn't formalized\n\n## Proposed Design\n\n### Interface: `HeatingSystem`\n\n```typescript\ninterface HeatingSystem {\n  // Device state streams (domain types, not HA entities)\n  readonly trvUpdates: Observable\u003cTrvUpdate\u003e\n  readonly heatingUpdates: Observable\u003cHeatingUpdate\u003e\n  readonly temperatureReadings: Observable\u003cTemperatureSensorEntity\u003e\n  readonly sleepModeEvents: Observable\u003cGoodnightEventEntity\u003e\n  \n  // Control actions (Effect for typed errors and composability)\n  setTrvTemperature(entityId: ClimateEntityId, temp: Temperature): Effect.Effect\u003cvoid, HeatingSystemError\u003e\n  setTrvMode(entityId: ClimateEntityId, mode: OperationalClimateMode): Effect.Effect\u003cvoid, HeatingSystemError\u003e\n}\n```\n\n### Implementations\n\n1. **HomeAssistantHeatingSystem** - Wraps existing providers, translates HA entities to domain types\n2. **InMemoryHeatingSystem** - For testing, emits controllable fake domain data\n\n## Benefits\n\n- E2E tests inject `InMemoryHeatingSystem` with fake domain data (no HA knowledge needed)\n- Core logic explicitly declares its external dependencies\n- Future: could swap to different smart home systems (MQTT, local BLE, etc.)\n- Existing provider code largely reused, just wrapped\n- Effect-based actions provide typed errors and composability\n\n## Out of Scope\n\n- Changing the internal RxJS/Effect architecture\n- Migrating away from current provider implementations\n- Supporting multiple heating systems simultaneously","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-29T12:12:08.761103Z","created_by":"graemefoster","updated_at":"2025-12-29T12:13:46.788055Z","dependencies":[{"issue_id":"dh-ijgk","depends_on_id":"dh-raum","type":"blocks","created_at":"2025-12-29T12:12:48.791877Z","created_by":"daemon"}]}
{"id":"dh-izer","title":"Add visual snapshot testing with Playwright","description":"# Visual Snapshot Testing with Playwright\n\nAdd visual regression testing to catch unintended UI changes in PRs.\n\n## Approach\n\nUse Playwright's built-in `toHaveScreenshot()` for visual comparisons. Snapshots are generated only in CI (Linux) to avoid cross-platform rendering differences.\n\n## Scope\n\n- Main dashboard view only (for now)\n- Existing smoke test fixtures provide deterministic data\n- CSS stylesheet freezes animations during capture\n\n## Design Decisions\n\n1. **Effect pattern** - Match existing E2E test style. Add `captureVisualSnapshot` function to `e2e/support/heating-app.ts`\n\n2. **Snapshot storage** - All snapshots in `e2e/snapshots/` directory (not per-test-file), configured via `snapshotPathTemplate`\n\n3. **Animation handling** - Apply `screenshot.css` that disables all CSS animations/transitions during capture\n\n4. **CI-only generation** - Never generate snapshots locally. Use `update-snapshots` label on PR to trigger regeneration via GitHub API (verified commits using App token)\n\n## Files to Create/Modify\n\n**New files:**\n- `packages/deep-heating/e2e/visual.spec.ts` - Test using Effect pattern\n- `packages/deep-heating/e2e/screenshot.css` - Freeze animations\n- `packages/deep-heating/e2e/snapshots/dashboard.png` - Generated by CI\n\n**Modify:**\n- `packages/deep-heating/e2e/support/heating-app.ts` - Add `captureVisualSnapshot(name)` function\n- `packages/deep-heating/playwright.config.ts` - Add `expect.toHaveScreenshot` config with stylePath and snapshotPathTemplate\n- `.github/workflows/ci.yml` - Add snapshot update flow with GitHub App token and Contents API\n\n## Playwright Config Additions\n\n```typescript\nexpect: {\n  toHaveScreenshot: {\n    stylePath: resolve(__dirname, 'e2e/screenshot.css'),\n    maxDiffPixelRatio: 0.01,\n  },\n},\nsnapshotPathTemplate: '{testDir}/snapshots/{arg}{ext}',\n```\n\n## CI Workflow\n\nWhen PR has `update-snapshots` label:\n1. Generate App token (same as release workflow)\n2. Run `playwright test --update-snapshots`\n3. Commit changed snapshots via GitHub Contents API (verified commits)\n\n## First Run\n\nInitial PR will fail (no baseline exists). Add `update-snapshots` label to generate baseline, then remove label.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-29T10:20:36.023845Z","updated_at":"2025-12-29T11:31:27.268406Z","closed_at":"2025-12-29T11:31:27.268406Z"}
{"id":"dh-j07","title":"Replace decodeUnknownSync with Effect-based decode for resilience","description":"home-assistant-api.ts line 173 uses Schema.decodeUnknownSync inside an Effect:\n\n```typescript\nEffect.map(Schema.decodeUnknownSync(Schema.Array(HomeAssistantEntity)))\n```\n\nIf HA returns malformed entity data, this throws synchronously rather than returning a typed error. The Effect runtime catches it as an unexpected defect, but the polling stream may crash rather than gracefully handling the bad data.\n\nSame pattern exists in:\n- climate.ts:21 - decodeClimateEntityId\n- temperature.ts:10 - decodeTemperature  \n- heatingActions.ts:9 - decodeOperationalClimateMode\n\nFix: Use Schema.decodeUnknown (Effect version) instead of decodeUnknownSync, then handle decode failures gracefully - log and skip malformed entities rather than crashing.\n\nThis is the same resilience pattern as dh-lbw (Either for mismatched IDs).","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-08T08:55:08.092254Z","updated_at":"2025-12-08T15:05:00.368439Z","closed_at":"2025-12-08T15:05:00.368439Z"}
{"id":"dh-j7qk","title":"Wire AdjustRoom to RoomActors in server","description":"The server.gleam currently has a no-op room adjuster callback:\n\n\\`\\`\\`gleam\nlet room_adjuster = fn(_room_name: String, _adjustment: Float) { Nil }\n\\`\\`\\`\n\nThis needs to be wired to send AdjustRoom messages to the appropriate RoomActors. The implementation should:\n\n1. Get a registry/map of room name → RoomActor subject from the supervision tree\n2. Look up the RoomActor by room_name\n3. Send an AdjustRoom(adjustment) message to that actor\n\nThis is the last piece needed for the temperature adjustment buttons to actually work.\n\nDepends on: The supervision tree exposing a way to look up RoomActors by name.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T13:16:26.271984849Z","created_by":"graeme","updated_at":"2026-01-04T13:16:40.389643734Z","closed_at":"2026-01-04T13:16:40.389643734Z","close_reason":"Duplicate of existing dh-4wu2"}
{"id":"dh-jai","title":"Update TypeScript and related deps to 5.9.x","description":"## Task\nUpdate TypeScript and all related dependencies to latest stable versions.\n\n## Dependencies to Update\n- typescript → 5.9.x\n- @typescript-eslint/parser → latest compatible\n- @typescript-eslint/eslint-plugin → latest compatible\n- ts-jest → latest compatible (until Jest removal)\n\n## Steps\n1. Update package.json dependencies\n2. Run `bun install`\n3. Fix any immediate type errors\n4. Verify build still works","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:13:37.147036706Z","updated_at":"2026-01-02T14:31:00.056512363Z","closed_at":"2025-11-29T14:47:41.606591Z","dependencies":[{"issue_id":"dh-jai","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:13:41.589823896Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-jj2","title":"Refactor flake.nix to reduce duplication and improve maintainability","description":"## Task\nRefactor flake.nix to reduce code duplication and improve maintainability.\n\n## Current Issues\n- Repeated patterns for bun2nix package generation (generateBunNix, generateBunNixDeepHeating)\n- Similar derivation structures that could be extracted into helper functions\n- Large single file (~12KB) that could be split into modules\n\n## Potential Improvements\n- Extract common patterns into let bindings or lib functions\n- Consider splitting into nix/ directory with separate files:\n  - nix/packages.nix - package derivations\n  - nix/dev-shell.nix - development shell\n  - nix/lib.nix - shared helper functions\n- Use flake-parts or similar for better organization (optional)\n- Add inline documentation for complex derivations\n\n## Acceptance\n- flake.nix is easier to understand and modify\n- No functional changes to outputs\n- All existing builds still work","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-26T09:13:10.588109Z","updated_at":"2026-01-02T14:31:00.0315225Z","closed_at":"2025-11-29T19:49:01.228104Z"}
{"id":"dh-jjs","title":"Share single timer across all TRV scheduled temperature groups","description":"## Summary\n\nIn trvScheduledTargetTemperatures.ts, each TRV group creates its own independent timer:\n\n```typescript\nmergeMap((trvScheduleGroup$) =\u003e\n  combineLatest([\n    timer(0, refreshIntervalSeconds * 1000).pipe(  // NEW timer per TRV!\n      map(localNow),\n      shareReplay(1),\n    ),\n    trvScheduleGroup$,\n  ])\n```\n\nWith 6 TRVs, this creates 6 independent timers all firing every 60 seconds, potentially at different times.\n\n## Improvement\n\nCreate a single shared timer outside the mergeMap:\n\n```typescript\nconst sharedTimer$ = timer(0, refreshIntervalSeconds * 1000).pipe(\n  map(localNow),\n  shareReplay(1),\n);\n\ntrvHiveHeatingSchedule$.pipe(\n  groupBy(...),\n  mergeMap((trvScheduleGroup$) =\u003e\n    combineLatest([sharedTimer$, trvScheduleGroup$])\n  )\n)\n```\n\nThis ensures all TRVs recalculate at the same time, reducing timer overhead.\n\n## Related\n- dh-d41 (introduced this pattern)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-10T07:58:06.81107Z","updated_at":"2025-12-10T07:58:35.25432Z","dependencies":[{"issue_id":"dh-jjs","depends_on_id":"dh-7sjo","type":"parent-child","created_at":"2025-12-29T16:53:57.933412Z","created_by":"daemon"}]}
{"id":"dh-js6","title":"Add error handlers to all RxJS subscriptions in DeepHeating.ts","description":"DeepHeating.ts has 18 .subscribe() calls with no error handlers. If any observable errors (e.g., from a Schema decode failure or network issue), that subscription terminates silently with no logging or recovery.\n\nCritical subscriptions that affect TRV control:\n- heatingProvider.trvApiUpdates$.subscribe - feeds TRV state into the system\n- appliedTrvActions$.subscribe(publishTrvControlState) - publishes applied actions\n\nAll subscriptions should have error handlers that at minimum log the error. Consider using a helper function to wrap subscriptions with consistent error handling.","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-06T08:01:38.17116Z","updated_at":"2025-12-06T08:03:10.442178Z","dependencies":[{"issue_id":"dh-js6","depends_on_id":"dh-7sjo","type":"parent-child","created_at":"2025-12-29T16:53:57.813015Z","created_by":"daemon"}]}
{"id":"dh-k08","title":"Add separate typecheck turbo task","description":"Currently typecheck is bundled into lint. Having a separate `typecheck` task (like brownsauce) makes it easier to run just type checking without linting, and allows better dependency ordering in the turbo pipeline.\n\n## Implementation notes (from brownsauce)\n\nThe typecheck task should have:\n- `dependsOn: [\"^build\", \"^typecheck\"]` - needs upstream builds and typechecks\n- Explicit `inputs` for caching: `src/**/*.ts`, `tsconfig*.json`, `package.json`, `$TURBO_ROOT$/bun.lock`\n- `cache: true` and `outputs: []`\n\nThen update `lint` to depend on `typecheck` instead of just `^build`.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T08:26:37.580082Z","updated_at":"2025-11-30T08:45:00.477308Z","closed_at":"2025-11-30T08:45:00.477308Z"}
{"id":"dh-k8y","title":"Replace npm lockfile with bun.lock","description":"## Task\nRemove package-lock.json and generate bun.lock by running `bun install`.\n\n## Steps\n1. Delete package-lock.json\n2. Run `bun install` to generate bun.lock\n3. Verify all dependencies resolve correctly\n4. Check for any resolution differences between npm and bun\n\n## Verification\n- `bun install` completes without errors\n- All workspace packages are linked correctly","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:12:18.037048567Z","updated_at":"2025-11-25T07:47:37.137086051Z","closed_at":"2025-11-25T07:47:37.137086051Z","dependencies":[{"issue_id":"dh-k8y","depends_on_id":"dh-vkw","type":"blocks","created_at":"2025-11-25T07:33:58.268370587Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-kag","title":"Add full E2E smoke test with headless browser","description":"Extend the basic smoke test (dh-27t) to include full end-to-end verification using a headless browser (Playwright or similar):\n\n- Load frontend in headless browser\n- Verify WebSocket connection is actually established\n- Check for JS errors in console\n- Optionally verify basic UI renders correctly\n\nThis is a follow-up to the basic HTTP + WebSocket probe smoke test.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-02T18:17:22.889831Z","updated_at":"2025-12-08T14:36:57.407857Z","closed_at":"2025-12-08T14:36:57.407857Z","dependencies":[{"issue_id":"dh-kag","depends_on_id":"dh-27t","type":"blocks","created_at":"2025-12-02T18:17:29.116803Z","created_by":"daemon"}]}
{"id":"dh-klx","title":"Replace debug with Effect Logger","description":"## Overview\nMigrate files using the `debug` package to Effect Logger.\n\n## Why Blocked\nThe debug package is used in RxJS subscribe callbacks and pure functions - NOT in Effect context. Cannot use Effect.log outside of an Effect runtime.\n\nMust wait for dh-ez9 (migrate createDeepHeating to Effect) before this becomes feasible.\n\n## Files Using debug (8 total)\n- packages/deep-heating-rx/src/lib/streams/DeepHeating.ts\n- packages/deep-heating-rx/src/lib/streams/actions.ts\n- packages/deep-heating-rx/src/lib/streams/rooms/roomDecisionPoints.ts\n- packages/deep-heating-rx/src/lib/streams/trvs/trvActions.ts\n- packages/deep-heating-rx/src/lib/streams/trvs/trvDecisionPoints.ts\n- packages/deep-heating-rx/src/lib/streams/trvs/trvDesiredTargetTemperatures.ts\n- packages/deep-heating-rx/src/lib/streams/trvs/trvTemperatures.ts\n- packages/deep-heating-home-assistant/src/lib/climate/climate.ts\n\n## Effect Logger Capabilities\n- Logger.make for custom formatters\n- Namespaced logging via Effect.annotateLogs\n- Log levels (Debug, Info, Warning, Error)\n- Structured JSON logging with Logger.json\n- Log spans with Effect.withLogSpan\n\nThis removes the debug dependency and provides better observability.","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T11:57:57.248818Z","updated_at":"2025-12-12T18:20:04.955842Z","dependencies":[{"issue_id":"dh-klx","depends_on_id":"dh-ez9","type":"blocks","created_at":"2025-12-12T18:19:54.742177Z","created_by":"daemon"}]}
{"id":"dh-klzp","title":"Export HomeAssistantHeatingSystem from package","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T16:19:45.278701Z","created_by":"graemefoster","updated_at":"2025-12-29T16:38:35.59471Z","closed_at":"2025-12-29T16:38:35.59471Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-klzp","depends_on_id":"dh-ymvk","type":"blocks","created_at":"2025-12-29T16:19:54.778826Z","created_by":"daemon"}]}
{"id":"dh-km6","title":"Apply consistent Effect lint rules to test files","description":"## Overview\nTest files should be linted to the same standard as production code, with minimal exceptions.\n\n## Current State\n- Test files (\\*.spec.ts, \\*.test.ts) may have different/relaxed lint rules\n- Effect.gen was used in tests without lint errors (should use pipe pattern)\n- Inconsistent enforcement between test and production code\n\n## Target State\n- Apply the same Effect lint rules to test files as production code\n- Only allow specific, justified exceptions (e.g. allowing any for test fixtures)\n- Ensure eslint-plugin-effect rules apply uniformly\n\n## Files to Change\n- ESLint config (remove test-specific overrides that relax Effect rules)\n- Fix any test files that violate the rules after config change\n\n## Rationale\nTests should model good code practices. If a pattern is bad enough to lint against in production, it's bad enough to lint against in tests.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T13:05:45.470372Z","updated_at":"2025-11-30T16:52:21.741961Z","closed_at":"2025-11-30T16:52:21.741961Z"}
{"id":"dh-ko1","title":"Evaluate Effect ESLint rules for web package","description":"The web package (SvelteKit) has several Effect ESLint rules disabled because it's not an Effect-based application:\n- effect/prefer-effect-platform (off) - uses process.env directly\n- effect/prefer-match-over-ternary (off) - simple ternaries in UI code\n- functional/prefer-immutable-types (off) - Svelte stores are mutable\n- functional/prefer-readonly-type (off) - Svelte stores are mutable\n\nConsider whether these rules should be gradually adopted or if the overrides are permanent.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T08:09:52.687576Z","updated_at":"2025-11-30T09:13:21.676216Z","closed_at":"2025-11-30T09:13:21.676216Z"}
{"id":"dh-ktd","title":"Update bun.lock and nix files as part of release","description":"During the release process, bun.lock is updated by changesets but the nix lockfiles (bun-deep-heating.nix) are not regenerated. This can lead to build failures in CI as the nix files go out of sync with the actual lockfile.\n\nConsider running bun2nix as part of the release workflow, or having the sync workflow commit directly to the release branch.","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T17:22:17.145044Z","updated_at":"2025-11-30T17:22:26.122442Z","dependencies":[{"issue_id":"dh-ktd","depends_on_id":"dh-i01m","type":"parent-child","created_at":"2025-12-29T16:53:56.571774Z","created_by":"daemon"}]}
{"id":"dh-lbw","title":"Replace throw statements with catchError and retry in RxJS pipelines","description":"Two locations use throw Error() inside RxJS pipelines:\n\n1. determineAction() in trvActions.ts - throws if climateEntityIds don't match across streams\n2. getRoomTargetTemperatures() in roomTargetTemperatures.ts - throws if room names don't match\n\nThese errors indicate a programming bug (mismatched data), but throwing will terminate the entire observable stream with no recovery. A single corrupted update from HA could kill the whole heating control system.\n\nOptions:\n- Use catchError to log and skip the bad value\n- Use filter to silently drop mismatched values (with logging)\n- Consider if the mismatch check is even necessary given the pipeline design","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-06T08:01:44.858934Z","updated_at":"2025-12-06T08:24:14.327942Z","closed_at":"2025-12-06T08:24:14.327942Z"}
{"id":"dh-lo5","title":"Optimise nix lockfile regeneration with caching","description":"## Problem\n\nThe GitHub Actions workflow `sync-bun-nix.yml` takes ~2 minutes to regenerate `bun-deep-heating.nix` when `bun.lock` changes. Most of this time is spent on nix/cachix setup, not the actual regeneration (~2 seconds).\n\nWe want to:\n1. Enable local regeneration (pre-commit hook) so lockfile drift is caught before CI\n2. Eliminate duplicate work in the nix flake\n\n## Current State\n\n- `sync-bun-nix.yml` workflow runs on push when `bun.lock` changes\n- Runs `turbo prune` then `bun2nix` to generate `bun-deep-heating.nix`\n- The flake has `generateBunNixDeepHeating` derivation but it duplicates `turbo prune` work (prunedWorkspace already runs it)\n\n## Solutions Considered\n\n1. **Turbo task** - BLOCKED: turbo's recursive invocation detection flags `turbo prune` in scripts as potentially recursive (false positive).\n\n2. **Split nix derivation for precise caching** - REJECTED: Would require either duplicating `turbo prune` or reimplementing its package selection logic.\n\n3. **Refactor nix derivation (chosen)** - Make `generateBunNixDeepHeating` depend on `prunedWorkspace`. Accepts imprecise caching (rebuilds on any source change) but eliminates duplicate work.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-10T21:09:43.003013Z","updated_at":"2025-12-10T21:09:43.003013Z","dependencies":[{"issue_id":"dh-lo5","depends_on_id":"dh-9so","type":"blocks","created_at":"2025-12-10T21:10:20.260489Z","created_by":"daemon"},{"issue_id":"dh-lo5","depends_on_id":"dh-49v","type":"blocks","created_at":"2025-12-10T21:10:20.3039Z","created_by":"daemon"},{"issue_id":"dh-lo5","depends_on_id":"dh-i01m","type":"parent-child","created_at":"2025-12-29T16:53:55.557019Z","created_by":"daemon"}]}
{"id":"dh-lou","title":"Schema mismatch: radiator temperature sent as Option-encoded but client expects plain value","description":"ParseError in web client when receiving room state from Socket.IO.\n\n**Error:**\nThe radiator `temperature` field is received as Option-encoded format:\n`{\"_id\":\"Option\",\"_tag\":\"Some\",\"value\":{\"temperature\":26,\"time\":\"2025-11-30T18:54:36.444Z\"}}`\n\nBut the client schema expects plain `{ temperature, time } | null`.\n\n**Root cause investigation needed:**\n- Check if server (deep-heating-socketio) is double-encoding Option values\n- Check if schema definitions differ between server and client\n- The radiator temperature schema uses `({ temperature, time } | null \u003c-\u003e Option\u003c...\u003e)` transformation\n\n**Type safety gap:**\nThe compiler should catch this mismatch. Investigation should identify where type safety is broken:\n- Are schemas properly shared between packages?\n- Is there an `any` cast or type assertion breaking the type chain?\n- Is Socket.IO's emit/receive properly typed end-to-end?\n\n**Fix requirements:**\n- Fix the immediate encoding mismatch\n- Ensure end-to-end type safety so compiler catches future mismatches\n\n**Location:**\n- Client receives data via Socket.IO 'state' event\n- Error occurs in compiled SvelteKit code (home.DPgHIzN1.js)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-30T18:57:33.714272Z","updated_at":"2025-11-30T19:03:05.553069Z","closed_at":"2025-11-30T19:03:05.553069Z"}
{"id":"dh-lph","title":"Clarify bd sync instructions for protected main branch","description":"## Problem\nCurrent beads workflow instructions don't account for protected main branch. Running `bd sync` on main fails due to branch protection, causing confusing errors.\n\n## Clarification needed\n- On feature branches: `bd sync` works fine, use it freely\n- On main: Don't run `bd sync` manually - the daemon handles it via beads-metadata branch\n\n## Update locations\n- Session start hook instructions\n- Any beads documentation in the repo","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T11:13:43.546171Z","updated_at":"2025-11-29T11:16:23.340646Z","closed_at":"2025-11-29T11:16:23.340646Z"}
{"id":"dh-luf","title":"Remove Jest and Vitest dependencies","description":"## Task\nClean up Jest and Vitest dependencies after all tests are migrated.\n\n## Dependencies to Remove\n- jest\n- ts-jest\n- @types/jest\n- jest-environment-jsdom\n- vitest\n- @vitest/coverage-v8\n- Any other jest-* or vitest-* packages\n\n## Files to Delete\n- jest.config.ts files\n- jest.preset.js\n- vitest.config.ts files\n- Any Jest/Vitest specific setup files\n\n## Verification\n- `bun test` runs all tests successfully\n- No Jest/Vitest references remain in codebase","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:33.079972681Z","updated_at":"2026-01-02T14:31:00.035017575Z","closed_at":"2025-11-30T11:17:02.962985Z","dependencies":[{"issue_id":"dh-luf","depends_on_id":"dh-5rw","type":"blocks","created_at":"2025-11-25T07:14:39.582336623Z","created_by":"daemon","metadata":"{}"},{"issue_id":"dh-luf","depends_on_id":"dh-09s","type":"blocks","created_at":"2025-11-25T07:14:39.59646713Z","created_by":"daemon","metadata":"{}"},{"issue_id":"dh-luf","depends_on_id":"dh-91v","type":"blocks","created_at":"2025-11-25T07:14:39.611205132Z","created_by":"daemon","metadata":"{}"},{"issue_id":"dh-luf","depends_on_id":"dh-e5x","type":"blocks","created_at":"2025-11-25T07:14:39.625573041Z","created_by":"daemon","metadata":"{}"},{"issue_id":"dh-luf","depends_on_id":"dh-2nz","type":"blocks","created_at":"2025-11-30T11:06:24.574077Z","created_by":"daemon"}]}
{"id":"dh-lul","title":"Phase 1: Update to Vite 6 + SvelteKit 2.49 (stay on Svelte 4)","description":"Update to Vite 6 and latest SvelteKit while staying on Svelte 4.\n\n## Updates\n- @sveltejs/kit: 2.5.26 → 2.49.0\n- @sveltejs/adapter-node: 5.2.2 → 5.4.0\n- @sveltejs/vite-plugin-svelte: 3.1.2 → 5.x (last version supporting Svelte 4)\n- vite: 5.4.21 → 6.4.1\n\n## Why v5 of vite-plugin-svelte?\nVersion 6 dropped Svelte 4 support entirely. We need to stay on v5 until we migrate to Svelte 5.\n\n## Tasks\n1. Close Renovate PR #1076 (it's trying to update to plugin v6 which won't work)\n2. Update package.json with the versions above\n3. Run bun install to update lock file\n4. Run turbo all to verify build passes\n5. Check for deprecation warnings in build output","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-01T17:26:58.133948Z","updated_at":"2025-12-01T17:46:09.473885Z","closed_at":"2025-12-01T17:46:09.473885Z"}
{"id":"dh-lun","title":"Fix CI/Sync race condition for bun-deep-heating.nix","description":"When bun.lock changes, the sync workflow and CI workflow both trigger. Sync commits with [skip ci] so CI never re-runs after the fix is applied. This causes CI to fail even though sync successfully fixed the file.\n\nRoot cause:\n1. Sync commits use [skip ci] preventing CI re-run\n2. validate-nix job doesn't checkout PR HEAD like build job does\n\nFix:\n1. Remove [skip ci] from sync commit message\n2. Make validate-nix checkout PR head ref","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T14:23:14.076874Z","updated_at":"2025-11-29T14:24:59.256312Z","closed_at":"2025-11-29T14:24:59.256312Z"}
{"id":"dh-m18p","title":"Add temperature formatting utilities for UI","description":"## Overview\n\nAdd display-focused utilities to the temperature module for UI rendering. These complement the existing arithmetic/comparison functions.\n\n## Context\n\nThe existing `deep_heating/temperature.gleam` has:\n- Opaque `Temperature` type with smart constructor\n- Arithmetic: `add`, `subtract`\n- Comparison: `compare`, `eq`, `gt`, `lt`, `gte`, `lte`\n- Rounding: `round_up_half`, `round_down_half`\n- Constants: `min_room_target`, `min_trv_target`, etc.\n\nThe UI needs formatting for display and sorting rooms by temperature.\n\n## TypeScript Reference\n\nFrom `/home/graeme/Development/home-automation/packages/deep-heating-web/src/lib/temperature.ts`:\n```typescript\nexport function formatTemperature(\n  temp: Option\u003cTemperature\u003e,\n  showUnits = true\n): string {\n  return pipe(\n    temp,\n    Option.map((t) =\u003e\n      new Intl.NumberFormat('en-GB', {\n        minimumFractionDigits: 1,\n        maximumFractionDigits: 1,\n      }).format(t) + (showUnits ? 'ºC' : '')\n    ),\n    Option.getOrElse(() =\u003e '–')\n  );\n}\n```\n\n## Implementation\n\nAdd to `src/deep_heating/temperature.gleam`:\n\n```gleam\nimport gleam/float\nimport gleam/int\nimport gleam/option.{type Option, None, Some}\n\n/// Format a temperature for display.\n/// Returns the temperature to 1 decimal place with \"°C\" suffix.\n/// Example: 20.5 -\u003e \"20.5°C\"\npub fn format(temp: Temperature) -\u003e String {\n  float_to_string_1dp(unwrap(temp)) \u003c\u003e \"°C\"\n}\n\n/// Format an optional temperature for display.\n/// Returns \"–\" (en-dash) for None.\npub fn format_option(temp: Option(Temperature)) -\u003e String {\n  case temp {\n    Some(t) -\u003e format(t)\n    None -\u003e \"–\"\n  }\n}\n\n/// Format a temperature without units (for use in controls).\npub fn format_bare(temp: Temperature) -\u003e String {\n  float_to_string_1dp(unwrap(temp))\n}\n\n/// Helper: format float to 1 decimal place.\nfn float_to_string_1dp(value: Float) -\u003e String {\n  let rounded = float.round(value *. 10.0) /. 10.0\n  let int_part = float.truncate(rounded)\n  let frac = float.absolute_value(rounded -. int.to_float(int_part)) *. 10.0\n  int.to_string(int_part) \u003c\u003e \".\" \u003c\u003e int.to_string(float.truncate(float.round(frac)))\n}\n```\n\nAdd to `src/ui/room_sort.gleam`:\n\n```gleam\nimport deep_heating/state.{type RoomState}\nimport deep_heating/temperature.{type Temperature}\nimport gleam/list\nimport gleam/option.{None, Some}\nimport gleam/order.{type Order}\n\n/// Sort rooms by temperature, hottest first.\npub fn sort_by_temperature(rooms: List(RoomState)) -\u003e List(RoomState) {\n  list.sort(rooms, compare_by_temperature)\n}\n\n/// Compare rooms by temperature for sorting (hottest first).\npub fn compare_by_temperature(a: RoomState, b: RoomState) -\u003e Order {\n  let a_temp = get_room_temp_or_max(a)\n  let b_temp = get_room_temp_or_max(b)\n  temperature.compare(b_temp, a_temp)  // Descending\n}\n\nfn get_room_temp_or_max(room: RoomState) -\u003e Temperature {\n  case room.temperature {\n    Some(reading) -\u003e reading.temperature\n    None -\u003e temperature.temperature(60.0)\n  }\n}\n```\n\n## Testing\n\n### Unit Tests for Formatting\n\nCreate `test/deep_heating/temperature_format_test.gleam`:\n\n```gleam\nimport deep_heating/temperature.{temperature, format, format_option, format_bare}\nimport gleam/option.{None, Some}\n\npub fn format_positive_temperature_test() {\n  let temp = temperature(20.5)\n  let assert \"20.5°C\" = format(temp)\n}\n\npub fn format_rounds_to_one_decimal_test() {\n  let temp = temperature(20.55)\n  let assert \"20.6°C\" = format(temp)\n}\n\npub fn format_negative_temperature_test() {\n  let temp = temperature(-5.0)\n  let assert \"-5.0°C\" = format(temp)\n}\n\npub fn format_option_some_test() {\n  let temp = Some(temperature(21.0))\n  let assert \"21.0°C\" = format_option(temp)\n}\n\npub fn format_option_none_test() {\n  let assert \"–\" = format_option(None)\n}\n\npub fn format_bare_no_units_test() {\n  let temp = temperature(19.5)\n  let assert \"19.5\" = format_bare(temp)\n}\n\npub fn format_zero_test() {\n  let temp = temperature(0.0)\n  let assert \"0.0°C\" = format(temp)\n}\n\npub fn format_whole_number_shows_decimal_test() {\n  let temp = temperature(20.0)\n  let assert \"20.0°C\" = format(temp)\n}\n```\n\n### Unit Tests for Sorting\n\nCreate `test/ui/room_sort_test.gleam`:\n\n```gleam\nimport ui/room_sort.{sort_by_temperature}\nimport test/ui/test_helpers.{room_with_temp, room_without_temp}\nimport gleam/list\n\npub fn sorts_hottest_first_test() {\n  let rooms = [\n    room_with_temp(\"Cold\", 18.0),\n    room_with_temp(\"Hot\", 24.0),\n    room_with_temp(\"Medium\", 21.0),\n  ]\n  \n  let sorted = sort_by_temperature(rooms)\n  let names = list.map(sorted, fn(r) { r.name })\n  \n  let assert [\"Hot\", \"Medium\", \"Cold\"] = names\n}\n\npub fn rooms_without_temp_sort_to_end_test() {\n  let rooms = [\n    room_without_temp(\"Unknown\"),\n    room_with_temp(\"Known\", 20.0),\n  ]\n  \n  let sorted = sort_by_temperature(rooms)\n  let names = list.map(sorted, fn(r) { r.name })\n  \n  let assert [\"Known\", \"Unknown\"] = names\n}\n\npub fn empty_list_returns_empty_test() {\n  let assert [] = sort_by_temperature([])\n}\n\npub fn single_room_returns_same_test() {\n  let rooms = [room_with_temp(\"Only\", 20.0)]\n  let assert [room] = sort_by_temperature(rooms)\n  let assert \"Only\" = room.name\n}\n```\n\n## Type Safety Considerations\n\n1. **Opaque Temperature type**: Already enforced - cannot construct invalid temperatures\n2. **Option handling**: Explicit `None` case returns \"–\" (user-friendly placeholder)\n3. **No stringly-typed formatting**: Functions return `String` but input is always typed\n4. **Sorting preserves type**: `compare_by_temperature` returns `Order`, works with `list.sort`\n\n## Acceptance Criteria\n\n- [ ] `format` returns temperature with 1 decimal + \"°C\" (e.g., \"20.5°C\")\n- [ ] `format_option` handles `None` with \"–\" placeholder\n- [ ] `format_bare` returns just the number (e.g., \"20.5\")\n- [ ] `sort_by_temperature` sorts hottest first\n- [ ] All functions have doc comments\n- [ ] Unit tests pass for:\n  - Positive, negative, zero temperatures\n  - Rounding to 1 decimal place\n  - None handling\n  - Sorting order\n  - Edge cases (empty list, single item)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T10:41:29.732044163Z","created_by":"graeme","updated_at":"2026-01-04T12:10:01.947729115Z","closed_at":"2026-01-04T12:10:01.947729115Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-m18p","depends_on_id":"dh-33jq.18","type":"blocks","created_at":"2026-01-04T10:47:25.659653802Z","created_by":"graeme"},{"issue_id":"dh-m18p","depends_on_id":"dh-33jq","type":"blocks","created_at":"2026-01-04T10:47:32.448748646Z","created_by":"graeme"}]}
{"id":"dh-m2mr","title":"Review and refactor test organization","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-04T12:27:50.30863639Z","created_by":"graeme","updated_at":"2026-01-04T12:27:50.30863639Z"}
{"id":"dh-m6b","title":"Fix flaky WebSocket server test port collision","description":"The WebSocket server tests intermittently fail with port collision:\n\n```\nerror: Failed to start server. Is port 60900 in use?\n(fail) WebSocket Server Integration \u003e should handle multiple room adjustments\n```\n\nThe tests use a fixed port (60900) and don't wait for the previous server to fully release the port before starting a new one.\n\n**Fix options:**\n1. Use port 0 to let OS assign an available port\n2. Add proper cleanup/wait between tests\n3. Run tests serially instead of in parallel\n\nFile: `packages/deep-heating-server/src/app/websocket-server.test.ts`","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-03T13:20:23.083911Z","updated_at":"2025-12-03T13:20:33.41683Z","dependencies":[{"issue_id":"dh-m6b","depends_on_id":"dh-stnj","type":"parent-child","created_at":"2025-12-29T16:53:54.107842Z","created_by":"daemon"}]}
{"id":"dh-mb0f","title":"Frontend dependencies upgrade (Dec 2025)","description":"Epic grouping all frontend dependency upgrades identified in Dec 2025.\n\n**Major upgrades:**\n- Tailwind CSS v3 → v4 (dh-x4pv)\n- DaisyUI v4 → v5 (dh-vyd3)\n\n**Minor upgrades:**\n- Svelte, svelte-check, prettier-plugin-svelte (dh-np8q)\n\n**Key considerations:**\n- Tailwind v4 and DaisyUI v5 must be upgraded together (DaisyUI v5 requires Tailwind v4)\n- Tailwind v4 removes need for autoprefixer\n- Minor upgrades are independent and low-risk\n\n**Existing Renovate PRs:**\n- #1280 (Tailwind)\n- #1279 (DaisyUI)  \n- #1278 (Svelte)\n- #1277 (autoprefixer - can close, will be removed)","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-26T16:22:25.752378Z","updated_at":"2025-12-26T17:01:27.65235Z","closed_at":"2025-12-26T17:01:27.65235Z","dependencies":[{"issue_id":"dh-mb0f","depends_on_id":"dh-x4pv","type":"blocks","created_at":"2025-12-26T16:22:58.58201Z","created_by":"daemon"},{"issue_id":"dh-mb0f","depends_on_id":"dh-vyd3","type":"blocks","created_at":"2025-12-26T16:22:58.620217Z","created_by":"daemon"},{"issue_id":"dh-mb0f","depends_on_id":"dh-np8q","type":"blocks","created_at":"2025-12-26T16:22:58.65797Z","created_by":"daemon"}]}
{"id":"dh-mcpu","title":"Create SVG icon module for UI","description":"## Overview\n\nCreate a Gleam module with SVG icons needed by the Lustre UI components. Icons are rendered as inline SVG for type safety and no external dependencies.\n\n## Required Icons\n\n1. **Fire icon** 🔥 - Shows when room is heating\n2. **Plus circle** ➕ - Increase temperature (solid + outline variants)\n3. **Minus circle** ➖ - Decrease temperature (solid + outline variants)\n\n## Implementation\n\nCreate `src/ui/icons.gleam`:\n\n```gleam\nimport lustre/attribute.{type Attribute, attribute}\nimport lustre/element.{type Element}\nimport lustre/element/svg\n\n/// Icon size type for type-safe sizing\npub type IconSize {\n  IconSmall   // 16px\n  IconMedium  // 24px (default)\n  IconLarge   // 32px\n}\n\nfn size_to_px(size: IconSize) -\u003e String {\n  case size {\n    IconSmall -\u003e \"16\"\n    IconMedium -\u003e \"24\"\n    IconLarge -\u003e \"32\"\n  }\n}\n\n/// Fire icon - displayed when heating is active\npub fn fire(size: IconSize) -\u003e Element(msg) {\n  let px = size_to_px(size)\n  svg.svg(\n    [\n      attribute(\"viewBox\", \"0 0 24 24\"),\n      attribute(\"width\", px),\n      attribute(\"height\", px),\n      attribute(\"fill\", \"currentColor\"),\n      attribute(\"data-testid\", \"fire-icon\"),\n    ],\n    [\n      svg.path([\n        attribute(\"d\", \"M17.66 11.2C17.43 10.9 17.15 10.64 16.89 10.38...\"),\n      ]),\n    ],\n  )\n}\n\n/// Plus circle icon (solid)\npub fn plus_circle_solid(size: IconSize) -\u003e Element(msg) { ... }\n\n/// Plus circle icon (outline)\npub fn plus_circle_outline(size: IconSize) -\u003e Element(msg) { ... }\n\n/// Minus circle icon (solid)\npub fn minus_circle_solid(size: IconSize) -\u003e Element(msg) { ... }\n\n/// Minus circle icon (outline)\npub fn minus_circle_outline(size: IconSize) -\u003e Element(msg) { ... }\n\n/// Helper: choose plus icon based on adjustment state\npub fn plus_icon(has_positive_adjustment: Bool, size: IconSize) -\u003e Element(msg) {\n  case has_positive_adjustment {\n    True -\u003e plus_circle_solid(size)\n    False -\u003e plus_circle_outline(size)\n  }\n}\n\n/// Helper: choose minus icon based on adjustment state\npub fn minus_icon(has_negative_adjustment: Bool, size: IconSize) -\u003e Element(msg) {\n  case has_negative_adjustment {\n    True -\u003e minus_circle_solid(size)\n    False -\u003e minus_circle_outline(size)\n  }\n}\n```\n\n## Testing\n\n### Snapshot Tests for Icons\n\nCreate `test/ui/icons_test.gleam`:\n\n```gleam\nimport birdie\nimport lustre/element\nimport ui/icons.{IconSmall, IconMedium, IconLarge}\n\npub fn fire_icon_small_test() {\n  icons.fire(IconSmall)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"fire_icon_small\")\n}\n\npub fn fire_icon_medium_test() {\n  icons.fire(IconMedium)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"fire_icon_medium\")\n}\n\npub fn fire_icon_large_test() {\n  icons.fire(IconLarge)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"fire_icon_large\")\n}\n\npub fn plus_circle_solid_test() {\n  icons.plus_circle_solid(IconMedium)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"plus_circle_solid\")\n}\n\npub fn plus_circle_outline_test() {\n  icons.plus_circle_outline(IconMedium)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"plus_circle_outline\")\n}\n\npub fn minus_circle_solid_test() {\n  icons.minus_circle_solid(IconMedium)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"minus_circle_solid\")\n}\n\npub fn minus_circle_outline_test() {\n  icons.minus_circle_outline(IconMedium)\n  |\u003e element.to_string()\n  |\u003e birdie.snap(\"minus_circle_outline\")\n}\n```\n\n### Query Tests for Icon Structure\n\n```gleam\nimport lustre/dev/query.{tag, attribute, has}\nimport ui/icons\n\npub fn fire_icon_is_svg_test() {\n  let icon = icons.fire(icons.IconMedium)\n  let assert True = query.has(icon, tag(\"svg\"))\n}\n\npub fn fire_icon_has_test_id_test() {\n  let icon = icons.fire(icons.IconMedium)\n  let assert True = query.has(icon, query.test_id(\"fire-icon\"))\n}\n\npub fn icon_uses_current_color_test() {\n  let icon = icons.fire(icons.IconMedium)\n  let assert True = query.has(icon, query.attribute(\"fill\", \"currentColor\"))\n}\n```\n\n### Unit Tests for Icon Selection Helpers\n\n```gleam\nimport lustre/element\nimport ui/icons\n\npub fn plus_icon_solid_when_positive_adjustment_test() {\n  let solid = icons.plus_circle_solid(icons.IconMedium) |\u003e element.to_string()\n  let selected = icons.plus_icon(True, icons.IconMedium) |\u003e element.to_string()\n  let assert True = solid == selected\n}\n\npub fn plus_icon_outline_when_no_adjustment_test() {\n  let outline = icons.plus_circle_outline(icons.IconMedium) |\u003e element.to_string()\n  let selected = icons.plus_icon(False, icons.IconMedium) |\u003e element.to_string()\n  let assert True = outline == selected\n}\n\npub fn minus_icon_solid_when_negative_adjustment_test() {\n  let solid = icons.minus_circle_solid(icons.IconMedium) |\u003e element.to_string()\n  let selected = icons.minus_icon(True, icons.IconMedium) |\u003e element.to_string()\n  let assert True = solid == selected\n}\n```\n\n## Type Safety Considerations\n\n1. **IconSize enum**: Prevents arbitrary sizes, ensures consistency\n2. **Polymorphic Element(msg)**: Icons work with any message type\n3. **No string paths**: SVG data is embedded, no runtime file loading failures\n4. **test-id attributes**: Enable query-based testing\n\n## Acceptance Criteria\n\n- [ ] Fire icon renders correctly\n- [ ] Plus/minus icons have both solid and outline variants\n- [ ] `IconSize` type controls sizing consistently\n- [ ] Helper functions select icon variant based on boolean\n- [ ] All icons use `currentColor` for CSS color inheritance\n- [ ] All icons have `data-testid` attributes\n- [ ] Snapshot tests pass for all icon variants\n- [ ] Query tests verify SVG structure\n- [ ] Unit tests verify helper selection logic","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T10:41:29.909479159Z","created_by":"graeme","updated_at":"2026-01-04T12:01:10.032533464Z","closed_at":"2026-01-04T12:01:10.032533464Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-mcpu","depends_on_id":"dh-33jq.18","type":"blocks","created_at":"2026-01-04T10:47:25.813612206Z","created_by":"graeme"},{"issue_id":"dh-mcpu","depends_on_id":"dh-33jq","type":"blocks","created_at":"2026-01-04T10:47:32.468495536Z","created_by":"graeme"}]}
{"id":"dh-mdh","title":"Replace Socket.IO with Effect Platform Socket","description":"## Overview\nReplace Socket.IO with @effect/platform Socket for real-time client-server communication.\n\n## Current State\n- Socket.IO used in deep-heating-socketio for real-time updates\n- RxJS fromEvent() used to convert socket events to observables\n- Manual connection handling\n\n## Target State\n- Use @effect/platform Socket and SocketServer\n- Native Effect Stream integration\n- Automatic reconnection with configurable backoff\n- Proper resource cleanup via Effect Scope\n\n## Effect Platform Socket Features\n- `Socket.makeWebSocket(url)` - Create WebSocket client\n- `Socket.toChannel()` - Convert to Effect Channel for bidirectional streaming\n- `SocketServer.run(handler)` - Server-side socket handling\n- Built-in reconnection with exponential backoff\n- Automatic cleanup on scope end\n\n## Alternative: effect-websocket library\nCommunity library with even richer support:\n- Runtime portability (Node/Bun/Browser)\n- `client.messages` - Stream of incoming messages\n- `client.events` - Connection lifecycle events\n- `client.send()` - Send messages\n\n## Migration Approach\n1. Replace Socket.IO server with Effect SocketServer\n2. Replace Socket.IO client events with Effect Socket streams\n3. Use adapters to expose as RxJS Observable for existing consumers\n4. Gradually migrate consumers to Effect Streams\n\n## Files to Change\n- packages/deep-heating-socketio/src/socket-server.ts\n- packages/deep-heating-socketio/src/server.ts\n- packages/deep-heating-web (client side)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T11:50:52.794367Z","updated_at":"2025-12-01T08:34:58.69229Z","closed_at":"2025-12-01T08:34:58.69229Z"}
{"id":"dh-mun","title":"Fix changesets github-api mode not deleting changeset files","description":"The changesets/action with commitMode: github-api fails to delete .changeset/*.md files after consuming them. This causes an infinite loop where each run creates a new 'Version Packages' PR because it sees unconsumed changesets.\n\n## Root cause\nKnown bug in changesets/action (issue #510). The GitHub API commit mode doesn't properly handle file deletions.\n\n## Current state\nPRs #1202 and #1203 added a workaround using `gh api` to delete files via the GitHub Contents API. However, the Contents API does NOT create verified commits even when using a GitHub App token.\n\n## Remaining work\nRewrite the deletion step to use the Git Data API instead:\n1. Get the current commit SHA for changeset-release/main\n2. Get the tree SHA for that commit\n3. Create a new tree that excludes the changeset .md files\n4. Create a new commit pointing to that tree (this will be verified)\n5. Update the branch ref to point to the new commit\n\nThis is more complex but is the only way to get verified commits via the API.\n\n## References\n- Upstream bug: https://github.com/changesets/action/issues/510\n- Git Data API: https://docs.github.com/en/rest/git/trees\n- Current workaround PRs: #1202, #1203","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-08T13:48:32.414004Z","updated_at":"2025-12-08T14:28:35.223087Z","closed_at":"2025-12-08T14:28:35.223087Z"}
{"id":"dh-mvv","title":"Install missing Effect peer deps to fix lockfile generation","description":"Install @effect/cluster, @effect/rpc, @effect/sql (and possibly @effect/workflow) as explicit deps in packages that use @effect/platform-bun. This should satisfy the peer dep chain so bun generates a parseable lockfile. Root cause: @effect/platform-bun@0.60.0+ added required peer deps on cluster/rpc/sql for BunClusterHttp and BunClusterSocket modules, even though we don't use them.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T08:38:09.610802Z","updated_at":"2025-12-12T08:54:47.386157Z","closed_at":"2025-12-12T08:54:47.386157Z"}
{"id":"dh-myp","title":"Fix Docker workflow trigger from release","description":"## Problem\nThe Docker workflow doesn't trigger after a release because the changesets action's `published` output only works for npm publishing, not our tag-based releases.\n\n## Current behavior\n- Release workflow runs `bun run release` which creates and pushes a git tag\n- Changesets action doesn't detect this as \"publishing\" because no npm packages changed\n- `published` output is false/empty, so Docker job is skipped\n\n## Solution\nDetect publish mode directly instead of relying on changesets output:\n- Check if changesets exist (version mode) vs no changesets (publish mode)\n- When in publish mode and release script succeeds, trigger Docker build\n- Or: have release script output the version, check if tag was created\n\n## References\n- Failed run: https://github.com/GraemeF/home-automation/actions/runs/19745964028\n- Tag v0.0.2 was created but Docker didn't build","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-27T19:14:53.465471081Z","updated_at":"2026-01-02T14:31:00.059727745Z","closed_at":"2025-11-28T18:47:43.075449Z"}
{"id":"dh-n48","title":"Create basic flake.nix with inputs and dev shell","description":"## Task\nCreate the initial flake.nix with:\n- nixpkgs and bun2nix inputs\n- Multi-arch support (forAllSystems helper)\n- Dev shell with Bun, Git, Docker\n\n## Acceptance\n- `nix develop` works on macOS\n- Shell has bun, git, docker available\n\n## Reference\n- automatarr/flake.nix lines 1-60, 567-606","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T18:42:20.212518Z","updated_at":"2025-11-25T18:59:28.41963Z","closed_at":"2025-11-25T18:59:28.41963Z"}
{"id":"dh-n86","title":"Add tagged error types with Effect.catchTag","description":"## Overview\nStandardize error handling across the codebase using Effect's tagged error pattern.\n\n## Current State\n- Mixed error handling (RxJS catchError, try/catch, Effect errors)\n- Errors lose type information\n- Difficult to handle specific error cases\n\n## Target State\n- Define tagged error types (e.g., HomeAssistantConnectionError, ConfigurationError)\n- Use Effect.catchTag for specific error handling\n- Proper error propagation through Effect chains\n\n## Files to Change\n- packages/deep-heating-home-assistant/src/lib/home-assistant-api.ts (define error types)\n- packages/deep-heating-rx/src/lib/heatingProvider.ts (use catchTag)\n\n## Reference\nSee automatarr's Effect.catchTag('EpisodeNotFoundError', ...) pattern","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T11:40:58.282176Z","updated_at":"2025-11-30T13:05:27.881128Z","closed_at":"2025-11-30T13:05:27.881128Z"}
{"id":"dh-np8q","title":"Update minor frontend deps (svelte, svelte-check, prettier-plugin-svelte)","description":"Minor/patch updates for frontend dependencies:\n\n- svelte: 5.45.8 → 5.46.0 (minor)\n- svelte-check: 4.3.4 → 4.3.5 (patch)\n- prettier-plugin-svelte: 3.4.0 → 3.4.1 (patch)\n\nThese are low-risk updates that can be done independently.\n\n**Related Renovate PR:** #1278 (svelte)","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T16:21:03.06112Z","updated_at":"2025-12-26T17:01:16.515008Z","closed_at":"2025-12-26T17:01:16.515008Z"}
{"id":"dh-nv4","title":"Add dependency-cruiser for architecture validation","description":"## Task\nAdd dependency-cruiser to validate architecture and detect circular dependencies.\n\n## Installation\n`bun add -D dependency-cruiser`\n\n## Configuration\nCreate .dependency-cruiser.cjs with rules for:\n- No circular dependencies\n- No orphan modules\n- Package boundary enforcement (e.g., types package shouldn't import from rx)\n\n## Integration\n- Add `deps:check` script to package.json\n- Add to Turbo `ci` pipeline\n- Configure in turbo.json","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:15.654944688Z","updated_at":"2026-01-02T14:31:00.042968506Z","closed_at":"2025-11-29T18:58:20.172506Z","dependencies":[{"issue_id":"dh-nv4","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:15:20.307396845Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-ny6e","title":"Add feature flag to hide pop-out button until feature complete","description":"The pop-out button and modal UI were merged in PR #1287, but the feature is incomplete - it only shows the UI, there's no backend implementation for the temporary whole-house temperature override.\n\nWe need to hide this behind a feature flag before releasing so users don't see a non-functional button.\n\nRelated beads:\n- dh-1b6u (Frontend: Pop-out UI and overlay)\n- dh-g7gt (E2E test fixture needs target temperatures)\n\nOptions:\n1. Environment variable check (e.g., ENABLE_POPOUT=true)\n2. Build-time flag\n3. Simply hide with CSS/conditional rendering until backend ready","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-26T18:29:00.999693Z","updated_at":"2025-12-29T10:20:23.11864Z","closed_at":"2025-12-29T10:20:23.11864Z"}
{"id":"dh-ojtl","title":"Fix stratus result.unwrap_both deprecation warning","description":"The stratus WebSocket library is using deprecated result.unwrap_both function from gleam_stdlib.\n\nWarning seen in CI:\n```\nwarning: Deprecated value used\n    ┌─ .../stratus/src/stratus.gleam:299:19\n    │\n299 │         |\u003e result.unwrap_both\n    │                   ^^^^^^^^^^^ This value has been deprecated\n\nIt was deprecated with this message: Use a case expression instead of this function\n```\n\nOptions:\n1. Check if newer version of stratus fixes this\n2. If no fix available, consider opening an issue/PR upstream\n3. If we're vendoring stratus, fix it ourselves","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-03T13:24:51.178318864Z","created_by":"graeme","updated_at":"2026-01-03T13:24:59.832640408Z"}
{"id":"dh-p8z","title":"Migrate ESLint to v9 flat config","description":"## Overview\nMigrate from ESLint 8.x with legacy .eslintrc.json to ESLint 9.x with flat config format (eslint.config.mjs).\n\n## Why\n- ESLint 8.x is deprecated\n- Flat config is the new standard\n- Better TypeScript integration\n- Enables modern plugins like eslint-plugin-functional\n\n## Scope\n- Update ESLint to 9.x\n- Convert all config files to flat format\n- Add functional programming rules\n- Add Effect-specific linting rules","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:14:01.736591712Z","updated_at":"2026-01-02T14:31:00.030331887Z","closed_at":"2025-11-29T16:48:22.843223Z","dependencies":[{"issue_id":"dh-p8z","depends_on_id":"dh-b44","type":"blocks","created_at":"2025-11-25T07:14:06.639968709Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-pgbg","title":"Consolidate test helper modules","description":"There are two test helper modules: src/test_helpers.gleam (for actor tests) and test/ui/test_helpers.gleam (for UI tests). Some fixtures may be duplicated or could be shared. Review whether these should be consolidated into a single test_helpers module or kept separate with clear responsibilities.","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-04T13:07:23.337321643Z","created_by":"graeme","updated_at":"2026-01-04T13:07:23.337321643Z"}
{"id":"dh-q2x","title":"Phase 2b: Complete Home Assistant API as Effect service","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-30T14:07:11.51191Z","updated_at":"2025-11-30T16:05:31.745805Z","closed_at":"2025-11-30T16:05:31.745805Z","dependencies":[{"issue_id":"dh-q2x","depends_on_id":"dh-udp","type":"blocks","created_at":"2025-11-30T14:07:50.662613Z","created_by":"daemon"}]}
{"id":"dh-qgz","title":"Frontend Socket.IO requests hit HA port 8123 instead of addon ingress","description":"When deployed to Home Assistant, the frontend cannot reach the backend Socket.IO server.\n\n## Symptoms\n- Socket.IO polling requests go to `http://homeassistant.local:8123/socket.io/`\n- All requests return 404 Not Found\n- Frontend repeatedly attempts to reconnect, failing each time\n\n## Expected Behavior\nSocket.IO requests should route through the HA ingress to the addon's backend server, not directly to HA's main port.\n\n## Root Cause (suspected)\nThe frontend is not using the correct base URL for Socket.IO connections when running behind HA ingress. The URL should be relative to the ingress path, not the HA host.\n\n## Relevant Stack Trace\n```\nGET http://homeassistant.local:8123/socket.io/?EIO=4\u0026transport=polling\u0026t=... 404 (Not Found)\n```","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-30T18:22:03.130949Z","updated_at":"2025-11-30T18:27:24.381222Z","closed_at":"2025-11-30T18:27:24.381222Z"}
{"id":"dh-qv64","title":"RoomActor: Implement target temperature calculation","description":"The Gleam RoomActor has a target_temperature field in RoomState but never calculates it (always None). Need to implement the calculation logic:\n\n- Auto mode: scheduled + adjustment (clamped to MinimumRoomTargetTemperature = 15°C)\n- Sleeping mode: returns MinimumRoomTargetTemperature (15°C)\n- Off mode: returns MinimumTrvTargetTemperature (7°C)\n\nSee TypeScript implementation in roomTargetTemperatures.ts and architecture doc recompute_target function.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:42:30.084080932Z","created_by":"graeme","updated_at":"2026-01-03T16:13:48.34938542Z","closed_at":"2026-01-03T16:13:48.34938542Z","close_reason":"Closed"}
{"id":"dh-r75","title":"Investigate why Hall, Bedroom, Gymnasium TRVs not receiving commands","description":"## Symptoms\n\nAfter the dh-d41 fix, all 6 TRVs emit scheduled temperatures. However, only 3 TRVs are receiving commands:\n- **Working**: climate.lounge_radiator, climate.kitchen_radiator, climate.office_radiator\n- **Not working**: climate.hall_radiator, climate.bedroom_radiator, climate.gymnasium_radiator\n\n## Analysis\n\nThe `combineLatest` in `trvActions.ts` waits for 4 streams per TRV:\n1. `trvDesiredTargetTemperatures` - from `trvDecisionPoints` → `roomDecisionPoints`\n2. `trvControlStates` - from `trvControlStateSubject` ← `heatingProvider.trvApiUpdates$`\n3. `trvTemperatures` - from `heatingProvider.trvApiUpdates$`\n4. `trvScheduledTargetTemperatures` - ✅ now working (dh-d41)\n\n## Root cause hypothesis: TRVs marked as 'unavailable' in Home Assistant\n\nThe `getTrvApiUpdates` function in `climate.ts` filters out TRVs with `state === 'unavailable'`. If Hall, Bedroom, and Gymnasium TRVs are marked unavailable in Home Assistant, they will be filtered out completely at the source, breaking ALL downstream chains:\n\n- `trvApiUpdates$` won't emit for them\n- `trvControlStates$` won't emit\n- `trvTemperatures$` won't emit\n- Room-level streams won't emit (blocking `roomDecisionPoints$`)\n- `trvDesiredTargetTemperatures$` won't emit\n- `trvActions$` will never produce actions for those TRVs\n\n## Diagnostic logging added\n\nThree debug namespaces have been added:\n\n1. **deep-heating:ha-climate** - Logs TRV filtering at Home Assistant level\n2. **deep-heating:room-decision-points** - Logs room-level stream emissions\n3. **deep-heating:trv-actions** - Logs TRV-level stream emissions\n\n## To run diagnostics\n\n```bash\nDEBUG=deep-heating:ha-climate,deep-heating:room-decision-points,deep-heating:trv-actions bun run dev\n```\n\nWatch for:\n- `⚠ FILTERED: state=unavailable` - TRV marked unavailable in HA\n- `⚠ MISSING streams` - Which streams never emitted for each TRV\n- `✓ TRV update received` - Which TRVs ARE being processed","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-10T08:15:21.77778Z","updated_at":"2025-12-10T16:07:13.634349Z","closed_at":"2025-12-10T16:07:13.634349Z"}
{"id":"dh-raum","title":"Update E2E tests to use InMemoryHeatingSystem","description":"Update Playwright E2E test setup to:\n\n1. Start server with `InMemoryHeatingSystem` instead of real HA connection\n2. Emit appropriate fake domain data (TRV states, temperatures, etc.)\n3. Target temperatures will now flow through correctly\n\nThis resolves dh-g7gt (E2E test fixture needs target temperatures).","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-29T12:12:39.461145Z","created_by":"graemefoster","updated_at":"2025-12-29T12:12:39.461145Z","dependencies":[{"issue_id":"dh-raum","depends_on_id":"dh-rju1","type":"blocks","created_at":"2025-12-29T12:12:48.731382Z","created_by":"daemon"},{"issue_id":"dh-raum","depends_on_id":"dh-wc7b","type":"blocks","created_at":"2025-12-29T12:12:48.762069Z","created_by":"daemon"},{"issue_id":"dh-raum","depends_on_id":"dh-stnj","type":"parent-child","created_at":"2025-12-29T16:53:53.171189Z","created_by":"daemon"}]}
{"id":"dh-rdx","title":"Update Svelte ecosystem to latest versions","description":"-","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-01T17:26:52.617829Z","updated_at":"2025-12-01T18:11:29.04834Z","closed_at":"2025-12-01T18:11:29.04834Z"}
{"id":"dh-rez","title":"Increase Renovate prConcurrentLimit after Nix migration","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T17:56:47.507033Z","updated_at":"2026-01-02T14:31:00.060816026Z","closed_at":"2025-11-29T15:16:05.339407Z","dependencies":[{"issue_id":"dh-rez","depends_on_id":"dh-hgg","type":"blocks","created_at":"2025-11-25T18:08:47.172001Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-rju1","title":"Implement InMemoryHeatingSystem for testing","description":"Create `InMemoryHeatingSystem` that implements `HeatingSystem` with controllable fake data:\n\n- Uses RxJS Subjects for each stream (can push test data)\n- Action methods return `Effect.succeed(void)` or record calls for assertion\n- Provides helper methods to emit test scenarios\n\nExample usage in tests:\n```typescript\nconst heating = new InMemoryHeatingSystem()\nheating.emitTrvUpdate({ climateEntityId: 'climate.living_room', state: { temperature: 19, target: 21, ... } })\n\n// Actions are no-ops but can be inspected\nconst result = Effect.runSync(heating.setTrvTemperature('climate.living_room', 21))\nexpect(heating.recordedActions).toContainEqual({ type: 'setTemperature', entityId: 'climate.living_room', temp: 21 })\n```\n\nLives in a new `deep-heating-testing` package or in `deep-heating-types`.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T12:12:38.732887Z","created_by":"graemefoster","updated_at":"2025-12-29T18:31:19.991524Z","closed_at":"2025-12-29T18:31:19.991524Z","close_reason":"Implemented in commit bbc692e","dependencies":[{"issue_id":"dh-rju1","depends_on_id":"dh-amoo","type":"blocks","created_at":"2025-12-29T12:12:48.668666Z","created_by":"daemon"}]}
{"id":"dh-rp7","title":"Investigate and improve type safety in deep-heating-web","description":"The derived store bug in home.ts (using set instead of update with an updater function) was not caught by TypeScript or svelte-check. Need to investigate why svelte-check doesn't catch this kind of type error and what we can do to improve type safety. This requires a deep dive into Svelte 5 type checking, svelte-check configuration, and potentially stricter TypeScript settings. Tasks: 1) Research why svelte-check didn't catch the set/update misuse 2) Review svelte-check and TypeScript configuration 3) Explore stricter type checking options 4) Document findings and implement improvements","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-03T18:40:52.486792Z","updated_at":"2025-12-08T14:53:11.695444Z","closed_at":"2025-12-08T14:53:11.695444Z"}
{"id":"dh-rr0","title":"Research UX patterns for duration/time selection","description":"Research best UX practices for letting users select:\n- A duration (e.g., 1hr, 2hr, 4hr) \n- A specific end date/time\n\nConsider mobile-friendly patterns, quick-select presets vs custom input, and how other apps handle similar 'away mode' or 'do not disturb' features.\n\nPart of: dh-ddf (Popping Out epic)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-16T17:49:10.281614Z","updated_at":"2025-12-16T17:49:10.281614Z"}
{"id":"dh-s4j","title":"Fix ingress port configuration for 502 error","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-30T17:55:39.94237Z","updated_at":"2025-11-30T17:56:04.582396Z","closed_at":"2025-11-30T17:56:04.582396Z"}
{"id":"dh-s6c","title":"Add Docker image with s6-overlay","description":"## Task\nCreate Docker image derivation:\n- Use dockerTools.buildLayeredImage\n- Include: deep-heating, nginx, s6 (from nixpkgs), binSh\n- Configure s6 services for nginx and socketio using raw s6 packages\n- Copy nginx config from packages/deep-heating/assets/ingress.conf\n- Use s6-svscan as PID 1 on a scandir\n\n## Approach (Updated)\nUsing raw s6 packages from nixpkgs instead of fetching s6-overlay tarballs:\n- pkgs.s6 - supervision suite\n- pkgs.s6-rc - service manager\n- pkgs.s6-linux-init - init tools\n- pkgs.execline - scripting\n\n## s6 Service Structure\n/run/service/ (scandir)\n├── nginx/\n│   ├── run\n│   └── down\n├── socketio/\n│   ├── run\n│   └── down\n└── web/\n    ├── run\n    └── down\n\n## Acceptance\n- `nix build .#dockerImage` succeeds (Linux only)\n- `docker load \u003c result` works\n- Container starts and serves requests\n\n## Reference\n- https://skarnet.org/software/s6/s6-svscan-1.html\n- https://skarnet.org/software/s6-linux-init/","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T18:42:53.971447Z","updated_at":"2025-11-26T18:19:55.877111918Z","closed_at":"2025-11-26T18:18:37.155413313Z","dependencies":[{"issue_id":"dh-s6c","depends_on_id":"dh-e8n","type":"blocks","created_at":"2025-11-25T18:43:56.867524Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-scbb","title":"HaPollerActor: Add sleep button detection","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T12:40:36.697973998Z","created_by":"graeme","updated_at":"2026-01-03T14:02:05.71020752Z","closed_at":"2026-01-03T14:02:05.71020752Z","close_reason":"Implemented sleep button detection in HaPollerActor with TDD - parses input_button entities and emits SleepButtonPressed when state changes","dependencies":[{"issue_id":"dh-scbb","depends_on_id":"dh-33jq.16","type":"blocks","created_at":"2026-01-03T12:40:41.802733998Z","created_by":"graeme"}]}
{"id":"dh-sgj5","title":"Implement Bun catalog for shared dependency versions","description":"Use Bun's catalog feature to manage shared dependency versions across the monorepo.\n\nInstead of repeating version numbers like `\"effect\": \"3.19.8\"` in every package.json, use `\"effect\": \"catalog:\"` and define versions once in the workspace root.\n\nBenefits:\n- Single source of truth for dependency versions\n- Easier to update dependencies across all packages\n- Reduces version drift between packages\n\nSee: https://bun.sh/docs/install/workspaces#catalogs","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-16T19:12:46.669848Z","updated_at":"2025-12-16T19:12:54.500775Z"}
{"id":"dh-sjt4","title":"Add Nix flake checks for Gleam","description":"Add flake checks for CI validation.\n\n## Requirements\n\nAdd `checks` output to `flake.nix`:\n1. `format` check - runs `gleam format --check src test`\n\nNote: `gleam build` check requires network for deps, so use pre-commit for that instead.\n\nReference: ../anticipatarr-gleam/flake.nix\n\n## Acceptance Criteria\n- [ ] `nix flake check` validates Gleam formatting\n- [ ] Check fails if code is not formatted","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T16:02:55.848388989Z","created_by":"graeme","updated_at":"2026-01-02T16:05:05.018725549Z","closed_at":"2026-01-02T16:05:05.018725549Z","close_reason":"Closed"}
{"id":"dh-spa","title":"Investigate Docker image install failure on HAOS Pi 4 (aarch64)","description":"## Root Cause: Cached armv7 architecture from old install\n\n**Error:** \"no matching manifest for linux/arm/v7\"\n\n**User's current system:**\n- HAOS 16.3\n- aarch64 (confirmed via `uname -m`)\n\n**What happened:**\nBefore v0.0.3 (commit 734ea94), config.yaml falsely claimed to support `armhf` and `armv7` architectures that we never actually built Docker images for. When the user originally installed the add-on:\n- Either their HAOS was running 32-bit at the time\n- Or there was an architecture detection issue\n- HA Supervisor stored \"armv7\" as the add-on's architecture\n\nWhen updating, Supervisor uses the **cached** architecture from the original install, not the current system architecture. So it's looking for armv7 images that don't exist.\n\n## Resolution\n**User must UNINSTALL and REINSTALL the add-on.** This will:\n1. Clear the cached architecture\n2. Re-detect the correct aarch64 architecture\n3. Pull the arm64 Docker image which we confirmed works\n\n## Lesson learned\nDon't claim architecture support in config.yaml without actually building those images!","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-30T17:22:17.470884Z","updated_at":"2025-11-30T17:38:22.671595Z","closed_at":"2025-11-30T17:38:22.671595Z"}
{"id":"dh-srn","title":"Phase 3: Migrate maintainState to Effect Stream","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T14:07:23.940615Z","updated_at":"2025-11-30T14:07:23.940615Z","dependencies":[{"issue_id":"dh-srn","depends_on_id":"dh-28y","type":"blocks","created_at":"2025-11-30T14:07:50.702128Z","created_by":"daemon"},{"issue_id":"dh-srn","depends_on_id":"dh-q2x","type":"blocks","created_at":"2025-11-30T14:07:50.74176Z","created_by":"daemon"}]}
{"id":"dh-stnj","title":"Testing Infrastructure improvements","description":"## Overview\nImprove test coverage and reliability across the codebase.\n\n## Goals\n- Add missing unit tests for web client\n- Improve E2E test infrastructure with InMemoryHeatingSystem\n- Fix flaky tests\n- Make E2E tests required for PR merge\n\n## Child Issues\n- dh-gh0: Add unit tests for web client WebSocket code\n- dh-raum: Update E2E tests to use InMemoryHeatingSystem\n- dh-g7gt: E2E test fixture needs target temperatures\n- dh-m6b: Fix flaky WebSocket server test port collision\n- dh-f6g: Make E2E job required for PR merge","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-29T16:53:11.874157Z","created_by":"graemefoster","updated_at":"2025-12-29T16:53:11.874157Z"}
{"id":"dh-stp9","title":"Investigate DaisyUI modal visibility issue with Playwright","description":"DaisyUI modal class causes Playwright's toBeVisible() to report dialog as visible even after close(). Need to investigate after dependency upgrades. Possible solutions: (1) upgrades might change CSS behaviour, (2) adjust Playwright visibility timeout, (3) add explicit waits for CSS transitions, (4) use different visibility assertion. Root cause is DaisyUI's opacity transitions on .modal class.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:26:42.144798Z","updated_at":"2025-12-26T18:02:57.181093Z","closed_at":"2025-12-26T18:02:57.181093Z"}
{"id":"dh-t4o","title":"Add AppArmor profile for security","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T17:55:40.943695Z","updated_at":"2025-12-13T09:09:42.97332Z","closed_at":"2025-12-13T09:09:42.97332Z"}
{"id":"dh-taws","title":"RoomDecisionActor: Implement offset-based compensation algorithm","description":"The TS uses an offset-based formula for TRV target calculation:\n  trvTarget = roomTarget + trvTemp - roomTemp\n\nThe Gleam uses fixed threshold-based compensation:\n  if diff \u003e 0.5: +2°C\n  if diff \u003c -0.5: -1°C\n  else: no compensation\n\n**ACTION: Implement the TS offset-based algorithm in Gleam to match the existing behavior.**\n\nSee:\n- packages/deep-heating-rx/src/lib/streams/trvs/trvDesiredTargetTemperatures.ts\n- packages/deep_heating/src/deep_heating/actor/room_decision_actor.gleam","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:44:47.309008285Z","created_by":"graeme","updated_at":"2026-01-03T13:35:03.950685481Z","closed_at":"2026-01-03T13:35:03.950685481Z","close_reason":"Implemented offset formula: trvTarget = roomTarget + trvTemp - roomTemp","dependencies":[{"issue_id":"dh-taws","depends_on_id":"dh-33jq","type":"blocks","created_at":"2026-01-03T11:44:58.467932273Z","created_by":"graeme"}]}
{"id":"dh-ts1","title":"Evaluate Effect ESLint rules for socketio package","description":"## Evaluation Complete\n\nThe socketio package ESLint overrides should remain **PERMANENT**.\n\n### Findings\n\nThe package is a **hybrid** codebase:\n- `server.ts` uses Effect (Effect.flatMap, Effect.tap, Schema, FileSystem layer)\n- `socket-server.ts` is pure RxJS/Socket.IO with a class-based pattern\n\n### Rule-by-Rule Analysis\n\n| Rule | Recommendation | Reason |\n|------|----------------|--------|\n| `effect/prefer-effect-platform` | Keep OFF | Intentionally hybrid - uses both Effect FileSystem and Node APIs |\n| `effect/no-classes` | Keep OFF | SocketServer class is sensible for Socket.IO stateful logic |\n| `effect/prefer-match-over-ternary` | Keep OFF | No significant ternaries, pedantic for simple cases |\n| `functional/prefer-immutable-types` | Keep OFF | Class subscriptions are inherently mutable |\n| `functional/prefer-readonly-type` | Keep OFF | Same as above |\n| `effect/no-curried-calls` | Keep OFF | Not relevant to RxJS code |\n| `effect/no-eta-expansion` | Keep OFF | One instance fixed manually |\n\n### Cleanup Done\n\nFixed eta-expansion in `server.ts:44`:\n- Before: `Effect.tap((data) =\u003e Effect.log(data))`\n- After: `Effect.tap(Effect.log)`\n\n### Conclusion\n\nFull Effect adoption would require significant refactoring with unclear benefit. The hybrid approach (Effect for initialization, RxJS for runtime) is intentional and reasonable.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T08:09:59.019537Z","updated_at":"2025-11-30T09:46:23.531075Z","closed_at":"2025-11-30T09:46:23.531075Z"}
{"id":"dh-ttb","title":"Configure protected main branch with beads sync branch","description":"## Task\nProtect the main branch and configure beads to use a separate sync branch for metadata commits.\n\n## Why\nWith main branch protected (requiring PRs), beads can't auto-commit issue updates directly to main. Solution is to use a separate `beads-metadata` branch.\n\n## Steps\n\n### 1. Protect main branch on GitHub\n- Settings → Branches → Add rule\n- Branch name pattern: `main`\n- Check \"Require pull request before merging\"\n- Save\n\n### 2. Configure beads for protected branch workflow\n```bash\nbd config set sync.branch beads-metadata\nbd daemon restart\n```\n\n### 3. Update hooks if needed\nThe daemon will auto-commit to `beads-metadata`. Periodically merge to main via PR:\n```bash\ngit push origin beads-metadata\ngh pr create --base main --head beads-metadata --title \"Update beads metadata\"\n```\n\n## Reference\nSee `../references/beads/docs/PROTECTED_BRANCHES.md` for full documentation.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-27T08:47:45.307192437Z","updated_at":"2025-11-27T18:41:02.50568896Z","closed_at":"2025-11-27T18:41:02.50568896Z"}
{"id":"dh-twu","title":"Docker builds hang due to disabled Nix sandbox in single-user mode","description":"## Summary\n\nPR #1223 switched Docker builds from `cachix/install-nix-action` (multi-user) to `nixbuild/nix-quick-install-action` (single-user). This caused Docker builds to hang for 46+ minutes until manually cancelled.\n\n## Root Cause\n\n**Single-user Nix on GitHub Actions has the sandbox DISABLED** because:\n- The sandbox requires either root (daemon) or user namespaces\n- GitHub Actions runners don't provide these for non-root users\n- Without sandbox, builds run in `/tmp/nix-build-...` instead of `/build/`\n\n## Evidence\n\n| Aspect | Successful Build (before #1223) | Failed Build (after #1223) |\n|--------|--------------------------------|---------------------------|\n| Installer | cachix/install-nix-action | nixbuild/nix-quick-install-action |\n| Mode | Multi-user (daemon) | Single-user (no daemon) |\n| Sandbox | ENABLED | DISABLED |\n| Build dir | /build/... | /tmp/nix-build-... |\n| Lifecycle msg | 'no network in sandbox' ✓ | (missing) |\n\n## Failure Sequence\n\n1. Without sandbox, environment differs from bun2nix expectations\n2. Bun lockfile parsing fails: `Failed to resolve peer dependency '@effect/cluster'`\n3. Bun falls back to resolving packages fresh\n4. Bun tries to write to cache: `EACCES: Permission denied (rename())`\n5. Build hangs indefinitely\n\n## Fix\n\nUse split approach:\n- **CI jobs** (ci.yml, release.yml, sync-bun-nix.yml): Keep `nix-quick-install-action` + `cache-nix-action` for fast cached builds\n- **Docker builds** (docker.yml): Use `cachix/install-nix-action` directly for multi-user mode with sandbox enabled\n\nThis gives us:\n- Fast cached CI for regular jobs (38% improvement retained)\n- Working Docker builds with proper sandbox isolation (~6-7 minutes)\n\n## Future Enhancement\n\nSee bead dh-b4l for evaluating Cachix service to add caching to Docker builds while keeping sandbox enabled.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-11T07:25:14.712654Z","updated_at":"2025-12-12T18:08:13.333852Z","closed_at":"2025-12-12T16:53:52.68719Z"}
{"id":"dh-udix","title":"Add data-testid to heating badge component","description":"The heating_badge component doesn't have a data-testid attribute, unlike other UI components (room-card, room-controls, connection-overlay). Tests currently find it by text content (\"Heating\", \"Idle\").\n\nFor consistency with other components, add:\n- `data-testid=\"heating-badge\"` to the outer div\n\nThis would make the view tests more robust and consistent with the testing patterns used elsewhere.","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-04T13:16:26.132192531Z","created_by":"graeme","updated_at":"2026-01-04T13:17:13.101817011Z","closed_at":"2026-01-04T13:17:13.101817011Z","close_reason":"Bad suggestion - test IDs are implementation details not visible to users. Testing by text content is the correct approach."}
{"id":"dh-udp","title":"Phase 1: Convert socketio entry point to Effect application","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-11-30T14:06:19.442727Z","updated_at":"2025-11-30T14:21:26.463432Z","closed_at":"2025-11-30T14:21:26.463432Z"}
{"id":"dh-ug1","title":"Incremental RxJS to Effect Stream migration","description":"## Overview\nTracking issue for the incremental migration from RxJS to Effect Streams.\n\n## Strategy\nUse adapters to enable bidirectional conversion between Effect Streams and RxJS Observables, allowing incremental migration without breaking existing code.\n\n## Sub-tasks (in order)\n1. dh-apg: Upgrade RxJS from 6.x to 7.x (enables AsyncIterable interop)\n2. dh-597: Create Effect Stream ↔ RxJS Observable adapters\n3. dh-9me: Pilot migration - heatingProvider.ts\n4. dh-07h: Replace RxJS Subjects with SubscriptionRef/PubSub\n5. dh-mdh: Replace Socket.IO with Effect Platform Socket\n\n## Benefits of This Approach\n- No big bang rewrite required\n- Each module can migrate independently\n- Existing consumers continue working via adapters\n- Can validate Effect patterns work before full commitment\n- Easy rollback if issues discovered\n\n## Completion Criteria\nClose when all sub-tasks complete and team is comfortable with Effect patterns.","status":"open","priority":2,"issue_type":"epic","created_at":"2025-11-30T11:51:36.374314Z","updated_at":"2026-01-03T09:09:17.625044424Z","dependencies":[{"issue_id":"dh-ug1","depends_on_id":"dh-apg","type":"blocks","created_at":"2025-11-30T11:51:40.558149Z","created_by":"daemon"},{"issue_id":"dh-ug1","depends_on_id":"dh-597","type":"blocks","created_at":"2025-11-30T11:51:40.597261Z","created_by":"daemon"},{"issue_id":"dh-ug1","depends_on_id":"dh-9me","type":"blocks","created_at":"2025-11-30T11:51:40.637623Z","created_by":"daemon"},{"issue_id":"dh-ug1","depends_on_id":"dh-07h","type":"blocks","created_at":"2025-11-30T11:51:40.67818Z","created_by":"daemon"},{"issue_id":"dh-ug1","depends_on_id":"dh-mdh","type":"blocks","created_at":"2025-11-30T11:51:40.71582Z","created_by":"daemon"},{"issue_id":"dh-ug1","depends_on_id":"dh-udp","type":"blocks","created_at":"2025-11-30T14:08:13.820663Z","created_by":"daemon"},{"issue_id":"dh-ug1","depends_on_id":"dh-28y","type":"blocks","created_at":"2025-11-30T14:08:13.861537Z","created_by":"daemon"},{"issue_id":"dh-ug1","depends_on_id":"dh-q2x","type":"blocks","created_at":"2025-11-30T14:08:13.902788Z","created_by":"daemon"},{"issue_id":"dh-ug1","depends_on_id":"dh-srn","type":"blocks","created_at":"2025-11-30T14:08:13.943479Z","created_by":"daemon"},{"issue_id":"dh-ug1","depends_on_id":"dh-ez9","type":"blocks","created_at":"2025-11-30T14:08:13.984289Z","created_by":"daemon"}]}
{"id":"dh-uo2","title":"Investigate bun.nix validation failures in CI","description":"PR #1197 failed CI with \"Validate bun.nix files\" check failing, even though:\n1. The branch didn't modify bun.lock\n2. git diff origin/main -- bun-deep-heating.nix shows no differences\n3. Main branch CI passes\n\nThe sync-bun-nix.yml workflow only triggers on:\n- workflow_dispatch (manual)\n- push to paths: 'bun.lock'\n\nSo if the nix files get out of sync for other reasons (e.g. bun2nix tool updates, different CI environment), the sync workflow never runs to fix them.\n\nThe CI validation step regenerates the nix file and compares it - the diff shows only whitespace/formatting differences (indentation with spaces).\n\nQuestions to investigate:\n1. Is CI using a different version of bun2nix than what generated the committed file?\n2. Should the sync workflow also run on PRs to fix drift?\n3. Should validation be more lenient (ignore whitespace)?\n4. Is there a race condition where validation runs before sync completes?\n\nRelated: dh-ktd tracks updating bun.lock and nix files as part of release","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-08T09:00:22.618167Z","updated_at":"2025-12-08T09:16:38.770256Z","closed_at":"2025-12-08T09:16:38.770256Z"}
{"id":"dh-v42","title":"Remove eslint-disable in trvScheduledTargetTemperatures test by using Effect Ref","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-10T07:42:01.883842Z","updated_at":"2025-12-10T18:10:31.916778Z","closed_at":"2025-12-10T18:10:31.916778Z"}
{"id":"dh-vh2","title":"P1: Last release failed - investigate and fix CI/merge gaps","description":"Root cause: rxjs-multi-scan bundles RxJS 6.x but we upgraded to RxJS 7.8.2 (#1114). Nix Docker build exposes type incompatibilities that local CI doesn't catch. Gap: Docker build not part of PR CI.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-30T16:55:55.979732Z","updated_at":"2025-11-30T17:15:49.54807Z","closed_at":"2025-11-30T17:15:49.54807Z"}
{"id":"dh-vjn","title":"Add pruned workspace derivation to flake.nix","description":"## Task\nAdd prunedWorkspace derivation:\n- depSource filter (exclude node_modules, .git, result, .beads, .turbo)\n- Run turbo prune for deep-heating-socketio and deep-heating-web\n- Output pruned workspace with pruned bun.lock\n\n## Acceptance\n- `nix build .#prunedWorkspace` succeeds\n- Output contains only needed packages\n- bun.lock is present in output\n\n## Reference\n- automatarr/flake.nix lines 85-221","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T18:42:35.375731Z","updated_at":"2025-11-26T07:24:10.955706Z","closed_at":"2025-11-26T07:24:10.955706Z","dependencies":[{"issue_id":"dh-vjn","depends_on_id":"dh-b0w","type":"blocks","created_at":"2025-11-25T18:43:56.71813Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-vk2","title":"Fix Home Assistant image path - manifest unknown error","description":"## Bug\nHome Assistant fails to install/update Deep Heating with:\n```\nCan't install ghcr.io/graemef/home-automation/deep-heating:0.0.4: DockerError(404, 'manifest unknown')\n```\n\n## Root Cause\nThe image path in config.yaml likely includes the repo name (`home-automation`) but the actual published image is at `ghcr.io/graemef/deep-heating:0.0.4` (without the repo path segment).\n\n## Fix\nCheck and correct the image path in the Home Assistant addon config.yaml to match where Docker images are actually published.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:09:19.246782Z","updated_at":"2025-11-29T13:54:57.512771Z","closed_at":"2025-11-29T13:54:57.512771Z"}
{"id":"dh-vkw","title":"Declare rxjs as explicit dependency in packages that use it","description":"## Overview\nFix implicit dependency hoisting that was relied upon by npm. Each package must declare its own dependencies explicitly.\n\n## Packages to fix\nBased on build errors, these packages need dependency declarations:\n- rxx: needs rxjs\n- deep-heating-types: needs @effect/schema\n- deep-heating-home-assistant: needs rxjs\n- deep-heating-rx: needs rxjs\n- deep-heating-web: needs vite (peer dep of @sveltejs/kit)\n- Potentially others\n\n## Approach\n1. Audit each package's imports\n2. Add missing dependencies to each package.json\n3. Run bun install to update lockfile\n4. Verify build passes\n\n## Verification\n- `bun run build` passes\n- `bun run test` passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:30:00.07673105Z","updated_at":"2025-11-25T07:47:37.128349198Z","closed_at":"2025-11-25T07:47:37.128349198Z"}
{"id":"dh-vlk","title":"Add arm64 Docker image builds to CI","description":"## Task\nAdd arm64/aarch64 Docker image builds to CI for Home Assistant deployment on Raspberry Pi and similar ARM devices.\n\n## Approach\nUse GitHub's free arm64 runners for public repos (GA as of Aug 2025).\n\n### Implementation\n1. Split docker job into parallel architecture-specific jobs:\n   - `docker-amd64`: runs-on `ubuntu-latest`, builds .#dockerImage, pushes with `-amd64` suffix\n   - `docker-arm64`: runs-on `ubuntu-24.04-arm`, builds .#dockerImage, pushes with `-arm64` suffix\n2. Add `docker-manifest` job that waits for both, then:\n   - `docker manifest create` to combine into multi-arch image\n   - Push manifest as `latest` and `sha-XXXXX` tags\n\n### Why This Approach\n- **Free**: GitHub arm64 runners are free for public repos\n- **Fast**: Native builds, no QEMU emulation (which would be 10x slower)\n- **Simple**: No cross-compilation complexity in Nix\n\n### References\n- https://github.blog/changelog/2025-01-16-linux-arm64-hosted-runners-now-available-for-free-in-public-repositories-public-preview/\n- Runner labels: `ubuntu-24.04-arm`, `ubuntu-22.04-arm`\n\n## Acceptance\n- CI builds and publishes linux/arm64 Docker image\n- Multi-arch manifest published to GHCR and DockerHub\n- Both architectures build in parallel","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-26T21:12:39.317586Z","updated_at":"2025-11-26T21:43:56.820529Z","closed_at":"2025-11-26T21:43:56.820529Z","dependencies":[{"issue_id":"dh-vlk","depends_on_id":"dh-icx","type":"blocks","created_at":"2025-11-26T21:13:05.326761Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-vmp","title":"Update deployment documentation for Nix","description":"## Task\nUpdate all deployment documentation to reflect Nix-based builds.\n\n## Documentation Updates\n- CLAUDE.md - Update build commands\n- README.md - New build/deploy instructions\n- packages/deep-heating/README.md - Nix-specific instructions\n\n## New Commands to Document\n- `nix develop` - Enter development shell\n- `nix build .#dockerImage` - Build container\n- `docker load \u003c result` - Load image\n- Deployment to Home Assistant\n\n## Remove\n- References to Docker multi-stage builds\n- npm/yarn based build instructions","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:45.726286969Z","updated_at":"2026-01-02T14:31:00.047562212Z","closed_at":"2025-11-29T15:18:14.991845Z","dependencies":[{"issue_id":"dh-vmp","depends_on_id":"dh-159","type":"blocks","created_at":"2025-11-25T07:15:50.655318831Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-vnw5","title":"Add E2E browser tests for Lustre UI","description":"The Lustre UI components have good unit test coverage via birdie snapshots and lustre/dev/query, but no E2E browser tests. Could use Playwright to verify: actual browser rendering, WebSocket connection/disconnection flow, real user interactions, and CSS styling. Backlog priority - unit tests catch most bugs and browser tests add maintenance burden.","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-04T13:06:45.010275672Z","created_by":"graeme","updated_at":"2026-01-04T13:07:06.194626222Z"}
{"id":"dh-vyd3","title":"Upgrade DaisyUI v4 to v5","description":"Major version upgrade from DaisyUI v4.12.24 to v5.x\n\n**Breaking changes affecting our codebase:**\n- card-compact → card-sm (Room.svelte:32)\n\n**Other DaisyUI v5 changes (not currently used):**\n- bottom-nav → dock\n- input-bordered removed (border is default now)\n- tabs-bordered → tabs-border\n- Various modifier class renames\n\n**Upgrade approach:**\n1. Update daisyui package to v5\n2. Change plugin usage: require('daisyui') → @plugin \"daisyui\" in CSS\n3. Fix card-compact → card-sm in Room.svelte\n\n**Related Renovate PR:** #1279\n**Requires:** Tailwind CSS v4 upgrade first","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:21:02.652484Z","updated_at":"2025-12-26T16:41:28.480277Z","closed_at":"2025-12-26T16:41:28.480277Z","dependencies":[{"issue_id":"dh-vyd3","depends_on_id":"dh-x4pv","type":"blocks","created_at":"2025-12-26T16:21:32.640505Z","created_by":"daemon"}]}
{"id":"dh-vyn","title":"GitHub workflow doesn't create verified commits","description":"The 'Sync bun.nix files' workflow (added in #1067) creates unsigned commits when it regenerates bun-deep-heating.nix. The repo requires verified commits, so these commits show as 'Unverified' on PRs (see PR #1071). Need to configure the workflow to sign commits using github-actions[bot] or a GitHub App.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:18:35.323793Z","updated_at":"2025-11-29T13:54:57.344536Z","closed_at":"2025-11-29T13:54:57.344536Z"}
{"id":"dh-w02v","title":"Add pre-commit hooks for Gleam","description":"Set up pre-commit framework with Gleam-specific hooks.\n\n## Requirements\n\nCreate `.pre-commit-config.yaml` with:\n1. `gleam-format` hook - auto-format Gleam files and stage changes\n2. `gleam-build` hook - build with `--warnings-as-errors`\n\nReference: ../anticipatarr-gleam/.pre-commit-config.yaml\n\n## Acceptance Criteria\n- [ ] `.pre-commit-config.yaml` exists with both hooks\n- [ ] Hooks run on `.gleam` files only\n- [ ] Format hook stages changed files automatically","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T16:02:28.898681695Z","created_by":"graeme","updated_at":"2026-01-02T16:03:51.565099587Z","closed_at":"2026-01-02T16:03:51.565099587Z","close_reason":"Closed"}
{"id":"dh-waxe","title":"Implement main boiler/heating control","description":"The TS has heatingActions for controlling the main boiler based on whether any room needs heating:\n\n- heatingActions$ - On/Off command for main heating\n- appliedHeatingActions$ - Confirmed action sent to HA\n- Turn ON when any room needs heating AND boiler is off\n- Turn OFF when no rooms need heating AND boiler is on\n\nThe Gleam architecture shows DeepHeatingState.is_heating field but no actor to control it.\n\nSee:\n- packages/deep-heating-rx/docs/data-flow-output.md (Layer 16)\n- packages/deep-heating-rx/src/lib/streams/actions.ts applyHeatingActions","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:51:32.081857613Z","created_by":"graeme","updated_at":"2026-01-04T09:41:41.294157103Z","closed_at":"2026-01-04T09:41:41.294157103Z","close_reason":"Closed"}
{"id":"dh-wc7b","title":"Wire server to consume HeatingSystem interface","description":"Update `deep-heating-server` to:\n\n1. Accept a `HeatingSystem` rather than constructing providers directly\n2. Create `HomeAssistantHeatingSystem` in production mode\n3. Allow injection of alternative implementation (for testing)\n\nThe server's `createDeepHeating` call should receive streams from the `HeatingSystem` interface.\n\n## Design\n\n### Approach\n- Server creates a bridge adapter from HeatingSystem → streams + callbacks\n- Debouncing lives in the server bridge layer (not in HeatingSystem or createDeepHeating)\n- This is transitional - long-term the whole app runs in Effect runtime with HeatingSystem via Layer\n\n### HeatingSystemStreams Interface\n\n**Location:** `packages/deep-heating-rx/src/lib/streams/DeepHeating.ts` (alongside createDeepHeating)\n\n```typescript\nexport interface HeatingSystemStreams {\n  readonly trvUpdates$: Observable\u003cTrvUpdate\u003e;\n  readonly heatingUpdates$: Observable\u003cHeatingUpdate\u003e;\n  readonly temperatureReadings$: Observable\u003cTemperatureSensorEntity\u003e;\n  readonly sleepModeEvents$: Observable\u003cGoodnightEventEntity\u003e;\n  readonly applyTrvAction: (action: ClimateAction) =\u003e void;\n  readonly applyHeatingAction: (action: ClimateAction) =\u003e void;\n}\n```\n\n### createDeepHeating Changes\n\n**File:** `packages/deep-heating-rx/src/lib/streams/DeepHeating.ts`\n\n1. Change signature:\n   - Remove: `entityUpdates$: Observable\u003cHomeAssistantEntity\u003e`\n   - Remove: `homeAssistantRuntime: Runtime.Runtime\u003cHomeAssistantApi\u003e`\n   - Add: `heatingSystem: HeatingSystemStreams`\n\n2. Delete internal provider creation (lines 155-166):\n   - Remove `createHomeAssistantHeatingProvider` call\n   - Remove `createHomeAssistantSensorProvider` call  \n   - Remove `createHomeAssistantButtonEventProvider` call\n\n3. Use passed-in streams:\n   ```typescript\n   const temperatureSensorUpdate$ = heatingSystem.temperatureReadings$;\n   const buttonEvents$ = heatingSystem.sleepModeEvents$;\n   ```\n\n4. Update TRV stream subscriptions (line 229):\n   - Change `heatingProvider.trvApiUpdates$` → `heatingSystem.trvUpdates$`\n\n5. Update heating stream subscriptions (line 247):\n   - Change `heatingProvider.heatingApiUpdates$` → `heatingSystem.heatingUpdates$`\n\n6. Replace action publishers (lines 349-355):\n   ```typescript\n   const publishTrvAction = heatingSystem.applyTrvAction;\n   const publishHeatingAction = heatingSystem.applyHeatingAction;\n   ```\n\n7. Remove imports: `createHomeAssistantHeatingProvider`, `createHomeAssistantSensorProvider`, `createHomeAssistantButtonEventProvider`, `HomeAssistantApi`\n\n8. Add imports: `TrvUpdate`, `HeatingUpdate` from deep-heating-types\n\n### Server Bridge Adapter\n\n**Location:** `packages/deep-heating-server/src/app/heatingSystemAdapter.ts` (new file)\n\n```typescript\nimport { ClimateAction, HeatingSystem } from '@home-automation/deep-heating-types';\nimport { Effect, Runtime } from 'effect';\nimport { Subject, Subscription } from 'rxjs';\nimport { debounceTime, groupBy, mergeMap } from 'rxjs/operators';\nimport type { HeatingSystemStreams } from '@home-automation/deep-heating-rx';\n\nexport interface HeatingSystemAdapterResult {\n  readonly streams: HeatingSystemStreams;\n  readonly cleanup: () =\u003e void;\n}\n\nexport const createHeatingSystemAdapter = (\n  heatingSystem: Context.Tag.Service\u003ctypeof HeatingSystem\u003e,\n): HeatingSystemAdapterResult =\u003e {\n  const trvActionSubject = new Subject\u003cClimateAction\u003e();\n  const heatingActionSubject = new Subject\u003cClimateAction\u003e();\n  const subscriptions: Subscription[] = [];\n\n  // TRV actions: 5s debounce per entity (prevents rapid API calls)\n  subscriptions.push(\n    trvActionSubject.pipe(\n      groupBy(x =\u003e x.climateEntityId),\n      mergeMap(group =\u003e group.pipe(debounceTime(5000))),\n    ).subscribe(action =\u003e {\n      // Run both mode and temperature - order doesn't matter, HA handles atomically\n      Effect.runPromise(\n        Effect.all([\n          heatingSystem.setTrvMode(action.climateEntityId, action.mode),\n          heatingSystem.setTrvTemperature(action.climateEntityId, action.targetTemperature),\n        ], { concurrency: 'unbounded' })\n      ).catch(e =\u003e console.error('TRV action failed:', e));\n    })\n  );\n\n  // Heating actions: 5s flat debounce (single heating entity)\n  subscriptions.push(\n    heatingActionSubject.pipe(\n      debounceTime(5000),\n    ).subscribe(action =\u003e {\n      Effect.runPromise(\n        Effect.all([\n          heatingSystem.setTrvMode(action.climateEntityId, action.mode),\n          heatingSystem.setTrvTemperature(action.climateEntityId, action.targetTemperature),\n        ], { concurrency: 'unbounded' })\n      ).catch(e =\u003e console.error('Heating action failed:', e));\n    })\n  );\n\n  return {\n    streams: {\n      trvUpdates$: heatingSystem.trvUpdates,\n      heatingUpdates$: heatingSystem.heatingUpdates,\n      temperatureReadings$: heatingSystem.temperatureReadings,\n      sleepModeEvents$: heatingSystem.sleepModeEvents,\n      applyTrvAction: action =\u003e trvActionSubject.next(action),\n      applyHeatingAction: action =\u003e heatingActionSubject.next(action),\n    },\n    cleanup: () =\u003e subscriptions.forEach(s =\u003e s.unsubscribe()),\n  };\n};\n```\n\n### Server.ts Changes\n\n**File:** `packages/deep-heating-server/src/server.ts`\n\n1. Add HeatingSystem layer:\n   ```typescript\n   import { HomeAssistantHeatingSystemLive } from '@home-automation/deep-heating-home-assistant';\n   import { HeatingSystem } from '@home-automation/deep-heating-types';\n   import { createHeatingSystemAdapter } from './app/heatingSystemAdapter';\n\n   const createHeatingSystemLayer = (home: Home) =\u003e\n     HomeAssistantHeatingSystemLive(home).pipe(\n       Layer.provide(HomeAssistantLayer),\n     );\n   ```\n\n2. Update startHeatingSystem:\n   - Remove `homeAssistantRuntime` parameter\n   - Add `HeatingSystem` to Effect requirements\n   - Create adapter and pass to createDeepHeating\n   - Register cleanup in finalizer\n\n3. Update runServer:\n   - Load home config first (needed to create layer)\n   - Provide HeatingSystemLayer after home is loaded\n\n### Testing\n\nUse `InMemoryHeatingSystemLive` Layer for both unit and E2E tests - implementation tracked in dependent bead dh-raum.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T12:12:39.098368Z","created_by":"graemefoster","updated_at":"2025-12-29T17:43:08.758628Z","closed_at":"2025-12-29T17:43:08.758628Z","close_reason":"Implemented HeatingSystemStreams interface and adapter","dependencies":[{"issue_id":"dh-wc7b","depends_on_id":"dh-ymvk","type":"blocks","created_at":"2025-12-29T12:12:48.69973Z","created_by":"daemon"},{"issue_id":"dh-wc7b","depends_on_id":"dh-klzp","type":"blocks","created_at":"2025-12-29T16:20:07.06577Z","created_by":"daemon"}]}
{"id":"dh-wwf","title":"Uncomment deny all in nginx ingress config","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-30T17:55:40.285739Z","updated_at":"2025-11-30T17:56:04.903216Z","closed_at":"2025-11-30T17:56:04.903216Z"}
{"id":"dh-x4pv","title":"Upgrade Tailwind CSS v3 to v4","description":"Major version upgrade from Tailwind CSS v3.4.19 to v4.x\n\n**Breaking changes to address:**\n- Replace @tailwind directives with @import \"tailwindcss\" in app.css\n- Update postcss.config.cjs: replace tailwindcss plugin with @tailwindcss/postcss\n- Remove autoprefixer (now handled automatically by Tailwind v4)\n- Add @config directive to load JS config file\n- Utility renames: shadow-sm→shadow-xs, rounded-sm→rounded-xs, ring→ring-3, outline-none→outline-hidden\n- Default border color changed to currentColor\n\n**Upgrade approach:**\n1. Run npx @tailwindcss/upgrade for automatic migration\n2. Review and fix any remaining issues\n3. Test UI thoroughly\n\n**Related Renovate PR:** #1280","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:21:02.324166Z","updated_at":"2025-12-26T16:41:28.478182Z","closed_at":"2025-12-26T16:41:28.478182Z"}
{"id":"dh-xco","title":"Decision: No armv7/armhf support (users should upgrade to 64-bit)","description":"## Decision: No armv7/armhf Support\n\nWe will NOT add armv7/armhf Docker builds. Users on 32-bit systems should upgrade to 64-bit.\n\n## Rationale\n\nHome Assistant officially deprecated armv7, armhf, and i386 architectures in May 2025:\n- **2025.6**: Deprecation warnings started\n- **2025.12**: Support ends completely (no more builds)\n\nKey facts from HA:\n- armv7 represents only 0.95% of HA installations\n- More than half are RPi3/4 users who accidentally installed 32-bit\n- These devices fully support 64-bit (aarch64)\n\nSource: https://www.home-assistant.io/blog/2025/05/22/deprecating-core-and-supervised-installation-methods-and-32-bit-systems/\n\n## Our Supported Architectures\n\nPer config.yaml:\n- amd64 (x86_64)\n- aarch64 (arm64)\n\n## Migration Path for Affected Users\n\nIf users see \"no matching manifest for linux/arm/v7\":\n1. Create a backup in Home Assistant\n2. Download 64-bit HAOS image for their device\n3. Flash to SD card\n4. Restore backup during onboarding\n\nHA backups are architecture-independent and restore seamlessly.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-28T18:37:41.145105Z","updated_at":"2025-11-29T13:36:04.918249Z","closed_at":"2025-11-29T09:16:50.345493Z"}
{"id":"dh-xid","title":"Add CI check to detect bun lockfile parsing failures","description":"Add a cheap CI check that detects when bun emits 'warn: Ignoring lockfile' - indicating it can't parse its own lockfile. Must run BEFORE node_modules exists (before bun install), otherwise bun skips re-parsing. Key insight: with node_modules present, bun just says 'no changes' and doesn't reveal the problem.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T08:38:09.196676Z","updated_at":"2025-12-12T08:41:37.249865Z","closed_at":"2025-12-12T08:41:37.249865Z"}
{"id":"dh-xo0","title":"Configure branch protection to require validate-nix check","description":"## Task\nUpdate GitHub branch protection rules to require the validate-nix CI check to pass before merging PRs.\n\n## Problem\nCurrently can merge PRs even when the bun-deep-heating.nix validation fails, which breaks Docker builds on main.\n\n## Solution\nAdd 'Validate bun.nix files' job to required status checks in branch protection settings.\n\n## Steps\n1. Go to repo Settings \u003e Branches \u003e main protection rule\n2. Add 'Validate bun.nix files' to required status checks\n3. Ensure 'Require status checks to pass before merging' is enabled\n\n## Note\nThis is a manual GitHub settings change, not code.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T10:51:10.151722Z","updated_at":"2025-11-29T11:02:57.816143Z","closed_at":"2025-11-29T11:02:57.816143Z","dependencies":[{"issue_id":"dh-xo0","depends_on_id":"dh-3zy","type":"blocks","created_at":"2025-11-29T10:51:32.72862Z","created_by":"daemon"}]}
{"id":"dh-yak3","title":"HaPollerActor: Add exponential backoff retry on connection errors","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T12:52:12.556484901Z","created_by":"graeme","updated_at":"2026-01-03T14:17:34.637177313Z","closed_at":"2026-01-03T14:17:34.637177313Z","close_reason":"Implemented exponential backoff with tests","dependencies":[{"issue_id":"dh-yak3","depends_on_id":"dh-33jq.16","type":"blocks","created_at":"2026-01-03T12:52:19.389275414Z","created_by":"graeme"}]}
{"id":"dh-ybs","title":"Skip CI for changeset-release branch","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:35:23.830201Z","updated_at":"2025-11-29T09:36:01.824313Z","closed_at":"2025-11-29T09:36:01.824313Z"}
{"id":"dh-yjba","title":"HouseModeActor: Implement time-based sleep logic","description":"The TS houseModes.ts has automatic time-based logic for Sleeping mode:\n\n1. If button pressed today AND after 8pm → Sleeping\n2. Else if current hour \u003c 3am → Sleeping  \n3. Else → Auto\n\nThe Gleam implementation is purely message-driven with no time awareness. Need to add:\n- Timer for 63-second re-evaluation\n- Time-based Sleeping mode (before 3am)\n- Button time validation (only accept after 8pm on same day)\n- Automatic transition to Auto (after 3am)\n\nSee: packages/deep-heating-rx/src/lib/streams/house/houseModes.ts","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:46:12.57130337Z","created_by":"graeme","updated_at":"2026-01-03T14:41:35.558213013Z","closed_at":"2026-01-03T14:41:35.558213013Z","close_reason":"Implemented time-based sleep logic with tests: before 3am=Sleeping, after 3am=Auto, button after 8pm=Sleeping","dependencies":[{"issue_id":"dh-yjba","depends_on_id":"dh-33jq","type":"blocks","created_at":"2026-01-03T11:46:22.378878352Z","created_by":"graeme"}]}
{"id":"dh-ymvk","title":"Implement HomeAssistantHeatingSystem wrapping existing providers","description":"## Design\n\n**File:** `packages/deep-heating-home-assistant/src/lib/climate/homeAssistantHeatingSystem.ts`\n\n### Approach\n- HeatingSystem becomes an Effect Service (Context.Tag) in deep-heating-types\n- HomeAssistantHeatingSystemLive is a Layer factory that takes `Home` config\n- Entity updates stream created internally using `getEntityUpdatesStream`\n- Lifecycle managed with `Layer.scoped` and `Effect.addFinalizer`\n- Action methods call HA API directly (no debouncing - caller's responsibility)\n- Uses `streamToObservable` + `share()` for RxJS bridge (Effect migration is separate)\n\n### Implementation\n```typescript\nexport const HomeAssistantHeatingSystemLive = (\n  home: Home,\n): Layer.Layer\u003cHeatingSystem, HomeAssistantConnectionError, HomeAssistantApi\u003e =\u003e\n  Layer.scoped(\n    HeatingSystem,\n    Effect.gen(function* () {\n      const api = yield* HomeAssistantApi;\n      \n      // Internal entity stream with lifecycle\n      const entityStream = getEntityUpdatesStream.pipe(\n        Stream.provideService(HomeAssistantApi, api)\n      );\n      const entityUpdates$ = streamToObservable(entityStream).pipe(share());\n      \n      // Keep-alive + cleanup\n      const subscription = entityUpdates$.subscribe();\n      yield* Effect.addFinalizer(() =\u003e Effect.sync(() =\u003e subscription.unsubscribe()));\n      \n      // Wire observables from existing provider functions\n      // Wire action methods with error mapping to HeatingSystemError\n      \n      return { /* HeatingSystem */ };\n    })\n  );\n```\n\n### Dependencies\n- dh-amoo: HeatingSystem interface (done)\n- dh-44d4: Add as Effect Service\n- dh-klzp: Export from package","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T12:12:38.388472Z","created_by":"graemefoster","updated_at":"2025-12-29T16:38:35.59222Z","closed_at":"2025-12-29T16:38:35.59222Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-ymvk","depends_on_id":"dh-amoo","type":"blocks","created_at":"2025-12-29T12:12:48.637406Z","created_by":"daemon"},{"issue_id":"dh-ymvk","depends_on_id":"dh-44d4","type":"blocks","created_at":"2025-12-29T16:19:54.752347Z","created_by":"daemon"}]}
{"id":"dh-ypci","title":"Bundle Tailwind/DaisyUI locally instead of CDN","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-04T12:56:27.972299019Z","created_by":"graeme","updated_at":"2026-01-04T12:56:27.972299019Z"}
{"id":"dh-yy2","title":"Inline Docker build in release workflow","description":"## Goal\nMove Docker build into the release workflow instead of triggering via git tag.\n\n## Context\nCurrently (after dh-1gr), Docker builds are triggered by git tags created by the release script. This works but adds complexity with tag management.\n\n## Future Approach\nHandle multi-arch Docker builds directly in the release workflow when changesets/action runs publish. Needs to handle:\n- Multi-arch (amd64, arm64) on different runners\n- Nix-based Docker builds\n- Manifest creation\n\n## Blocked by\ndh-1gr (need tag-triggered approach working first)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-27T08:15:37.372798173Z","updated_at":"2026-01-02T14:31:00.03843414Z","closed_at":"2025-11-29T19:09:41.071172Z","dependencies":[{"issue_id":"dh-yy2","depends_on_id":"dh-1gr","type":"blocks","created_at":"2025-11-27T08:16:01.09221279Z","created_by":"daemon","metadata":"{}"}]}
{"id":"dh-z3mu","title":"Backend: Pop-out state and schedule override","description":"Broad strokes - details emerge from TDD:\n- Config for pop-out temperature\n- State management (persist like room adjustments)\n- Schedule override logic\n- WebSocket API for frontend\n\nImplementation driven by outer E2E test failures.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-16T17:59:12.400042Z","updated_at":"2025-12-16T17:59:12.400042Z","dependencies":[{"issue_id":"dh-z3mu","depends_on_id":"dh-dny6","type":"blocks","created_at":"2025-12-16T17:59:34.946628Z","created_by":"daemon"}]}
{"id":"dh-zcyl","title":"RoomDecisionActor: Add temperature clamping (7-32°C)","description":"The TS implementation clamps TRV target temperatures:\n- Minimum: 7°C (MinimumTrvTargetTemperature)\n- Maximum: 32°C (MaximumTrvTargetTemperature)\n\nThe Gleam RoomDecisionActor doesn't clamp temperatures. Need to add clamping to computed_desired_trv_target function.\n\nSee: packages/deep-heating-rx/src/lib/streams/trvs/trvDesiredTargetTemperatures.ts","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:44:47.415309507Z","created_by":"graeme","updated_at":"2026-01-03T15:28:09.30146748Z","closed_at":"2026-01-03T15:28:09.30146748Z","close_reason":"Implemented temperature clamping (7-32°C) in RoomDecisionActor","dependencies":[{"issue_id":"dh-zcyl","depends_on_id":"dh-33jq","type":"blocks","created_at":"2026-01-03T11:44:58.48722169Z","created_by":"graeme"}]}
{"id":"dh-zreg","title":"Add HaPollerActor to supervision tree","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T12:40:36.822641056Z","created_by":"graeme","updated_at":"2026-01-03T12:52:24.467905476Z","closed_at":"2026-01-03T12:52:24.467905476Z","close_reason":"HaPollerActor added to supervision tree with restart tests","dependencies":[{"issue_id":"dh-zreg","depends_on_id":"dh-33jq.16","type":"blocks","created_at":"2026-01-03T12:40:41.822707045Z","created_by":"graeme"}]}
{"id":"dh-zylb","title":"RoomActor: Add TRV mode tracking and room mode derivation","description":"In TypeScript, room mode is derived from TRV modes. If any TRV is 'off', the room mode becomes 'Off'. The Gleam RoomActor:\n\n- Has TrvModeChanged message type (already implemented)\n- Tracks TRV modes in TrvState (already implemented)\n- MISSING: room_mode field in RoomState\n- MISSING: Logic to derive room mode from TRV modes\n\nNeed to add:\n1. room_mode field to RoomState\n2. derive_room_mode function that returns RoomModeOff if any TRV is HvacOff, otherwise house_mode_to_room_mode(house_mode)\n\n**TypeScript reference:**\n- Main worktree: /home/graeme/Development/home-automation\n- File: packages/deep-heating-rx/src/lib/streams/rooms/roomModes.ts\n- Function: getRoomMode(trvModes, houseMode) - returns 'Off' if any TRV mode is 'off', otherwise houseMode","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T11:42:30.186202053Z","created_by":"graeme","updated_at":"2026-01-04T09:55:54.165426956Z","closed_at":"2026-01-04T09:55:54.165426956Z","close_reason":"Implemented room_mode field on RoomState with derive_room_mode function. If any TRV is HvacOff, room mode is RoomModeOff, otherwise derived from house_mode."}
{"id":"dh-zzz","title":"Move root dependencies to workspace packages","description":"## Problem\nRoot package.json contains runtime dependencies that should live in workspace packages. This causes knip to flag them as unused (since they're not imported in root code) and requires manual `ignoreDependencies` config.\n\n## Current state\nRoot package.json has these runtime deps that belong in workspaces:\n- `@effect/platform`, `effect` → used by multiple packages\n- `express`, `socket.io`, `dotenv` → deep-heating-socketio\n- `@sveltejs/adapter-node`, `@sveltejs/kit`, `svelte-material-icons` → deep-heating-web\n- `luxon`, `rxjs-multi-scan` → deep-heating-rx and others\n- `axios`, `amazon-user-pool-srp-client`, `jsonwebtoken` → check usage\n- `bufferutil`, `utf-8-validate` → websocket optimizations, check usage\n- `socket.io-client` → deep-heating-web\n- `tslib` → check if still needed\n\n## Solution\n1. For each dep in root dependencies, find which workspace(s) import it\n2. Add the dep to that workspace's package.json\n3. Remove from root package.json\n4. Run `bun install` to update lockfile\n5. Update knip config to remove the now-unnecessary ignoreDependencies\n\n## Benefits\n- Clearer dependency graph per package\n- knip can properly detect unused deps per workspace\n- Easier to understand what each package needs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T18:01:52.698421Z","updated_at":"2025-11-29T18:15:02.960996Z","closed_at":"2025-11-29T18:15:02.960996Z"}
