{"id":"dh-02n","title":"Add dependency validation tooling","description":"## Overview\nAdd tooling to detect circular dependencies, orphan modules, and unused code.\n\n## Tools\n- dependency-cruiser - Architecture validation and circular dependency detection\n- knip - Unused exports, dependencies, and files detection\n- changesets - Semantic versioning and changelog generation\n\n## Why\n- Catch architectural issues early\n- Keep codebase clean of dead code\n- Proper release management with changelogs","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:15:15.548317712Z","updated_at":"2025-11-25T07:15:15.548317712Z","dependencies":[{"issue_id":"dh-02n","depends_on_id":"dh-5rx","type":"blocks","created_at":"2025-11-25T07:15:20.292822533Z","created_by":"daemon"}]}
{"id":"dh-07h","title":"Replace RxJS Subjects with Effect SubscriptionRef/PubSub","description":"## Overview\nReplace RxJS Subject patterns with Effect's SubscriptionRef and PubSub for state management with subscribers.\n\n## RxJS → Effect Mapping\n\n### BehaviorSubject/ReplaySubject(1) → SubscriptionRef\n```typescript\n// RxJS\nconst subject = new BehaviorSubject\u003cState\u003e(initialState)\nsubject.next(newState)\nsubject.subscribe(handler)\n\n// Effect\nconst ref = yield* SubscriptionRef.make\u003cState\u003e(initialState)\nyield* SubscriptionRef.set(ref, newState)\nyield* Stream.runForEach(ref.changes, handler)\n```\n\nKey features:\n- `ref.changes` is a Stream that emits current value + all changes\n- Can sample current value with `SubscriptionRef.get(ref)`\n- Multiple subscribers each get independent streams\n\n### Subject (multicast) → PubSub\n```typescript\n// RxJS  \nconst subject = new Subject\u003cEvent\u003e()\nsubject.next(event)\nsubject.subscribe(handler)\n\n// Effect\nconst pubsub = yield* PubSub.bounded\u003cEvent\u003e(16)\nyield* PubSub.publish(pubsub, event)\nconst subscriber = yield* PubSub.subscribe(pubsub)\nyield* Queue.take(subscriber) // or Stream.fromQueue\n```\n\nBackpressure strategies:\n- `PubSub.bounded(n)` - Backpressure, suspends publisher\n- `PubSub.dropping(n)` - Drops new messages when full\n- `PubSub.sliding(n)` - Drops oldest messages\n- `PubSub.unbounded()` - No limit (careful!)\n\n## Current Usage in Codebase\n- DeepHeating.ts uses multiple Subjects for state broadcasting\n- trvControlStateSubject, trvStatusSubject, heatingStatusSubject\n- These are good candidates for SubscriptionRef\n\n## Dependencies\n- Requires dh-597 (adapters) to expose as Observable during transition\n\n## Files to Change\n- packages/deep-heating-rx/src/lib/DeepHeating.ts","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T11:51:08.126613Z","updated_at":"2025-11-30T11:51:08.126613Z","dependencies":[{"issue_id":"dh-07h","depends_on_id":"dh-597","type":"blocks","created_at":"2025-11-30T11:51:11.718223Z","created_by":"daemon"}]}
{"id":"dh-08z","title":"Add CI aggregation task to turbo","description":"Brownsauce has a cleaner pattern: `all` → `ci` → (build, lint, test, deps:check, release:validate, etc). Currently home-automation's `all` task just depends on build/lint/test directly. Should add a `ci` task that aggregates all checks needed for the CI pipeline, including deps:check and potentially release:validate for changesets.\n\n## Implementation notes (from brownsauce)\n\nThe `ci` task aggregates all checks:\n- build, lint, test (already have)\n- `//#deps:check` (just added)\n- `//#arch:check` (if we add dependency-cruiser)\n- `//#release:validate` (for changeset validation)\n- `validate:docs` (if applicable)\n\nThen `all` just depends on `ci` for a clean hierarchy.\n\nEach task should have explicit `inputs` arrays for proper caching - see brownsauce/turbo.json for the patterns.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T08:26:37.747865Z","updated_at":"2025-11-30T08:47:36.510561Z","closed_at":"2025-11-30T08:47:36.510561Z","close_reason":"Closed"}
{"id":"dh-09s","title":"Migrate deep-heating-home-assistant tests to Bun","description":"## Task\nMigrate tests in packages/deep-heating-home-assistant from Jest to Bun native.\n\n## Steps\n1. Update test imports to use buntest\n2. Convert Jest patterns to Bun equivalents\n3. Convert Effect tests to use `it.effect()`\n4. Update package.json test script\n5. Remove Jest config\n\n## Notes\nThis package uses Effect heavily - good candidate for it.effect() patterns","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:32.639852102Z","updated_at":"2025-11-30T10:54:19.523674Z","closed_at":"2025-11-30T10:54:19.523674Z","close_reason":"Completed in PR #1106. Tests already used bun-test-effect; removed legacy .babelrc and updated tsconfig.spec.json to remove Jest types.","dependencies":[{"issue_id":"dh-09s","depends_on_id":"dh-659","type":"blocks","created_at":"2025-11-25T07:14:39.539958612Z","created_by":"daemon"}]}
{"id":"dh-0av","title":"Add //#deps:check turbo task for knip","description":"Currently `unused:check` in package.json runs `knip-bun` directly, bypassing turbo. This means no caching and no dependency ordering. Should add a root-level turbo task like brownsauce has.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T08:26:37.415716Z","updated_at":"2025-11-30T08:40:37.382656Z","closed_at":"2025-11-30T08:40:37.382656Z","close_reason":"Closed"}
{"id":"dh-0ia","title":"Replace dotenv with Effect Config in socketio","description":"## Overview\nReplace manual dotenv configuration loading in deep-heating-socketio with Effect's Config module.\n\n## Current State\n- server.ts uses dotenv.config() and process.env directly\n- No validation of required env vars at startup\n- Error messages for missing config are unclear\n\n## Target State\n- Use Effect Config module for all environment variables\n- Type-safe config with Schema validation\n- Clear error messages when config is missing\n- Follow pattern from automatarr (Config.string, Config.withDefault, Config.all)\n\n## Files to Change\n- packages/deep-heating-socketio/src/server.ts\n\n## Reference\nSee automatarr's media-requests-sonarr for Config patterns","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T11:40:39.9509Z","updated_at":"2025-11-30T12:04:11.217245Z","dependencies":[{"issue_id":"dh-0ia","depends_on_id":"dh-mdh","type":"blocks","created_at":"2025-11-30T12:05:18.488365Z","created_by":"daemon"}]}
{"id":"dh-159","title":"Migrate deep-heating Docker image to Nix","description":"## Task\nReplace packages/deep-heating/Dockerfile with Nix derivation.\n\n## Current Dockerfile\n- Multi-stage build\n- Turbo prune → Build → Runtime\n- nginx + pm2 for serving\n\n## Nix Approach\n- Separate derivations for build and runtime\n- Use dockerTools.buildLayeredImage\n- Include nginx and process manager in image\n\n## Output\n- Container image loadable via `docker load \u003c result`\n- Equivalent functionality to current Docker image\n- Smaller size due to minimal base\n\n## Home Assistant Integration\n- Verify image works as HA add-on\n- Check any add-on specific requirements","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:45.592528121Z","updated_at":"2025-11-29T15:15:21.324088Z","closed_at":"2025-11-29T15:15:21.324088Z","close_reason":"Migration already complete - Docker images being built via Nix and published (v0.0.5 live)","dependencies":[{"issue_id":"dh-159","depends_on_id":"dh-hgg","type":"blocks","created_at":"2025-11-25T07:15:50.641723297Z","created_by":"daemon"}]}
{"id":"dh-1gr","title":"Add changesets for version management","description":"## Goal\nControl releases of the deep-heating Docker image and produce release notes, rather than releasing on every push to main.\n\n## Design\n\n### packages/deep-heating gets a package.json\nCreated `packages/deep-heating/package.json` with dependencies on:\n- deep-heating-socketio\n- @home-automation/deep-heating-web\n\nThis allows changesets' `updateInternalDependencies` to automatically bump deep-heating when its deps change.\n\n### Workflow\n1. Push changes to main with changesets → `release.yml` runs\n2. `changesets/action` creates \"Version Packages\" PR\n3. Merge that PR → `changesets/action` runs `bun run release`\n4. `release` script creates git tag (e.g., `v0.1.0`)\n5. Tag triggers `docker.yml` → builds multi-arch Docker images\n\n### Scripts\n- `bun run changeset` - create a changeset\n- `bun run version` - bump versions + sync config.yaml\n- `bun run version:sync` - sync version to Home Assistant config.yaml\n- `bun run release` - create and push git tag\n\n### Workflows\n- `.github/workflows/release.yml` - runs changesets/action on push to main\n- `.github/workflows/docker.yml` - builds Docker on tag push (v*)\n- `.github/workflows/ci.yml` - build/test/lint only (no Docker)\n\n### Requirements\n- Protected main branch (PRs required)\n- GitHub App for verified commits:\n  - `RELEASE_APP_ID` secret\n  - `RELEASE_APP_PRIVATE_KEY` secret\n\n## Files Created/Modified\n- `packages/deep-heating/package.json` (new)\n- `.changeset/config.json` (configured)\n- `scripts/sync-version.ts` (new)\n- `scripts/create-release-tag.ts` (new)\n- `.github/workflows/release.yml` (new)\n- `.github/workflows/docker.yml` (new)\n- `.github/workflows/ci.yml` (removed Docker jobs)\n- `package.json` (added scripts)\n\n## Follow-up\ndh-yy2: Inline Docker build in release workflow (blocked by this)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:15.865152041Z","updated_at":"2025-11-28T15:32:18.948208Z","closed_at":"2025-11-27T08:29:20.668453688Z","dependencies":[{"issue_id":"dh-1gr","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:15:20.336977293Z","created_by":"daemon"}]}
{"id":"dh-1kv","title":"Add bun enforcement to package.json","description":"## Task\nConfigure package.json to enforce bun usage and prevent accidental npm/yarn usage.\n\n## Changes\n1. Update packageManager field: `\"packageManager\": \"bun@1.3.2\"`\n2. Add preinstall hook: `\"preinstall\": \"npx only-allow bun\"`\n\n## Why\nPrevents team members from accidentally using npm and creating lockfile conflicts.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:12:29.631173058Z","updated_at":"2025-11-25T07:48:23.093390559Z","closed_at":"2025-11-25T07:48:23.093390559Z","dependencies":[{"issue_id":"dh-1kv","depends_on_id":"dh-k8y","type":"blocks","created_at":"2025-11-25T07:13:21.163325085Z","created_by":"daemon"}]}
{"id":"dh-1yg","title":"Add Effect Schedule for polling intervals","description":"## Overview\n**This bead is superseded by dh-9me (Migrate heatingProvider.ts to Effect Streams).**\n\nThe original scope was to add Effect Schedule for polling, but investigation revealed:\n\n1. The file path was wrong - heatingProvider.ts is in `deep-heating-home-assistant`, not `deep-heating-rx`\n2. The polling happens in `getEntityUpdates` in `home-assistant-api.ts` using RxJS `timer()`\n3. Properly replacing RxJS timer with Effect Schedule requires Effect Stream ↔ RxJS adapters\n4. The adapters require RxJS 7.x for clean AsyncIterable interop\n\n## Correct Migration Path\n1. **dh-apg**: Upgrade RxJS 6.x → 7.x (enables AsyncIterable)\n2. **dh-597**: Create Effect Stream ↔ RxJS Observable adapters\n3. **dh-9me**: Migrate heatingProvider.ts to Effect Streams (includes Schedule)\n\n## Remaining Value\nOnce dh-9me is complete, this bead can track adding exponential backoff retry logic to the Effect-based polling. For now, marking as blocked by the migration path.\n\n## Files Actually Affected\n- packages/deep-heating-home-assistant/src/lib/home-assistant-api.ts (getEntityUpdates)\n- packages/deep-heating-home-assistant/src/lib/climate/heatingProvider.ts (debounceTime)\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T11:40:52.026904Z","updated_at":"2025-11-30T13:19:41.458203Z","dependencies":[{"issue_id":"dh-1yg","depends_on_id":"dh-n86","type":"blocks","created_at":"2025-11-30T11:41:15.118665Z","created_by":"daemon"},{"issue_id":"dh-1yg","depends_on_id":"dh-9me","type":"blocks","created_at":"2025-11-30T13:19:15.847858Z","created_by":"daemon"}]}
{"id":"dh-1z5","title":"Replace Node util.isDeepStrictEqual with Effect Equal","description":"Migrate rxx package from Node's isDeepStrictEqual to Effect Equal.\n\nFiles to migrate:\n- packages/rxx/src/lib/rxx.ts\n- packages/deep-heating-socketio/src/app/socket-server.ts\n\nEffect Equal capabilities:\n- Equal.equals for structural equality\n- Hash module for efficient hashing\n- Integrates with Effect data types\n\nThis removes the Node util dependency and keeps equality checking consistent with Effect patterns.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-11-30T11:57:57.860167Z","updated_at":"2025-11-30T12:48:22.420038Z","closed_at":"2025-11-30T12:48:22.420038Z","close_reason":"Migration not appropriate: Effect Equal.equals requires types to implement the Equal interface (via Data.struct or similar). The current types are plain TypeScript interfaces, so Equal.equals would do reference equality, not deep equality. isDeepStrictEqual from node:util works correctly and is supported by Bun since v0.5.6. This migration should only be done if/when the types are converted to Effect data types."}
{"id":"dh-20r","title":"Convert .eslintrc.json to eslint.config.mjs","description":"## Task\nMigrate from legacy ESLint config format to flat config.\n\n## Changes\n- Delete .eslintrc.json files\n- Create eslint.config.mjs at root\n- Migrate all rules and plugin configurations\n- Update any package-specific ESLint configs\n\n## Structure\nThe new config should have layered configuration:\n1. Base TypeScript rules\n2. Prettier compatibility\n3. Functional programming rules (non-test files)\n4. Test-specific rules\n\n## Reference\nSee automatarr/eslint.config.mjs for target structure","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:01.97891588Z","updated_at":"2025-11-29T16:11:34.246591Z","closed_at":"2025-11-29T16:11:34.246591Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-20r","depends_on_id":"dh-hkk","type":"blocks","created_at":"2025-11-25T07:14:06.668370682Z","created_by":"daemon"}]}
{"id":"dh-27o","title":"Add GitHub Releases to release workflow","description":"Currently the release workflow creates git tags via changesets but doesn't create actual GitHub Releases with release notes.\n\n**Current state:**\n- release.yml uses changesets/action to version and tag\n- Docker images are built and pushed\n- No GitHub Release is created\n\n**Desired state:**\n- Create GitHub Release when version is published\n- Include aggregated changelog from changesets\n- Link to Docker images in release notes\n\n**Implementation options:**\n1. Enable changesets action's built-in release creation (may need config)\n2. Add separate step using softprops/action-gh-release\n3. Use gh CLI to create release\n\n**Acceptance criteria:**\n- [ ] GitHub Release created for each version\n- [ ] Release notes contain changelog from merged changesets\n- [ ] Docker image links included in release body","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:54:48.912168Z","updated_at":"2025-11-29T10:05:26.230783Z","closed_at":"2025-11-29T10:05:26.230783Z","close_reason":"Implemented in PR #1061 - added github-release job to Docker workflow"}
{"id":"dh-28y","title":"Phase 2a: Migrate SocketServer to Effect Platform","description":"","status":"open","priority":1,"issue_type":"feature","created_at":"2025-11-30T14:06:26.93284Z","updated_at":"2025-11-30T14:06:26.93284Z"}
{"id":"dh-2ko","title":"Configure Renovate: 5-day minimum release age and bun config","description":"Configure Renovate to ignore packages updated less than 5 days ago (minimumReleaseAge). Also ensure bun package manager is configured the same way.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-11-29T11:34:01.655731Z","updated_at":"2025-11-29T11:34:05.093833Z","closed_at":"2025-11-29T11:34:05.093833Z","close_reason":"Closed"}
{"id":"dh-2mm","title":"Add Effect.withSpan for observability","description":"## Overview\nAdd structured tracing/telemetry using Effect.withSpan for better debugging and monitoring.\n\n## Current State\n- Basic Effect.log usage exists\n- No structured spans or traces\n- Difficult to trace request flow through the system\n\n## Target State\n- Add Effect.withSpan to key operations\n- Include relevant attributes (entity IDs, temperatures, etc.)\n- Enable tracing of request flow through Effect chains\n\n## Files to Change\n- packages/deep-heating-home-assistant/src/lib/home-assistant-api.ts\n- packages/deep-heating-rx/src/lib/heatingProvider.ts\n\n## Reference\nSee automatarr's Effect.withSpan('operation-name', { attributes: { key: value } }) pattern","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-30T11:41:04.385103Z","updated_at":"2025-11-30T11:41:04.385103Z"}
{"id":"dh-2nz","title":"Search repo for remaining Jest/Babel/Vitest references","description":"## Task\nThoroughly search the entire repo for remaining references to legacy testing/build tools that should be removed.\n\n## Findings\n\n### .babelrc files (Nx legacy) - FOUND\nThese files exist and contain `@nx/js/babel` preset:\n- `packages/dictionary/.babelrc`\n- `packages/rxx/.babelrc`\n- `packages/deep-heating-state/.babelrc`\n- `packages/deep-heating-types/.babelrc`\n\n### jest.config.* files - NONE FOUND\nNo jest.config files in our packages (only in node_modules from dependencies).\n\n### vitest.config.* files - NONE FOUND\n\n### References to jest in tsconfig files - FOUND\nMany tsconfig files reference jest:\n\n**tsconfig.lib.json files** (exclude jest.config.ts):\n- `packages/deep-heating-types/tsconfig.lib.json`\n- `packages/rxx/tsconfig.lib.json`\n- `packages/deep-heating-socketio/tsconfig.app.json`\n- `packages/deep-heating/tsconfig.app.json`\n- `packages/deep-heating-home-assistant/tsconfig.lib.json`\n- `packages/dictionary/tsconfig.lib.json`\n- `packages/deep-heating-state/tsconfig.lib.json`\n\n**tsconfig.spec.json files** (types: [\"jest\", \"node\"]):\n- `packages/deep-heating-types/tsconfig.spec.json`\n- `packages/deep-heating-socketio/tsconfig.spec.json`\n- `packages/rxx/tsconfig.spec.json`\n- `packages/deep-heating-state/tsconfig.spec.json`\n- `packages/dictionary/tsconfig.spec.json`\n- `packages/deep-heating-web/tsconfig.spec.json`\n\n### \"node\" types in tsconfig - FOUND (also legacy)\n**tsconfig.lib.json / tsconfig.app.json files** with `\"types\": [\"node\"]`:\n- `packages/deep-heating-rx/tsconfig.lib.json`\n- `packages/deep-heating-socketio/tsconfig.app.json`\n- `packages/deep-heating-types/tsconfig.lib.json`\n- `packages/rxx/tsconfig.lib.json`\n- `packages/deep-heating/tsconfig.app.json`\n- `packages/dictionary/tsconfig.lib.json`\n- `packages/deep-heating-state/tsconfig.lib.json`\n- `packages/deep-heating-home-assistant/tsconfig.lib.json`\n\n### @types/jest in package.json - NONE FOUND\n\n### ts-jest, babel-jest dependencies - NONE FOUND\n\n### jest.fn(), jest.spyOn() patterns - NONE FOUND\n\n### Vitest imports - NONE FOUND\n\n### @nx/js/babel preset references - FOUND (in .babelrc files listed above)\n\n### Nx package.json dependencies - NONE FOUND\n\n## Summary\n\nFiles to **remove entirely**:\n- 4 × `.babelrc` files (packages: dictionary, rxx, deep-heating-state, deep-heating-types)\n\nFiles to **update**:\n- 7 × `tsconfig.lib.json`/`tsconfig.app.json` files:\n  - Remove jest.config.ts from exclude (where present)\n  - Remove `\"types\": [\"node\"]` or set to empty array\n- 6 × `tsconfig.spec.json` files:\n  - Remove \"jest\" and \"node\" from types array (should use bun types or empty)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T11:06:10.454971Z","updated_at":"2025-11-30T11:08:51.329821Z","closed_at":"2025-11-30T11:08:51.329821Z","close_reason":"Closed"}
{"id":"dh-2o9","title":"Add eslint-plugin-functional for immutability rules","description":"## Task\nAdd and configure eslint-plugin-functional to enforce immutable programming patterns.\n\n## Installation\n`bun add -D eslint-plugin-functional`\n\n## Configuration\nAdd to eslint.config.mjs with rules like:\n- no-let (prefer const)\n- immutable-data (no mutations)\n- no-loop-statements (prefer map/filter/reduce)\n- functional-parameters (no rest params in certain contexts)\n\n## Scope\nApply to source files only, not test files (tests may need mutations for setup)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:02.102854144Z","updated_at":"2025-11-29T16:28:07.195541Z","closed_at":"2025-11-29T16:28:07.195541Z","close_reason":"Added functional/no-let and functional/no-loop-statements rules for source files. Type-aware rules (immutable-data, prefer-immutable-types) deferred to dh-hnu as they require parserOptions.project config. Codebase already clean - no violations found.","dependencies":[{"issue_id":"dh-2o9","depends_on_id":"dh-20r","type":"blocks","created_at":"2025-11-25T07:14:06.682565579Z","created_by":"daemon"}]}
{"id":"dh-3r6","title":"Create bun-pruned.nix for dependency management","description":"## Task\nCreate Nix derivation for Bun dependencies that can be cached and shared.\n\n## Purpose\n- Extract production dependencies from bun.lock\n- Create fixed-output derivation for caching\n- Enable reproducible builds without network access\n\n## Reference\n- automatarr/bun-pruned.nix\n- This is auto-generated from bun.lock\n\n## Integration\n- Pre-commit hook to regenerate when bun.lock changes\n- Import into flake.nix for builds","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:45.308801827Z","updated_at":"2025-11-29T14:51:19.452764Z","closed_at":"2025-11-29T14:51:19.452764Z","close_reason":"Implemented as bun.nix and bun-deep-heating.nix (autogenerated by bun2nix)","dependencies":[{"issue_id":"dh-3r6","depends_on_id":"dh-7rz","type":"blocks","created_at":"2025-11-25T07:15:50.612672212Z","created_by":"daemon"}]}
{"id":"dh-3vs","title":"Update scripts and verify builds with Bun","description":"## Task\nEnsure all npm scripts work correctly with bun and verify the full build pipeline.\n\n## Verification Steps\n1. `bun run build` - all packages build successfully\n2. `bun run test` - all tests pass\n3. `bun run lint` - linting works\n4. `bun run dev` - dev servers start correctly\n5. Manual smoke test of web UI\n\n## Notes\n- Most scripts should work unchanged\n- Watch for any npm-specific behaviours in scripts\n- Update any scripts that shell out to npm directly","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:12:29.729974266Z","updated_at":"2025-11-25T07:49:21.373612057Z","closed_at":"2025-11-25T07:49:21.373612057Z","dependencies":[{"issue_id":"dh-3vs","depends_on_id":"dh-1kv","type":"blocks","created_at":"2025-11-25T07:13:21.177791972Z","created_by":"daemon"}]}
{"id":"dh-3zy","title":"Add workflow to auto-sync bun-deep-heating.nix when bun.lock changes","description":"## Task\nPort the sync-bun-pruned-nix.yml workflow from automatarr to home-automation.\n\n## What it does\nWhen bun.lock is pushed (e.g., by Renovate), automatically:\n1. Regenerate bun-deep-heating.nix using turbo prune + bun2nix\n2. If changed, commit and push with [skip ci]\n\n## Reference\nSee automatarr/.github/workflows/sync-bun-pruned-nix.yml\n\n## Differences from automatarr\n- Use GitHub-hosted runners (not homelab)\n- Use turbo prune flow instead of Nix flake outputs\n- Skip Attic cache integration\n- Only one nix file to regenerate (bun-deep-heating.nix)\n\n## Implementation\n1. Create .github/workflows/sync-bun-nix.yml\n2. Trigger on push to bun.lock\n3. Run turbo prune + bun2nix\n4. Commit and push if changed","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T10:51:03.083673Z","updated_at":"2025-11-29T13:54:57.677384Z","closed_at":"2025-11-29T13:54:57.677384Z","close_reason":"Workflow implemented and working with GitHub App verification"}
{"id":"dh-597","title":"Create Effect Stream ↔ RxJS Observable adapters","description":"## Overview\nCreate adapter functions in the rxx package to convert between Effect Streams and RxJS Observables.\n\n## Adapters Needed\n\n### Effect Stream → RxJS Observable\n```typescript\n// Option 1: Via AsyncIterable (cleanest, needs RxJS 7+)\nexport const streamToObservable = \u003cA, E\u003e(\n  stream: Stream\u003cA, E\u003e,\n  runtime: Runtime.Runtime\u003cnever\u003e\n): Observable\u003cA\u003e =\u003e from(Stream.toAsyncIterable(stream))\n\n// Option 2: Manual subscription\nexport const streamToObservable = \u003cA, E, R\u003e(\n  stream: Stream\u003cA, E, R\u003e,\n  runtime: Runtime.Runtime\u003cR\u003e\n): Observable\u003cA\u003e =\u003e new Observable(subscriber =\u003e {\n  const fiber = Effect.runFork(\n    Stream.runForEach(stream, a =\u003e Effect.sync(() =\u003e subscriber.next(a))),\n    { runtime }\n  )\n  return () =\u003e Effect.runFork(Fiber.interrupt(fiber))\n})\n```\n\n### RxJS Observable → Effect Stream\n```typescript\nexport const observableToStream = \u003cA\u003e(\n  observable: Observable\u003cA\u003e\n): Stream\u003cA, Error\u003e =\u003e Stream.async\u003cA, Error\u003e(emit =\u003e {\n  const subscription = observable.subscribe({\n    next: a =\u003e emit.single(a),\n    error: e =\u003e emit.fail(e instanceof Error ? e : new Error(String(e))),\n    complete: () =\u003e emit.end()\n  })\n  return Effect.sync(() =\u003e subscription.unsubscribe())\n})\n```\n\n## Dependencies\n- Requires dh-apg (RxJS upgrade) for cleanest AsyncIterable approach\n\n## Files to Change\n- packages/rxx/src/lib/rxx.ts (or new file adapters.ts)\n- packages/rxx/package.json (add effect dependency)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T11:50:24.899088Z","updated_at":"2025-11-30T13:48:10.306003Z","closed_at":"2025-11-30T13:48:10.306003Z","close_reason":"Implemented Effect Stream ↔ RxJS Observable adapters using RxJS 7's AsyncIterable support. Both adapters tested with 11 passing tests.","dependencies":[{"issue_id":"dh-597","depends_on_id":"dh-apg","type":"blocks","created_at":"2025-11-30T11:50:29.403035Z","created_by":"daemon"}]}
{"id":"dh-5re","title":"Exclude .beads/ from CI workflow triggers","description":"## Problem\nCommits that only change `.beads/` files (issue tracking) unnecessarily trigger CI workflows, wasting compute resources.\n\n## Solution\nAdd path exclusion filters to CI workflows so they don't run when only `.beads/**` files change.\n\n## Files to update\n- `.github/workflows/ci.yml`\n- Any other workflows that shouldn't run for beads-only changes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-28T19:09:32.928277Z","updated_at":"2025-11-29T08:39:43.971954Z","closed_at":"2025-11-29T08:39:43.971954Z"}
{"id":"dh-5rw","title":"Migrate deep-heating-rx tests to Bun","description":"## Task\nMigrate all tests in packages/deep-heating-rx from Jest to Bun native.\n\n## Steps\n1. Update test file imports to use buntest\n2. Convert Jest-specific patterns:\n   - `describe/it/expect` → Bun equivalents\n   - `jest.fn()` → `mock()`\n   - `jest.spyOn()` → Bun spy equivalent\n3. Convert Effect tests to use `it.effect()`\n4. Update package.json test script\n5. Remove Jest config\n\n## Files\nThis package has the most tests - treat as the main migration reference.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:32.502838683Z","updated_at":"2025-11-30T10:58:21.43315Z","closed_at":"2025-11-30T10:58:21.43315Z","close_reason":"Migration complete: tests already using bun:test, cleaned up Jest references from tsconfig files, removed legacy .babelrc","dependencies":[{"issue_id":"dh-5rw","depends_on_id":"dh-659","type":"blocks","created_at":"2025-11-25T07:14:39.525817975Z","created_by":"daemon"}]}
{"id":"dh-5rx","title":"Expand Effect library usage","description":"## Overview\n**This is now a tracking/parent issue.** The actual work has been broken into sub-tasks.\n\n## Sub-tasks\n- dh-0ia: Replace dotenv with Effect Config in socketio\n- dh-n86: Add tagged error types with Effect.catchTag  \n- dh-1yg: Add Effect Schedule for polling intervals (depends on dh-n86)\n- dh-2mm: Add Effect.withSpan for observability\n- dh-7zk: Expand Layer-based DI to socketio server (depends on dh-0ia)\n\n## Original Scope\nUpdate Effect library usage throughout the codebase, following patterns established in automatarr.\n\n## Completion Criteria\nClose this issue when all sub-tasks are complete.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:14:57.343388698Z","updated_at":"2025-11-30T11:41:30.214519Z","dependencies":[{"issue_id":"dh-5rx","depends_on_id":"dh-gno","type":"blocks","created_at":"2025-11-25T07:15:01.655005736Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-0ia","type":"blocks","created_at":"2025-11-30T11:41:19.824189Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-1yg","type":"blocks","created_at":"2025-11-30T11:41:19.860752Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-n86","type":"blocks","created_at":"2025-11-30T11:41:19.898286Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-2mm","type":"blocks","created_at":"2025-11-30T11:41:19.935043Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-7zk","type":"blocks","created_at":"2025-11-30T11:41:19.972188Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-aah","type":"blocks","created_at":"2025-11-30T11:58:13.058841Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-klx","type":"blocks","created_at":"2025-11-30T11:58:13.09534Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-6wp","type":"blocks","created_at":"2025-11-30T11:58:13.13298Z","created_by":"daemon"},{"issue_id":"dh-5rx","depends_on_id":"dh-1z5","type":"blocks","created_at":"2025-11-30T11:58:13.170554Z","created_by":"daemon"}]}
{"id":"dh-659","title":"Integrate buntest package from eventsourcing repo","description":"## Task\nIntegrate buntest package from eventsourcing repo for Effect test integration.\n\n## Dependency\nThis depends on the buntest-equivalent package being published from the eventsourcing repo. Once available, add it as a workspace dependency.\n\n## Steps\n1. Wait for buntest package to be published from eventsourcing repo\n2. Add as dependency: `bun add -D @\u003cscope\u003e/buntest`\n3. Verify it provides required features:\n   - `it.effect()` for Effect-native test assertions\n   - Proper Effect runtime management per test\n   - Integration with Bun's expect API\n4. Update any test utilities documentation\n\n## Blocked By\nExternal: buntest package publication from eventsourcing repo","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:32.367784892Z","updated_at":"2025-11-30T10:28:18.996811Z","closed_at":"2025-11-30T10:28:18.996811Z","close_reason":"Integrated @codeforbreakfast/bun-test-effect package. Converted home-assistant-api.spec.ts to use Effect-native it.effect() tests with layer() for shared test context.","dependencies":[{"issue_id":"dh-659","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:14:39.511441216Z","created_by":"daemon"}]}
{"id":"dh-68e","title":"Fix Renovate warnings from dashboard","description":"Address Renovate warnings shown on the dashboard. See: https://github.com/GraemeF/home-automation/issues/163","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T10:25:42.423953Z","updated_at":"2025-11-29T18:47:57.195228Z","closed_at":"2025-11-29T18:47:57.195228Z","close_reason":"Fixed via PR #1094 - updated to use workspace: protocol"}
{"id":"dh-6wp","title":"Replace rxjs-multi-scan with Effect patterns","description":"Migrate deep-heating-state from rxjs-multi-scan to Effect patterns.\n\nFile to migrate:\n- packages/deep-heating-state/src/lib/deep-heating-state.ts\n\nThe multiScan operator combines multiple observables into a single state. Options:\n1. SubscriptionRef with multiple update sources\n2. Effect Stream combinators (mergeAll, zipAll)\n3. Custom scan over merged streams\n\nThis removes the rxjs-multi-scan dependency and moves us closer to full Effect adoption.","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T11:57:57.55187Z","updated_at":"2025-11-30T11:57:57.55187Z"}
{"id":"dh-6xb","title":"Replace custom turbo FOD with nixpkgs package","description":"The flake.nix has ~50 lines of custom turboFod derivation (lines 28-79) that manually fetches turbo via bun and extracts the binary.\n\nnixpkgs already has 'turbo' and 'turbo-unwrapped' packages at the version we need (2.6.1). The pkgs.turbo wrapper disables telemetry and update notifications by default - perfect for reproducible Nix builds.\n\nReplace turboFod usage in:\n- prunedWorkspace (line 107)\n- deep-heating build phase (line 237)\n- generateBunNixDeepHeating (lines 191, 195)\n\nMay need to update nixpkgs input if the pinned version has an older/broken turbo.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-26T18:56:58.062400889Z","updated_at":"2025-11-26T21:03:11.268555Z","closed_at":"2025-11-26T21:03:11.268555Z","close_reason":"Replaced custom turboFod derivation with pkgs.turbo from nixpkgs. Build verified working."}
{"id":"dh-7rz","title":"Create flake.nix for reproducible builds","description":"## Task\nCreate Nix flake configuration for the monorepo.\n\n## Design (2025-11-25)\n\n### Approach\nFull Nix build replicating automatarr's pattern:\n- bun2nix for dependency management\n- turbo prune for workspace isolation\n- Single combined derivation for both apps\n- s6-overlay for process management in Docker\n\n### Inputs\n- nixpkgs (nixos-unstable)\n- bun2nix (github:baileyluTCD/bun2nix)\n\n### Dependency Management\n- turbo FOD: Platform-specific turbo binary (2.6.1)\n- Pruned workspace: `turbo prune deep-heating-socketio @home-automation/deep-heating-web --docker`\n- bun-deep-heating.nix: Generated from pruned lockfile, checked into git\n\n### Build Derivation\n- Single `deep-heating` derivation using bun2nix mkDerivation\n- Turbo builds all packages in dependency order\n- Bundle socketio backend with `bun build` (single file)\n- Copy SvelteKit build output (.svelte-kit/output)\n\n### Docker Image\n- `dockerTools.buildLayeredImage`\n- Contents: deep-heating + nginx + s6-overlay + binSh\n- s6 services: nginx (serves static + proxy) + socketio backend\n- Estimated size: ~80-100MB (vs ~200MB+ current)\n\n### Dev Shell\n- Bun, Git, Docker\n- Works on macOS and Linux\n- `nix develop` for consistent environment\n\n### Files to Create\n- flake.nix - Main flake\n- bun.nix - Full lockfile deps (CI validation)\n- bun-deep-heating.nix - Pruned deps (builds)\n\n### Reference\n- automatarr/flake.nix for structure","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:45.193162353Z","updated_at":"2025-11-26T20:37:54.156314Z","closed_at":"2025-11-26T18:29:41.466754291Z","dependencies":[{"issue_id":"dh-7rz","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:15:50.598603433Z","created_by":"daemon"},{"issue_id":"dh-7rz","depends_on_id":"dh-s6c","type":"blocks","created_at":"2025-11-25T18:43:56.923192Z","created_by":"daemon"}]}
{"id":"dh-7xh","title":"Document Effect patterns and conventions","description":"## Overview\nDocument Effect patterns and conventions for the team, including RxJS migration mappings.\n\n## Content to Document\n\n### RxJS → Effect Stream Operator Mapping\n\n| RxJS | Effect Stream | Notes |\n|------|---------------|-------|\n| `combineLatest` | `Stream.zipLatest` / `Stream.zipLatestWith` / `Stream.zipLatestAll` | Direct equivalent! |\n| `merge` | `Stream.merge` / `Stream.mergeWith` | ✅ |\n| `concat` | `Stream.concat` / `Stream.concatAll` | ✅ |\n| `zip` | `Stream.zip` / `Stream.zipWith` / `Stream.zipAll` | ✅ |\n| `map` | `Stream.map` | ✅ |\n| `filter` | `Stream.filter` | ✅ |\n| `mergeMap/flatMap` | `Stream.flatMap` | ✅ |\n| `concatMap` | `Stream.flatMap(..., { concurrency: 1 })` | ✅ |\n| `switchMap` | `Stream.flatMap(..., { switch: true })` | ✅ |\n| `scan` | `Stream.scan` | ✅ |\n| `debounceTime` | `Stream.debounce` | ✅ |\n| `throttleTime` | `Stream.throttle` | ✅ |\n| `take` | `Stream.take` | ✅ |\n| `takeUntil` | `Stream.takeUntil` | ✅ |\n| `takeWhile` | `Stream.takeWhile` | ✅ |\n| `distinctUntilChanged` | `Stream.changes` / `Stream.changesWith` | ✅ |\n| `groupBy` | `Stream.groupByKey` / `Stream.groupBy` | ✅ |\n| `share` | `Stream.share` | ✅ |\n| `shareReplay` | `Stream.broadcast` / `Stream.broadcastDynamic` | ✅ |\n| `startWith` | Compose with `Stream.concat` | ⚠️ |\n| `withLatestFrom` | Custom implementation needed | ⚠️ |\n| `exhaustMap` | Not available | ❌ |\n\n### Subject → Effect Equivalents\n\n| RxJS | Effect | Notes |\n|------|--------|-------|\n| `BehaviorSubject` | `SubscriptionRef` | Has `.changes` stream + current value |\n| `Subject` | `PubSub` | Broadcast to all subscribers |\n| `ReplaySubject(1)` | `SubscriptionRef` | Same as BehaviorSubject |\n\n### Effect Patterns Used in Codebase\n- Schema for all domain types\n- Layer/Context.Tag for dependency injection\n- Config for environment variables\n- Effect.gen for async composition\n- Stream for reactive data flows\n\n## Files to Create\n- docs/effect-patterns.md or similar","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:57.655023309Z","updated_at":"2025-11-30T11:51:27.404196Z","dependencies":[{"issue_id":"dh-7xh","depends_on_id":"dh-c34","type":"blocks","created_at":"2025-11-25T07:15:01.697606001Z","created_by":"daemon"}]}
{"id":"dh-7zk","title":"Expand Layer-based DI to socketio server","description":"## Overview\nExtend the Layer-based dependency injection pattern from home-assistant-api to the socketio server.\n\n## Current State\n- home-assistant-api.ts has proper Layer/Context.Tag patterns\n- server.ts creates services manually without DI\n- Hard to test server components in isolation\n\n## Target State\n- Define Context.Tag services for server components\n- Use Layer composition to build the server\n- Enable easier testing with mock layers\n\n## Files to Change\n- packages/deep-heating-socketio/src/server.ts\n- Potentially new files for service definitions\n\n## Dependencies\n- Should be done after Config migration (dh-0ia) since config will be a Layer","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T11:41:11.239156Z","updated_at":"2025-11-30T11:41:11.239156Z","dependencies":[{"issue_id":"dh-7zk","depends_on_id":"dh-0ia","type":"blocks","created_at":"2025-11-30T11:41:15.081541Z","created_by":"daemon"}]}
{"id":"dh-821","title":"Set up GitHub App for release workflow","description":"## Task\nCreate and configure a GitHub App for the changesets release workflow to create verified commits.\n\n## Steps\n1. Create GitHub App at https://github.com/settings/apps/new\n2. Configure permissions:\n   - **Contents**: Read \u0026 write (to commit version bumps)\n   - **Pull requests**: Read \u0026 write (to create PRs)\n3. Install app on home-automation repo\n4. Add repository secrets:\n   - `RELEASE_APP_ID` - the App ID from app settings\n   - `RELEASE_APP_PRIVATE_KEY` - generate and download a private key\n\n## Why\n- Commits made with default GITHUB_TOKEN aren't verified\n- PRs created by default token won't trigger other workflows\n- GitHub App gives proper attribution and verified commits\n\n## Blocked by\nNothing - can be done anytime\n\n## Blocks\nFirst real release using changesets","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-27T08:46:26.78554636Z","updated_at":"2025-11-27T18:28:43.352730961Z","closed_at":"2025-11-27T18:28:43.352730961Z"}
{"id":"dh-8g9","title":"Add Effect-specific ESLint rules","description":"## Task\nAdd ESLint rules to enforce correct Effect usage patterns.\n\n## Progress\n- Installed @codeforbreakfast/eslint-effect\n- Configured recommended rules with RxJS overrides\n- Fixed 50+ lint errors across deep-heating-types, deep-heating-home-assistant, rxx packages\n- Disabled effect/no-method-pipe (conflicts with RxJS)\n- Disabled effect/no-if-statement (too strict for mixed codebase)\n- Disabled functional/type-declaration-immutability (I.+ heuristic too blunt)\n\n## Remaining\n- 24 errors in deep-heating-web package need fixing\n\n## TODO\nGrab /fix-all command from brownsauce repo to help fix remaining issues automatically\n\n## Rules Enabled\n- effect/no-runPromise (except tests/scripts)\n- effect/no-runSync (except tests/scripts)\n- effect/prefer-andThen\n- effect/prefer-as\n- effect/no-curried-calls\n- effect/no-eta-expansion\n- functional/prefer-immutable-types (with RxJS patterns ignored)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:02.222727342Z","updated_at":"2025-11-30T08:08:59.839253Z","closed_at":"2025-11-30T08:08:59.839253Z","close_reason":"All Effect ESLint rules now pass. Added package-specific overrides for web/socketio packages that aren't Effect-based.","dependencies":[{"issue_id":"dh-8g9","depends_on_id":"dh-20r","type":"blocks","created_at":"2025-11-25T07:14:06.696610574Z","created_by":"daemon"}]}
{"id":"dh-91v","title":"Migrate remaining package tests to Bun","description":"## Task\nMigrate tests in remaining packages from Jest to Bun native:\n- deep-heating-types\n- deep-heating-state\n- rxx\n- dictionary (if any)\n\n## Steps per package\n1. Update test imports to use buntest\n2. Convert Jest patterns to Bun equivalents\n3. Update package.json test script\n4. Remove Jest config\n\n## Notes\nThese packages likely have fewer tests - should be straightforward after rx and home-assistant migrations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:32.783048317Z","updated_at":"2025-11-30T11:16:57.700128Z","closed_at":"2025-11-30T11:16:57.700128Z","close_reason":"No tests to migrate in remaining packages (deep-heating-types test already using bun:test). Legacy config cleaned up as part of dh-luf.","dependencies":[{"issue_id":"dh-91v","depends_on_id":"dh-5rw","type":"blocks","created_at":"2025-11-25T07:14:39.55415719Z","created_by":"daemon"}]}
{"id":"dh-9i8","title":"Add knip for unused code detection","description":"## Task\nAdd knip to detect unused exports, dependencies, and files.\n\n## Installation\n`bun add -D knip`\n\n## Configuration\nCreate knip.config.ts with:\n- Workspace configuration for monorepo\n- Entry points for each package\n- Ignore patterns for false positives\n\n## Integration\n- Add `unused:check` script to package.json\n- Optionally add to CI pipeline\n\n## Benefits\n- Find dead code\n- Detect unused dependencies\n- Keep exports clean","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:15.757204914Z","updated_at":"2025-11-29T17:58:18.367516Z","closed_at":"2025-11-29T17:58:18.367516Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-9i8","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:15:20.321738185Z","created_by":"daemon"}]}
{"id":"dh-9me","title":"Migrate heatingProvider.ts to Effect Streams","description":"## Overview\nPilot migration of heatingProvider.ts from RxJS to Effect Streams using the new adapters.\n\n## Why This File\n- Already mixes Effect and RxJS (uses Runtime.runPromise)\n- Good boundary point between Effect HTTP calls and RxJS streams\n- Relatively isolated - can test migration without affecting whole system\n\n## Current State\n- `getEntityUpdates` in home-assistant-api.ts uses RxJS timer() for polling\n- Uses switchMap, mergeAll, shareReplay\n- Bridges to Effect via Runtime.runPromise\n- heatingProvider.ts uses debounceTime and groupBy for action batching\n\n## Target State\n- Use Effect Stream with Schedule.fixed for polling intervals\n- Use Schedule.exponential for retry with backoff on failures\n- Use Stream.flatMap with switch: true for switchMap equivalent  \n- Use Stream.broadcast for shareReplay equivalent\n- Export as Observable via adapter for backward compatibility\n\n## Approach\n1. Rewrite internals using Effect Stream\n2. Use streamToObservable adapter at the export boundary\n3. Consumers don't need to change yet\n\n## Dependencies\n- Requires dh-597 (adapters)\n\n## Files to Change\n- packages/deep-heating-home-assistant/src/lib/home-assistant-api.ts (getEntityUpdates)\n- packages/deep-heating-home-assistant/src/lib/climate/heatingProvider.ts\n","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-11-30T11:50:38.911303Z","updated_at":"2025-11-30T13:57:12.421061Z","dependencies":[{"issue_id":"dh-9me","depends_on_id":"dh-597","type":"blocks","created_at":"2025-11-30T11:50:42.495626Z","created_by":"daemon"}]}
{"id":"dh-9vb","title":"Add Effect language service plugin","description":"## Task\nAdd the Effect TypeScript language service plugin for better IDE integration.\n\n## Steps\n1. Add `@effect/language-service` as dev dependency\n2. Update tsconfig.base.json to include plugin:\n```json\n{\n  \"compilerOptions\": {\n    \"plugins\": [\n      { \"name\": \"@effect/language-service\" }\n    ]\n  }\n}\n```\n\n## Benefits\n- Better autocomplete for Effect types\n- Improved error messages for Effect code\n- Hover information for Effect combinators","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:13:37.36770342Z","updated_at":"2025-11-29T15:22:08.506058Z","closed_at":"2025-11-29T15:22:08.506058Z","close_reason":"Already implemented - dependency installed and plugin configured in tsconfig.base.json","dependencies":[{"issue_id":"dh-9vb","depends_on_id":"dh-cb3","type":"blocks","created_at":"2025-11-25T07:13:41.617795594Z","created_by":"daemon"}]}
{"id":"dh-a5l","title":"Migrate package manager from npm to Bun","description":"## Overview\nReplace npm with Bun as the primary package manager. This is the foundational change that unblocks most other modernisation work.\n\n## Why Bun?\n- Faster installs and script execution\n- Built-in TypeScript support\n- Native test runner (needed for testing migration)\n- Simpler toolchain (replaces multiple tools)\n\n## Scope\n- Replace lockfile\n- Update package.json configuration\n- Verify all packages build and run correctly\n- Update documentation\n\n## Technical Notes\n- Bun is largely npm-compatible but watch for native module compilation differences\n- Turbo orchestration should continue unchanged\n- May need to update some scripts that assume npm-specific behaviour","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:12:12.163911812Z","updated_at":"2025-11-25T07:49:27.847241901Z","closed_at":"2025-11-25T07:49:27.847241901Z"}
{"id":"dh-a6k","title":"Replace Docker with Nix flakes for deployment","description":"## Overview\nReplace multi-stage Docker builds with Nix flakes for reproducible, minimal container images.\n\n## Why Nix\n- Bit-for-bit reproducible builds\n- Automatic dependency layering (optimal caching)\n- Minimal final images (no build tools)\n- Cross-compilation support\n- Better handling of Bun/Node native deps\n\n## Scope\n- Create flake.nix for the monorepo\n- Create bun-pruned.nix for dependency management\n- Build container images via Nix\n- Multi-arch support (x86_64, aarch64)\n\n## Challenges\n- Learning curve for Nix\n- Home Assistant add-on integration may have requirements\n- CI/CD pipeline changes","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:15:45.057190805Z","updated_at":"2025-11-25T07:15:45.057190805Z","dependencies":[{"issue_id":"dh-a6k","depends_on_id":"dh-02n","type":"blocks","created_at":"2025-11-25T07:15:50.583498596Z","created_by":"daemon"}]}
{"id":"dh-aah","title":"Replace luxon with Effect DateTime","description":"Migrate 6 files from luxon DateTime/Duration to Effect DateTime module.\n\nFiles to migrate:\n- packages/deep-heating-rx/src/lib/utils/datetime.ts\n- packages/deep-heating-rx/src/lib/streams/rooms/roomScheduledTargetTemperatures.ts\n- packages/deep-heating-rx/src/lib/streams/house/houseModes.ts\n- packages/deep-heating-rx/src/lib/streams/trvs/trvActions.test.ts\n- packages/deep-heating-types/src/lib/weekSchedule.ts\n- packages/deep-heating-types/src/lib/weekSchedule.test.ts\n\nEffect DateTime capabilities:\n- DateTime.unsafeMake / DateTime.unsafeMakeZoned for creation\n- DateTime.add for arithmetic\n- DateTime.distanceDuration for differences\n- Full timezone support with TimeZone.Named\n- Duration module for time spans\n\nThis removes the luxon dependency entirely.","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T11:57:56.956725Z","updated_at":"2025-11-30T11:57:56.956725Z","dependencies":[{"issue_id":"dh-aah","depends_on_id":"dh-7zk","type":"blocks","created_at":"2025-11-30T12:05:18.780233Z","created_by":"daemon"}]}
{"id":"dh-am2","title":"Add @effect/workflow for orchestration","description":"## Task\nAdd @effect/workflow for orchestration patterns if applicable to the heating logic.\n\n## Evaluation\n1. Review current heating orchestration in deep-heating-rx\n2. Determine if workflow patterns would benefit the codebase\n3. If yes, add @effect/workflow and implement\n\n## Potential Use Cases\n- Heating schedule management\n- TRV coordination workflows\n- State machine patterns\n\n## Notes\nThis is optional - only implement if it provides clear benefits over current RxJS approach","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:57.551200953Z","updated_at":"2025-11-25T07:14:57.551200953Z","dependencies":[{"issue_id":"dh-am2","depends_on_id":"dh-c34","type":"blocks","created_at":"2025-11-25T07:15:01.683576424Z","created_by":"daemon"}]}
{"id":"dh-apg","title":"Upgrade RxJS from 6.x to 7.x","description":"## Overview\nUpgrade RxJS from 6.6.7 to 7.x (or 8.x) to get better AsyncIterable support needed for Effect interop.\n\n## Current State\n- RxJS 6.6.7 used across the codebase\n- Limited AsyncIterable support in RxJS 6\n\n## Target State\n- RxJS 7.x or 8.x with full AsyncIterable support\n- `from(asyncIterable)` works for converting Effect Streams\n- Minimal breaking changes (most operators unchanged)\n\n## Why\n- RxJS 7+ can convert AsyncIterable to Observable via `from()`\n- Effect Stream has `toAsyncIterable()` method\n- This enables bidirectional conversion between Effect and RxJS\n\n## Files to Change\n- All package.json files with rxjs dependency\n- May need minor operator import changes (rxjs/operators → rxjs)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T11:50:10.218065Z","updated_at":"2025-11-30T13:35:29.443256Z","closed_at":"2025-11-30T13:35:29.443256Z","close_reason":"Upgraded RxJS from 6.6.7 to 7.8.2 across all packages. Enables AsyncIterable interop for Effect Stream adapters."}
{"id":"dh-b0w","title":"Add turbo FOD to flake.nix","description":"## Task\nAdd turbo Fixed-Output Derivation:\n- Platform-specific turbo binary packages\n- Platform-specific hashes (generate for current platform)\n- turboFod derivation that fetches turbo 2.6.1\n\n## Acceptance\n- `nix build .#turboFod` succeeds\n- turbo binary works: `result/bin/turbo --version`\n\n## Reference\n- automatarr/flake.nix lines 100-186","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T18:42:25.985622Z","updated_at":"2025-11-26T07:13:08.091333Z","closed_at":"2025-11-26T07:13:08.091333Z","close_reason":"Turbo FOD working correctly. Root cause of version mismatch was stale node_modules - turbo has local preference behavior that defers to local installation. Fixed by running bun install.","dependencies":[{"issue_id":"dh-b0w","depends_on_id":"dh-n48","type":"blocks","created_at":"2025-11-25T18:43:56.668526Z","created_by":"daemon"}]}
{"id":"dh-b44","title":"Update TypeScript to 5.9.x","description":"## Overview\nUpdate TypeScript to the latest stable version (5.9.x) and modernise the configuration.\n\n## Key Changes\n- Update TypeScript from current version to 5.9.x\n- Switch target from ES2015 to ES2022\n- Switch module resolution from Node to Bundler\n- Add Effect language service plugin for better IDE diagnostics\n\n## Why\n- Better type inference and error messages\n- ES2022 features available without transpilation\n- Bundler resolution is more appropriate for modern tooling\n- Effect plugin provides better autocomplete and error messages for Effect code","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:13:37.033048447Z","updated_at":"2025-11-29T14:11:06.926292Z","closed_at":"2025-11-29T14:11:06.926292Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-b44","depends_on_id":"dh-a5l","type":"blocks","created_at":"2025-11-25T07:13:41.575516189Z","created_by":"daemon"}]}
{"id":"dh-b5h","title":"Update documentation for Bun migration","description":"## Task\nUpdate all documentation to reflect the new Bun-based workflow.\n\n## Files to Update\n- CLAUDE.md - Update all command examples from npm to bun\n- .mise.toml - Add bun to managed tools\n- README files in packages if they reference npm\n\n## Changes\n- `npm run X` → `bun run X` or just `bun X`\n- `npm install` → `bun install`\n- `npm test` → `bun test`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:12:29.82246809Z","updated_at":"2025-11-25T18:16:24.805187Z","closed_at":"2025-11-25T18:16:24.805187Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-b5h","depends_on_id":"dh-3vs","type":"blocks","created_at":"2025-11-25T07:13:21.191675234Z","created_by":"daemon"}]}
{"id":"dh-bx6","title":"Configure Renovate to update Bun version in both mise and flake.nix","description":"## Problem\nRenovate updates Bun version in .mise.toml but not in flake.nix (or vice versa), leaving them out of sync.\n\nPR #1068 updates Bun 1.3.2 → 1.3.3 but only in one location.\n\n## Bun version locations\n- `.mise.toml` - local dev tooling\n- `flake.nix` - Nix builds (Docker image)\n\n## Solution\nConfigure Renovate to recognise both files and update them together, either via:\n- Custom manager with regex\n- Group rule to update both in same PR\n- Post-upgrade task to sync versions\n\n## Reference\nCheck Renovate docs for custom managers and regexManagers.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T11:11:31.880448Z","updated_at":"2025-11-29T19:28:06.462905Z","closed_at":"2025-11-29T19:28:06.462905Z","close_reason":"Solved by removing duplication - bun version now comes only from nixpkgs via nix develop. No need for Renovate to sync two files."}
{"id":"dh-c34","title":"Update Effect to 3.19.x","description":"## Task\nUpdate Effect and related packages to latest stable versions.\n\n## Dependencies to Update\n- effect → 3.19.x\n- @effect/platform → 0.93.x\n- @effect/platform-node → latest compatible\n- @effect/schema → latest (if separate from effect)\n\n## Steps\n1. Update package.json dependencies\n2. Run `bun install`\n3. Fix any breaking changes from version upgrade\n4. Verify all Effect-using code still works\n\n## Breaking Changes to Watch\n- Check Effect changelog for 3.5 → 3.19 breaking changes\n- Schema API may have changed\n- Platform APIs may have changed","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:57.449614167Z","updated_at":"2025-11-30T11:33:45.343269Z","closed_at":"2025-11-30T11:33:45.343269Z","close_reason":"Effect already updated to 3.19.6 in all packages","dependencies":[{"issue_id":"dh-c34","depends_on_id":"dh-luf","type":"blocks","created_at":"2025-11-25T07:15:01.669564208Z","created_by":"daemon"}]}
{"id":"dh-cb3","title":"Modernise tsconfig: ES2022 target and bundler resolution","description":"## Task\nUpdate TypeScript configuration to use modern settings.\n\n## Changes to tsconfig.base.json\n- `target`: ES2015 → ES2022\n- `module`: ESNext (keep)\n- `moduleResolution`: Node → Bundler\n\n## Changes to package tsconfigs\n- Review and update any package-specific overrides\n- Ensure library output settings are still correct\n\n## Verification\n- Full build passes\n- All tests pass\n- Runtime behaviour unchanged","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:13:37.253291677Z","updated_at":"2025-11-29T14:49:32.415893Z","closed_at":"2025-11-29T14:49:32.415893Z","close_reason":"Completed in PR #1079","dependencies":[{"issue_id":"dh-cb3","depends_on_id":"dh-jai","type":"blocks","created_at":"2025-11-25T07:13:41.603753769Z","created_by":"daemon"}]}
{"id":"dh-d8w","title":"Fix nix sync workflow fetching SHA from wrong branch","description":"","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T13:06:59.499163Z","updated_at":"2025-11-29T13:07:37.3255Z","closed_at":"2025-11-29T13:07:37.3255Z","close_reason":"Closed"}
{"id":"dh-dd4","title":"Set up bun2nix dependency management","description":"## Task\nSet up bun2nix for dependency management:\n- Generate bun-deep-heating.nix from pruned lockfile\n- Generate bun.nix from full lockfile (CI validation)\n- Add generateBunNix and generateBunNixDeepHeating derivations\n- Add bunDepsDeepHeating using fetchBunDeps\n- Add validateDeps derivation for CI\n\n## Acceptance\n- bun-deep-heating.nix and bun.nix files generated and committed\n- `nix build .#bunDepsDeepHeating` succeeds\n- `nix build .#validateDeps` succeeds\n\n## Reference\n- automatarr/flake.nix lines 224-342","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T18:42:41.889504Z","updated_at":"2025-11-26T07:36:09.083059Z","closed_at":"2025-11-26T07:36:09.083059Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-dd4","depends_on_id":"dh-vjn","type":"blocks","created_at":"2025-11-25T18:43:56.768614Z","created_by":"daemon"}]}
{"id":"dh-e5x","title":"Migrate deep-heating-web tests to Bun","description":"## Task\nMigrate tests in packages/deep-heating-web from Vitest to Bun native.\n\n## Challenges\n- SvelteKit uses Vitest by default\n- Component testing may need different approach\n- Svelte Testing Library integration\n\n## Steps\n1. Research Bun + Svelte testing options\n2. Update test imports and patterns\n3. Handle component mounting/rendering\n4. Update vite.config.ts and package.json\n5. Remove Vitest dependencies\n\n## Notes\nThis may be the most complex migration due to Svelte integration. Consider if hybrid approach (Vitest for component tests only) is acceptable.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:32.935855558Z","updated_at":"2025-11-30T11:16:58.019681Z","closed_at":"2025-11-30T11:16:58.019681Z","close_reason":"No tests in deep-heating-web package. Legacy config cleaned up as part of dh-luf.","dependencies":[{"issue_id":"dh-e5x","depends_on_id":"dh-5rw","type":"blocks","created_at":"2025-11-25T07:14:39.568043554Z","created_by":"daemon"}]}
{"id":"dh-e8n","title":"Create deep-heating build derivation","description":"## Task\nCreate the main deep-heating derivation:\n- Use bun2nix mkDerivation with pruned workspace\n- Build all packages with turbo\n- Bundle socketio backend with bun build\n- Copy SvelteKit build output\n- Create wrapper script for socketio\n\n## Output Structure\n- $out/bin/deep-heating-socketio - Wrapper script\n- $out/lib/deep-heating/socketio-bundle.js - Bundled backend\n- $out/lib/deep-heating/web/ - SvelteKit output\n\n## Acceptance\n- `nix build .#deep-heating` succeeds\n- `result/bin/deep-heating-socketio --help` runs (or similar)\n\n## Reference\n- automatarr/flake.nix lines 344-431","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T18:42:47.62984Z","updated_at":"2025-11-26T08:45:38.000547Z","closed_at":"2025-11-26T08:45:38.000547Z","close_reason":"deep-heating build derivation complete - builds socketio bundle and SvelteKit web frontend using turbo and bun2nix","dependencies":[{"issue_id":"dh-e8n","depends_on_id":"dh-dd4","type":"blocks","created_at":"2025-11-25T18:43:56.816482Z","created_by":"daemon"}]}
{"id":"dh-eq0","title":"Fix DateTime.local eta-expansion in timer streams","description":"Four files use `() =\u003e DateTime.local()` wrapper with eslint-disable comments for effect/no-eta-expansion. This is needed because RxJS timer passes a number to map callbacks but DateTime.local() doesn't accept it. Consider creating a helper function or using a different pattern.\n\nFiles affected:\n- houseModes.ts:37\n- roomSchedules.ts:22\n- roomScheduledTargetTemperatures.ts:48\n- trvScheduledTargetTemperatures.ts:17","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T08:09:45.403693Z","updated_at":"2025-11-30T08:58:35.399774Z","closed_at":"2025-11-30T08:58:35.399774Z","close_reason":"Closed"}
{"id":"dh-ew7","title":"Remove unused Dockerfiles","description":"The following Dockerfiles are dead code - production builds use Nix (nix build .#dockerImage):\n\n- packages/deep-heating/Dockerfile\n- packages/deep-heating-socketio/Dockerfile  \n- packages/deep-heating-web/Dockerfile\n\nAlso remove the npm scripts from package.json:\n- docker:build:deep-heating\n- docker:build:socketio\n- docker:build:web\n- docker:build:all","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T10:00:33.995087Z","updated_at":"2025-11-29T10:21:36.580612Z","closed_at":"2025-11-29T10:21:36.580612Z","close_reason":"Closed"}
{"id":"dh-ez9","title":"Phase 4: Incrementally migrate createDeepHeating streams","description":"","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-30T14:07:45.769223Z","updated_at":"2025-11-30T14:07:45.769223Z"}
{"id":"dh-gno","title":"Migrate testing from Jest/Vitest to Bun native","description":"## Overview\nReplace Jest and Vitest with Bun's native test runner, including Effect integration via a buntest-style utility package.\n\n## Why\n- Bun's test runner is faster\n- Native TypeScript support without ts-jest\n- Better Effect integration possible\n- Simpler toolchain (one less tool)\n\n## Scope\n- Create buntest utility package for Effect integration\n- Migrate all package tests to Bun syntax\n- Remove Jest and Vitest dependencies\n- Update Turbo pipeline for new test command\n\n## Challenges\n- Jest mocking patterns need Bun equivalents\n- Vitest's Svelte integration needs replacement\n- Effect test patterns need it.effect() support","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:14:32.220270678Z","updated_at":"2025-11-29T17:11:07.959239Z","closed_at":"2025-11-29T17:11:07.959239Z","close_reason":"Migrated from Jest/Vitest to Bun native test runner","dependencies":[{"issue_id":"dh-gno","depends_on_id":"dh-p8z","type":"blocks","created_at":"2025-11-25T07:14:39.496933005Z","created_by":"daemon"}]}
{"id":"dh-gzw","title":"Fix Nix build network errors in CI","description":"## Problem\nNix build in GitHub Actions fails with network errors when downloading npm packages:\n- `ConnectionRefused downloading tarball`\n- `FailedToOpenSocket downloading tarball`\n\n## Failed run\nhttps://github.com/GraemeF/home-automation/actions/runs/19771675627\n\n## Context\nThe bun2nix fetcher can't reach the npm registry from within the Nix sandbox during CI builds.\n\n## Potential causes\n- Nix sandbox network restrictions\n- GitHub Actions runner network configuration\n- bun2nix fixed-output derivation issues","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-28T18:47:50.370411Z","updated_at":"2025-11-28T19:08:00.735556Z","closed_at":"2025-11-28T19:08:00.735556Z","close_reason":"Fixed by PR #1051 - added CI validation for bun-deep-heating.nix sync and regenerated the file"}
{"id":"dh-hgg","title":"Set up multi-arch Nix builds","description":"## Task\nConfigure Nix flake for multi-architecture support.\n\n## Architectures\n- x86_64-linux (primary)\n- aarch64-linux (ARM servers, Raspberry Pi)\n- aarch64-darwin (optional, for Mac development)\n\n## Implementation\n- Use flake-utils or nixpkgs.lib.systems for multi-arch\n- Configure QEMU for cross-compilation if needed\n- Test builds on both architectures\n\n## Verification\n- `nix build .#packages.x86_64-linux.dockerImage`\n- `nix build .#packages.aarch64-linux.dockerImage`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:45.448272697Z","updated_at":"2025-11-29T14:51:40.273328Z","closed_at":"2025-11-29T14:51:40.273328Z","close_reason":"Already implemented in flake.nix using nixpkgs.lib.systems.flakeExposed and forAllSystems","dependencies":[{"issue_id":"dh-hgg","depends_on_id":"dh-3r6","type":"blocks","created_at":"2025-11-25T07:15:50.627143754Z","created_by":"daemon"}]}
{"id":"dh-hkk","title":"Update ESLint to 9.x","description":"## Task\nUpdate ESLint and related plugins to version 9.x.\n\n## Dependencies to Update\n- eslint → 9.x\n- @typescript-eslint/parser → 8.x (compatible with ESLint 9)\n- @typescript-eslint/eslint-plugin → 8.x\n- eslint-config-prettier → latest\n- eslint-plugin-svelte → latest compatible\n\n## Notes\n- Some plugins may not yet support ESLint 9 flat config\n- Check compatibility before updating\n- May need to temporarily disable incompatible plugins","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:01.857328777Z","updated_at":"2025-11-29T16:01:45.345116Z","closed_at":"2025-11-29T16:01:45.345116Z","close_reason":"ESLint updated to v9.39.1 and typescript-eslint to v8.47.0. PR #1086 merged.","dependencies":[{"issue_id":"dh-hkk","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:14:06.654470948Z","created_by":"daemon"}]}
{"id":"dh-hnu","title":"Enable type-aware ESLint rules for eslint-plugin-functional","description":"## Task\nAdd parserOptions.project configuration to enable type-aware ESLint rules from eslint-plugin-functional.\n\n## Rules to Enable\n- `functional/immutable-data` - Prevent mutations (requires type info to detect complex cases)\n- `functional/prefer-immutable-types` - Prefer readonly types\n\n## Implementation\n1. Add `parserOptions.project: true` to the source-functional config\n2. May need per-package tsconfig.eslint.json files for proper scope\n3. Test performance impact (typed linting can be slower)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T16:24:19.013397Z","updated_at":"2025-11-29T17:00:08.78292Z","closed_at":"2025-11-29T17:00:08.78292Z","close_reason":"Merged in PR #1090","dependencies":[{"issue_id":"dh-hnu","depends_on_id":"dh-2o9","type":"blocks","created_at":"2025-11-29T16:27:54.425704Z","created_by":"daemon"}]}
{"id":"dh-icx","title":"Update CI to publish Nix-built Docker image","description":"## Task\nUpdate GitHub Actions workflow to build and publish Docker images using Nix instead of Dockerfile.\n\n## Current State\n- Docker builds disabled in CI (`if: false`)\n- When enabled, uses `docker/build-push-action` with Dockerfile\n- Nix build produces 337MB image (28% smaller than Dockerfile's 466MB)\n\n## Implementation\n1. Install Nix in CI (e.g., `cachix/install-nix-action`)\n2. Build with `nix build .#dockerImage`\n3. Load image: `docker load \u003c result`\n4. Push to GHCR and DockerHub\n\n## Considerations\n- Multi-arch support: may need separate builds for amd64/arm64\n- Caching: consider Cachix or GitHub Actions cache for Nix store\n- The flake is on feature/nix-flake branch - merge first or test in PR\n\n## Acceptance\n- CI builds Docker image with Nix on push to main\n- Image published to ghcr.io/graemef/deep-heating\n- Image size ~337MB (not 466MB)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-26T18:22:51.672871536Z","updated_at":"2025-11-26T21:33:41.732392Z","closed_at":"2025-11-26T21:33:41.732392Z","close_reason":"CI workflow updated to build Docker images with Nix. Builds x86_64-linux only for now. arm64 support tracked in dh-vlk.","dependencies":[{"issue_id":"dh-icx","depends_on_id":"dh-7rz","type":"blocks","created_at":"2025-11-26T18:23:17.293667872Z","created_by":"daemon"}]}
{"id":"dh-jai","title":"Update TypeScript and related deps to 5.9.x","description":"## Task\nUpdate TypeScript and all related dependencies to latest stable versions.\n\n## Dependencies to Update\n- typescript → 5.9.x\n- @typescript-eslint/parser → latest compatible\n- @typescript-eslint/eslint-plugin → latest compatible\n- ts-jest → latest compatible (until Jest removal)\n\n## Steps\n1. Update package.json dependencies\n2. Run `bun install`\n3. Fix any immediate type errors\n4. Verify build still works","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:13:37.147036706Z","updated_at":"2025-11-29T14:47:41.606591Z","closed_at":"2025-11-29T14:47:41.606591Z","close_reason":"TypeScript already at 5.9.3, related deps updated","dependencies":[{"issue_id":"dh-jai","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:13:41.589823896Z","created_by":"daemon"}]}
{"id":"dh-jj2","title":"Refactor flake.nix to reduce duplication and improve maintainability","description":"## Task\nRefactor flake.nix to reduce code duplication and improve maintainability.\n\n## Current Issues\n- Repeated patterns for bun2nix package generation (generateBunNix, generateBunNixDeepHeating)\n- Similar derivation structures that could be extracted into helper functions\n- Large single file (~12KB) that could be split into modules\n\n## Potential Improvements\n- Extract common patterns into let bindings or lib functions\n- Consider splitting into nix/ directory with separate files:\n  - nix/packages.nix - package derivations\n  - nix/dev-shell.nix - development shell\n  - nix/lib.nix - shared helper functions\n- Use flake-parts or similar for better organization (optional)\n- Add inline documentation for complex derivations\n\n## Acceptance\n- flake.nix is easier to understand and modify\n- No functional changes to outputs\n- All existing builds still work","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-26T09:13:10.588109Z","updated_at":"2025-11-29T19:49:01.228104Z","closed_at":"2025-11-29T19:49:01.228104Z","close_reason":"Extracted s6 service definitions into data+helpers, cleaned up source filtering patterns"}
{"id":"dh-k08","title":"Add separate typecheck turbo task","description":"Currently typecheck is bundled into lint. Having a separate `typecheck` task (like brownsauce) makes it easier to run just type checking without linting, and allows better dependency ordering in the turbo pipeline.\n\n## Implementation notes (from brownsauce)\n\nThe typecheck task should have:\n- `dependsOn: [\"^build\", \"^typecheck\"]` - needs upstream builds and typechecks\n- Explicit `inputs` for caching: `src/**/*.ts`, `tsconfig*.json`, `package.json`, `$TURBO_ROOT$/bun.lock`\n- `cache: true` and `outputs: []`\n\nThen update `lint` to depend on `typecheck` instead of just `^build`.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T08:26:37.580082Z","updated_at":"2025-11-30T08:45:00.477308Z","closed_at":"2025-11-30T08:45:00.477308Z","close_reason":"Closed"}
{"id":"dh-k8y","title":"Replace npm lockfile with bun.lock","description":"## Task\nRemove package-lock.json and generate bun.lock by running `bun install`.\n\n## Steps\n1. Delete package-lock.json\n2. Run `bun install` to generate bun.lock\n3. Verify all dependencies resolve correctly\n4. Check for any resolution differences between npm and bun\n\n## Verification\n- `bun install` completes without errors\n- All workspace packages are linked correctly","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:12:18.037048567Z","updated_at":"2025-11-25T07:47:37.137086051Z","closed_at":"2025-11-25T07:47:37.137086051Z","dependencies":[{"issue_id":"dh-k8y","depends_on_id":"dh-vkw","type":"blocks","created_at":"2025-11-25T07:33:58.268370587Z","created_by":"daemon"}]}
{"id":"dh-klx","title":"Replace debug with Effect Logger","description":"Migrate 2 files from debug package to Effect Logger.\n\nFiles to migrate:\n- packages/deep-heating-socketio/src/main.ts\n- packages/deep-heating-rx/src/lib/streams/DeepHeating.ts\n\nEffect Logger capabilities:\n- Logger.make for custom formatters\n- Namespaced logging via Effect.annotateLogs\n- Log levels (Debug, Info, Warning, Error)\n- Structured JSON logging with Logger.json\n- Log spans with Effect.withLogSpan\n\nThis removes the debug dependency and provides better observability.","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T11:57:57.248818Z","updated_at":"2025-11-30T11:57:57.248818Z"}
{"id":"dh-km6","title":"Apply consistent Effect lint rules to test files","description":"## Overview\nTest files should be linted to the same standard as production code, with minimal exceptions.\n\n## Current State\n- Test files (\\*.spec.ts, \\*.test.ts) may have different/relaxed lint rules\n- Effect.gen was used in tests without lint errors (should use pipe pattern)\n- Inconsistent enforcement between test and production code\n\n## Target State\n- Apply the same Effect lint rules to test files as production code\n- Only allow specific, justified exceptions (e.g. allowing any for test fixtures)\n- Ensure eslint-plugin-effect rules apply uniformly\n\n## Files to Change\n- ESLint config (remove test-specific overrides that relax Effect rules)\n- Fix any test files that violate the rules after config change\n\n## Rationale\nTests should model good code practices. If a pattern is bad enough to lint against in production, it's bad enough to lint against in tests.","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T13:05:45.470372Z","updated_at":"2025-11-30T13:06:34.455215Z"}
{"id":"dh-ko1","title":"Evaluate Effect ESLint rules for web package","description":"The web package (SvelteKit) has several Effect ESLint rules disabled because it's not an Effect-based application:\n- effect/prefer-effect-platform (off) - uses process.env directly\n- effect/prefer-match-over-ternary (off) - simple ternaries in UI code\n- functional/prefer-immutable-types (off) - Svelte stores are mutable\n- functional/prefer-readonly-type (off) - Svelte stores are mutable\n\nConsider whether these rules should be gradually adopted or if the overrides are permanent.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T08:09:52.687576Z","updated_at":"2025-11-30T09:13:21.676216Z","closed_at":"2025-11-30T09:13:21.676216Z","close_reason":"Evaluation complete: All four disabled rules (prefer-effect-platform, prefer-match-over-ternary, prefer-immutable-types, prefer-readonly-type) should remain permanently disabled. SvelteKit's SSR patterns, Svelte's mutable store reactivity model, and simple UI ternaries are all legitimate reasons for these overrides. The existing ESLint config comments accurately document the rationale."}
{"id":"dh-lph","title":"Clarify bd sync instructions for protected main branch","description":"## Problem\nCurrent beads workflow instructions don't account for protected main branch. Running `bd sync` on main fails due to branch protection, causing confusing errors.\n\n## Clarification needed\n- On feature branches: `bd sync` works fine, use it freely\n- On main: Don't run `bd sync` manually - the daemon handles it via beads-metadata branch\n\n## Update locations\n- Session start hook instructions\n- Any beads documentation in the repo","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T11:13:43.546171Z","updated_at":"2025-11-29T11:16:23.340646Z","closed_at":"2025-11-29T11:16:23.340646Z","close_reason":"Added SessionStart hook to clarify bd sync should not be run on main branch"}
{"id":"dh-luf","title":"Remove Jest and Vitest dependencies","description":"## Task\nClean up Jest and Vitest dependencies after all tests are migrated.\n\n## Dependencies to Remove\n- jest\n- ts-jest\n- @types/jest\n- jest-environment-jsdom\n- vitest\n- @vitest/coverage-v8\n- Any other jest-* or vitest-* packages\n\n## Files to Delete\n- jest.config.ts files\n- jest.preset.js\n- vitest.config.ts files\n- Any Jest/Vitest specific setup files\n\n## Verification\n- `bun test` runs all tests successfully\n- No Jest/Vitest references remain in codebase","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:14:33.079972681Z","updated_at":"2025-11-30T11:17:02.962985Z","closed_at":"2025-11-30T11:17:02.962985Z","close_reason":"Removed 4 .babelrc files, cleaned all tsconfig files (removed jest/node types, jest.config.ts excludes), added bun-types to tsconfig.base.json. All tests pass.","dependencies":[{"issue_id":"dh-luf","depends_on_id":"dh-5rw","type":"blocks","created_at":"2025-11-25T07:14:39.582336623Z","created_by":"daemon"},{"issue_id":"dh-luf","depends_on_id":"dh-09s","type":"blocks","created_at":"2025-11-25T07:14:39.59646713Z","created_by":"daemon"},{"issue_id":"dh-luf","depends_on_id":"dh-91v","type":"blocks","created_at":"2025-11-25T07:14:39.611205132Z","created_by":"daemon"},{"issue_id":"dh-luf","depends_on_id":"dh-e5x","type":"blocks","created_at":"2025-11-25T07:14:39.625573041Z","created_by":"daemon"},{"issue_id":"dh-luf","depends_on_id":"dh-2nz","type":"blocks","created_at":"2025-11-30T11:06:24.574077Z","created_by":"daemon"}]}
{"id":"dh-lun","title":"Fix CI/Sync race condition for bun-deep-heating.nix","description":"When bun.lock changes, the sync workflow and CI workflow both trigger. Sync commits with [skip ci] so CI never re-runs after the fix is applied. This causes CI to fail even though sync successfully fixed the file.\n\nRoot cause:\n1. Sync commits use [skip ci] preventing CI re-run\n2. validate-nix job doesn't checkout PR HEAD like build job does\n\nFix:\n1. Remove [skip ci] from sync commit message\n2. Make validate-nix checkout PR head ref","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T14:23:14.076874Z","updated_at":"2025-11-29T14:24:59.256312Z","closed_at":"2025-11-29T14:24:59.256312Z","close_reason":"Fixed by removing [skip ci] from sync commits and making CI checkout PR head ref"}
{"id":"dh-mdh","title":"Replace Socket.IO with Effect Platform Socket","description":"## Overview\nReplace Socket.IO with @effect/platform Socket for real-time client-server communication.\n\n## Current State\n- Socket.IO used in deep-heating-socketio for real-time updates\n- RxJS fromEvent() used to convert socket events to observables\n- Manual connection handling\n\n## Target State\n- Use @effect/platform Socket and SocketServer\n- Native Effect Stream integration\n- Automatic reconnection with configurable backoff\n- Proper resource cleanup via Effect Scope\n\n## Effect Platform Socket Features\n- `Socket.makeWebSocket(url)` - Create WebSocket client\n- `Socket.toChannel()` - Convert to Effect Channel for bidirectional streaming\n- `SocketServer.run(handler)` - Server-side socket handling\n- Built-in reconnection with exponential backoff\n- Automatic cleanup on scope end\n\n## Alternative: effect-websocket library\nCommunity library with even richer support:\n- Runtime portability (Node/Bun/Browser)\n- `client.messages` - Stream of incoming messages\n- `client.events` - Connection lifecycle events\n- `client.send()` - Send messages\n\n## Migration Approach\n1. Replace Socket.IO server with Effect SocketServer\n2. Replace Socket.IO client events with Effect Socket streams\n3. Use adapters to expose as RxJS Observable for existing consumers\n4. Gradually migrate consumers to Effect Streams\n\n## Files to Change\n- packages/deep-heating-socketio/src/socket-server.ts\n- packages/deep-heating-socketio/src/server.ts\n- packages/deep-heating-web (client side)","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T11:50:52.794367Z","updated_at":"2025-11-30T11:50:52.794367Z"}
{"id":"dh-myp","title":"Fix Docker workflow trigger from release","description":"## Problem\nThe Docker workflow doesn't trigger after a release because the changesets action's `published` output only works for npm publishing, not our tag-based releases.\n\n## Current behavior\n- Release workflow runs `bun run release` which creates and pushes a git tag\n- Changesets action doesn't detect this as \"publishing\" because no npm packages changed\n- `published` output is false/empty, so Docker job is skipped\n\n## Solution\nDetect publish mode directly instead of relying on changesets output:\n- Check if changesets exist (version mode) vs no changesets (publish mode)\n- When in publish mode and release script succeeds, trigger Docker build\n- Or: have release script output the version, check if tag was created\n\n## References\n- Failed run: https://github.com/GraemeF/home-automation/actions/runs/19745964028\n- Tag v0.0.2 was created but Docker didn't build","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-27T19:14:53.465471081Z","updated_at":"2025-11-28T18:47:43.075449Z","closed_at":"2025-11-28T18:47:43.075449Z","close_reason":"Verified working - Docker build triggered after v0.0.3 release. Nix build failure is separate issue."}
{"id":"dh-n48","title":"Create basic flake.nix with inputs and dev shell","description":"## Task\nCreate the initial flake.nix with:\n- nixpkgs and bun2nix inputs\n- Multi-arch support (forAllSystems helper)\n- Dev shell with Bun, Git, Docker\n\n## Acceptance\n- `nix develop` works on macOS\n- Shell has bun, git, docker available\n\n## Reference\n- automatarr/flake.nix lines 1-60, 567-606","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T18:42:20.212518Z","updated_at":"2025-11-25T18:59:28.41963Z","closed_at":"2025-11-25T18:59:28.41963Z","close_reason":"Closed"}
{"id":"dh-n86","title":"Add tagged error types with Effect.catchTag","description":"## Overview\nStandardize error handling across the codebase using Effect's tagged error pattern.\n\n## Current State\n- Mixed error handling (RxJS catchError, try/catch, Effect errors)\n- Errors lose type information\n- Difficult to handle specific error cases\n\n## Target State\n- Define tagged error types (e.g., HomeAssistantConnectionError, ConfigurationError)\n- Use Effect.catchTag for specific error handling\n- Proper error propagation through Effect chains\n\n## Files to Change\n- packages/deep-heating-home-assistant/src/lib/home-assistant-api.ts (define error types)\n- packages/deep-heating-rx/src/lib/heatingProvider.ts (use catchTag)\n\n## Reference\nSee automatarr's Effect.catchTag('EpisodeNotFoundError', ...) pattern","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T11:40:58.282176Z","updated_at":"2025-11-30T13:05:27.881128Z","closed_at":"2025-11-30T13:05:27.881128Z","close_reason":"Implemented tagged error types following automatarr pattern"}
{"id":"dh-nv4","title":"Add dependency-cruiser for architecture validation","description":"## Task\nAdd dependency-cruiser to validate architecture and detect circular dependencies.\n\n## Installation\n`bun add -D dependency-cruiser`\n\n## Configuration\nCreate .dependency-cruiser.cjs with rules for:\n- No circular dependencies\n- No orphan modules\n- Package boundary enforcement (e.g., types package shouldn't import from rx)\n\n## Integration\n- Add `deps:check` script to package.json\n- Add to Turbo `ci` pipeline\n- Configure in turbo.json","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:15.654944688Z","updated_at":"2025-11-29T18:58:20.172506Z","closed_at":"2025-11-29T18:58:20.172506Z","close_reason":"Won't do - package.json workspace refs already enforce boundaries, knip handles orphans. Circular dep detection not worth the tool overhead for this codebase size.","dependencies":[{"issue_id":"dh-nv4","depends_on_id":"dh-b5h","type":"blocks","created_at":"2025-11-25T07:15:20.307396845Z","created_by":"daemon"}]}
{"id":"dh-p8z","title":"Migrate ESLint to v9 flat config","description":"## Overview\nMigrate from ESLint 8.x with legacy .eslintrc.json to ESLint 9.x with flat config format (eslint.config.mjs).\n\n## Why\n- ESLint 8.x is deprecated\n- Flat config is the new standard\n- Better TypeScript integration\n- Enables modern plugins like eslint-plugin-functional\n\n## Scope\n- Update ESLint to 9.x\n- Convert all config files to flat format\n- Add functional programming rules\n- Add Effect-specific linting rules","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-25T07:14:01.736591712Z","updated_at":"2025-11-29T16:48:22.843223Z","closed_at":"2025-11-29T16:48:22.843223Z","close_reason":"Already completed in PRs #1086 and #1087","dependencies":[{"issue_id":"dh-p8z","depends_on_id":"dh-b44","type":"blocks","created_at":"2025-11-25T07:14:06.639968709Z","created_by":"daemon"}]}
{"id":"dh-q2x","title":"Phase 2b: Complete Home Assistant API as Effect service","description":"","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-30T14:07:11.51191Z","updated_at":"2025-11-30T14:07:11.51191Z"}
{"id":"dh-rez","title":"Increase Renovate prConcurrentLimit after Nix migration","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T17:56:47.507033Z","updated_at":"2025-11-29T15:16:05.339407Z","closed_at":"2025-11-29T15:16:05.339407Z","close_reason":"Won't do - decided not to increase Renovate limit","dependencies":[{"issue_id":"dh-rez","depends_on_id":"dh-hgg","type":"blocks","created_at":"2025-11-25T18:08:47.172001Z","created_by":"daemon"}]}
{"id":"dh-s6c","title":"Add Docker image with s6-overlay","description":"## Task\nCreate Docker image derivation:\n- Use dockerTools.buildLayeredImage\n- Include: deep-heating, nginx, s6 (from nixpkgs), binSh\n- Configure s6 services for nginx and socketio using raw s6 packages\n- Copy nginx config from packages/deep-heating/assets/ingress.conf\n- Use s6-svscan as PID 1 on a scandir\n\n## Approach (Updated)\nUsing raw s6 packages from nixpkgs instead of fetching s6-overlay tarballs:\n- pkgs.s6 - supervision suite\n- pkgs.s6-rc - service manager\n- pkgs.s6-linux-init - init tools\n- pkgs.execline - scripting\n\n## s6 Service Structure\n/run/service/ (scandir)\n├── nginx/\n│   ├── run\n│   └── down\n├── socketio/\n│   ├── run\n│   └── down\n└── web/\n    ├── run\n    └── down\n\n## Acceptance\n- `nix build .#dockerImage` succeeds (Linux only)\n- `docker load \u003c result` works\n- Container starts and serves requests\n\n## Reference\n- https://skarnet.org/software/s6/s6-svscan-1.html\n- https://skarnet.org/software/s6-linux-init/","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T18:42:53.971447Z","updated_at":"2025-11-26T20:37:54.157125Z","closed_at":"2025-11-26T18:18:37.155413313Z","dependencies":[{"issue_id":"dh-s6c","depends_on_id":"dh-e8n","type":"blocks","created_at":"2025-11-25T18:43:56.867524Z","created_by":"daemon"}]}
{"id":"dh-srn","title":"Phase 3: Migrate maintainState to Effect Stream","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T14:07:23.940615Z","updated_at":"2025-11-30T14:07:23.940615Z"}
{"id":"dh-ts1","title":"Evaluate Effect ESLint rules for socketio package","description":"## Evaluation Complete\n\nThe socketio package ESLint overrides should remain **PERMANENT**.\n\n### Findings\n\nThe package is a **hybrid** codebase:\n- `server.ts` uses Effect (Effect.flatMap, Effect.tap, Schema, FileSystem layer)\n- `socket-server.ts` is pure RxJS/Socket.IO with a class-based pattern\n\n### Rule-by-Rule Analysis\n\n| Rule | Recommendation | Reason |\n|------|----------------|--------|\n| `effect/prefer-effect-platform` | Keep OFF | Intentionally hybrid - uses both Effect FileSystem and Node APIs |\n| `effect/no-classes` | Keep OFF | SocketServer class is sensible for Socket.IO stateful logic |\n| `effect/prefer-match-over-ternary` | Keep OFF | No significant ternaries, pedantic for simple cases |\n| `functional/prefer-immutable-types` | Keep OFF | Class subscriptions are inherently mutable |\n| `functional/prefer-readonly-type` | Keep OFF | Same as above |\n| `effect/no-curried-calls` | Keep OFF | Not relevant to RxJS code |\n| `effect/no-eta-expansion` | Keep OFF | One instance fixed manually |\n\n### Cleanup Done\n\nFixed eta-expansion in `server.ts:44`:\n- Before: `Effect.tap((data) =\u003e Effect.log(data))`\n- After: `Effect.tap(Effect.log)`\n\n### Conclusion\n\nFull Effect adoption would require significant refactoring with unclear benefit. The hybrid approach (Effect for initialization, RxJS for runtime) is intentional and reasonable.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-30T08:09:59.019537Z","updated_at":"2025-11-30T09:46:23.531075Z","closed_at":"2025-11-30T09:46:23.531075Z","close_reason":"Evaluated rules - overrides are permanent. Fixed one eta-expansion instance."}
{"id":"dh-ttb","title":"Configure protected main branch with beads sync branch","description":"## Task\nProtect the main branch and configure beads to use a separate sync branch for metadata commits.\n\n## Why\nWith main branch protected (requiring PRs), beads can't auto-commit issue updates directly to main. Solution is to use a separate `beads-metadata` branch.\n\n## Steps\n\n### 1. Protect main branch on GitHub\n- Settings → Branches → Add rule\n- Branch name pattern: `main`\n- Check \"Require pull request before merging\"\n- Save\n\n### 2. Configure beads for protected branch workflow\n```bash\nbd config set sync.branch beads-metadata\nbd daemon restart\n```\n\n### 3. Update hooks if needed\nThe daemon will auto-commit to `beads-metadata`. Periodically merge to main via PR:\n```bash\ngit push origin beads-metadata\ngh pr create --base main --head beads-metadata --title \"Update beads metadata\"\n```\n\n## Reference\nSee `../references/beads/docs/PROTECTED_BRANCHES.md` for full documentation.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-27T08:47:45.307192437Z","updated_at":"2025-11-27T18:41:02.50568896Z","closed_at":"2025-11-27T18:41:02.50568896Z"}
{"id":"dh-udp","title":"Phase 1: Convert socketio entry point to Effect application","description":"","status":"open","priority":1,"issue_type":"feature","created_at":"2025-11-30T14:06:19.442727Z","updated_at":"2025-11-30T14:06:19.442727Z"}
{"id":"dh-ug1","title":"Incremental RxJS to Effect Stream migration","description":"## Overview\nTracking issue for the incremental migration from RxJS to Effect Streams.\n\n## Strategy\nUse adapters to enable bidirectional conversion between Effect Streams and RxJS Observables, allowing incremental migration without breaking existing code.\n\n## Sub-tasks (in order)\n1. dh-apg: Upgrade RxJS from 6.x to 7.x (enables AsyncIterable interop)\n2. dh-597: Create Effect Stream ↔ RxJS Observable adapters\n3. dh-9me: Pilot migration - heatingProvider.ts\n4. dh-07h: Replace RxJS Subjects with SubscriptionRef/PubSub\n5. dh-mdh: Replace Socket.IO with Effect Platform Socket\n\n## Benefits of This Approach\n- No big bang rewrite required\n- Each module can migrate independently\n- Existing consumers continue working via adapters\n- Can validate Effect patterns work before full commitment\n- Easy rollback if issues discovered\n\n## Completion Criteria\nClose when all sub-tasks complete and team is comfortable with Effect patterns.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-30T11:51:36.374314Z","updated_at":"2025-11-30T11:51:36.374314Z","dependencies":[{"issue_id":"dh-ug1","depends_on_id":"dh-apg","type":"blocks","created_at":"2025-11-30T11:51:40.558149Z","created_by":"daemon"},{"issue_id":"dh-ug1","depends_on_id":"dh-597","type":"blocks","created_at":"2025-11-30T11:51:40.597261Z","created_by":"daemon"},{"issue_id":"dh-ug1","depends_on_id":"dh-9me","type":"blocks","created_at":"2025-11-30T11:51:40.637623Z","created_by":"daemon"},{"issue_id":"dh-ug1","depends_on_id":"dh-07h","type":"blocks","created_at":"2025-11-30T11:51:40.67818Z","created_by":"daemon"},{"issue_id":"dh-ug1","depends_on_id":"dh-mdh","type":"blocks","created_at":"2025-11-30T11:51:40.71582Z","created_by":"daemon"}]}
{"id":"dh-vjn","title":"Add pruned workspace derivation to flake.nix","description":"## Task\nAdd prunedWorkspace derivation:\n- depSource filter (exclude node_modules, .git, result, .beads, .turbo)\n- Run turbo prune for deep-heating-socketio and deep-heating-web\n- Output pruned workspace with pruned bun.lock\n\n## Acceptance\n- `nix build .#prunedWorkspace` succeeds\n- Output contains only needed packages\n- bun.lock is present in output\n\n## Reference\n- automatarr/flake.nix lines 85-221","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T18:42:35.375731Z","updated_at":"2025-11-26T07:24:10.955706Z","closed_at":"2025-11-26T07:24:10.955706Z","close_reason":"Closed","dependencies":[{"issue_id":"dh-vjn","depends_on_id":"dh-b0w","type":"blocks","created_at":"2025-11-25T18:43:56.71813Z","created_by":"daemon"}]}
{"id":"dh-vk2","title":"Fix Home Assistant image path - manifest unknown error","description":"## Bug\nHome Assistant fails to install/update Deep Heating with:\n```\nCan't install ghcr.io/graemef/home-automation/deep-heating:0.0.4: DockerError(404, 'manifest unknown')\n```\n\n## Root Cause\nThe image path in config.yaml likely includes the repo name (`home-automation`) but the actual published image is at `ghcr.io/graemef/deep-heating:0.0.4` (without the repo path segment).\n\n## Fix\nCheck and correct the image path in the Home Assistant addon config.yaml to match where Docker images are actually published.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:09:19.246782Z","updated_at":"2025-11-29T13:54:57.512771Z","closed_at":"2025-11-29T13:54:57.512771Z","close_reason":"Fixed in commit 4edf11f - corrected Docker image path"}
{"id":"dh-vkw","title":"Declare rxjs as explicit dependency in packages that use it","description":"## Overview\nFix implicit dependency hoisting that was relied upon by npm. Each package must declare its own dependencies explicitly.\n\n## Packages to fix\nBased on build errors, these packages need dependency declarations:\n- rxx: needs rxjs\n- deep-heating-types: needs @effect/schema\n- deep-heating-home-assistant: needs rxjs\n- deep-heating-rx: needs rxjs\n- deep-heating-web: needs vite (peer dep of @sveltejs/kit)\n- Potentially others\n\n## Approach\n1. Audit each package's imports\n2. Add missing dependencies to each package.json\n3. Run bun install to update lockfile\n4. Verify build passes\n\n## Verification\n- `bun run build` passes\n- `bun run test` passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:30:00.07673105Z","updated_at":"2025-11-25T07:47:37.128349198Z","closed_at":"2025-11-25T07:47:37.128349198Z"}
{"id":"dh-vlk","title":"Add arm64 Docker image builds to CI","description":"## Task\nAdd arm64/aarch64 Docker image builds to CI for Home Assistant deployment on Raspberry Pi and similar ARM devices.\n\n## Approach\nUse GitHub's free arm64 runners for public repos (GA as of Aug 2025).\n\n### Implementation\n1. Split docker job into parallel architecture-specific jobs:\n   - `docker-amd64`: runs-on `ubuntu-latest`, builds .#dockerImage, pushes with `-amd64` suffix\n   - `docker-arm64`: runs-on `ubuntu-24.04-arm`, builds .#dockerImage, pushes with `-arm64` suffix\n2. Add `docker-manifest` job that waits for both, then:\n   - `docker manifest create` to combine into multi-arch image\n   - Push manifest as `latest` and `sha-XXXXX` tags\n\n### Why This Approach\n- **Free**: GitHub arm64 runners are free for public repos\n- **Fast**: Native builds, no QEMU emulation (which would be 10x slower)\n- **Simple**: No cross-compilation complexity in Nix\n\n### References\n- https://github.blog/changelog/2025-01-16-linux-arm64-hosted-runners-now-available-for-free-in-public-repositories-public-preview/\n- Runner labels: `ubuntu-24.04-arm`, `ubuntu-22.04-arm`\n\n## Acceptance\n- CI builds and publishes linux/arm64 Docker image\n- Multi-arch manifest published to GHCR and DockerHub\n- Both architectures build in parallel","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-26T21:12:39.317586Z","updated_at":"2025-11-26T21:43:56.820529Z","closed_at":"2025-11-26T21:43:56.820529Z","close_reason":"Implemented multi-arch Docker builds in CI","dependencies":[{"issue_id":"dh-vlk","depends_on_id":"dh-icx","type":"blocks","created_at":"2025-11-26T21:13:05.326761Z","created_by":"daemon"}]}
{"id":"dh-vmp","title":"Update deployment documentation for Nix","description":"## Task\nUpdate all deployment documentation to reflect Nix-based builds.\n\n## Documentation Updates\n- CLAUDE.md - Update build commands\n- README.md - New build/deploy instructions\n- packages/deep-heating/README.md - Nix-specific instructions\n\n## New Commands to Document\n- `nix develop` - Enter development shell\n- `nix build .#dockerImage` - Build container\n- `docker load \u003c result` - Load image\n- Deployment to Home Assistant\n\n## Remove\n- References to Docker multi-stage builds\n- npm/yarn based build instructions","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-25T07:15:45.726286969Z","updated_at":"2025-11-29T15:18:14.991845Z","closed_at":"2025-11-29T15:18:14.991845Z","close_reason":"PR #1084 - updated READMEs with bun commands and arm64 architecture shields","dependencies":[{"issue_id":"dh-vmp","depends_on_id":"dh-159","type":"blocks","created_at":"2025-11-25T07:15:50.655318831Z","created_by":"daemon"}]}
{"id":"dh-vyn","title":"GitHub workflow doesn't create verified commits","description":"The 'Sync bun.nix files' workflow (added in #1067) creates unsigned commits when it regenerates bun-deep-heating.nix. The repo requires verified commits, so these commits show as 'Unverified' on PRs (see PR #1071). Need to configure the workflow to sign commits using github-actions[bot] or a GitHub App.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-11-29T11:18:35.323793Z","updated_at":"2025-11-29T13:54:57.344536Z","closed_at":"2025-11-29T13:54:57.344536Z","close_reason":"Fixed - GitHub App token now creates verified commits"}
{"id":"dh-xco","title":"Decision: No armv7/armhf support (users should upgrade to 64-bit)","description":"## Decision: No armv7/armhf Support\n\nWe will NOT add armv7/armhf Docker builds. Users on 32-bit systems should upgrade to 64-bit.\n\n## Rationale\n\nHome Assistant officially deprecated armv7, armhf, and i386 architectures in May 2025:\n- **2025.6**: Deprecation warnings started\n- **2025.12**: Support ends completely (no more builds)\n\nKey facts from HA:\n- armv7 represents only 0.95% of HA installations\n- More than half are RPi3/4 users who accidentally installed 32-bit\n- These devices fully support 64-bit (aarch64)\n\nSource: https://www.home-assistant.io/blog/2025/05/22/deprecating-core-and-supervised-installation-methods-and-32-bit-systems/\n\n## Our Supported Architectures\n\nPer config.yaml:\n- amd64 (x86_64)\n- aarch64 (arm64)\n\n## Migration Path for Affected Users\n\nIf users see \"no matching manifest for linux/arm/v7\":\n1. Create a backup in Home Assistant\n2. Download 64-bit HAOS image for their device\n3. Flash to SD card\n4. Restore backup during onboarding\n\nHA backups are architecture-independent and restore seamlessly.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-28T18:37:41.145105Z","updated_at":"2025-11-29T13:36:04.918249Z","closed_at":"2025-11-29T09:16:50.345493Z","close_reason":"Removed armhf/armv7 from config.yaml - no users on ARM32 hardware"}
{"id":"dh-xo0","title":"Configure branch protection to require validate-nix check","description":"## Task\nUpdate GitHub branch protection rules to require the validate-nix CI check to pass before merging PRs.\n\n## Problem\nCurrently can merge PRs even when the bun-deep-heating.nix validation fails, which breaks Docker builds on main.\n\n## Solution\nAdd 'Validate bun.nix files' job to required status checks in branch protection settings.\n\n## Steps\n1. Go to repo Settings \u003e Branches \u003e main protection rule\n2. Add 'Validate bun.nix files' to required status checks\n3. Ensure 'Require status checks to pass before merging' is enabled\n\n## Note\nThis is a manual GitHub settings change, not code.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T10:51:10.151722Z","updated_at":"2025-11-29T11:02:57.816143Z","closed_at":"2025-11-29T11:02:57.816143Z","close_reason":"Added 'Validate bun.nix files' to required status checks via GitHub API","dependencies":[{"issue_id":"dh-xo0","depends_on_id":"dh-3zy","type":"blocks","created_at":"2025-11-29T10:51:32.72862Z","created_by":"daemon"}]}
{"id":"dh-ybs","title":"Skip CI for changeset-release branch","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T09:35:23.830201Z","updated_at":"2025-11-29T09:36:01.824313Z","closed_at":"2025-11-29T09:36:01.824313Z"}
{"id":"dh-yy2","title":"Inline Docker build in release workflow","description":"## Goal\nMove Docker build into the release workflow instead of triggering via git tag.\n\n## Context\nCurrently (after dh-1gr), Docker builds are triggered by git tags created by the release script. This works but adds complexity with tag management.\n\n## Future Approach\nHandle multi-arch Docker builds directly in the release workflow when changesets/action runs publish. Needs to handle:\n- Multi-arch (amd64, arm64) on different runners\n- Nix-based Docker builds\n- Manifest creation\n\n## Blocked by\ndh-1gr (need tag-triggered approach working first)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-27T08:15:37.372798173Z","updated_at":"2025-11-29T19:09:41.071172Z","closed_at":"2025-11-29T19:09:41.071172Z","close_reason":"PR #1096 created - removes tag trigger, uses workflow_call only","dependencies":[{"issue_id":"dh-yy2","depends_on_id":"dh-1gr","type":"blocks","created_at":"2025-11-27T08:16:01.09221279Z","created_by":"daemon"}]}
{"id":"dh-zzz","title":"Move root dependencies to workspace packages","description":"## Problem\nRoot package.json contains runtime dependencies that should live in workspace packages. This causes knip to flag them as unused (since they're not imported in root code) and requires manual `ignoreDependencies` config.\n\n## Current state\nRoot package.json has these runtime deps that belong in workspaces:\n- `@effect/platform`, `effect` → used by multiple packages\n- `express`, `socket.io`, `dotenv` → deep-heating-socketio\n- `@sveltejs/adapter-node`, `@sveltejs/kit`, `svelte-material-icons` → deep-heating-web\n- `luxon`, `rxjs-multi-scan` → deep-heating-rx and others\n- `axios`, `amazon-user-pool-srp-client`, `jsonwebtoken` → check usage\n- `bufferutil`, `utf-8-validate` → websocket optimizations, check usage\n- `socket.io-client` → deep-heating-web\n- `tslib` → check if still needed\n\n## Solution\n1. For each dep in root dependencies, find which workspace(s) import it\n2. Add the dep to that workspace's package.json\n3. Remove from root package.json\n4. Run `bun install` to update lockfile\n5. Update knip config to remove the now-unnecessary ignoreDependencies\n\n## Benefits\n- Clearer dependency graph per package\n- knip can properly detect unused deps per workspace\n- Easier to understand what each package needs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-29T18:01:52.698421Z","updated_at":"2025-11-29T18:15:02.960996Z","closed_at":"2025-11-29T18:15:02.960996Z","close_reason":"Completed - PR #1093 created"}
